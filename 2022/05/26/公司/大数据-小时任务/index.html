<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>大数据任务-小时任务 | 白菜君の技术库</title>

  
  <meta name="author" content="白菜(whiteCcinn)">
  

  
  <meta name="description" content="知道做不到，等于不知道">
  

  
  <meta name="keywords" content="白菜,文辉,技术博客,whiteCcinn">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="大数据任务-小时任务"/>

  <meta property="og:site_name" content="白菜君の技术库"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="白菜君の技术库" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">白菜君の技术库</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives/">文章</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/about/">关于我</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>大数据任务-小时任务</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2022/05/26/公司/大数据-小时任务/" rel="bookmark">
        <time class="entry-date published" datetime="2022-05-26T03:52:40.000Z">
          2022-05-26
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>总结一下公司大数据的任务ETL离线工作流 - 小时任务</p>
<a id="more"></a>

<p>公司的ETL服务，目前采用的是组件为：</p>
<ul>
<li>数仓 (hadoop)</li>
<li>任务调度器 (azkaban)</li>
<li>出仓 (gp)</li>
<li>数仓查询 (hue)(hive)(spark)</li>
</ul>
<h2 id="job-hour（小时任务）"><a href="#job-hour（小时任务）" class="headerlink" title="job_hour（小时任务）"></a>job_hour（小时任务）</h2><ul>
<li>schedule: <code>30 * * * *</code></li>
</ul>
<blockquote>
<p>每小时30分的时候进行启动任务</p>
</blockquote>
<p><img src="/images/%E5%85%AC%E5%8F%B8/bigdata-hour.png" alt="小时任务"></p>
<h3 id="check-tk-batch-log-success"><a href="#check-tk-batch-log-success" class="headerlink" title="check_tk_batch_log_success"></a>check_tk_batch_log_success</h3><blockquote>
<p>检测tk服务是否把原始日志已经上传到oss服务中</p>
</blockquote>
<p>核心流程如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">path=$&#123;LOG_TRACKING_BATCH_PATH&#125;</span><br><span class="line"></span><br><span class="line">path=$&#123;path&#125;/$&#123;yyyy&#125;/$&#123;mm&#125;/$&#123;dd&#125;/$&#123;hh&#125;/_SUCCESS</span><br><span class="line"></span><br><span class="line">hadoop fs -test -e $&#123;path&#125;</span><br></pre></td></tr></table></figure>

<p>数据是根据每个小时为一个基本单位，通过<code>_SUCCESS</code>文件来标志当前小时的数据是否已经同步到OSS完毕。</p>
<h3 id="sync-mysql-config"><a href="#sync-mysql-config" class="headerlink" title="sync_mysql_config"></a>sync_mysql_config</h3><blockquote>
<p>同步mysql的当前配置信息</p>
</blockquote>
<h4 id="同步广告位数据"><a href="#同步广告位数据" class="headerlink" title="同步广告位数据"></a>同步广告位数据</h4><p>核心流程如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stat_source='placement'</span><br><span class="line"></span><br><span class="line">mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e "</span><br><span class="line">select id,uuid,format from $&#123;DB_NAME&#125;.$&#123;stat_source&#125;</span><br><span class="line">" &gt; tmp/bigdata_mysql_placement_list.log</span><br><span class="line"></span><br><span class="line">if [ -f "tmp/bigdata_mysql_placement_list.log" ]; then</span><br><span class="line">    # hadoop fs -rm -r $&#123;CLIENT_TMP_LOG_META_PATH&#125;/tmp/placement/</span><br><span class="line">    $&#123;FILE_COMMAND_RM&#125; $&#123;CLIENT_TMP_LOG_META_PATH&#125;/tmp/placement/ --recursive</span><br><span class="line">    $&#123;FILE_COMMAND_CP&#125; tmp/bigdata_mysql_placement_list.log $&#123;CLIENT_TMP_LOG_META_PATH&#125;/tmp/placement/</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<ol>
<li>从数据库导出广告信息：<code>id</code>, <code>uuid</code>, <code>format(广告样式)</code> 到<code>广告列表文件</code></li>
<li>把本地数据更新到oss中</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">tmpfilename="tmp/bigdata_mysql_placement.log"</span><br><span class="line"></span><br><span class="line">mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e "</span><br><span class="line">    select </span><br><span class="line">        id,</span><br><span class="line">        uuid,        </span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,      </span><br><span class="line">        name,        </span><br><span class="line">        format,      </span><br><span class="line">        remark,      </span><br><span class="line">        create_time, </span><br><span class="line">        update_time </span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_NAME&#125;.$&#123;stat_source&#125; </span><br><span class="line">    ;</span><br><span class="line">" --skip-column-names | sed 's/\t/|/g' &gt; $&#123;tmpfilename&#125;</span><br><span class="line"></span><br><span class="line">if [ -f "$&#123;tmpfilename&#125;" ]; then</span><br><span class="line"></span><br><span class="line">    target="$&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_PLACEMENT&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/"</span><br><span class="line"></span><br><span class="line">    $&#123;FILE_COMMAND_RM&#125; $&#123;target&#125; --recursive</span><br><span class="line"></span><br><span class="line">    $&#123;FILE_COMMAND_CP&#125; $&#123;tmpfilename&#125; $&#123;target&#125;</span><br><span class="line"></span><br><span class="line">    echo "sync $&#123;tmpfilename&#125; to $&#123;target&#125;"</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<ol>
<li>导出数据广告位数据，并且以<code>|</code>符号作为分隔符，写入到<code>广告位文件</code></li>
<li>如果 <code>广告位</code> 文件存在的话，那么就把 <code>广告位文件</code> 从 <code>file-oss</code> 同步到 <code>hive-oss</code></li>
</ol>
<h4 id="同步广告聚合收益数据"><a href="#同步广告聚合收益数据" class="headerlink" title="同步广告聚合收益数据"></a>同步广告聚合收益数据</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">bigdata_unit_source='unit'</span><br><span class="line">bigdata_network_source='network'</span><br><span class="line">tmpAdsourcefilename="tmp/bigdata_mysql_unit.log"</span><br><span class="line">tmpAdsourceFbFilename="tmp/bigdata_mysql_unit_fb.log"</span><br><span class="line"></span><br><span class="line">mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e "</span><br><span class="line">    select </span><br><span class="line">        a.id,     </span><br><span class="line">        a.publisher_id,</span><br><span class="line">        a.placement_id,</span><br><span class="line">        a.network_id,  </span><br><span class="line">        a.network_id,</span><br><span class="line">        0,  </span><br><span class="line">        a.name,</span><br><span class="line">        a.remote_unique,</span><br><span class="line">        a.remote_unit,</span><br><span class="line">        a.header_bidding_switch,</span><br><span class="line">        a.ecpm,</span><br><span class="line">        a.ecpm_currency,</span><br><span class="line">        a.cap_hour,</span><br><span class="line">        a.cap_hour_switch,</span><br><span class="line">        a.cap_day,</span><br><span class="line">        a.cap_day_switch,</span><br><span class="line">        a.pacing,</span><br><span class="line">        a.pacing_switch,</span><br><span class="line">        a.create_time,</span><br><span class="line">        a.update_time,</span><br><span class="line">        a.status,</span><br><span class="line">        b.nw_firm_id</span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_NAME&#125;.$&#123;bigdata_unit_source&#125; a</span><br><span class="line">    left outer join</span><br><span class="line">         $&#123;DB_NAME&#125;.$&#123;bigdata_network_source&#125; b</span><br><span class="line">    on</span><br><span class="line">        a.network_id=b.id</span><br><span class="line">    where </span><br><span class="line">        b.nw_firm_id!=1</span><br><span class="line">    ;</span><br><span class="line">" --skip-column-names | sed 's/\t/|/g' &gt; $&#123;tmpAdsourcefilename&#125;</span><br><span class="line"></span><br><span class="line">mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e "</span><br><span class="line">    select </span><br><span class="line">        a.id,     </span><br><span class="line">        a.publisher_id,</span><br><span class="line">        a.placement_id,</span><br><span class="line">        b.parent_id,  </span><br><span class="line">        a.network_id,</span><br><span class="line">        b.parent_id,  </span><br><span class="line">        a.name,</span><br><span class="line">        a.remote_unique,</span><br><span class="line">        a.remote_unit,</span><br><span class="line">        a.header_bidding_switch,</span><br><span class="line">        a.ecpm,</span><br><span class="line">        a.ecpm_currency,</span><br><span class="line">        a.cap_hour,</span><br><span class="line">        a.cap_hour_switch,</span><br><span class="line">        a.cap_day,</span><br><span class="line">        a.cap_day_switch,</span><br><span class="line">        a.pacing,</span><br><span class="line">        a.pacing_switch,</span><br><span class="line">        a.create_time,</span><br><span class="line">        a.update_time,</span><br><span class="line">        a.status,</span><br><span class="line">        b.nw_firm_id</span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_NAME&#125;.$&#123;bigdata_unit_source&#125; a</span><br><span class="line">    left outer join</span><br><span class="line">         $&#123;DB_NAME&#125;.$&#123;bigdata_network_source&#125; b</span><br><span class="line">    on</span><br><span class="line">        a.network_id=b.id</span><br><span class="line">    where </span><br><span class="line">        b.nw_firm_id=1</span><br><span class="line">    ;</span><br><span class="line">" --skip-column-names | sed 's/\t/|/g' &gt; $&#123;tmpAdsourceFbFilename&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if [ -f "$&#123;tmpfilename&#125;" ]; then</span><br><span class="line"></span><br><span class="line">    target="$&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_UNIT&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/"</span><br><span class="line"></span><br><span class="line">    $&#123;FILE_COMMAND_RM&#125; $&#123;target&#125; --recursive</span><br><span class="line"></span><br><span class="line">    $&#123;FILE_COMMAND_CP&#125; $&#123;tmpAdsourcefilename&#125; $&#123;target&#125;</span><br><span class="line">    $&#123;FILE_COMMAND_CP&#125; $&#123;tmpAdsourceFbFilename&#125; $&#123;target&#125;</span><br><span class="line"></span><br><span class="line">    echo "sync $&#123;tmpfilename&#125; to $&#123;target&#125;"</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<ol>
<li>把 <code>国内广告</code> 和 <code>国外广告</code> 数据导出分别放在<code>不同的文件</code>中</li>
<li>然后从 <code>file-oss</code> 同步到 <code>hive-oss</code></li>
</ol>
<blockquote>
<p>备注：这里采用的是判断${tmpfilename}是广告位的文件，暂不确定是不是说明如果广告位文件没数据的话，那么这个逻辑也不做处理了。</p>
</blockquote>
<h4 id="广告场景"><a href="#广告场景" class="headerlink" title="广告场景"></a>广告场景</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">bigdata_scenario_source='scenario'</span><br><span class="line">tmpScenariofilename="tmp/bigdata_mysql_scenario.log"</span><br><span class="line"></span><br><span class="line">mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e "</span><br><span class="line">    select </span><br><span class="line">        id,</span><br><span class="line">        uuid,</span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,</span><br><span class="line">        placement_id,</span><br><span class="line">        name,</span><br><span class="line">        remark,</span><br><span class="line">        create_time,</span><br><span class="line">        update_time,</span><br><span class="line">        status</span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_NAME&#125;.$&#123;bigdata_scenario_source&#125;</span><br><span class="line">    ;</span><br><span class="line">" --skip-column-names | sed 's/\t/|/g' &gt; $&#123;tmpScenariofilename&#125;</span><br><span class="line"></span><br><span class="line">if [ -f "$&#123;tmpScenariofilename&#125;" ]; then</span><br><span class="line"></span><br><span class="line">    target="$&#123;HIVE_DB_PATH&#125;/$&#123;T_BIGDATA_SCENARIO&#125;/"</span><br><span class="line"></span><br><span class="line">    $&#123;FILE_COMMAND_RM&#125; $&#123;target&#125; --recursive</span><br><span class="line"></span><br><span class="line">    $&#123;FILE_COMMAND_CP&#125; $&#123;tmpScenariofilename&#125; $&#123;target&#125;</span><br><span class="line"></span><br><span class="line">    echo "sync $&#123;tmpScenariofilename&#125; to $&#123;target&#125;"</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<ol>
<li>把广告场景数据导入到广告场景文件中</li>
<li>然后从 <code>file-oss</code> 同步到 <code>hive-oss</code></li>
</ol>
<h4 id="等等…"><a href="#等等…" class="headerlink" title="等等…"></a>等等…</h4><h3 id="check-strategy-app-log-success"><a href="#check-strategy-app-log-success" class="headerlink" title="check_strategy_app_log_success"></a>check_strategy_app_log_success</h3><blockquote>
<p>检测app日志策略是否写入完成</p>
</blockquote>
<h3 id="check-strategy-placement-log-success"><a href="#check-strategy-placement-log-success" class="headerlink" title="check_strategy_placement_log_success"></a>check_strategy_placement_log_success</h3><blockquote>
<p>检测广告策略日志写入是否写入完成</p>
</blockquote>
<h3 id="parse-tk-batch"><a href="#parse-tk-batch" class="headerlink" title="parse_tk_batch"></a>parse_tk_batch</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dependencies=check_tk_batch_log_success,sync_mysql_config</span><br><span class="line">command=sh -x parse_tk_batch.sh</span><br></pre></td></tr></table></figure>

<blockquote>
<p>开始解析tk数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">log_type=18</span><br><span class="line">hadoop fs -rm -r $&#123;CLIENT_TMP_LOG_META_PATH&#125;/$&#123;T_BIGDATA_TK_BATCH&#125;/</span><br><span class="line">hadoop jar $&#123;parse_jar&#125; $&#123;LOG_TRACKING_BATCH_PATH&#125;/$&#123;yyyy&#125;/$&#123;mm&#125;/$&#123;dd&#125;/$&#123;hh&#125;/* $&#123;CLIENT_TMP_LOG_META_PATH&#125; $&#123;yyyy_mm_dd_hh&#125; $&#123;log_type&#125; $&#123;T_BIGDATA_TK_BATCH&#125; $&#123;T_BIGDATA_DEVICE_ACTIVE_HOUR&#125; $&#123;CLIENT_TMP_LOG_META_PATH&#125;/tmp/placement/bigdata_mysql_placement_list.log</span><br></pre></td></tr></table></figure>
<p>通过hadoop的<code>map-reduce</code>进行处理分布式处理数据</p>
<p>其实目前脚本来说，这里只有前5个参数有用</p>
<ol>
<li>第一个参数是原始日志的目录（有用）</li>
<li>第二个参数是输出日志的目录（没用）</li>
<li>第三个参数是日期时间</li>
<li>第四个参数是日志类型（这里=18）</li>
<li>第五个参数是表名（也是完整hive路径的一级目录）</li>
<li>第六个参数是输出结果表名（这里没用）</li>
<li>第七个参数是这里是广告日志文件路径</li>
</ol>
<p>TK原始日志的存储目录下，tk原始日志文件中里面有不同类型的数据，其中有一个<code>type</code>类型，可以叫做<code>tk_type</code>, 代表不同类型的数据(<code>TYPE_TRACKING_XXX</code>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrackingLogConst</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_REQUEST = <span class="number">1</span>; <span class="comment">// 请求</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_FILLED_REQUEST = <span class="number">2</span>; <span class="comment">// 有填充的请求</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_NO_FILLED_REQUEST = <span class="number">3</span>; <span class="comment">// 没填充的请求</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_IMPRESSION = <span class="number">4</span>; <span class="comment">// 展示</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_REFERSH_IMPRESSION = <span class="number">5</span>; <span class="comment">//刷新展示</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_CLICK = <span class="number">6</span>; <span class="comment">// 点击</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_VIDEO_PLAY = <span class="number">7</span>; <span class="comment">// 视频播放</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_RV_PLAY_START = <span class="number">8</span>;<span class="comment">// 激励视频播放开始</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_RV_PLAY_COMPLETE = <span class="number">9</span>;<span class="comment">// 激励视频播放完成</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_LOAD = <span class="number">10</span>;<span class="comment">// load调用数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_HEADER_BIDDING = <span class="number">11</span>;<span class="comment">// header bidding</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_LOADFILLED = <span class="number">12</span>;<span class="comment">// loadfilled数据</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_SHOW = <span class="number">13</span>;<span class="comment">// show调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_RAND_WATERFALL = <span class="number">15</span>;<span class="comment">// show调用</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_TRACKING_AD_SCENARIO = <span class="number">16</span>;<span class="comment">// 到达广告场景</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// myoffer的tracking对应类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_RV_0 = <span class="string">"1"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_RV_25 = <span class="string">"2"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_RV_50 = <span class="string">"3"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_RV_75 = <span class="string">"4"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_RV_100 = <span class="string">"5"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_RV_END_SHOW = <span class="string">"6"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_RV_END_CLOSE = <span class="string">"7"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_IMPRESSION = <span class="string">"8"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TYPE_MYOFFER_TRACKING_CLICK = <span class="string">"9"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> org.apache.hadoop.mapreduce.lib.output.MultipleOutputs&lt;Text, Text&gt; mos;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">(Mapper.Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    mos = <span class="keyword">new</span> MultipleOutputs&lt;Text, Text&gt;(context);</span><br><span class="line">    Configuration conf = context.getConfiguration();</span><br><span class="line">    tableName = conf.get(<span class="string">"table_name"</span>);</span><br><span class="line">    deviceTable = conf.get(<span class="string">"result_table"</span>);</span><br><span class="line">    inputTime = conf.get(<span class="string">"date"</span>);</span><br><span class="line">    inputTimeSplit = inputTime.split(<span class="string">"-"</span>);</span><br><span class="line">    logType = Integer.parseInt(conf.get(<span class="string">"log_type"</span>));</span><br><span class="line"></span><br><span class="line">    Path[] uriList = context.getLocalCacheFiles();</span><br><span class="line"></span><br><span class="line">    placementMap = PlacementData.getPlacementListFromUri(uriList);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">super</span>.setup(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeMosString</span><span class="params">(StringBuilder stringBuilder, <span class="keyword">int</span> trackingType)</span> </span>&#123;</span><br><span class="line">    String resultString = stringBuilder.toString();</span><br><span class="line">    <span class="keyword">if</span> (LogFactory.isDebug) &#123;</span><br><span class="line">        System.out.println(<span class="string">"result:"</span> + resultString + <span class="string">" tableName:"</span> + tableName + <span class="string">"/yyyy="</span> + inputTimeSplit[<span class="number">0</span>] + <span class="string">"/mm="</span> + inputTimeSplit[<span class="number">1</span>] + <span class="string">"/dd="</span> + inputTimeSplit[<span class="number">2</span>] + <span class="string">"/hh="</span> + inputTimeSplit[<span class="number">3</span>] + <span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 写结果表</span></span><br><span class="line">    <span class="keyword">if</span> (resultString != <span class="keyword">null</span> &amp;&amp; resultString != <span class="string">""</span> &amp;&amp; !LogFactory.isDebug) &#123;</span><br><span class="line">        <span class="comment">// 写结果后，会使用logtype_作为前缀</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mos.write(<span class="keyword">new</span> Text(resultString), <span class="keyword">new</span> Text(), tableName + <span class="string">"/"</span> + trackingType + <span class="string">"/raw/"</span> + logType + <span class="string">"_"</span> + trackingType + <span class="string">"_"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    String outputPathTmp = outputPath + <span class="string">"/"</span> + tableName + logType + <span class="string">"/"</span>;</span><br><span class="line">    FileSystem fs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        fs = FileSystem.get(<span class="keyword">new</span> URI(inputPath), conf);</span><br><span class="line">        Path outPath = <span class="keyword">new</span> Path(outputPathTmp);</span><br><span class="line">        <span class="keyword">if</span> (fs.exists(outPath)) &#123;</span><br><span class="line">            fs.delete(outPath, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>父级路径位：<code>outputPathTmp</code>: <code>/{table}{logType}/</code></p>
<p>看到数据被解析之后，会被写入到如下子级路径：</p>
<p><code>{tableName} + &quot;/&quot; + {trackingType} + &quot;/raw/&quot; + {logType} + &quot;_&quot; + {trackingType} + &quot;_&quot;</code></p>
<p>在当前的解析任务中，以 <code>TYPE_TRACKING_IMPRESSION=4</code> 为例子，具体的例子如下：</p>
<p><code>{T_BIGDATA_TK_BATCH}/4/raw/18_4_xxx</code></p>
<p>具体用法需要串联下一个节点来看。</p>
<h3 id="copy-xxx-copy-impression为例"><a href="#copy-xxx-copy-impression为例" class="headerlink" title="copy_xxx(copy_impression为例)"></a>copy_xxx(copy_impression为例)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">&#123;FILE_COMMAND_RM&#125; <span class="variable">$&#123;HIVE_DB_PATH&#125;</span>/<span class="variable">$&#123;T_BIGDATA_IMPRESSION&#125;</span>/yyyy=<span class="variable">$&#123;yyyy&#125;</span>/mm=<span class="variable">$&#123;mm&#125;</span>/dd=<span class="variable">$&#123;dd&#125;</span>/hh=<span class="variable">$&#123;hh&#125;</span> --recursive</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;FILE_COMMAND_RM&#125; <span class="variable">$&#123;HIVE_DB_PATH&#125;</span>/<span class="variable">$&#123;T_BIGDATA_IMPRESSION_V2&#125;</span>/yyyy=<span class="variable">$&#123;yyyy&#125;</span>/mm=<span class="variable">$&#123;mm&#125;</span>/dd=<span class="variable">$&#123;dd&#125;</span>/hh=<span class="variable">$&#123;hh&#125;</span> --recursive</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;FILE_COMMAND_SYNC&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_META_PATH&#125;</span>/<span class="variable">$&#123;T_BIGDATA_TK_BATCH&#125;</span>18/<span class="variable">$&#123;T_BIGDATA_TK_BATCH&#125;</span>/4/raw/ <span class="variable">$&#123;HIVE_DB_PATH&#125;</span>/<span class="variable">$&#123;T_BIGDATA_IMPRESSION&#125;</span>/yyyy=<span class="variable">$&#123;yyyy&#125;</span>/mm=<span class="variable">$&#123;mm&#125;</span>/dd=<span class="variable">$&#123;dd&#125;</span>/hh=<span class="variable">$&#123;hh&#125;</span>/</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;FILE_COMMAND_SYNC&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_META_PATH&#125;</span>/<span class="variable">$&#123;T_BIGDATA_TK_BATCH&#125;</span>18/<span class="variable">$&#123;T_BIGDATA_TK_BATCH&#125;</span>/5/raw/ <span class="variable">$&#123;HIVE_DB_PATH&#125;</span>/<span class="variable">$&#123;T_BIGDATA_IMPRESSION&#125;</span>/yyyy=<span class="variable">$&#123;yyyy&#125;</span>/mm=<span class="variable">$&#123;mm&#125;</span>/dd=<span class="variable">$&#123;dd&#125;</span>/hh=<span class="variable">$&#123;hh&#125;</span>/</span></span><br><span class="line"></span><br><span class="line">hive -e "</span><br><span class="line">        use $&#123;DB_BIGDATA&#125;;</span><br><span class="line">        alter table $&#123;T_BIGDATA_IMPRESSION&#125; drop IF EXISTS  partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;',hh='$&#123;hh&#125;');</span><br><span class="line">        alter table $&#123;T_BIGDATA_IMPRESSION&#125; add partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;',hh='$&#123;hh&#125;') location 'yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125;';</span><br><span class="line">"</span><br><span class="line"></span><br><span class="line">hql=" select</span><br><span class="line">        cast(c_date as int) as c_date,</span><br><span class="line">        c_time,</span><br><span class="line">        cast(created as bigint) as created,</span><br><span class="line">        ip,</span><br><span class="line">        remote_ip,</span><br><span class="line">        server_id,</span><br><span class="line">        country_code,</span><br><span class="line">        cast((case when os_platform is null or os_platform='' then 1 else os_platform end) as int) as os_platform,</span><br><span class="line">        imei,</span><br><span class="line">        mac,</span><br><span class="line">        android_id,</span><br><span class="line">        gaid,</span><br><span class="line">        idfa,</span><br><span class="line">        os_vn,</span><br><span class="line">        os_vc,</span><br><span class="line">        model,</span><br><span class="line">        brand,</span><br><span class="line">        screen_size,</span><br><span class="line">        cast((case when orientation is null or orientation='' then 1 else orientation end) as int) as orientation,</span><br><span class="line">        network_type,</span><br><span class="line">        mcc,</span><br><span class="line">        mnc,</span><br><span class="line">        language,</span><br><span class="line">        time_zone,</span><br><span class="line">        user_agent,</span><br><span class="line">        gpv,</span><br><span class="line">        app_vn,</span><br><span class="line">        app_vc,</span><br><span class="line">        app_package,</span><br><span class="line">        sdk_version,</span><br><span class="line">        cast((case when publisher_id is null or publisher_id='' then 0 else publisher_id end) as int) as publisher_id,</span><br><span class="line">        app_id,</span><br><span class="line">        cast((case when app_raw_id is null or app_raw_id='' then 0 else app_raw_id end) as int) as app_raw_id,</span><br><span class="line">        placement_id,</span><br><span class="line">        cast((case when placement_raw_id is null or placement_raw_id='' then 0 else placement_raw_id end) as int) as placement_raw_id,</span><br><span class="line">        request_id,</span><br><span class="line">        psid,</span><br><span class="line">        sessionid,</span><br><span class="line">        cast((case when sdk_time is null or sdk_time='' then 0 else sdk_time end) as bigint) as sdk_time,</span><br><span class="line">        ug_id,</span><br><span class="line">        nw_version,</span><br><span class="line">        cast((case when nw_firm_id is null or nw_firm_id='' then 0 else nw_firm_id end) as int) as nw_firm_id,</span><br><span class="line">        cast((case when sc_type is null or sc_type='' then 0 else sc_type end) as int) as sc_type,</span><br><span class="line">        cast((case when group_id is null or group_id='' then 0 else group_id end) as int) as group_id,</span><br><span class="line">        cast((case when format is null or format='' then 0 else format end) as int) as format,</span><br><span class="line">        extra,</span><br><span class="line">        cast((case when is_refresh is null or is_refresh='' then 0 else is_refresh end) as int) as is_refresh,</span><br><span class="line">        cast((case when unit_id is null or unit_id='' then 0 else unit_id end) as int) as unit_id,</span><br><span class="line">        cast((case when system_type is null or system_type='' then 0 else system_type end) as int) as system_type,</span><br><span class="line">        cast((case when load_type is null or load_type='' then 0 else load_type end) as int) as load_type,</span><br><span class="line">        case when asid is null then '' else asid end as asid,</span><br><span class="line">        case when channel is null then '' else channel end as channel,</span><br><span class="line">        case when upid is null then '' else upid end as upid,</span><br><span class="line">        cast((case when auto_refresh is null or auto_refresh='' then 0 else auto_refresh end) as int) as auto_refresh,</span><br><span class="line">        cast((case when aprn_auto_req is null or aprn_auto_req='' then 0 else aprn_auto_req end) as int) as aprn_auto_req,</span><br><span class="line">        cast((case when bidtype is null or bidtype='' then 0 else bidtype end) as int) as bidtype,</span><br><span class="line">        cast((case when bidprice is null or bidprice='' then 0 else bidprice end) as float) as bidprice,</span><br><span class="line">        case when offer_pkg is null then '' else offer_pkg end as offer_pkg,</span><br><span class="line">        case when sub_channel is null then '' else sub_channel end as sub_channel,</span><br><span class="line">        case when idfv is null then '' else idfv end as idfv,</span><br><span class="line">        cast((case when traffic_group_id is null or traffic_group_id='' then 0 else traffic_group_id end) as int) as traffic_group_id,</span><br><span class="line">        cast((case when myoffer_show_type is null or myoffer_show_type='' then 0 else myoffer_show_type end) as int) as myoffer_show_type,</span><br><span class="line">        cast((case when ofl is null or ofl='' then 0 else ofl end) as int) as ofl,</span><br><span class="line">        cast((case when gdpr_cs is null or gdpr_cs='' then 0 else gdpr_cs end) as int) as gdpr_cs,</span><br><span class="line">        case when scenario is null then '1' else scenario end as scenario,</span><br><span class="line">        cast((case when deduction_res is null or deduction_res='' then 0 else deduction_res end) as int) as deduction_res,</span><br><span class="line">        cast((case when deduction_num is null or deduction_num='' then 1 else deduction_num end) as int) as deduction_num,</span><br><span class="line">        case when oaid is null then '' else oaid end as oaid,</span><br><span class="line">        cast((case when is_cn_sdk is null or is_cn_sdk='' then 0 else is_cn_sdk end) as int) as is_cn_sdk,</span><br><span class="line">        cast((case when adtype_day_show_times is null or adtype_day_show_times='' then 0 else adtype_day_show_times end) as int) as adtype_day_show_times,</span><br><span class="line">        cast((case when adtype_hour_show_times is null or adtype_hour_show_times='' then 0 else adtype_hour_show_times end) as int) as adtype_hour_show_times,</span><br><span class="line">        cast((case when placement_day_show_times is null or placement_day_show_times='' then 0 else placement_day_show_times end) as int) as placement_day_show_times,</span><br><span class="line">        cast((case when placement_hour_show_times is null or placement_hour_show_times='' then 0 else placement_hour_show_times end) as int) as placement_hour_show_times,</span><br><span class="line">        case when install_source is null then '' else install_source end as install_source,</span><br><span class="line">        protocol,</span><br><span class="line">        origin_num,</span><br><span class="line">        protocol_type,</span><br><span class="line">        abtest_id,</span><br><span class="line">        first_init_time,</span><br><span class="line">        days_from_first_init,</span><br><span class="line">        app_custom,</span><br><span class="line">        user_id,</span><br><span class="line">        age,</span><br><span class="line">        gender,</span><br><span class="line">        cl_imp,</span><br><span class="line">        ex_ad</span><br><span class="line">        from </span><br><span class="line">            $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_IMPRESSION&#125;</span><br><span class="line">        where </span><br><span class="line">            yyyy='$&#123;yyyy&#125;'</span><br><span class="line">            and mm='$&#123;mm&#125;'</span><br><span class="line">            and dd='$&#123;dd&#125;'</span><br><span class="line">            and hh='$&#123;hh&#125;' "</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">spark-submit --class com.BigData.spark.jobs.common.CommonSparkSaveORCJob \</span><br><span class="line">--name "BigData_CommonSparkDateTimeJob_copy_impression_dt$&#123;yyyy_mm_dd_hh&#125;" \</span><br><span class="line">--master yarn  \</span><br><span class="line">--deploy-mode cluster \</span><br><span class="line">--executor-memory 2g \</span><br><span class="line">--driver-memory 2g \</span><br><span class="line">--executor-cores 2 \</span><br><span class="line">--num-executors 8 \</span><br><span class="line">--conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">--conf spark.dynamicAllocation.minExecutors=8 \</span><br><span class="line">--conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">--conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line">--files "$&#123;HIVE_SITE_PATH&#125;" \</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_HIVE_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;HIVE_DB_PATH&#125;</span>/<span class="variable">$&#123;T_BIGDATA_IMPRESSION_V2&#125;</span>/yyyy=<span class="variable">$&#123;yyyy&#125;</span>/mm=<span class="variable">$&#123;mm&#125;</span>/dd=<span class="variable">$&#123;dd&#125;</span>/hh=<span class="variable">$&#123;hh&#125;</span>/"</span>\</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> hive -e "</span><br><span class="line">    use $&#123;DB_BIGDATA&#125;;</span><br><span class="line">    alter table $&#123;T_BIGDATA_IMPRESSION_V2&#125; drop IF EXISTS  partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;',hh='$&#123;hh&#125;');</span><br><span class="line">    alter table $&#123;T_BIGDATA_IMPRESSION_V2&#125; add partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;',hh='$&#123;hh&#125;') location 'yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/hh=$&#123;hh&#125;';</span><br><span class="line"> "</span><br></pre></td></tr></table></figure>


<p>这里接着上一个节点的分析，这里的<code>${CLIENT_TMP_LOG_META_PATH}/${T_BIGDATA_TK_BATCH}18/${T_BIGDATA_TK_BATCH}/4/raw/</code> 就是经过hadoop解析后输出文件的目录</p>
<ol>
<li>如果有历史的数据，则删除历史的数据，然后重新导入数据到表中</li>
<li>接着再把数据copy到 <code>impression</code> 对应的目录分区中</li>
<li>重建（修复）分区，把数据加载到hive中的<code>impression</code></li>
<li>通过sql把数据进行 <code>第一次</code> 清洗，经过这一级的清洗，通过spark把数据转成 <code>ORC</code> 格式进行存储到 <code>impression_v2</code> 表</li>
<li>重建（修复）分区，把数据加载到hive中<code>impression_v2</code></li>
</ol>
<h3 id="merge-xxx-merge-tk-impression为例"><a href="#merge-xxx-merge-tk-impression为例" class="headerlink" title="merge_xxx(merge_tk_impression为例)"></a>merge_xxx(merge_tk_impression为例)</h3><blockquote>
<p>清洗tk的impression数据到tk小时的orc表（此orc非物理上的orc表）</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">hql="select</span><br><span class="line">        $&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;,</span><br><span class="line">        $&#123;hh&#125;,</span><br><span class="line">        a.nw_firm_id,</span><br><span class="line">        a.group_id,</span><br><span class="line">        a.unit_id,</span><br><span class="line">        a.system_type,</span><br><span class="line">        a.sdk_version,</span><br><span class="line">        a.app_vn,</span><br><span class="line">        a.os_platform,</span><br><span class="line">        a.country_code,</span><br><span class="line">        a.publisher_id,</span><br><span class="line">        a.app_raw_id,</span><br><span class="line">        a.placement_raw_id,</span><br><span class="line">        a.format,</span><br><span class="line">        a.sc_type,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        cast(count(a.request_id) as bigint),</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        a.channel,</span><br><span class="line">        a.sub_channel,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        $&#123;timeStamp&#125;,</span><br><span class="line">        0,</span><br><span class="line">        cast(b.network_id as int),</span><br><span class="line">        a.traffic_group_id,</span><br><span class="line">        a.bidtype,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        cast((sum(a.bidprice)/1000) as float),</span><br><span class="line">        case when (a.scenario is null or a.scenario='' or c.uuid is null or c.status&lt;&gt;3) then '1' else a.scenario end,</span><br><span class="line">        case when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.uuid is null) then 1 when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.status&lt;&gt;3) then 2 else 0 end,</span><br><span class="line">        case when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.uuid is null or a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.status&lt;&gt;3) then a.scenario else '' end,</span><br><span class="line">        cast(sum(case when a.deduction_num is null or a.deduction_num = '' then '1' else a.deduction_num end) as bigint),                </span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        case  when (a.is_cn_sdk is null or a.is_cn_sdk='null') then 0 else a.is_cn_sdk end,</span><br><span class="line">        case when os_platform=2 and length(model)&gt;=4 and upper(substr(model,1,4))='IPAD' then 2 else 1 end,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        case when (os_platform = '2' and ((length(idfa) &gt; 0 and idfa &lt;&gt; '00000000-0000-0000-0000-000000000000') or (idfa = '' and gdpr_cs = '1'))) then 1 else 0 end as idfa_exist_tag,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        a.abtest_id</span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_IMPRESSION_V2&#125; as a</span><br><span class="line">    left outer join</span><br><span class="line">        $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_UNIT&#125; as b</span><br><span class="line">    on</span><br><span class="line">        a.yyyy='$&#123;yyyy&#125;'</span><br><span class="line">        and a.mm='$&#123;mm&#125;'</span><br><span class="line">        and a.dd='$&#123;dd&#125;'</span><br><span class="line">        and a.hh='$&#123;hh&#125;'</span><br><span class="line">        and b.yyyy='$&#123;yyyy&#125;'</span><br><span class="line">        and b.mm='$&#123;mm&#125;'</span><br><span class="line">        and b.dd='$&#123;dd&#125;'</span><br><span class="line">        and a.unit_id=b.id</span><br><span class="line">    left outer join</span><br><span class="line">        $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_SCENARIO&#125; as c</span><br><span class="line">    on</span><br><span class="line">        a.yyyy='$&#123;yyyy&#125;'</span><br><span class="line">        and a.mm='$&#123;mm&#125;'</span><br><span class="line">        and a.dd='$&#123;dd&#125;'</span><br><span class="line">        and a.hh='$&#123;hh&#125;'</span><br><span class="line">        and a.placement_raw_id=c.placement_id</span><br><span class="line">        and a.scenario=c.uuid</span><br><span class="line">    where </span><br><span class="line">        a.yyyy='$&#123;yyyy&#125;'</span><br><span class="line">        and a.mm='$&#123;mm&#125;'</span><br><span class="line">        and a.dd='$&#123;dd&#125;'</span><br><span class="line">        and a.hh='$&#123;hh&#125;'</span><br><span class="line">        and a.is_refresh=0</span><br><span class="line">        and a.unit_id&gt;0</span><br><span class="line">        and a.publisher_id is not null</span><br><span class="line">        and a.bidprice &lt;&gt; 'Infinity'</span><br><span class="line">        and a.bidprice &gt;= 0</span><br><span class="line">        and a.bidprice &lt;= 100000</span><br><span class="line">    group by </span><br><span class="line">        a.nw_firm_id, </span><br><span class="line">        a.group_id, </span><br><span class="line">        a.unit_id, </span><br><span class="line">        a.system_type, </span><br><span class="line">        a.sdk_version, </span><br><span class="line">        a.app_vn, </span><br><span class="line">        a.os_platform, </span><br><span class="line">        a.country_code, </span><br><span class="line">        a.publisher_id, </span><br><span class="line">        a.app_raw_id, </span><br><span class="line">        a.placement_raw_id, </span><br><span class="line">        a.format, </span><br><span class="line">        a.sc_type,</span><br><span class="line">        a.channel,</span><br><span class="line">        a.sub_channel,</span><br><span class="line">        b.network_id,</span><br><span class="line">        a.traffic_group_id,</span><br><span class="line">        a.bidtype,</span><br><span class="line">        case when (a.scenario is null or a.scenario='' or c.uuid is null or c.status&lt;&gt;3) then '1' else a.scenario end,</span><br><span class="line">        case when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.uuid is null) then 1 when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.status&lt;&gt;3) then 2 else 0 end,</span><br><span class="line">        case when (a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.uuid is null or a.scenario is not null and a.scenario&lt;&gt;'' and a.scenario&lt;&gt;'1' and c.status&lt;&gt;3) then a.scenario else '' end,</span><br><span class="line">        case  when (a.is_cn_sdk is null or a.is_cn_sdk='null') then 0 else a.is_cn_sdk end,</span><br><span class="line">        case when os_platform=2 and length(model)&gt;=4 and upper(substr(model,1,4))='IPAD' then 2 else 1 end,</span><br><span class="line">        case when (os_platform = '2' and ((length(idfa) &gt; 0 and idfa &lt;&gt; '00000000-0000-0000-0000-000000000000') or (idfa = '' and gdpr_cs = '1'))) then 1 else 0 end,</span><br><span class="line">        a.abtest_id</span><br><span class="line">"</span><br><span class="line"></span><br><span class="line">spark-submit --class com.BigData.spark.jobs.common.CommonSparkDateTimeJob \</span><br><span class="line">--name "BigData_CommonSparkDateTimeJob_merge_impression_dt$&#123;yyyy_mm_dd_hh&#125;" \</span><br><span class="line">--master yarn  \</span><br><span class="line">--deploy-mode cluster \</span><br><span class="line">--executor-memory 2g \</span><br><span class="line">--driver-memory 2g \</span><br><span class="line">--executor-cores 2 \</span><br><span class="line">--num-executors 8 \</span><br><span class="line">--conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">--conf spark.dynamicAllocation.minExecutors=8 \</span><br><span class="line">--conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">--conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line">--files "$&#123;HIVE_SITE_PATH&#125;" \</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_HIVE_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;yyyy_mm_dd_hh&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DB_BIGDATA&#125;</span>.<span class="variable">$&#123;T_BIGDATA_REPORT_TK_HOUR_ORC&#125;</span>"</span>  <span class="string">"dt='<span class="variable">$&#123;yyyy&#125;</span>-<span class="variable">$&#123;mm&#125;</span>-<span class="variable">$&#123;dd&#125;</span>', hh='<span class="variable">$&#123;hh&#125;</span>', dimen='3'"</span> <span class="string">"overwrite"</span>\</span></span><br></pre></td></tr></table></figure>

<ol>
<li>这里是操作的主表为<code>v2</code>表，join的表一般只能是<code>v1</code>表，因为文本的解析是一起执行的，但是<code>各个任务的v2表</code>什么时候更新完毕暂时是不确定的。</li>
<li>这里看到分区信息中有一个 <code>dimen = &#39;3&#39;</code>，是和接下来的 <code>${T_BIGDATA_REPORT_TK_HOUR_ORC}</code> 有关系。这是一个tk数据的汇总表，几乎所有维度的数据最后都会汇集在这里，加上我们有不同的任务的数据都写入到这个表，所以我们加一个dimen的分区，便于区分不同的<code>数据的来源</code>。</li>
</ol>
<h3 id="merge-tracking-hour"><a href="#merge-tracking-hour" class="headerlink" title="merge_tracking_hour"></a>merge_tracking_hour</h3><blockquote>
<p>清洗orc的表数据到非orc的表，数据基本可以认为是一份基本可以出仓的数据了</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">hql="select</span><br><span class="line">        $&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;,</span><br><span class="line">        $&#123;hh&#125;,</span><br><span class="line">        case nw_firm_id when '' then 0 else nw_firm_id end,</span><br><span class="line">        case group_id when '' then 0 else group_id end,</span><br><span class="line">        case nw_firm_id when '35' then 1 else unit_id end,</span><br><span class="line">        case system_type when '' then 0 else system_type end,</span><br><span class="line">        case sdk_version when 'null' then '0' else sdk_version end,</span><br><span class="line">        case when app_vn = 'null' then '0' when length(app_vn) &gt;= 50 then '0' else regexp_replace(app_vn,'\\\\\\\\0000','') end as app_vn,</span><br><span class="line">        case os_platform when '' then 0 else os_platform end,</span><br><span class="line">        case geo_short when 'null' then '00' else geo_short end,</span><br><span class="line">        case publisher_id when '' then 0 else publisher_id end,</span><br><span class="line">        case app_id when '' then 0 else app_id end,</span><br><span class="line">        case placement_id when '' then 0 when 'null' then 0 else placement_id end,</span><br><span class="line">        case format when '' then 0 else format end,</span><br><span class="line">        case sc_type when '' then 0 else sc_type end,</span><br><span class="line">        cast(sum(request) as bigint),</span><br><span class="line">        cast(sum(filled_request) as bigint),</span><br><span class="line">        cast(sum(impression) as bigint),</span><br><span class="line">        cast(sum(click) as bigint),</span><br><span class="line">        cast(sum(load) as bigint),</span><br><span class="line">        cast(sum(filled_load) as bigint),</span><br><span class="line">        cast(sum(rv_play_start) as bigint),</span><br><span class="line">        cast(sum(rv_play_complete) as bigint),</span><br><span class="line">        case channel when '' then '' else channel end,</span><br><span class="line">        case sub_channel when '' then '' else sub_channel end,</span><br><span class="line">        cast(sum(app_request) as bigint),</span><br><span class="line">        cast(sum(placement_request) as bigint),</span><br><span class="line">        cast(sum(show) as bigint),</span><br><span class="line">        $&#123;timeStamp&#125;,</span><br><span class="line">        cast(sum(impression_optimize) as bigint),</span><br><span class="line">        case network_id when '' then 0 else network_id end,</span><br><span class="line">        case  when (traffic_group_id is null or traffic_group_id='') then 0 else traffic_group_id end,</span><br><span class="line">        case  when (bidtype is null or bidtype='') then 0 else bidtype end,</span><br><span class="line">        cast(sum(bid_request) as bigint),</span><br><span class="line">        cast(sum(bid_response) as bigint),</span><br><span class="line">        cast(sum(case when dimen='12' then estimated_revenue else 0 end) as float),</span><br><span class="line">        case when (scenario is null or scenario='') then '1' else scenario end,</span><br><span class="line">        case when (error_type is null or error_type='') then 0 else error_type end,</span><br><span class="line">        case when (error_msg is null or error_msg='') then '' else error_msg end,</span><br><span class="line">        cast(sum(case when (fake_impression_optimize&gt;0 and dimen='12') then fake_impression_optimize else 0 end) as bigint),</span><br><span class="line">        cast(sum(case when (fake_filled_load is null) then 0 else fake_filled_load end) as bigint),</span><br><span class="line">        cast(sum(case when (fake_filled_request is null) then 0 else fake_filled_request end) as bigint),</span><br><span class="line">        case  when (is_cn_sdk is null or is_cn_sdk='null' or is_cn_sdk='') then 0 else is_cn_sdk end,</span><br><span class="line">        case when device_type is null then 1 else device_type end,</span><br><span class="line">        cast(sum(load_cost_time) as bigint),</span><br><span class="line">        cast(sum(request_cost_time) as bigint),</span><br><span class="line">        idfa_exist_tag,</span><br><span class="line">        case coalesce(sum(bid_response),0) when 0  then 0.0 else cast(sum(bid_response * coalesce(bid_response_ecpm,0)) / sum(bid_response) as float) end,</span><br><span class="line">        cast(sum(case when (scenario_entry is null or scenario_entry='') then 0 else scenario_entry end) as bigint),</span><br><span class="line">        cast(sum(case when (scenario_entry_ready is null or scenario_entry_ready='') then 0 else scenario_entry_ready end) as bigint),</span><br><span class="line">        abtest_id</span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_HOUR_ORC&#125;</span><br><span class="line">    where </span><br><span class="line">        dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;'</span><br><span class="line">        and hh='$&#123;hh&#125;'</span><br><span class="line">        and dimen in ('1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16')</span><br><span class="line">        and unit_id is not null</span><br><span class="line">        and publisher_id is not null</span><br><span class="line">        and app_id is not null</span><br><span class="line">        and placement_id is not null</span><br><span class="line">        and format is not null</span><br><span class="line">        and sc_type is not null</span><br><span class="line">        and system_type is not null </span><br><span class="line">        and os_platform is not null </span><br><span class="line">        and sdk_version is not null </span><br><span class="line">        and app_vn is not null </span><br><span class="line">        and channel is not null </span><br><span class="line">        and sub_channel is not null </span><br><span class="line">        and group_id is not null</span><br><span class="line">        and nw_firm_id is not null</span><br><span class="line">        and network_id is not null</span><br><span class="line">        and group_id&gt;=0</span><br><span class="line">        and group_id&lt;=2147483647</span><br><span class="line">        and format&lt;=10</span><br><span class="line">        and estimated_revenue &lt;&gt; 'Infinity'</span><br><span class="line">        and is_cn_sdk&lt;=1</span><br><span class="line">        and length(geo_short)&lt;=2</span><br><span class="line">    group by</span><br><span class="line">        case nw_firm_id when '' then 0 else nw_firm_id end,</span><br><span class="line">        case group_id when '' then 0 else group_id end,</span><br><span class="line">        case nw_firm_id when '35' then 1 else unit_id end,</span><br><span class="line">        case system_type when '' then 0 else system_type end,</span><br><span class="line">        case sdk_version when 'null' then '0' else sdk_version end,</span><br><span class="line">        case when app_vn = 'null' then '0' when length(app_vn) &gt;= 50 then '0' else regexp_replace(app_vn,'\\\\\\\\0000','') end,</span><br><span class="line">        case os_platform when '' then 0 else os_platform end,</span><br><span class="line">        case geo_short when 'null' then '00' else geo_short end,</span><br><span class="line">        case publisher_id when '' then 0 else publisher_id end,</span><br><span class="line">        case app_id when '' then 0 else app_id end,</span><br><span class="line">        case placement_id when '' then 0 when 'null' then 0 else placement_id end,</span><br><span class="line">        case format when '' then 0 else format end,</span><br><span class="line">        case sc_type when '' then 0 else sc_type end,</span><br><span class="line">        case channel when '' then '' else channel end,</span><br><span class="line">        case sub_channel when '' then '' else sub_channel end,</span><br><span class="line">        case network_id when '' then 0 else network_id end,</span><br><span class="line">        case  when (traffic_group_id is null or traffic_group_id='') then 0 else traffic_group_id end,</span><br><span class="line">        case  when (bidtype is null or bidtype='') then 0 else bidtype end,</span><br><span class="line">        case when (scenario is null or scenario='') then '1' else scenario end,</span><br><span class="line">        case when (error_type is null or error_type='') then 0 else error_type end,</span><br><span class="line">        case when (error_msg is null or error_msg='') then '' else error_msg end,</span><br><span class="line">        case  when (is_cn_sdk is null or is_cn_sdk='null' or is_cn_sdk='') then 0 else is_cn_sdk end,</span><br><span class="line">        case when device_type is null then 1 else device_type end,</span><br><span class="line">        idfa_exist_tag,</span><br><span class="line">        abtest_id</span><br><span class="line">"</span><br><span class="line"></span><br><span class="line">spark-submit --class com.BigData.spark.jobs.common.CommonSparkDateTimeJob \</span><br><span class="line">--name "BigData_CommonSparkDateTimeJob_merge_report_hour_dt$&#123;yyyy_mm_dd_hh&#125;" \</span><br><span class="line">--master yarn  \</span><br><span class="line">--deploy-mode cluster \</span><br><span class="line">--executor-memory 2g \</span><br><span class="line">--driver-memory 2g \</span><br><span class="line">--executor-cores 2 \</span><br><span class="line">--num-executors 8 \</span><br><span class="line">--conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">--conf spark.dynamicAllocation.minExecutors=8 \</span><br><span class="line">--conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">--conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line">--files "$&#123;HIVE_SITE_PATH&#125;" \</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_HIVE_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;yyyy_mm_dd_hh&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DB_BIGDATA&#125;</span>.<span class="variable">$&#123;T_BIGDATA_REPORT_TK_HOUR&#125;</span>"</span>  <span class="string">"dt='<span class="variable">$&#123;yyyy&#125;</span>-<span class="variable">$&#123;mm&#125;</span>-<span class="variable">$&#123;dd&#125;</span>', hh='<span class="variable">$&#123;hh&#125;</span>', dimen='0'"</span> <span class="string">"overwrite"</span>\</span></span><br></pre></td></tr></table></figure>

<ol>
<li>where条件加上了<code>dimen in (&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;7&#39;,&#39;8&#39;,&#39;9&#39;,&#39;10&#39;,&#39;11&#39;,&#39;12&#39;,&#39;13&#39;,&#39;14&#39;,&#39;15&#39;,&#39;16&#39;)</code>，代表要拿到所有父节点的任务数据</li>
<li>其他的where条件代表在这个节点，不可能存在这些字段没有数据</li>
<li>把数据写入到非orc的表中，并且 <code>dimen = &#39;0&#39;</code></li>
</ol>
<h3 id="to-db-tracking-hour"><a href="#to-db-tracking-hour" class="headerlink" title="to_db_tracking_hour"></a>to_db_tracking_hour</h3><blockquote>
<p>数据出仓到gp</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">dimension_tk_hour_field="date_time,hour,nw_firm_id,group_id,unit_id,system,sdk_version,app_version,platform,geo_short,publisher_id,app_id,placement_id,format,sc_type,channel,sub_channel,hour_timestamp,network_id,traffic_group_id,bid_type,scenario,error_type,error_msg,is_cn_sdk,device_type,idfa_exist_tag "</span><br><span class="line">hive_dimension_tk_hour_field="date_time,hour,nw_firm_id,group_id,unit_id,system_type,sdk_version,app_vn,os_platform,geo_short,publisher_id,app_id,placement_id,format,sc_type,channel,sub_channel,hour_timestamp,network_id,traffic_group_id,bidtype,scenario,error_type,error_msg,is_cn_sdk,device_type,idfa_exist_tag"</span><br><span class="line">select_tk_hour_field="$&#123;hive_dimension_tk_hour_field&#125;,cast(sum(request) as bigint),cast(sum(filled_request) as bigint),cast(sum(impression) as bigint),cast(sum(click) as bigint),cast(sum(load) as bigint),cast(sum(filled_load) as bigint),cast(sum(rv_play_start) as bigint),cast(sum(rv_play_complete) as bigint),cast(sum(app_request) as bigint),cast(sum(placement_request) as bigint),cast(sum(show) as bigint),cast(sum(impression_optimize) as bigint),cast(sum(bid_request) as bigint),cast(sum(bid_response) as bigint),cast(sum(estimated_revenue) as float),cast(sum(fake_impression_optimize) as bigint),cast(sum(fake_filled_load) as bigint),cast(sum(fake_filled_request) as bigint),cast(sum(load_cost_time) as bigint),cast(sum(request_cost_time) as bigint), case coalesce(sum(bid_response),0) when 0  then 0.0 else cast(sum(bid_response * coalesce(bid_response_ecpm,0)) / sum(bid_response) as float) end as bid_response_ecpm,cast(sum(scenario_entry) as bigint),cast(sum(scenario_entry_ready) as bigint) "</span><br><span class="line">export_tk_hour_field="$&#123;dimension_tk_hour_field&#125;,request,filled_request,impression,click,loads,filled_loads,rv_start,rv_complete,strategy_app_request,strategy_placement_request,shows,impression_optimize,bid_request,bid_filled_request,estimated_revenue,fake_impression_optimize,fake_filled_load,fake_filled_request,load_cost_time,request_cost_time,bid_filled_request_ecpm,scenario_entry,scenario_entry_ready"</span><br><span class="line"></span><br><span class="line">function export_tk_hour_func() &#123;</span><br><span class="line">  stat_source_hour='report_tk_hour'</span><br><span class="line">  gp_delete_timeStamp=$(expr $&#123;timeStamp&#125; + 1 \* 3600)</span><br><span class="line">  del_sql="delete from $&#123;stat_source_hour&#125; where date_time = $&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125; and hour=$&#123;hh&#125; and add_timestamp&lt;$&#123;gp_delete_timeStamp&#125; and source_type not in (2);"</span><br><span class="line">  select_sql="select $&#123;select_tk_hour_field&#125; from $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_HOUR&#125; where dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;' and hh='$&#123;hh&#125;' and dimen='0' group by $&#123;hive_dimension_tk_hour_field&#125;"</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 针对两个库的删除和导入</span></span><br><span class="line">  export_to_pgsql_by_select_data "$&#123;select_sql&#125;" $&#123;stat_source_hour&#125; bigdata_job_base_data_report_hour_$&#123;RANDOM&#125;_tmp.log "$&#123;del_sql&#125;" '|' "($&#123;export_tk_hour_field&#125;)"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export_to_pgsql_by_select_data() &#123;</span><br><span class="line">  el_sql=$1</span><br><span class="line">  el_stat_source=$2</span><br><span class="line">  el_tmp_file=$3</span><br><span class="line">  el_delete_sql=$4</span><br><span class="line">  el_terminated=$5</span><br><span class="line">  el_rows=$6</span><br><span class="line"></span><br><span class="line">  filepath=$(</span><br><span class="line">    cd "$(dirname "$0")"</span><br><span class="line">    pwd</span><br><span class="line">  )</span><br><span class="line">  fileTmpDir=tmp_$&#123;el_stat_source&#125;/$&#123;el_stat_source&#125;/</span><br><span class="line"></span><br><span class="line">  if [ -f "$&#123;el_tmp_file&#125;" ]; then</span><br><span class="line">    rm $&#123;el_tmp_file&#125;</span><br><span class="line">  fi</span><br><span class="line">  hive -e "</span><br><span class="line">              INSERT OVERWRITE  DIRECTORY '$&#123;fileTmpDir&#125;'</span><br><span class="line">              ROW format delimited fields terminated BY '$&#123;el_terminated&#125;'</span><br><span class="line">              $&#123;el_sql&#125;</span><br><span class="line">            "</span><br><span class="line">  hadoop fs -getmerge $&#123;fileTmpDir&#125;* $&#123;el_tmp_file&#125;</span><br><span class="line">  head -n 20 $&#123;el_tmp_file&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="built_in">export</span> to pgsql</span></span><br><span class="line">  echo "copy $&#123;el_stat_source&#125;  $&#123;el_rows&#125; from STDIN delimiter as '$&#123;el_terminated&#125;';"</span><br><span class="line">  sql="copy $&#123;el_stat_source&#125;  $&#123;el_rows&#125; from STDIN delimiter as '$&#123;el_terminated&#125;'"</span><br><span class="line"></span><br><span class="line">  if [[ $&#123;PG_BI_DB_ENABLE&#125; = true ]]; then</span><br><span class="line">    psql "host=$&#123;PG_BI_DB_HOST&#125; port=$&#123;PG_BI_DB_PORT&#125; user=$&#123;PG_BI_DB_USER&#125; password=$&#123;PG_BI_DB_PWD&#125; dbname=$&#123;PG_BI_DB_NAME&#125;" -c "$&#123;el_delete_sql&#125;"</span><br><span class="line">    psql "host=$&#123;PG_BI_DB_HOST&#125; port=$&#123;PG_BI_DB_PORT&#125; user=$&#123;PG_BI_DB_USER&#125; password=$&#123;PG_BI_DB_PWD&#125; dbname=$&#123;PG_BI_DB_NAME&#125;" -c "$&#123;sql&#125;" &lt;$&#123;el_tmp_file&#125;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  if [[ $&#123;PG_REL_BI_DB_ENABLE&#125; = true ]]; then</span><br><span class="line">    psql "host=$&#123;PG_REL_BI_DB_HOST&#125; port=$&#123;PG_REL_BI_DB_PORT&#125; user=$&#123;PG_REL_BI_DB_USER&#125; password=$&#123;PG_REL_BI_DB_PWD&#125; dbname=$&#123;PG_REL_BI_DB_NAME&#125;" -c "$&#123;el_delete_sql&#125;"</span><br><span class="line">    psql "host=$&#123;PG_REL_BI_DB_HOST&#125; port=$&#123;PG_REL_BI_DB_PORT&#125; user=$&#123;PG_REL_BI_DB_USER&#125; password=$&#123;PG_REL_BI_DB_PWD&#125; dbname=$&#123;PG_REL_BI_DB_NAME&#125;" -c "$&#123;sql&#125;" &lt;$&#123;el_tmp_file&#125;</span><br><span class="line">  fi</span><br><span class="line"></span><br><span class="line">  rm $&#123;el_tmp_file&#125;</span><br><span class="line">  hadoop fs -rmr $&#123;fileTmpDir&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export_tk_hour_func</span><br></pre></td></tr></table></figure>

<ol>
<li>把数据通过sql查出来，然后通过 <code>|</code> 符号进行分割，然后写入到一个临时文件中</li>
<li>删除当前小时周期下的数据</li>
<li>通过 <code>copy</code> 命令列出所有的字段，然后通过标准输入<code>STDIN</code> 作为分隔符，从<code>临时文件中</code>导入数据</li>
</ol>
<h3 id="to-db-traking"><a href="#to-db-traking" class="headerlink" title="to_db_traking"></a>to_db_traking</h3><blockquote>
<p>把小时级表的数据合并到天级表</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 天表的数据都来自于小时表，从小时表导出后导入天表</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tk表及东八区的时间和小时表的时间一样，0时区和西八区需要特殊处理一下</span></span><br><span class="line">currentUnixTime=$(date '+%s')</span><br><span class="line">tmpTkHourFileName="/data/gp_tk_tmp/report_tk_utce8_$&#123;currentUnixTime&#125;.log" # 此文件是在GP服务器上面的，需要有专门的任务去做清除</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 参照收益任务hour小时数据到天级数据的处理方式: export_report_unit_hour.sh</span></span><br><span class="line">CurrentDay=$&#123;utce8_yyyy&#125;$&#123;utce8_mm&#125;$&#123;utce8_dd&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 机器为零时区</span></span><br><span class="line">startTimeStamp=`date -d "8 hour ago $&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125; 00:00:00" +%s`</span><br><span class="line">endTimeStamp=`date -d "8 hour ago $&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125; 23:59:59" +%s`</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> estimate_revenue_api,estimate_currency_revenue_api,ready_request,ready_success,show_failed 由ltv任务写入</span></span><br><span class="line">pgSearchSql="</span><br><span class="line">SELECT</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;CurrentDay&#125;,</span></span><br><span class="line">  nw_firm_id,</span><br><span class="line">  group_id,</span><br><span class="line">  geo_short,</span><br><span class="line">  publisher_id,</span><br><span class="line">  channel,</span><br><span class="line">  sub_channel,</span><br><span class="line">  system,</span><br><span class="line">  platform,</span><br><span class="line">  app_id,</span><br><span class="line">  sdk_version,</span><br><span class="line">  app_version,</span><br><span class="line">  placement_id,</span><br><span class="line">  unit_id,</span><br><span class="line">  format,</span><br><span class="line">  sc_type,</span><br><span class="line">  SUM(request),</span><br><span class="line">  SUM(filled_request),</span><br><span class="line">  SUM(strategy_app_request),</span><br><span class="line">  SUM(strategy_placement_request),</span><br><span class="line">  SUM(impression),</span><br><span class="line">  SUM(shows),</span><br><span class="line">  SUM(click),</span><br><span class="line">  SUM(loads),</span><br><span class="line">  SUM(filled_loads),</span><br><span class="line">  SUM(rv_start),</span><br><span class="line">  SUM(rv_complete),</span><br><span class="line">  SUM(impression_optimize),</span><br><span class="line">  network_id,</span><br><span class="line">  bid_type,</span><br><span class="line">  SUM(estimated_revenue),</span><br><span class="line">  traffic_group_id,</span><br><span class="line">  SUM(bid_request),</span><br><span class="line">  SUM(bid_filled_request),</span><br><span class="line">  case when (scenario is null or scenario='') then '1' else scenario end,</span><br><span class="line">  error_type,</span><br><span class="line">  case when (error_msg is null or error_msg='') then '' else error_msg end,</span><br><span class="line">  SUM(fake_impression_optimize),</span><br><span class="line">  SUM(fake_filled_load),</span><br><span class="line">  SUM(fake_filled_request),</span><br><span class="line">  is_cn_sdk,</span><br><span class="line">  device_type,</span><br><span class="line">  source_type,</span><br><span class="line">  SUM(load_cost_time),</span><br><span class="line">  SUM(request_cost_time),</span><br><span class="line">  idfa_exist_tag,</span><br><span class="line">  case coalesce(sum(bid_filled_request),0) when 0  then 0.0 else cast(sum(bid_filled_request * bid_filled_request_ecpm) / sum(bid_filled_request) as float) end,</span><br><span class="line">  SUM(scenario_entry),</span><br><span class="line">  SUM(scenario_entry_ready)</span><br><span class="line">FROM</span><br><span class="line">  report_tk_hour</span><br><span class="line">WHERE</span><br><span class="line">  hour_timestamp &gt;= $&#123;startTimeStamp&#125;</span><br><span class="line">  AND hour_timestamp &lt;= $&#123;endTimeStamp&#125;</span><br><span class="line">  AND source_type NOT IN (2)</span><br><span class="line">  AND add_timestamp &lt; $&#123;gp_delete_timeStamp&#125;</span><br><span class="line">GROUP BY</span><br><span class="line">  nw_firm_id,</span><br><span class="line">  group_id,</span><br><span class="line">  geo_short,</span><br><span class="line">  publisher_id,</span><br><span class="line">  channel,</span><br><span class="line">  sub_channel,</span><br><span class="line">  system,</span><br><span class="line">  platform,</span><br><span class="line">  app_id,</span><br><span class="line">  sdk_version,</span><br><span class="line">  app_version,</span><br><span class="line">  placement_id,</span><br><span class="line">  unit_id,</span><br><span class="line">  format,</span><br><span class="line">  sc_type,</span><br><span class="line">  network_id,</span><br><span class="line">  bid_type,</span><br><span class="line">  traffic_group_id,</span><br><span class="line">  case when (scenario is null or scenario='') then '1' else scenario end,</span><br><span class="line">  error_type,</span><br><span class="line">  case when (error_msg is null or error_msg='') then '' else error_msg end,</span><br><span class="line">  is_cn_sdk,</span><br><span class="line">  device_type,</span><br><span class="line">  source_type,</span><br><span class="line">  idfa_exist_tag</span><br><span class="line">  "</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导出数据，report_tk 和 report_tk_utce8 表数据一致，只用导出一次便可</span></span><br><span class="line">outputSql="COPY ( $&#123;pgSearchSql&#125; ) TO '$&#123;tmpTkHourFileName&#125;' WITH CSV;"</span><br><span class="line">export PGPASSWORD=$&#123;PG_BI_DB_PWD&#125;</span><br><span class="line">psql --host=$&#123;PG_BI_DB_HOST&#125; --port=$&#123;PG_BI_DB_PORT&#125; --user=$&#123;PG_BI_DB_USER&#125; --dbname=$&#123;PG_BI_DB_NAME&#125; -c "$&#123;outputSql&#125;"</span><br><span class="line"></span><br><span class="line">deleteSql="DELETE FROM report_tk_utce8 WHERE date_time = $&#123;CurrentDay&#125;  AND source_type NOT IN (2) AND add_timestamp &lt; $&#123;gp_delete_timeStamp&#125;;"</span><br><span class="line">inputSql="COPY report_tk_utce8 ( $&#123;rowNames&#125; ) FROM '$&#123;tmpTkHourFileName&#125;' WITH CSV;"</span><br><span class="line"></span><br><span class="line">export PGPASSWORD=$&#123;PG_BI_DB_PWD&#125;</span><br><span class="line">respTag10=`psql --host=$&#123;PG_BI_DB_HOST&#125; --port=$&#123;PG_BI_DB_PORT&#125; --user=$&#123;PG_BI_DB_USER&#125; --dbname=$&#123;PG_BI_DB_NAME&#125; &lt;&lt;EOF</span><br><span class="line">BEGIN;</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;deleteSql&#125;</span></span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;inputSql&#125;</span></span><br><span class="line">COMMIT;</span><br><span class="line">EOF`</span><br><span class="line"></span><br><span class="line">echo $&#123;respTag10&#125;</span><br><span class="line">if [[ $&#123;respTag10&#125; =~ "ROLLBACK" ]] ; then</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<ol>
<li>先把数据导出到一个临时文件<code>${tmpTkHourFileName}</code></li>
<li>再把数据从临时文件导入到另外一个天级表<code>report_tk_utce8</code></li>
<li>utc0/utcw8时区的一样的操作</li>
</ol>
<h3 id="merge-tracking-hour-1"><a href="#merge-tracking-hour-1" class="headerlink" title="merge_tracking_hour"></a>merge_tracking_hour</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">转换成utc8时间</span></span><br><span class="line">utce8_day_start_timeStamp=`date -d "$&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125; 00:00:00" +%s`</span><br><span class="line">utce8_day_end_timeStamp=`date -d "$&#123;utce8_yyyy&#125;-$&#123;utce8_mm&#125;-$&#123;utce8_dd&#125; 23:00:00" +%s`</span><br><span class="line">while_run_stamp=$&#123;utce8_day_start_timeStamp&#125;</span><br><span class="line">utce8_utc0_hour_where='('</span><br><span class="line"></span><br><span class="line">while [ "$&#123;while_run_stamp&#125;" -le "$&#123;utce8_day_end_timeStamp&#125;" ]</span><br><span class="line">do</span><br><span class="line">    tmp_run_stamp=`expr $&#123;while_run_stamp&#125; - 8 \* 3600`</span><br><span class="line">    tmp_date_time=`date -d @$&#123;tmp_run_stamp&#125; "+%Y-%m-%d-%H"`</span><br><span class="line">    tmp_yyyy=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $1&#125;'`</span><br><span class="line">    tmp_mm=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $2&#125;'`</span><br><span class="line">    tmp_dd=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $3&#125;'`</span><br><span class="line">    tmp_hh=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $4&#125;'`</span><br><span class="line">    if [ "$&#123;while_run_stamp&#125;" == "$&#123;utce8_day_start_timeStamp&#125;" ]</span><br><span class="line">        then</span><br><span class="line">           utce8_utc0_hour_where="$&#123;utce8_utc0_hour_where&#125;dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hh='$&#123;tmp_hh&#125;'"</span><br><span class="line">        else</span><br><span class="line">           utce8_utc0_hour_where="$&#123;utce8_utc0_hour_where&#125; or dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hh='$&#123;tmp_hh&#125;'"</span><br><span class="line">        fi</span><br><span class="line">        while_run_stamp=`expr $&#123;while_run_stamp&#125; + 3600`</span><br><span class="line">done</span><br><span class="line">utce8_utc0_hour_where="$&#123;utce8_utc0_hour_where&#125;)"</span><br><span class="line"></span><br><span class="line">hql="select</span><br><span class="line">        $&#123;utce8_yyyy&#125;$&#123;utce8_mm&#125;$&#123;utce8_dd&#125;,</span><br><span class="line">        nw_firm_id,</span><br><span class="line">        group_id,</span><br><span class="line">        unit_id,</span><br><span class="line">        system_type,</span><br><span class="line">        sdk_version,</span><br><span class="line">        app_vn,</span><br><span class="line">        os_platform,</span><br><span class="line">        geo_short,</span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,</span><br><span class="line">        placement_id,</span><br><span class="line">        format,</span><br><span class="line">        sc_type,</span><br><span class="line">        cast(sum(request) as bigint),</span><br><span class="line">        cast(sum(filled_request) as bigint),</span><br><span class="line">        cast(sum(impression) as bigint),</span><br><span class="line">        cast(sum(click) as bigint),</span><br><span class="line">        cast(sum(load) as bigint),</span><br><span class="line">        cast(sum(filled_load) as bigint),</span><br><span class="line">        cast(sum(rv_play_start) as bigint),</span><br><span class="line">        cast(sum(rv_play_complete) as bigint),</span><br><span class="line">        channel,</span><br><span class="line">        sub_channel,</span><br><span class="line">        cast(sum(app_request) as bigint),</span><br><span class="line">        cast(sum(placement_request) as bigint),</span><br><span class="line">        cast(sum(show) as bigint),</span><br><span class="line">        cast(sum(impression_optimize) as bigint),</span><br><span class="line">        case  when network_id is null then 0 else network_id end,</span><br><span class="line">        case  when (traffic_group_id is null or traffic_group_id='') then 0 else traffic_group_id end,</span><br><span class="line">        case  when (bidtype is null or bidtype='') then 0 else bidtype end,</span><br><span class="line">        cast(sum(case  when (bid_request is null or bid_request='') then 0 else bid_request end) as bigint),</span><br><span class="line">        cast(sum(case  when (bid_response is null or bid_response='') then 0 else bid_response end) as bigint),</span><br><span class="line">        cast(sum(case  when (estimated_revenue is null or estimated_revenue='') then 0 else estimated_revenue end) as float),</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        case when (scenario is null or scenario='') then '1' else scenario end,</span><br><span class="line">        case when (error_type is null or error_type='') then 0 else error_type end,</span><br><span class="line">        case when (error_msg is null or error_msg='') then '' else error_msg end,</span><br><span class="line">        cast(sum(case when (fake_impression_optimize is null or fake_impression_optimize='') then impression_optimize else fake_impression_optimize end) as bigint),</span><br><span class="line">        cast(sum(case when (fake_filled_load is null or fake_filled_load='') then filled_load else fake_filled_load end) as bigint),</span><br><span class="line">        cast(sum(case when (fake_filled_request is null or fake_filled_request='') then filled_request else fake_filled_request end) as bigint),</span><br><span class="line">        case  when (is_cn_sdk is null or is_cn_sdk='null' or is_cn_sdk='') then 0 else is_cn_sdk end,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        case when device_type is null then 1 else device_type end,</span><br><span class="line">        cast(sum(case when load_cost_time is null or load_cost_time&lt;0 then 0 else load_cost_time end) as bigint),</span><br><span class="line">        cast(sum(case when request_cost_time is null or request_cost_time&lt;0 then 0 else request_cost_time end) as bigint),</span><br><span class="line">        case when idfa_exist_tag is null then 0 else idfa_exist_tag end,</span><br><span class="line">        case coalesce(sum(bid_response),0) when 0  then 0.0 else cast(sum(bid_response * coalesce(bid_response_ecpm,0)) / sum(bid_response) as float) end,</span><br><span class="line">        cast(coalesce(sum(scenario_entry),0) as bigint),</span><br><span class="line">        cast(coalesce(sum(scenario_entry_ready),0) as bigint),</span><br><span class="line">        abtest_id</span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_BIGDATA&#125;.$&#123;T_BIGDATA_REPORT_TK_HOUR&#125;</span><br><span class="line">    where </span><br><span class="line">        $&#123;utce8_utc0_hour_where&#125;</span><br><span class="line">        and dimen='0'</span><br><span class="line">        and group_id&gt;=0</span><br><span class="line">        and group_id&lt;=2147483647</span><br><span class="line">    group by </span><br><span class="line">        nw_firm_id,</span><br><span class="line">        group_id,</span><br><span class="line">        unit_id,</span><br><span class="line">        system_type,</span><br><span class="line">        sdk_version,</span><br><span class="line">        app_vn,</span><br><span class="line">        os_platform,</span><br><span class="line">        geo_short,</span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,</span><br><span class="line">        placement_id,</span><br><span class="line">        format,</span><br><span class="line">        sc_type,</span><br><span class="line">        channel,</span><br><span class="line">        sub_channel,</span><br><span class="line">        case</span><br><span class="line">            when network_id is null then 0</span><br><span class="line">        else network_id</span><br><span class="line">        end,</span><br><span class="line">        case  when (traffic_group_id is null or traffic_group_id='') then 0 else traffic_group_id end,</span><br><span class="line">        case  when (bidtype is null or bidtype='') then 0 else bidtype end,</span><br><span class="line">        case when (scenario is null or scenario='') then '1' else scenario end,</span><br><span class="line">        case when (error_type is null or error_type='') then 0 else error_type end,</span><br><span class="line">        case when (error_msg is null or error_msg='') then '' else error_msg end,</span><br><span class="line">        case  when (is_cn_sdk is null or is_cn_sdk='null' or is_cn_sdk='') then 0 else is_cn_sdk end,</span><br><span class="line">        case when device_type is null then 1 else device_type end,</span><br><span class="line">        case when idfa_exist_tag is null then 0 else idfa_exist_tag end,</span><br><span class="line">        abtest_id</span><br><span class="line">"</span><br><span class="line"></span><br><span class="line">spark-submit --class com.BigData.spark.jobs.common.CommonSparkDateTimeJob \</span><br><span class="line">--name "BigData_CommonSparkDateTimeJob_merge_report_utce8_dt$&#123;yyyy_mm_dd_hh&#125;" \</span><br><span class="line">--master yarn  \</span><br><span class="line">--deploy-mode cluster \</span><br><span class="line">--executor-memory 2g \</span><br><span class="line">--driver-memory 2g \</span><br><span class="line">--executor-cores 2 \</span><br><span class="line">--num-executors 8 \</span><br><span class="line">--conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">--conf spark.dynamicAllocation.minExecutors=8 \</span><br><span class="line">--conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">--conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line">--files "$&#123;HIVE_SITE_PATH&#125;" \</span><br><span class="line"><span class="meta">$</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_HIVE_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;yyyy_mm_dd_hh&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DB_BIGDATA&#125;</span>.<span class="variable">$&#123;T_BIGDATA_REPORT_TK_UTCE8&#125;</span>"</span>  <span class="string">"dt='<span class="variable">$&#123;utce8_yyyy&#125;</span>-<span class="variable">$&#123;utce8_mm&#125;</span>-<span class="variable">$&#123;utce8_dd&#125;</span>', dimen='0'"</span> <span class="string">"overwrite"</span>\</span></span><br></pre></td></tr></table></figure>

<ol>
<li>数据通过小时表转成<code>report_tk</code>表，并且 <code>dimen=&#39;0&#39;</code></li>
</ol>
<h3 id="abtest-tk-xxx"><a href="#abtest-tk-xxx" class="headerlink" title="abtest_tk_xxx"></a>abtest_tk_xxx</h3><blockquote>
<p>业务需要，根据abtest_id，把数据分别成不同的traffi_group_id，原始的数据的abtest_id字段会变成&amp;&amp;，分别出来的会变成00</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br></pre></td><td class="code"><pre><span class="line">tk_dimen='0'</span><br><span class="line">abtest_tk_tmp_dimen="10$&#123;tk_dimen&#125;"</span><br><span class="line">zone_type=$1</span><br><span class="line"></span><br><span class="line">if [ -n "$&#123;run_type&#125;" ]; then</span><br><span class="line">  if [[ $&#123;run_type&#125; = 'utcw8' ]]; then</span><br><span class="line">    zone_type="3"</span><br><span class="line">  else</span><br><span class="line">    if [[ $&#123;run_type&#125; = 'utc0' ]]; then</span><br><span class="line">      zone_type="2"</span><br><span class="line">    else</span><br><span class="line">      zone_type="1"</span><br><span class="line">    fi</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">zone_yyyy="$&#123;yyyy&#125;"</span><br><span class="line">zone_mm="$&#123;mm&#125;"</span><br><span class="line">zone_dd="$&#123;dd&#125;"</span><br><span class="line">zone_tk_table="$&#123;T_BIGDATA_REPORT_TK_UTCE8&#125;"</span><br><span class="line">zone_abtest_tk_table="$&#123;T_BIGDATA_REPORT_ABTEST_TK_UTCE8&#125;"</span><br><span class="line">zone_gp_abtest_tk_table="report_abtest_tk_utce8"</span><br><span class="line"></span><br><span class="line">if [ "$&#123;zone_type&#125;" == "2" ]; then</span><br><span class="line">  zone_yyyy="$&#123;utc0_yyyy&#125;"</span><br><span class="line">  zone_mm="$&#123;utc0_mm&#125;"</span><br><span class="line">  zone_dd="$&#123;utc0_dd&#125;"</span><br><span class="line">  zone_tk_table="$&#123;T_BIGDATA_REPORT_TK_UTC0&#125;"</span><br><span class="line">  zone_abtest_tk_table="$&#123;T_BIGDATA_REPORT_ABTEST_TK_UTC0&#125;"</span><br><span class="line">  zone_gp_abtest_tk_table="report_abtest_tk_utc0"</span><br><span class="line">else</span><br><span class="line">  if [ "$&#123;zone_type&#125;" == "3" ]; then</span><br><span class="line">    zone_yyyy="$&#123;utcw8_yyyy&#125;"</span><br><span class="line">    zone_mm="$&#123;utcw8_mm&#125;"</span><br><span class="line">    zone_dd="$&#123;utcw8_dd&#125;"</span><br><span class="line">    zone_tk_table="$&#123;T_BIGDATA_REPORT_TK_UTCW8&#125;"</span><br><span class="line">    zone_abtest_tk_table="$&#123;T_BIGDATA_REPORT_ABTEST_TK_UTCW8&#125;"</span><br><span class="line">    zone_gp_abtest_tk_table="report_abtest_tk_utcw8"</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">hql="select</span><br><span class="line">        date_time,</span><br><span class="line">        nw_firm_id,</span><br><span class="line">        group_id,</span><br><span class="line">        unit_id,</span><br><span class="line">        sdk_version,</span><br><span class="line">        app_vn,</span><br><span class="line">        os_platform,</span><br><span class="line">        geo_short,</span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,</span><br><span class="line">        placement_id,</span><br><span class="line">        format,</span><br><span class="line">        device_type,</span><br><span class="line">        channel,</span><br><span class="line">        network_id,</span><br><span class="line">        case when abtest_id is null then '' else abtest_id end as abtest_id,</span><br><span class="line">        traffic_group_id,</span><br><span class="line">        bidtype,</span><br><span class="line">        cast(sum(request) as bigint),</span><br><span class="line">        cast(sum(filled_request) as bigint),</span><br><span class="line">        cast(sum(impression) as bigint),</span><br><span class="line">        cast(sum(click) as bigint),</span><br><span class="line">        cast(sum(load) as bigint),</span><br><span class="line">        cast(sum(filled_load) as bigint),</span><br><span class="line">        cast(sum(rv_play_start) as bigint),</span><br><span class="line">        cast(sum(rv_play_complete) as bigint),</span><br><span class="line">        cast(sum(show) as bigint),</span><br><span class="line">        cast(sum(impression_optimize) as bigint),</span><br><span class="line">        cast(sum(case  when (bid_request is null or bid_request='') then 0 else bid_request end) as bigint),</span><br><span class="line">        cast(sum(case  when (bid_response is null or bid_response='') then 0 else bid_response end) as bigint),</span><br><span class="line">        cast(sum(case  when (estimated_revenue is null or estimated_revenue='') then 0 else estimated_revenue end) as float),</span><br><span class="line">        cast(sum(case  when (estimate_revenue_api is null or estimate_revenue_api='') then 0 else estimate_revenue_api end) as float),</span><br><span class="line">        cast(sum(case  when (estimate_currency_revenue_api is null or estimate_currency_revenue_api='') then 0 else estimate_currency_revenue_api end) as float),</span><br><span class="line">        cast(sum(case when (fake_impression_optimize is null or fake_impression_optimize='') then impression_optimize else fake_impression_optimize end) as bigint),</span><br><span class="line">        cast(sum(case when (fake_filled_load is null or fake_filled_load='') then filled_load else fake_filled_load end) as bigint),</span><br><span class="line">        cast(sum(case when (fake_filled_request is null or fake_filled_request='') then filled_request else fake_filled_request end) as bigint),</span><br><span class="line">        sum(ready_request),</span><br><span class="line">        sum(ready_success),</span><br><span class="line">        sum(show_failed)</span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_BIGDATA&#125;.$&#123;zone_tk_table&#125;</span><br><span class="line">    where </span><br><span class="line">        dt='$&#123;zone_yyyy&#125;-$&#123;zone_mm&#125;-$&#123;zone_dd&#125;'</span><br><span class="line">        and dimen='$&#123;tk_dimen&#125;'</span><br><span class="line">    group by </span><br><span class="line">        date_time,</span><br><span class="line">        nw_firm_id,</span><br><span class="line">        group_id,</span><br><span class="line">        unit_id,</span><br><span class="line">        sdk_version,</span><br><span class="line">        app_vn,</span><br><span class="line">        os_platform,</span><br><span class="line">        geo_short,</span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,</span><br><span class="line">        placement_id,</span><br><span class="line">        format,</span><br><span class="line">        device_type,</span><br><span class="line">        channel,</span><br><span class="line">        network_id,</span><br><span class="line">        case when abtest_id is null then '' else abtest_id end,</span><br><span class="line">        traffic_group_id,</span><br><span class="line">        bidtype</span><br><span class="line">        "</span><br><span class="line"></span><br><span class="line">spark-submit --class com.BigData.spark.parse.jobs.ParseAndSpiltAbtestTkJob \</span><br><span class="line">  --name "BigData_ParseAndSpiltAbtestTkJob_abtest_dt$&#123;yyyy_mm_dd_hh&#125;_$&#123;zone_type&#125;" \</span><br><span class="line">  --master yarn \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --executor-memory 2g \</span><br><span class="line">  --driver-memory 2g \</span><br><span class="line">  --executor-cores 2 \</span><br><span class="line">  --num-executors 8 \</span><br><span class="line">  --conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">  --conf spark.dynamicAllocation.minExecutors=32 \</span><br><span class="line">  --conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">  --conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line">  --files "$&#123;HIVE_SITE_PATH&#125;" \</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;yyyy_mm_dd_hh&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"abtest_id"</span> <span class="string">"traffic_group_id"</span> <span class="string">"<span class="variable">$&#123;DB_BIGDATA&#125;</span>.<span class="variable">$&#123;zone_abtest_tk_table&#125;</span>"</span> <span class="string">"dt='<span class="variable">$&#123;zone_yyyy&#125;</span>-<span class="variable">$&#123;zone_mm&#125;</span>-<span class="variable">$&#123;zone_dd&#125;</span>', dimen='<span class="variable">$&#123;abtest_tk_tmp_dimen&#125;</span>'"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 合并分解后的数据</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次减少维度数据</span></span><br><span class="line">merge_hql=" </span><br><span class="line">select</span><br><span class="line">        date_time,</span><br><span class="line">        0 as nw_firm_id,</span><br><span class="line">        0 as group_id,</span><br><span class="line">        0 as unit_id,</span><br><span class="line">        '',</span><br><span class="line">        '',</span><br><span class="line">        0 as os_platform,</span><br><span class="line">        geo_short,</span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,</span><br><span class="line">        placement_id,</span><br><span class="line">        -1 as format,</span><br><span class="line">        -1 as device_type,</span><br><span class="line">        '',</span><br><span class="line">        0,</span><br><span class="line">        case when abtest_id &lt;&gt;'&amp;&amp;' then '00' else abtest_id end as abtest_id,</span><br><span class="line">        traffic_group_id,</span><br><span class="line">        -1 as bidtype,</span><br><span class="line">        cast(sum(request) as bigint),</span><br><span class="line">        cast(sum(filled_request) as bigint),</span><br><span class="line">        cast(sum(impression) as bigint),</span><br><span class="line">        cast(sum(click) as bigint),</span><br><span class="line">        cast(sum(load) as bigint),</span><br><span class="line">        cast(sum(filled_load) as bigint),</span><br><span class="line">        cast(sum(rv_play_start) as bigint),</span><br><span class="line">        cast(sum(rv_play_complete) as bigint),</span><br><span class="line">        cast(sum(show) as bigint),</span><br><span class="line">        cast(sum(impression_optimize) as bigint),</span><br><span class="line">        cast(sum(case  when (bid_request is null or bid_request='') then 0 else bid_request end) as bigint),</span><br><span class="line">        cast(sum(case  when (bid_response is null or bid_response='') then 0 else bid_response end) as bigint),</span><br><span class="line">        cast(sum(case  when (estimated_revenue is null or estimated_revenue='') then 0 else estimated_revenue end) as float),</span><br><span class="line">        cast(sum(case  when (estimate_revenue_api is null or estimate_revenue_api='') then 0 else estimate_revenue_api end) as float),</span><br><span class="line">        cast(sum(case  when (estimate_currency_revenue_api is null or estimate_currency_revenue_api='') then 0 else estimate_currency_revenue_api end) as float),</span><br><span class="line">        cast(sum(case when (fake_impression_optimize is null or fake_impression_optimize='') then impression_optimize else fake_impression_optimize end) as bigint),</span><br><span class="line">        cast(sum(case when (fake_filled_load is null or fake_filled_load='') then filled_load else fake_filled_load end) as bigint),</span><br><span class="line">        cast(sum(case when (fake_filled_request is null or fake_filled_request='') then filled_request else fake_filled_request end) as bigint),</span><br><span class="line">        sum(ready_request),</span><br><span class="line">        sum(ready_success),</span><br><span class="line">        sum(show_failed)</span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_BIGDATA&#125;.$&#123;zone_abtest_tk_table&#125;</span><br><span class="line">    where </span><br><span class="line">        dt='$&#123;zone_yyyy&#125;-$&#123;zone_mm&#125;-$&#123;zone_dd&#125;'</span><br><span class="line">        and dimen='$&#123;abtest_tk_tmp_dimen&#125;'</span><br><span class="line">    group by </span><br><span class="line">        date_time,</span><br><span class="line">        geo_short,</span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,</span><br><span class="line">        placement_id,</span><br><span class="line">        case when abtest_id &lt;&gt;'&amp;&amp;' then '00' else abtest_id end,</span><br><span class="line">        traffic_group_id</span><br><span class="line">    "</span><br><span class="line"></span><br><span class="line">spark-submit --class com.BigData.spark.jobs.common.CommonSparkDateTimeJob \</span><br><span class="line">  --name "BigData_CommonSparkDateTimeJob_merge_strategy_app_dt$&#123;yyyy_mm_dd_hh&#125;" \</span><br><span class="line">  --master yarn \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --executor-memory 2g \</span><br><span class="line">  --driver-memory 2g \</span><br><span class="line">  --executor-cores 2 \</span><br><span class="line">  --num-executors 8 \</span><br><span class="line">  --conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">  --conf spark.dynamicAllocation.minExecutors=32 \</span><br><span class="line">  --conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">  --conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line">  --files "$&#123;HIVE_SITE_PATH&#125;" \</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;yyyy_mm_dd_hh&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;merge_hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DB_BIGDATA&#125;</span>.<span class="variable">$&#123;zone_abtest_tk_table&#125;</span>"</span> <span class="string">"dt='<span class="variable">$&#123;zone_yyyy&#125;</span>-<span class="variable">$&#123;zone_mm&#125;</span>-<span class="variable">$&#123;zone_dd&#125;</span>', dimen='<span class="variable">$&#123;tk_dimen&#125;</span>'"</span> <span class="string">"overwrite"</span></span></span><br><span class="line"></span><br><span class="line">source ./export_tk_util.sh</span><br><span class="line"></span><br><span class="line">export_abtest_tk_func "$&#123;DB_BIGDATA&#125;.$&#123;zone_abtest_tk_table&#125;" " dt='$&#123;zone_yyyy&#125;-$&#123;zone_mm&#125;-$&#123;zone_dd&#125;' and dimen='$&#123;tk_dimen&#125;' and traffic_group_id&gt;0" "$&#123;zone_gp_abtest_tk_table&#125;" "date_time=$&#123;zone_yyyy&#125;$&#123;zone_mm&#125;$&#123;zone_dd&#125; and add_timestamp&lt;$&#123;gp_delete_timeStamp&#125; and source_type not in (2)"</span><br></pre></td></tr></table></figure>

<ol>
<li>把数据传递进到spark脚本中，在spark中把数据进行分裂，然后存放在对应的<code>dimen = &#39;100&#39;</code></li>
<li>从表中的<code>dimen = &#39;100&#39;</code>中提取数据，把数据的维度再次缩小</li>
</ol>
<p>spark代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">object ParseAndSpiltAbtestTkJob &#123;</span><br><span class="line">  def main(args: Array[String]): Unit &#x3D; &#123;</span><br><span class="line">    val tmpPath &#x3D; parseArg(args(0))</span><br><span class="line">    &#x2F;&#x2F;format:yyyy-mm-dd-hh</span><br><span class="line">    val dt &#x3D; args(1)</span><br><span class="line">    val selectSql &#x3D; parseArg(args(2))</span><br><span class="line">    val abtestField &#x3D; args(3)</span><br><span class="line">    val trafficGroupField &#x3D; args(4)</span><br><span class="line">    val outputTable &#x3D; parseArg(args(5))</span><br><span class="line">    val partition &#x3D; args(6)</span><br><span class="line">    var trafficGroupFieldRaw &#x3D; &quot;&amp;&amp;&quot;</span><br><span class="line">    var trafficGroupFieldNew &#x3D; &quot;&quot;</span><br><span class="line">    if (args.length &gt;&#x3D; 8) &#123;</span><br><span class="line">      trafficGroupFieldRaw &#x3D; args(7)</span><br><span class="line">    &#125;</span><br><span class="line">    if (args.length &gt;&#x3D; 9) &#123;</span><br><span class="line">      trafficGroupFieldNew &#x3D; args(8)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    val sparkSession: SparkSession &#x3D; SparkSession.builder</span><br><span class="line">      &#x2F;&#x2F;      .master(&quot;local[3]&quot;)</span><br><span class="line">      .enableHiveSupport() &#x2F;&#x2F; self-explanatory, isn&#39;t it?</span><br><span class="line">      .config(&quot;spark.sql.warehouse.dir&quot;, tmpPath)</span><br><span class="line">      .getOrCreate</span><br><span class="line"></span><br><span class="line">    sparkSession.sqlContext.setConf(&quot;hive.merge.mapfiles&quot;, &quot;true&quot;)</span><br><span class="line">    sparkSession.sqlContext.setConf(&quot;mapred.max.split.size&quot;, &quot;256000000&quot;)</span><br><span class="line">    sparkSession.sqlContext.setConf(&quot;mapred.min.split.size.per.node&quot;, &quot;192000000&quot;)</span><br><span class="line">    sparkSession.sqlContext.setConf(&quot;mapred.min.split.size.per.rack&quot;, &quot;192000000&quot;)</span><br><span class="line">    sparkSession.sqlContext.setConf(&quot;hive.input.format&quot;, &quot;org.apache.hadoop.hive.ql.io.CombineHiveInputFormat&quot;)</span><br><span class="line"></span><br><span class="line">    val rawData &#x3D; sparkSession.sql(selectSql)</span><br><span class="line">    val newRdd: RDD[Row] &#x3D; rawData.rdd.map(row &#x3D;&gt; &#123;</span><br><span class="line">      &#x2F;&#x2F;        System.out.println(&quot;--------------------------------------&quot;, row.toString())</span><br><span class="line">      var resultList: ArrayBuffer[Row] &#x3D; new ArrayBuffer[Row]()</span><br><span class="line">      val tkRows &#x3D; mapSpiltFunc(row, abtestField, trafficGroupField, trafficGroupFieldRaw, trafficGroupFieldNew)</span><br><span class="line">      if (tkRows !&#x3D; null &amp;&amp; tkRows.nonEmpty) &#123;</span><br><span class="line">        resultList ++&#x3D; tkRows</span><br><span class="line">      &#125;</span><br><span class="line">      resultList</span><br><span class="line">    &#125;).flatMap(row &#x3D;&gt; row)</span><br><span class="line">    &#x2F;&#x2F;通过时间戳随机表名</span><br><span class="line">    val time &#x3D; System.currentTimeMillis() % 100000000;</span><br><span class="line">    val tmpTable &#x3D; &quot;spark_CommonSparkDateTimeJob_&quot; + time + &quot;_table&quot;</span><br><span class="line">    sparkSession.createDataFrame(newRdd, rawData.schema).registerTempTable(tmpTable)</span><br><span class="line">    val insertString &#x3D; &quot;insert overwrite table &quot; + outputTable + &quot; partition(&quot; + partition + &quot;) select * from &quot; + tmpTable</span><br><span class="line">    sparkSession.sql(insertString)</span><br><span class="line">    sparkSession.stop()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  def parseArg(arg: String): String &#x3D; &#123;</span><br><span class="line">    var tmpArg &#x3D; arg</span><br><span class="line">    if (tmpArg.startsWith(&quot;&#39;&quot;)) &#123;</span><br><span class="line">      tmpArg &#x3D; tmpArg.substring(1);</span><br><span class="line">    &#125;</span><br><span class="line">    if (tmpArg.endsWith(&quot;&#39;&quot;)) &#123;</span><br><span class="line">      tmpArg &#x3D; tmpArg.substring(0, tmpArg.length() - 1);</span><br><span class="line">    &#125;</span><br><span class="line">    tmpArg;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  def mapSpiltFunc(row: Row, abtestField: String, trafficGroupField: String, trafficGroupFieldRaw: String, trafficGroupFieldNew: String): ArrayBuffer[Row] &#x3D; &#123;</span><br><span class="line">    var resultList: ArrayBuffer[Row] &#x3D; new ArrayBuffer[Row]()</span><br><span class="line">    val abtest &#x3D; row.getAs[String](abtestField)</span><br><span class="line">    val rowRawArray &#x3D; row.toSeq.toArray</span><br><span class="line">    val trafficGroupIndex &#x3D; row.fieldIndex(trafficGroupField)</span><br><span class="line">    val abtestGroupIndex &#x3D; row.fieldIndex(abtestField)</span><br><span class="line">    val curtGroupId &#x3D; row.getAs[String](trafficGroupField)</span><br><span class="line"></span><br><span class="line">    if (!TextUtils.isEmpty(curtGroupId) &amp;&amp; curtGroupId &gt; &quot;0&quot;) &#123;</span><br><span class="line">      val newCurGroupRow &#x3D; rowRawArray.clone()</span><br><span class="line">      if (trafficGroupFieldRaw.isEmpty) &#123;</span><br><span class="line">        newCurGroupRow(abtestGroupIndex) &#x3D; &quot;&amp;&amp;&quot;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        newCurGroupRow(abtestGroupIndex) &#x3D; trafficGroupFieldRaw;</span><br><span class="line">      &#125;</span><br><span class="line">      resultList +&#x3D; Row.fromSeq(newCurGroupRow)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (TextUtils.isEmpty(abtest) || abtest.equals(&quot;&#123;&#125;&quot;)) &#123;</span><br><span class="line">      return resultList</span><br><span class="line">    &#125;</span><br><span class="line">    val tGroupIDs &#x3D; AbtestTkParsing.getTrafficGroupIDs(abtest)</span><br><span class="line">    for (groupId &lt;- tGroupIDs) &#123;</span><br><span class="line">      if (!groupId.equals(curtGroupId)) &#123;</span><br><span class="line">        val newGroupRow &#x3D; rowRawArray.clone()</span><br><span class="line">        if (trafficGroupFieldNew.nonEmpty) &#123;</span><br><span class="line">          newGroupRow(abtestGroupIndex) &#x3D; trafficGroupFieldNew</span><br><span class="line">        &#125;</span><br><span class="line">        newGroupRow(trafficGroupIndex) &#x3D; groupId;</span><br><span class="line">        resultList +&#x3D; Row.fromSeq(newGroupRow)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    resultList</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<p>至此，一个基本的<code>小时任务</code>的大数据ETL服务就做完了该作的事情了</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/大数据/">大数据</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/大数据/">大数据</a><a href="/tags/公司/">公司</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2023 白菜(whiteCcinn)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>