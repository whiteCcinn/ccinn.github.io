<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>大数据任务-重分配任务 | 白菜君の技术库</title>

  
  <meta name="author" content="白菜(whiteCcinn)">
  

  
  <meta name="description" content="知道做不到，等于不知道">
  

  
  <meta name="keywords" content="白菜,文辉,技术博客,whiteCcinn">
  

  <meta id="viewport" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <meta property="og:title" content="大数据任务-重分配任务"/>

  <meta property="og:site_name" content="白菜君の技术库"/>

  
  <meta property="og:image" content="/favicon.ico"/>
  

  <link href="/favicon.ico" rel="icon">
  <link rel="alternate" href="/atom.xml" title="白菜君の技术库" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
<div class="blog">
  <div class="content">

    <header>
  <div class="site-branding">
    <h1 class="site-title">
      <a href="/">白菜君の技术库</a>
    </h1>
    <p class="site-description"></p>
  </div>
  <nav class="site-navigation">
    <ul>
      
        <li><a href="/">主页</a></li>
      
        <li><a href="/archives/">文章</a></li>
      
        <li><a href="/tags/">标签</a></li>
      
        <li><a href="/categories/">分类</a></li>
      
        <li><a href="/about/">关于我</a></li>
      
    </ul>
  </nav>
</header>

    <main class="site-main posts-loop">
    <article>

  
    
    <h3 class="article-title"><span>大数据任务-重分配任务</span></h3>
    
  

  <div class="article-top-meta">
    <span class="posted-on">
      <a href="/2022/05/27/公司/大数据-重分配任务/" rel="bookmark">
        <time class="entry-date published" datetime="2022-05-27T10:52:40.000Z">
          2022-05-27
        </time>
      </a>
    </span>
  </div>


  

  <div class="article-content">
    <div class="entry">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>总结一下公司大数据的任务ETL离线工作流 - 重分配任务</p>
<a id="more"></a>

<p>公司的ETL服务，目前采用的是组件为：</p>
<ul>
<li>数仓 (hadoop)</li>
<li>任务调度器 (azkaban)</li>
<li>出仓 (gp)</li>
<li>数仓查询 (hue)(hive)(spark)</li>
</ul>
<h2 id="job-tk-reassign（重分配任务）"><a href="#job-tk-reassign（重分配任务）" class="headerlink" title="job_tk_reassign（重分配任务）"></a>job_tk_reassign（重分配任务）</h2><ul>
<li>schedule: <code>30 10 * * *</code></li>
</ul>
<blockquote>
<p>按 <code>天</code> 为一个周期</p>
</blockquote>
<p>天级指标：</p>
<ul>
<li><code>isready</code></li>
<li><code>isready_success</code></li>
<li><code>showfailed</code></li>
</ul>
<p>所以在查看报表数据的时候，这3个指标是<code>天级</code>的。</p>
<p>除了上面所说的，代码也包含了<code>source_type = 2</code>，即实时的数据。但是目前来说，已经没有<code>source_type=2</code>的数据了，主要是业务导向。</p>
<p><img src="/images/%E5%85%AC%E5%8F%B8/tk_reassign.png" alt="重分配任务"></p>
<h3 id="sync-mysql-unit-and-placement"><a href="#sync-mysql-unit-and-placement" class="headerlink" title="sync_mysql_unit_and_placement"></a>sync_mysql_unit_and_placement</h3><blockquote>
<p>拉取最新的广告位数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">stat_source='placement'</span><br><span class="line"></span><br><span class="line">tmpfilename="tmp/uparpu_mysql_placement.log"</span><br><span class="line"></span><br><span class="line">mkdir -p tmp</span><br><span class="line"></span><br><span class="line">if [ -f "$&#123;tmpfilename&#125;" ]; then</span><br><span class="line"></span><br><span class="line">  rm -f $&#123;tmpfilename&#125;</span><br><span class="line">  echo "delete $&#123;tmpfilename&#125;"</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">mysql -u$&#123;DB_USER&#125; -P$&#123;DB_PORT&#125; -p$&#123;DB_PWD&#125; -h$&#123;DB_HOST&#125; -e "</span><br><span class="line">    select </span><br><span class="line">        id,</span><br><span class="line">        uuid,        </span><br><span class="line">        publisher_id,</span><br><span class="line">        app_id,      </span><br><span class="line">        name,        </span><br><span class="line">        format,      </span><br><span class="line">        remark,      </span><br><span class="line">        create_time, </span><br><span class="line">        update_time </span><br><span class="line">    from </span><br><span class="line">        $&#123;DB_NAME&#125;.$&#123;stat_source&#125;</span><br><span class="line">    ;</span><br><span class="line">" --skip-column-names | sed 's/\t/|/g' &gt;$&#123;tmpfilename&#125;</span><br><span class="line"></span><br><span class="line">if [ -f "$&#123;tmpfilename&#125;" ]; then</span><br><span class="line"></span><br><span class="line">  target="$&#123;HIVE_DB_PATH&#125;/$&#123;T_UPARPU_PLACEMENT&#125;/yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;/"</span><br><span class="line"></span><br><span class="line">  hadoop fs -rm -r $&#123;target&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;FILE_COMMAND_CP&#125; <span class="variable">$&#123;tmpfilename&#125;</span> <span class="variable">$&#123;target&#125;</span></span></span><br><span class="line"></span><br><span class="line">  hive -e "</span><br><span class="line">        use $&#123;DB_UPARPU&#125;;</span><br><span class="line">        alter table $&#123;T_UPARPU_PLACEMENT&#125; drop partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;');</span><br><span class="line">        alter table $&#123;T_UPARPU_PLACEMENT&#125; add partition (yyyy='$&#123;yyyy&#125;',mm='$&#123;mm&#125;',dd='$&#123;dd&#125;') location 'yyyy=$&#123;yyyy&#125;/mm=$&#123;mm&#125;/dd=$&#123;dd&#125;';</span><br><span class="line">    "</span><br><span class="line"></span><br><span class="line">  echo "sync $&#123;tmpfilename&#125; to $&#123;target&#125;"</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<ol>
<li>从mysql把出最新的广告位数据，然后同步到对应的hive表中</li>
</ol>
<h3 id="merge-isready"><a href="#merge-isready" class="headerlink" title="merge_isready"></a>merge_isready</h3><blockquote>
<p>统计isready的数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">清洗isready数据，写入report_tk,dt&amp;dimen=15</span></span><br><span class="line">hourGap=0</span><br><span class="line">date_time_timeStamp=$(date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00" +%s)</span><br><span class="line">next_date_time_timeStamp=$(expr $&#123;date_time_timeStamp&#125; + 86400)</span><br><span class="line">next_date_time=$(date -d @$&#123;next_date_time_timeStamp&#125; "+%Y-%m-%d")</span><br><span class="line"></span><br><span class="line">where_dt="dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;'"</span><br><span class="line">if [[ $&#123;run_type&#125; = 'utc0' ]]; then</span><br><span class="line">  hourGap=8</span><br><span class="line">  where_dt="dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')"</span><br><span class="line">else</span><br><span class="line">  if [[ $&#123;run_type&#125; = 'utcw8' ]]; then</span><br><span class="line">    hourGap=16</span><br><span class="line">    where_dt="dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')"</span><br><span class="line">  else</span><br><span class="line">    hourGap=0</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">转换成utc8时间</span></span><br><span class="line">day_start_timeStamp=$(date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00" +%s)</span><br><span class="line">day_end_timeStamp=$(date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 23:00:00" +%s)</span><br><span class="line">while_run_stamp=$&#123;day_start_timeStamp&#125;</span><br><span class="line">where_hour='('</span><br><span class="line"></span><br><span class="line">while [ "$&#123;while_run_stamp&#125;" -le "$&#123;day_end_timeStamp&#125;" ]; do</span><br><span class="line">  tmp_run_stamp=$(expr $&#123;while_run_stamp&#125; + $&#123;hourGap&#125; \* 3600)</span><br><span class="line">  tmp_date_time=$(date -d @$&#123;tmp_run_stamp&#125; "+%Y-%m-%d-%H")</span><br><span class="line">  tmp_yyyy=$(echo $&#123;tmp_date_time&#125; | awk -F- '&#123;print $1&#125;')</span><br><span class="line">  tmp_mm=$(echo $&#123;tmp_date_time&#125; | awk -F- '&#123;print $2&#125;')</span><br><span class="line">  tmp_dd=$(echo $&#123;tmp_date_time&#125; | awk -F- '&#123;print $3&#125;')</span><br><span class="line">  tmp_hh=$(echo $&#123;tmp_date_time&#125; | awk -F- '&#123;print $4&#125;')</span><br><span class="line">  if [ "$&#123;while_run_stamp&#125;" == "$&#123;day_start_timeStamp&#125;" ]; then</span><br><span class="line">    where_hour="$&#123;where_hour&#125;dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'"</span><br><span class="line">  else</span><br><span class="line">    where_hour="$&#123;where_hour&#125; or dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'"</span><br><span class="line">  fi</span><br><span class="line">  while_run_stamp=$(expr $&#123;while_run_stamp&#125; + 3600)</span><br><span class="line">done</span><br><span class="line">where_hour="$&#123;where_hour&#125;)"</span><br><span class="line"></span><br><span class="line">hql="</span><br><span class="line">      select</span><br><span class="line">          '$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;',</span><br><span class="line">          case  when (c.nw_firm_id is null) then '0' else c.nw_firm_id end,</span><br><span class="line">          case  when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end,</span><br><span class="line">          case c.nw_firm_id when '35' then '1' else case  when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end,</span><br><span class="line">          1,</span><br><span class="line">          a.sdk_version,</span><br><span class="line">          a.app_vn,</span><br><span class="line">          a.os_platform,</span><br><span class="line">          a.geo_short,</span><br><span class="line">          a.publisher_id,</span><br><span class="line">          a.app_raw_id,</span><br><span class="line">          b.id,</span><br><span class="line">          b.format,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case  when (a.channel is null) then '' else a.channel end,</span><br><span class="line">          case  when (a.sub_channel is null) then '' else a.sub_channel end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case  when (c.network_id is null) then '0' else c.network_id end,</span><br><span class="line">          case  when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          1,</span><br><span class="line">          0,</span><br><span class="line">          '',</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case when (a.is_cn_sdk is null or  cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end,</span><br><span class="line">          cast(sum(case  when (a.key_count is null or a.key_count='') then 0 else a.key_count end) as bigint),</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case when device_type is null then 1 else device_type end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case when abtest_id is null then '' else abtest_id end,</span><br><span class="line">          0</span><br><span class="line">      from </span><br><span class="line">          (</span><br><span class="line">            select </span><br><span class="line">                  nw_firm_id,</span><br><span class="line">                  group_id,</span><br><span class="line">                  unit_id,</span><br><span class="line">                  placement_id,</span><br><span class="line">                  sdk_version,</span><br><span class="line">                  app_vn,</span><br><span class="line">                  os_platform,</span><br><span class="line">                  geo_short,</span><br><span class="line">                  publisher_id,</span><br><span class="line">                  app_raw_id,</span><br><span class="line">                  channel,</span><br><span class="line">                  sub_channel,</span><br><span class="line">                  traffic_group_id,</span><br><span class="line">                  is_cn_sdk,</span><br><span class="line">                  device_type,</span><br><span class="line">                  abtest_id,</span><br><span class="line">                  cast(sum(case  when (key_count is null or key_count='') then 0 else key_count end) as bigint) key_count</span><br><span class="line">            from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_EVENT_ANALYSIS_COUNT&#125;</span><br><span class="line">            where</span><br><span class="line">                 $&#123;where_dt&#125;</span><br><span class="line">                 and key='1004632'</span><br><span class="line">                 and $&#123;where_hour&#125;</span><br><span class="line">                 $&#123;whereInPublisherList&#125;</span><br><span class="line">            group by </span><br><span class="line">                  nw_firm_id,</span><br><span class="line">                  group_id,</span><br><span class="line">                  unit_id,</span><br><span class="line">                  placement_id,</span><br><span class="line">                  sdk_version,</span><br><span class="line">                  app_vn,</span><br><span class="line">                  os_platform,</span><br><span class="line">                  geo_short,</span><br><span class="line">                  publisher_id,</span><br><span class="line">                  app_raw_id,</span><br><span class="line">                  channel,</span><br><span class="line">                  sub_channel,</span><br><span class="line">                  traffic_group_id,</span><br><span class="line">                  is_cn_sdk,</span><br><span class="line">                  device_type,</span><br><span class="line">                  abtest_id</span><br><span class="line">          ) as a</span><br><span class="line">      left outer join</span><br><span class="line">          (</span><br><span class="line">                select id,uuid,app_id,format</span><br><span class="line">                from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_PLACEMENT&#125;</span><br><span class="line">                where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125;</span><br><span class="line">                group by id,uuid,app_id,format</span><br><span class="line">          ) as b</span><br><span class="line">      on </span><br><span class="line">          a.placement_id=b.uuid and a.app_raw_id=b.app_id</span><br><span class="line">      left outer join</span><br><span class="line">          (</span><br><span class="line">                select id,network_id,nw_firm_id</span><br><span class="line">                from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_UNIT&#125;</span><br><span class="line">                where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125;</span><br><span class="line">          ) as c</span><br><span class="line">      on </span><br><span class="line">          a.unit_id=c.id</span><br><span class="line">      where</span><br><span class="line">         cast(a.group_id as bigint)&lt;=2147483647</span><br><span class="line">         and b.uuid is not null</span><br><span class="line">      group by </span><br><span class="line">          case  when (c.nw_firm_id is null) then '0' else c.nw_firm_id end,</span><br><span class="line">          case  when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end,</span><br><span class="line">          case c.nw_firm_id when '35' then '1' else case  when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end,</span><br><span class="line">          a.sdk_version,</span><br><span class="line">          a.app_vn,</span><br><span class="line">          a.os_platform,</span><br><span class="line">          a.geo_short,</span><br><span class="line">          a.publisher_id,</span><br><span class="line">          a.app_raw_id,</span><br><span class="line">          b.id,</span><br><span class="line">          b.format,</span><br><span class="line">          case  when (a.channel is null) then '' else a.channel end,</span><br><span class="line">          case  when (a.sub_channel is null) then '' else a.sub_channel end,</span><br><span class="line">          case  when (c.network_id is null) then '0' else c.network_id end,</span><br><span class="line">          case  when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end,</span><br><span class="line">          case when (a.is_cn_sdk is null or  cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end,</span><br><span class="line">          case when device_type is null then 1 else device_type end,</span><br><span class="line">          case when abtest_id is null then '' else abtest_id end</span><br><span class="line">"</span><br><span class="line"></span><br><span class="line">spark-submit --class com.topon.spark.jobs.common.CommonSparkDateTimeJob \</span><br><span class="line">  --name "TopOn_CommonSparkDateTimeJob_report_isready_dt$&#123;yyyy_mm_dd&#125;" \</span><br><span class="line">  --master yarn \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --executor-memory "$&#123;SPARK_EXECUTOR_MEMORY&#125;" \</span><br><span class="line">  --driver-memory "$&#123;SPARK_DRIVER_MEMORY&#125;" \</span><br><span class="line">  --executor-cores 2 \</span><br><span class="line">  --num-executors "$&#123;SPARK_NUM_EXECUTORS&#125;" \</span><br><span class="line">  --conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">  --conf spark.dynamicAllocation.minExecutors=32 \</span><br><span class="line">  --conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">  --conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;yyyy_mm_dd&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DB_UPARPU&#125;</span>.<span class="variable">$&#123;T_RUN_REASSIGN_REPORT_TK&#125;</span>"</span> <span class="string">"dt='<span class="variable">$&#123;ymd&#125;</span>', dimen='15'"</span> <span class="string">"overwrite"</span></span></span><br></pre></td></tr></table></figure>

<ol>
<li><code>key=&#39;1004632&#39;</code> 的数据为<code>isready</code>的数据</li>
<li>由于原始数据已经有统计，所以<code>sum(key_count)</code>的总和就是<code>isready</code>的<code>对应维度</code>的总数</li>
<li>数据写入到 <code>dimen = &#39;15&#39;</code> 的分区</li>
</ol>
<h3 id="merge-isready-success"><a href="#merge-isready-success" class="headerlink" title="merge_isready_success"></a>merge_isready_success</h3><blockquote>
<p>统计isready_success的数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">清洗isready_success数据，写入report_tk,dt&amp;dimen=16</span></span><br><span class="line">hourGap=0</span><br><span class="line">date_time_timeStamp=`date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00" +%s`</span><br><span class="line">next_date_time_timeStamp=`expr $&#123;date_time_timeStamp&#125; + 86400`</span><br><span class="line">next_date_time=`date -d @$&#123;next_date_time_timeStamp&#125; "+%Y-%m-%d"`</span><br><span class="line"></span><br><span class="line">where_dt="dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;'"</span><br><span class="line">if [[ $&#123;run_type&#125; = 'utc0' ]]</span><br><span class="line">  then</span><br><span class="line">     hourGap=8</span><br><span class="line">     where_dt="dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')"</span><br><span class="line">  else</span><br><span class="line">      if [[ $&#123;run_type&#125; = 'utcw8' ]] </span><br><span class="line">      then</span><br><span class="line">          hourGap=16</span><br><span class="line">          where_dt="dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')"</span><br><span class="line">      else</span><br><span class="line">          hourGap=0</span><br><span class="line">      fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">转换成utc8时间</span></span><br><span class="line">day_start_timeStamp=`date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00" +%s`</span><br><span class="line">day_end_timeStamp=`date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 23:00:00" +%s`</span><br><span class="line">while_run_stamp=$&#123;day_start_timeStamp&#125;</span><br><span class="line">where_hour='('</span><br><span class="line"></span><br><span class="line">while [ "$&#123;while_run_stamp&#125;" -le "$&#123;day_end_timeStamp&#125;" ]</span><br><span class="line">do</span><br><span class="line">      tmp_run_stamp=`expr $&#123;while_run_stamp&#125; + $&#123;hourGap&#125; \* 3600`</span><br><span class="line">      tmp_date_time=`date -d @$&#123;tmp_run_stamp&#125; "+%Y-%m-%d-%H"`</span><br><span class="line">      tmp_yyyy=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $1&#125;'`</span><br><span class="line">      tmp_mm=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $2&#125;'`</span><br><span class="line">      tmp_dd=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $3&#125;'`</span><br><span class="line">      tmp_hh=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $4&#125;'`</span><br><span class="line">      if [ "$&#123;while_run_stamp&#125;" == "$&#123;day_start_timeStamp&#125;" ]</span><br><span class="line">        then</span><br><span class="line">           where_hour="$&#123;where_hour&#125;dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'"</span><br><span class="line">        else</span><br><span class="line">           where_hour="$&#123;where_hour&#125; or dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'"</span><br><span class="line">        fi</span><br><span class="line">        while_run_stamp=`expr $&#123;while_run_stamp&#125; + 3600`</span><br><span class="line">done</span><br><span class="line">where_hour="$&#123;where_hour&#125;)"</span><br><span class="line"></span><br><span class="line">hql="</span><br><span class="line">      select</span><br><span class="line">          '$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;',</span><br><span class="line">          case  when (c.nw_firm_id is null) then '0' else c.nw_firm_id end,</span><br><span class="line">          case  when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end,</span><br><span class="line">          case c.nw_firm_id when '35' then '1' else case  when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end,</span><br><span class="line">          1,</span><br><span class="line">          a.sdk_version,</span><br><span class="line">          a.app_vn,</span><br><span class="line">          a.os_platform,</span><br><span class="line">          a.geo_short,</span><br><span class="line">          a.publisher_id,</span><br><span class="line">          a.app_raw_id,</span><br><span class="line">          b.id,</span><br><span class="line">          b.format,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case  when (a.channel is null) then '' else a.channel end,</span><br><span class="line">          case  when (a.sub_channel is null) then '' else a.sub_channel end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case  when (c.network_id is null) then '0' else c.network_id end,</span><br><span class="line">          case  when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          1,</span><br><span class="line">          0,</span><br><span class="line">          '',</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case when (a.is_cn_sdk is null or  cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end,</span><br><span class="line">          0,</span><br><span class="line">          cast(sum(case  when (a.key_count is null or a.key_count='') then 0 else a.key_count end) as bigint),</span><br><span class="line">          0,</span><br><span class="line">          case when device_type is null then 1 else device_type end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case when abtest_id is null then '' else abtest_id end,</span><br><span class="line">          0</span><br><span class="line">      from </span><br><span class="line">          (</span><br><span class="line">            select </span><br><span class="line">                  nw_firm_id,</span><br><span class="line">                  group_id,</span><br><span class="line">                  unit_id,</span><br><span class="line">                  placement_id,</span><br><span class="line">                  sdk_version,</span><br><span class="line">                  app_vn,</span><br><span class="line">                  os_platform,</span><br><span class="line">                  geo_short,</span><br><span class="line">                  publisher_id,</span><br><span class="line">                  app_raw_id,</span><br><span class="line">                  channel,</span><br><span class="line">                  sub_channel,</span><br><span class="line">                  traffic_group_id,</span><br><span class="line">                  is_cn_sdk,</span><br><span class="line">                  device_type,</span><br><span class="line">                  abtest_id,</span><br><span class="line">                  cast(sum(case  when (key_count is null or key_count='') then 0 else key_count end) as bigint) key_count</span><br><span class="line">            from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_EVENT_ANALYSIS_COUNT&#125;</span><br><span class="line">            where</span><br><span class="line">                 $&#123;where_dt&#125;</span><br><span class="line">                 and key='1004632'</span><br><span class="line">                 and extra3='1'</span><br><span class="line">                 and $&#123;where_hour&#125;</span><br><span class="line">                 $&#123;whereInPublisherList&#125;</span><br><span class="line">            group by </span><br><span class="line">                  nw_firm_id,</span><br><span class="line">                  group_id,</span><br><span class="line">                  unit_id,</span><br><span class="line">                  placement_id,</span><br><span class="line">                  sdk_version,</span><br><span class="line">                  app_vn,</span><br><span class="line">                  os_platform,</span><br><span class="line">                  geo_short,</span><br><span class="line">                  publisher_id,</span><br><span class="line">                  app_raw_id,</span><br><span class="line">                  channel,</span><br><span class="line">                  sub_channel,</span><br><span class="line">                  traffic_group_id,</span><br><span class="line">                  is_cn_sdk,</span><br><span class="line">                  device_type,</span><br><span class="line">                  abtest_id</span><br><span class="line">          ) as a</span><br><span class="line">      left outer join</span><br><span class="line">          (</span><br><span class="line">                select id,uuid,app_id,format</span><br><span class="line">                from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_PLACEMENT&#125;</span><br><span class="line">                where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125;</span><br><span class="line">                group by id,uuid,app_id,format</span><br><span class="line">          ) as b</span><br><span class="line">      on </span><br><span class="line">          a.placement_id=b.uuid and a.app_raw_id=b.app_id</span><br><span class="line">      left outer join</span><br><span class="line">          (</span><br><span class="line">                select id,network_id,nw_firm_id</span><br><span class="line">                from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_UNIT&#125;</span><br><span class="line">                where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125;</span><br><span class="line">          ) as c</span><br><span class="line">      on </span><br><span class="line">          a.unit_id=c.id</span><br><span class="line">      where</span><br><span class="line">         cast(a.group_id as bigint)&lt;=2147483647</span><br><span class="line">         and b.uuid is not null</span><br><span class="line">      group by </span><br><span class="line">          case  when (c.nw_firm_id is null) then '0' else c.nw_firm_id end,</span><br><span class="line">          case  when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end,</span><br><span class="line">          case c.nw_firm_id when '35' then '1' else case  when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end,</span><br><span class="line">          a.sdk_version,</span><br><span class="line">          a.app_vn,</span><br><span class="line">          a.os_platform,</span><br><span class="line">          a.geo_short,</span><br><span class="line">          a.publisher_id,</span><br><span class="line">          a.app_raw_id,</span><br><span class="line">          b.id,</span><br><span class="line">          b.format,</span><br><span class="line">          case  when (a.channel is null) then '' else a.channel end,</span><br><span class="line">          case  when (a.sub_channel is null) then '' else a.sub_channel end,</span><br><span class="line">          case  when (c.network_id is null) then '0' else c.network_id end,</span><br><span class="line">          case  when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end,</span><br><span class="line">          case when (a.is_cn_sdk is null or  cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end,</span><br><span class="line">          case when device_type is null then 1 else device_type end,</span><br><span class="line">          case when abtest_id is null then '' else abtest_id end</span><br><span class="line">"</span><br><span class="line"></span><br><span class="line">spark-submit --class com.topon.spark.jobs.common.CommonSparkDateTimeJob \</span><br><span class="line">  --name "TopOn_CommonSparkDateTimeJob_report_isready_success_dt$&#123;yyyy_mm_dd&#125;" \</span><br><span class="line">  --master yarn \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --executor-memory "$&#123;SPARK_EXECUTOR_MEMORY&#125;" \</span><br><span class="line">  --driver-memory "$&#123;SPARK_DRIVER_MEMORY&#125;" \</span><br><span class="line">  --executor-cores 2 \</span><br><span class="line">  --num-executors "$&#123;SPARK_NUM_EXECUTORS&#125;" \</span><br><span class="line">  --conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">  --conf spark.dynamicAllocation.minExecutors=32 \</span><br><span class="line">  --conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">  --conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;yyyy_mm_dd&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DB_UPARPU&#125;</span>.<span class="variable">$&#123;T_RUN_REASSIGN_REPORT_TK&#125;</span>"</span> <span class="string">"dt='<span class="variable">$&#123;ymd&#125;</span>', dimen='16'"</span> <span class="string">"overwrite"</span></span></span><br></pre></td></tr></table></figure>

<ol>
<li><code>key=&#39;1004632&#39; and extra3=&#39;1&#39;</code> 代表 isready 下，并且相应成功的数据</li>
<li>由于原始数据已经有统计，所以<code>sum(key_count)</code>的总和就是<code>isready_success</code>的<code>对应维度</code>的总数</li>
<li>写入到 <code>dimen = &#39;16&#39;</code> 的分区</li>
</ol>
<h3 id="merge-showfailed"><a href="#merge-showfailed" class="headerlink" title="merge_showfailed"></a>merge_showfailed</h3><blockquote>
<p>统计广告展示失败</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">清洗isready数据，写入report_tk,dt&amp;dimen=15</span></span><br><span class="line">hourGap=0</span><br><span class="line">date_time_timeStamp=`date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00" +%s`</span><br><span class="line">next_date_time_timeStamp=`expr $&#123;date_time_timeStamp&#125; + 86400`</span><br><span class="line">next_date_time=`date -d @$&#123;next_date_time_timeStamp&#125; "+%Y-%m-%d"`</span><br><span class="line"></span><br><span class="line">where_dt="dt='$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;'"</span><br><span class="line">if [[ $&#123;run_type&#125; = 'utc0' ]]</span><br><span class="line">  then</span><br><span class="line">     hourGap=8</span><br><span class="line">     where_dt="dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')"</span><br><span class="line">  else</span><br><span class="line">      if [[ $&#123;run_type&#125; = 'utcw8' ]] </span><br><span class="line">      then</span><br><span class="line">          hourGap=16</span><br><span class="line">          where_dt="dt in ('$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125;','$&#123;next_date_time&#125;')"</span><br><span class="line">      else</span><br><span class="line">          hourGap=0</span><br><span class="line">      fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">转换成utc8时间</span></span><br><span class="line">day_start_timeStamp=`date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 00:00:00" +%s`</span><br><span class="line">day_end_timeStamp=`date -d "$&#123;yyyy&#125;-$&#123;mm&#125;-$&#123;dd&#125; 23:00:00" +%s`</span><br><span class="line">while_run_stamp=$&#123;day_start_timeStamp&#125;</span><br><span class="line">where_hour='('</span><br><span class="line"></span><br><span class="line">while [ "$&#123;while_run_stamp&#125;" -le "$&#123;day_end_timeStamp&#125;" ]</span><br><span class="line">do</span><br><span class="line">      tmp_run_stamp=`expr $&#123;while_run_stamp&#125; + $&#123;hourGap&#125; \* 3600`</span><br><span class="line">      tmp_date_time=`date -d @$&#123;tmp_run_stamp&#125; "+%Y-%m-%d-%H"`</span><br><span class="line">      tmp_yyyy=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $1&#125;'`</span><br><span class="line">      tmp_mm=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $2&#125;'`</span><br><span class="line">      tmp_dd=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $3&#125;'`</span><br><span class="line">      tmp_hh=`echo $&#123;tmp_date_time&#125;|awk -F- '&#123;print $4&#125;'`</span><br><span class="line">      if [ "$&#123;while_run_stamp&#125;" == "$&#123;day_start_timeStamp&#125;" ]</span><br><span class="line">        then</span><br><span class="line">           where_hour="$&#123;where_hour&#125;dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'"</span><br><span class="line">        else</span><br><span class="line">           where_hour="$&#123;where_hour&#125; or dt='$&#123;tmp_yyyy&#125;-$&#123;tmp_mm&#125;-$&#123;tmp_dd&#125;' and hour='$&#123;tmp_hh&#125;'"</span><br><span class="line">        fi</span><br><span class="line">        while_run_stamp=`expr $&#123;while_run_stamp&#125; + 3600`</span><br><span class="line">done</span><br><span class="line">where_hour="$&#123;where_hour&#125;)"</span><br><span class="line"></span><br><span class="line">hql="</span><br><span class="line">      select</span><br><span class="line">          '$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;',</span><br><span class="line">          case  when (c.nw_firm_id is null) then '0' else c.nw_firm_id end,</span><br><span class="line">          case  when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end,</span><br><span class="line">          case c.nw_firm_id when '35' then '1' else case  when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end,</span><br><span class="line">          1,</span><br><span class="line">          a.sdk_version,</span><br><span class="line">          a.app_vn,</span><br><span class="line">          a.os_platform,</span><br><span class="line">          a.geo_short,</span><br><span class="line">          a.publisher_id,</span><br><span class="line">          a.app_raw_id,</span><br><span class="line">          b.id,</span><br><span class="line">          b.format,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case  when (a.channel is null) then '' else a.channel end,</span><br><span class="line">          case  when (a.sub_channel is null) then '' else a.sub_channel end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case  when (c.network_id is null) then '0' else c.network_id end,</span><br><span class="line">          case  when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          1,</span><br><span class="line">          0,</span><br><span class="line">          '',</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case when (a.is_cn_sdk is null or  cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          cast(sum(case  when (a.key_count is null or a.key_count='') then 0 else a.key_count end) as bigint),</span><br><span class="line">          case when device_type is null then 1 else device_type end,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          0,</span><br><span class="line">          case when abtest_id is null then '' else abtest_id end,</span><br><span class="line">          0</span><br><span class="line">      from </span><br><span class="line">          (</span><br><span class="line">            select </span><br><span class="line">                  group_id,</span><br><span class="line">                  unit_id,</span><br><span class="line">                  placement_id,</span><br><span class="line">                  sdk_version,</span><br><span class="line">                  app_vn,</span><br><span class="line">                  os_platform,</span><br><span class="line">                  geo_short,</span><br><span class="line">                  publisher_id,</span><br><span class="line">                  app_raw_id,</span><br><span class="line">                  channel,</span><br><span class="line">                  sub_channel,</span><br><span class="line">                  traffic_group_id,</span><br><span class="line">                  is_cn_sdk,</span><br><span class="line">                  device_type,</span><br><span class="line">                  abtest_id,</span><br><span class="line">                  cast(sum(case  when (key_count is null or key_count='') then 0 else key_count end) as bigint) key_count</span><br><span class="line">            from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_EVENT_ANALYSIS_COUNT&#125;</span><br><span class="line">            where</span><br><span class="line">                 $&#123;where_dt&#125;</span><br><span class="line">                 and key='1004633'</span><br><span class="line">                 and $&#123;where_hour&#125;</span><br><span class="line">                 $&#123;whereInPublisherList&#125;</span><br><span class="line">            group by </span><br><span class="line">                  group_id,</span><br><span class="line">                  unit_id,</span><br><span class="line">                  placement_id,</span><br><span class="line">                  sdk_version,</span><br><span class="line">                  app_vn,</span><br><span class="line">                  os_platform,</span><br><span class="line">                  geo_short,</span><br><span class="line">                  publisher_id,</span><br><span class="line">                  app_raw_id,</span><br><span class="line">                  channel,</span><br><span class="line">                  sub_channel,</span><br><span class="line">                  traffic_group_id,</span><br><span class="line">                  is_cn_sdk,</span><br><span class="line">                  device_type,</span><br><span class="line">                  abtest_id</span><br><span class="line">          ) as a</span><br><span class="line">      left outer join</span><br><span class="line">          (</span><br><span class="line">                select id,uuid,app_id,format</span><br><span class="line">                from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_PLACEMENT&#125;</span><br><span class="line">                where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125;</span><br><span class="line">                group by id,uuid,app_id,format</span><br><span class="line">          ) as b</span><br><span class="line">      on </span><br><span class="line">          a.placement_id=b.uuid and a.app_raw_id=b.app_id</span><br><span class="line">      left outer join</span><br><span class="line">          (</span><br><span class="line">                select id,network_id,nw_firm_id</span><br><span class="line">                from $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_UNIT&#125;</span><br><span class="line">                where yyyy='$&#123;yyyy&#125;' and mm='$&#123;mm&#125;' and dd='$&#123;dd&#125;' $&#123;whereInPublisherList&#125;</span><br><span class="line">          ) as c</span><br><span class="line">      on </span><br><span class="line">          a.unit_id=c.id</span><br><span class="line">      where</span><br><span class="line">         cast(a.group_id as bigint)&lt;=2147483647</span><br><span class="line">         and b.uuid is not null</span><br><span class="line">      group by </span><br><span class="line">          case  when (c.nw_firm_id is null) then '0' else c.nw_firm_id end,</span><br><span class="line">          case  when (a.group_id is null or a.group_id='' or cast(a.group_id as int) is null) then '0' else a.group_id end,</span><br><span class="line">          case c.nw_firm_id when '35' then '1' else case  when (a.unit_id is null or a.unit_id='' or cast(a.unit_id as int) is null) then '0' else a.unit_id end end,</span><br><span class="line">          a.sdk_version,</span><br><span class="line">          a.app_vn,</span><br><span class="line">          a.os_platform,</span><br><span class="line">          a.geo_short,</span><br><span class="line">          a.publisher_id,</span><br><span class="line">          a.app_raw_id,</span><br><span class="line">          b.id,</span><br><span class="line">          b.format,</span><br><span class="line">          case  when (a.channel is null) then '' else a.channel end,</span><br><span class="line">          case  when (a.sub_channel is null) then '' else a.sub_channel end,</span><br><span class="line">          case  when (c.network_id is null) then '0' else c.network_id end,</span><br><span class="line">          case  when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end,</span><br><span class="line">          case when (a.is_cn_sdk is null or  cast(a.is_cn_sdk as int) is null) then '0' else a.is_cn_sdk end,</span><br><span class="line">          case when device_type is null then 1 else device_type end,</span><br><span class="line">          case when abtest_id is null then '' else abtest_id end</span><br><span class="line">"</span><br><span class="line"></span><br><span class="line">spark-submit --class com.topon.spark.jobs.common.CommonSparkDateTimeJob \</span><br><span class="line">  --name "TopOn_CommonSparkDateTimeJob_report_showfailed_dt$&#123;yyyy_mm_dd&#125;" \</span><br><span class="line">  --master yarn \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --executor-memory "$&#123;SPARK_EXECUTOR_MEMORY&#125;" \</span><br><span class="line">  --driver-memory "$&#123;SPARK_DRIVER_MEMORY&#125;" \</span><br><span class="line">  --executor-cores 2 \</span><br><span class="line">  --num-executors "$&#123;SPARK_NUM_EXECUTORS&#125;" \</span><br><span class="line">  --conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">  --conf spark.dynamicAllocation.minExecutors=32 \</span><br><span class="line">  --conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">  --conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;yyyy_mm_dd&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DB_UPARPU&#125;</span>.<span class="variable">$&#123;T_RUN_REASSIGN_REPORT_TK&#125;</span>"</span> <span class="string">"dt='<span class="variable">$&#123;ymd&#125;</span>', dimen='17'"</span> <span class="string">"overwrite"</span></span></span><br></pre></td></tr></table></figure>

<ol>
<li><code>key=&#39;1004633&#39;</code> 代表 <code>showfailed</code> 的数据</li>
<li>由于原始数据已经有统计，所以<code>sum(key_count)</code>的总和就是<code>showfailed</code>的<code>对应维度</code>的总数</li>
<li>写入到 <code>dimen = &#39;17&#39;</code> 的分区</li>
</ol>
<h3 id="merge-revenue"><a href="#merge-revenue" class="headerlink" title="merge_revenue"></a>merge_revenue</h3><blockquote>
<p>统计收益数据</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hql="</span><br><span class="line">        select</span><br><span class="line">            '$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;',</span><br><span class="line">            case  when (a.nw_firm_id is null or a.nw_firm_id='' or a.nw_firm_id not rlike '^\\\\\\d+$') then '0' else a.nw_firm_id end,</span><br><span class="line">            case  when (a.group_id is null or a.group_id='' or a.group_id not rlike '^\\\\\\d+$') then '0' else a.group_id end,</span><br><span class="line">            case  when (a.unit_id is null or a.unit_id='' or a.unit_id not rlike '^\\\\\\d+$') then '0' else a.unit_id end,</span><br><span class="line">            a.system_type,</span><br><span class="line">            a.sdk_version,</span><br><span class="line">            case a.app_vn when 'null' then '0' else regexp_replace(a.app_vn,'\\\\\\\\0000','') end,</span><br><span class="line">            a.os_platform,</span><br><span class="line">            a.geo_short,</span><br><span class="line">            a.publisher_id,</span><br><span class="line">            a.app_id,</span><br><span class="line">            a.placement_id,</span><br><span class="line">            a.format,</span><br><span class="line">            a.sc_type,</span><br><span class="line">            cast(sum(a.request) as bigint),</span><br><span class="line">            cast(sum(a.filled_request) as bigint),</span><br><span class="line">            cast(sum(a.impression) as bigint),</span><br><span class="line">            cast(sum(a.click) as bigint),</span><br><span class="line">            cast(sum(a.load) as bigint),</span><br><span class="line">            cast(sum(a.filled_load) as bigint),</span><br><span class="line">            cast(sum(a.rv_play_start) as bigint),</span><br><span class="line">            cast(sum(a.rv_play_complete) as bigint),</span><br><span class="line">            a.channel,</span><br><span class="line">            a.sub_channel,</span><br><span class="line">            cast(sum(a.app_request) as bigint),</span><br><span class="line">            cast(sum(a.placement_request) as bigint),</span><br><span class="line">            cast(sum(a.show) as bigint),</span><br><span class="line">            cast(sum(a.impression_optimize) as bigint),</span><br><span class="line">            a.network_id,</span><br><span class="line">            case  when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end,</span><br><span class="line">            case  when (a.bidtype is null or a.bidtype='') then '0' else a.bidtype end,</span><br><span class="line">            cast(sum(case  when (a.bid_request is null or a.bid_request='') then '0' else a.bid_request end) as bigint),</span><br><span class="line">            cast(sum(case  when (a.bid_response is null or a.bid_response='') then '0' else a.bid_response end) as bigint),</span><br><span class="line">            cast(sum(case  when (a.estimated_revenue is null or a.estimated_revenue='') then '0' else a.estimated_revenue end) as float),</span><br><span class="line">            case </span><br><span class="line">                when (sum(case when a.fake_impression_optimize is not null then a.fake_impression_optimize else a.impression_optimize end)* sum(b.total_revenue) / sum(b.total_impression)) is null then '0' </span><br><span class="line">                else cast((sum(case when a.fake_impression_optimize is not null then a.fake_impression_optimize else a.impression_optimize end) * sum(b.total_revenue) / sum(b.total_impression)) as float) </span><br><span class="line">            end,</span><br><span class="line">            case </span><br><span class="line">                when (sum(case when a.fake_impression_optimize is not null then a.fake_impression_optimize else a.impression_optimize end)* sum(b.total_currency_revenue) / sum(b.total_impression)) is null then '0' </span><br><span class="line">                else cast((sum(case when a.fake_impression_optimize is not null then a.fake_impression_optimize else a.impression_optimize end) * sum(b.total_currency_revenue) / sum(b.total_impression)) as float) </span><br><span class="line">            end,</span><br><span class="line">            case when (scenario is null or scenario='') then '1' else scenario end,</span><br><span class="line">            case when (error_type is null or error_type='') then '0' else error_type end,</span><br><span class="line">            case when (error_msg is null or error_msg='') then '' else error_msg end,</span><br><span class="line">            cast(sum(case  when (a.fake_impression_optimize is null or a.fake_impression_optimize='') then a.impression_optimize else a.fake_impression_optimize end) as bigint),</span><br><span class="line">            cast(sum(case  when (a.fake_filled_load is null or a.fake_filled_load='') then a.filled_load else a.fake_filled_load end) as bigint),</span><br><span class="line">            cast(sum(case  when (a.fake_filled_request is null or a.fake_filled_request='') then a.filled_request else a.fake_filled_request end) as bigint),</span><br><span class="line">            case when (a.is_cn_sdk is null or a.is_cn_sdk not rlike '^\\\\\\d+$') then '0' else a.is_cn_sdk end,</span><br><span class="line">            cast(sum(case  when (a.ready_request is null or a.ready_request='' or a.ready_request='(null)') then 0 else a.ready_request end) as bigint),</span><br><span class="line">            cast(sum(case  when (a.ready_success is null or a.ready_success='' or a.ready_success='(null)') then 0 else a.ready_success end) as bigint),</span><br><span class="line">            cast(sum(case  when (a.show_failed is null or a.show_failed='' or a.show_failed='(null)') then 0 else a.show_failed end) as bigint),</span><br><span class="line">            case when device_type is null then 1 else device_type end,</span><br><span class="line">            cast(sum(case when load_cost_time is null or load_cost_time&lt;0 then 0 else load_cost_time end) as bigint),</span><br><span class="line">            cast(sum(case when request_cost_time is null or request_cost_time&lt;0 then 0 else request_cost_time end) as bigint),</span><br><span class="line">            case when idfa_exist_tag is null then 0 else idfa_exist_tag end,</span><br><span class="line">            case coalesce(sum(bid_response),0) when 0  then 0.0 else cast(sum(bid_response * coalesce(bid_response_ecpm,0)) / sum(bid_response) as float) end,</span><br><span class="line">            cast(coalesce(sum(scenario_entry),0) as bigint),</span><br><span class="line">            cast(coalesce(sum(scenario_entry_ready),0) as bigint),</span><br><span class="line">            case when abtest_id is null then '' else abtest_id end,</span><br><span class="line">            case when ofl is null then 0 else ofl end</span><br><span class="line">        from </span><br><span class="line">            (select *</span><br><span class="line">            from $&#123;DB_UPARPU&#125;.$&#123;T_RUN_REPORT_TK&#125;</span><br><span class="line">            where</span><br><span class="line">                dt = '$&#123;ymd&#125;'</span><br><span class="line">                and dimen in ('0','15','16','17','18')</span><br><span class="line">                and os_platform is not null</span><br><span class="line">                and length(sdk_version) &lt; 15</span><br><span class="line">                and bidtype&lt;=20</span><br><span class="line">                and bidtype&gt;=0</span><br><span class="line">                and format&gt;=0</span><br><span class="line">                $&#123;whereInPublisherList&#125;</span><br><span class="line">            ) as a</span><br><span class="line">        left join</span><br><span class="line">            (</span><br><span class="line">           select </span><br><span class="line">              app_id,</span><br><span class="line">              placement_id,</span><br><span class="line">              geo_short,</span><br><span class="line">              unit_id,</span><br><span class="line">              tk_impression as total_impression,</span><br><span class="line">              revenue as total_revenue,</span><br><span class="line">              currency_revenue as total_currency_revenue,</span><br><span class="line">              dt</span><br><span class="line">            from</span><br><span class="line">              $&#123;DB_UPARPU&#125;.$&#123;T_UPARPU_TK_UNIT_ECPM&#125;</span><br><span class="line">            where</span><br><span class="line">              dt = '$&#123;ymd&#125;'</span><br><span class="line">              $&#123;whereInPublisherList&#125;</span><br><span class="line">            ) as b</span><br><span class="line">        on </span><br><span class="line">            a.app_id = b.app_id and</span><br><span class="line">            a.placement_id=b.placement_id and</span><br><span class="line">            a.geo_short = b.geo_short and</span><br><span class="line">            a.unit_id = b.unit_id</span><br><span class="line">            and a.dt = '$&#123;ymd&#125;'</span><br><span class="line">            and b.dt = '$&#123;ymd&#125;'</span><br><span class="line">            and a.dimen in ('0','15','16','17','18')</span><br><span class="line">        where </span><br><span class="line">            a.dt = '$&#123;ymd&#125;'</span><br><span class="line">            and a.dimen in ('0','15','16','17','18')</span><br><span class="line">        group by </span><br><span class="line">            case  when (a.nw_firm_id is null or a.nw_firm_id='' or a.nw_firm_id not rlike '^\\\\\\d+$') then '0' else a.nw_firm_id end,</span><br><span class="line">            case  when (a.group_id is null or a.group_id='' or a.group_id not rlike '^\\\\\\d+$') then '0' else a.group_id end,</span><br><span class="line">            case  when (a.unit_id is null or a.unit_id='' or a.unit_id not rlike '^\\\\\\d+$') then '0' else a.unit_id end,</span><br><span class="line">            a.system_type,</span><br><span class="line">            a.sdk_version,</span><br><span class="line">            case a.app_vn when 'null' then '0' else regexp_replace(a.app_vn,'\\\\\\\\0000','') end,</span><br><span class="line">            a.os_platform,</span><br><span class="line">            a.geo_short,</span><br><span class="line">            a.publisher_id,</span><br><span class="line">            a.app_id,</span><br><span class="line">            a.placement_id,</span><br><span class="line">            a.format,</span><br><span class="line">            a.sc_type,</span><br><span class="line">            a.channel,</span><br><span class="line">            a.sub_channel,</span><br><span class="line">            a.network_id,</span><br><span class="line">            case  when (a.traffic_group_id is null or a.traffic_group_id='') then '0' else a.traffic_group_id end,</span><br><span class="line">            case  when (a.bidtype is null or a.bidtype='') then '0' else a.bidtype end,</span><br><span class="line">            case when (scenario is null or scenario='') then '1' else scenario end,</span><br><span class="line">            case when (error_type is null or error_type='') then '0' else error_type end,</span><br><span class="line">            case when (error_msg is null or error_msg='') then '' else error_msg end,</span><br><span class="line">            case when (a.is_cn_sdk is null or a.is_cn_sdk not rlike '^\\\\\\d+$') then '0' else a.is_cn_sdk end,</span><br><span class="line">            case when device_type is null then 1 else device_type end,</span><br><span class="line">            case when idfa_exist_tag is null then 0 else idfa_exist_tag end,</span><br><span class="line">            case when abtest_id is null then '' else abtest_id end,</span><br><span class="line">            case when ofl is null then 0 else ofl end</span><br><span class="line">"</span><br><span class="line"></span><br><span class="line">spark-submit --class com.topon.spark.jobs.common.CommonSparkDateTimeJob \</span><br><span class="line">  --name "TopOn_CommonSparkDateTimeJob_ltv_tk_reassign_revenue_dt$&#123;yyyy_mm_dd&#125;" \</span><br><span class="line">  --master yarn \</span><br><span class="line">  --deploy-mode cluster \</span><br><span class="line">  --executor-memory "$&#123;SPARK_EXECUTOR_MEMORY&#125;" \</span><br><span class="line">  --driver-memory "$&#123;SPARK_DRIVER_MEMORY&#125;" \</span><br><span class="line">  --executor-cores 2 \</span><br><span class="line">  --num-executors "$&#123;SPARK_NUM_EXECUTORS&#125;" \</span><br><span class="line">  --conf spark.dynamicAllocation.enabled=false \</span><br><span class="line">  --conf spark.dynamicAllocation.minExecutors=32 \</span><br><span class="line">  --conf spark.dynamicAllocation.maxExecutors=64 \</span><br><span class="line">  --conf spark.core.connection.ack.wait.timeout=300 \</span><br><span class="line"><span class="meta">  $</span><span class="bash">&#123;SPARK_SQL_JAR&#125; <span class="variable">$&#123;CLIENT_TMP_LOG_PATH&#125;</span> <span class="string">"<span class="variable">$&#123;ymd&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;hql&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DB_UPARPU&#125;</span>.<span class="variable">$&#123;T_RUN_REASSIGN_REPORT_TK&#125;</span>"</span> <span class="string">"dt='<span class="variable">$&#123;ymd&#125;</span>', dimen='00'"</span> <span class="string">"overwrite"</span></span></span><br></pre></td></tr></table></figure>

<ol>
<li><code>dimen in (&#39;0&#39;,&#39;15&#39;,&#39;16&#39;,&#39;17&#39;,&#39;18&#39;)</code>，分别是<code>0=原来的小时任务统计出来的数据，15=isready数据, 16=isready_success数据,17=showfailed数据, 18=source_type=2的实时数据</code>，拿到所有的数据，然后进行重新写入</li>
<li>重新写入到 <code>dimen = &#39;00&#39;</code> 的分区中</li>
</ol>
<h3 id="to-db"><a href="#to-db" class="headerlink" title="to_db"></a>to_db</h3><blockquote>
<p>数据出仓到gp</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">source ./export_tk_util.sh</span><br><span class="line">export_tk_func "$&#123;DB_UPARPU&#125;.$&#123;T_RUN_REASSIGN_REPORT_TK&#125;" "$&#123;T_RUN_REPORT_TK_SOURCE&#125;" "dt='$&#123;ymd&#125;' AND dimen='00'" " date_time =$&#123;yyyy&#125;$&#123;mm&#125;$&#123;dd&#125;  $&#123;whereInPublisherList&#125; "</span><br></pre></td></tr></table></figure>

<ol>
<li>把当天的数据delete掉</li>
<li>把所有数据重新写入到gp</li>
</ol>
<p>重分配到任务做的事情处理完毕。注意这里涉及到了<code>收益</code>数据，由于业务导向是聚合平台，所以会收益是从多个平台拉取回来的数据，可能存在拉取收益数据失败的情况，所以需要有重试机制，所以这里的的任务有分为<code>跑前1天</code>，<code>跑前2天</code>，<code>跑前3天</code>的数据，如果超过3天，都拉取失败，那么这部分数据我们需要手动重跑。</p>

      
    </div>

  </div>

  <div class="article-footer">
    <div class="article-meta pull-left">

    
      

    <span class="post-categories">
      <i class="icon-categories"></i>
        <a href="/categories/大数据/">大数据</a>
    </span>
    

    
    

    <span class="post-tags">
      <i class="icon-tags"></i>
        <a href="/tags/大数据/">大数据</a><a href="/tags/公司/">公司</a>
    </span>
    

    </div>

    
  </div>
</article>

  






    </main>

    <footer class="site-footer">
  <p class="site-info">
    Proudly powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and
    Theme by <a href="https://github.com/CodeDaraW/Hacker" target="_blank">Hacker</a>
    </br>
    
    &copy; 2022 白菜(whiteCcinn)
    
  </p>
</footer>
    
  </div>
</div>
</body>
</html>