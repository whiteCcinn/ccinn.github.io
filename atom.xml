<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>白菜君の技术库</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.crazylaw.cn/"/>
  <updated>2021-09-06T01:57:29.825Z</updated>
  <id>http://blog.crazylaw.cn/</id>
  
  <author>
    <name>白菜(whiteCcinn)</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>【Golang】- protobuf插件扩展开发2</title>
    <link href="http://blog.crazylaw.cn/2021/09/06/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%912/"/>
    <id>http://blog.crazylaw.cn/2021/09/06/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%912/</id>
    <published>2021-09-06T01:16:51.000Z</published>
    <updated>2021-09-06T01:57:29.825Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一片，我们讲到了<code>protobuf扩展开发</code>的大体流程和思路，这一篇，我们来继续总结一下相关的API细节。</p><a id="more"></a><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="第一点"><a href="#第一点" class="headerlink" title="第一点"></a>第一点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option go_package &#x3D; &quot;github.com&#x2F;xxxx&#x2F;pb&#x2F;go-pb&#x2F;api;pb&quot;;</span><br></pre></td></tr></table></figure><p>我们经常可以看到这种定义，分好前面的<code>github.com/xxxx/pb/go-pb/api</code>，我们在写代码的时候会被加载到：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(gen *Plugin)</span> <span class="title">NewGeneratedFile</span><span class="params">(filename <span class="keyword">string</span>, goImportPath GoImportPath)</span> *<span class="title">GeneratedFile</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们自己的代码</span></span><br><span class="line">filename := f.GeneratedFilenamePrefix + <span class="string">".api.go"</span></span><br><span class="line">g := plugin.NewGeneratedFile(strings.TrimPrefix(filename, strings.Trim(pbPkg.String(), <span class="string">"\""</span>)), f.GoImportPath)</span><br></pre></td></tr></table></figure><p>这里，我们可以看到<code>Plugin.NewGeneratedFile</code>有2个参数，第一个是<code>filename</code>,另外一个是<code>goImportPath</code>，分别的含义是：</p><p>生成的文件名和这个文件被import的时候，应该要怎么import。</p><ul><li>这个文件名需要注意的是，这是一个全路径文件名，如果你的文件名种存在<code>/</code>，那么前面的都是<code>目录</code>，直到最后一个，才是文件名。</li><li>例如我这里的是<code>github.com/xxxx/pb/go-pb/api</code>，那么生成的文件被引用的时候，就会<code>import &quot;github.com/xxxx/pb/go-pb/api&quot;</code>。</li></ul><p>看到这里，我们再来看看分号后面的<code>pb</code>，这个在外面写代码的时候到体现是：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 我们自己的代码</span></span><br><span class="line">g.P(<span class="string">"package "</span> + f.GoPackageName)</span><br></pre></td></tr></table></figure><p>看到其实这个<code>pb</code>会被加载进文件的<code>GoPackageName</code>种，所以分号前面的意义是不同的，前面的对应<code>filename</code>和<code>GoImportPath</code>,后面对应的就是<code>GoPackageName</code></p><h3 id="第二点"><a href="#第二点" class="headerlink" title="第二点"></a>第二点</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">pbPkg = protogen.GoImportPath(<span class="string">"github.com/xxx/pb/go-pb"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>在代码中，我们会定义一些这样子的xxxPkg的变量，他们由<code>protogen.GoImportPath</code>来包装起来，在使用上就是：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g.P(<span class="string">"     "</span>, method.GoName, <span class="string">"Api = "</span>, pbPkg.Ident(<span class="string">"NewApi"</span>), <span class="string">"(\""</span>, method.GoName, <span class="string">"\", \""</span>, m, <span class="string">"\", \""</span>, url, <span class="string">"\")"</span>)</span><br></pre></td></tr></table></figure><p>看到这里的<code>pbPkg.Ident(&quot;NewApi&quot;)</code>，意思就是这个要调用<code>pbPkg</code>包下的<code>NewApi</code>的方法。</p><p>值得注意的是，这里用到的<code>Ident()</code>API，顾名思义就是<code>.</code>的意思。</p><h3 id="第三点"><a href="#第三点" class="headerlink" title="第三点"></a>第三点</h3><p>有时候，我们调用<code>Plugin.NewGeneratedFile</code>，创建了生成文件实例并且已经预写入了一些内容，但是实际代码中，并<code>没有任何有意义</code>有价值的代码，那么这个时候我希望这个文件<code>不要生成</code>，我就可以调用<code>Skip()</code>的API。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 我们自己的代码</span></span><br><span class="line">g := plugin.NewGeneratedFile(strings.TrimPrefix(filename, strings.Trim(pbPkg.String(), <span class="string">"\""</span>)), f.GoImportPath)</span><br><span class="line">g.Skip()</span><br></pre></td></tr></table></figure><p>那么这个文件在最终将不会被生成。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;上一片，我们讲到了&lt;code&gt;protobuf扩展开发&lt;/code&gt;的大体流程和思路，这一篇，我们来继续总结一下相关的API细节。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>【Golang】- protobuf插件扩展开发</title>
    <link href="http://blog.crazylaw.cn/2021/09/04/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/"/>
    <id>http://blog.crazylaw.cn/2021/09/04/Golang/protobuf%E6%8F%92%E4%BB%B6%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/</id>
    <published>2021-09-04T06:16:51.000Z</published>
    <updated>2021-09-04T06:28:36.840Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近，项目需要用到protobuf来定义消息，但是我们需要一个更灵活的代码片段，如何通过<code>proto</code>文件来创建自定义的代码呢？<br>可以通过proto的<code>plugin</code>对方式来自己是一个<code>proto-gen</code>。</p><p>在网上看了一些教程，发现有一些教程已经过时了，而且过于片面，没有把整套思想很好的说明。并且也有一些功能点并没有完全实现。<br>这里总结一下相关的内容，并且说一下最近实现的一个插件。</p><blockquote><p>对于已经了解大概<code>proto</code>的人来说，相对简单，但是如果是<code>自定义option</code>呢？你又了解吗？</p></blockquote><a id="more"></a><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; test.proto</span><br><span class="line"></span><br><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line">package pb;</span><br><span class="line">option go_package &#x3D; &quot;&#x2F;;pb&quot;;</span><br><span class="line"></span><br><span class="line">import &quot;unknow.proto&quot;;</span><br><span class="line"></span><br><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http) &#x3D; &#123;</span><br><span class="line">            method: &quot;post&quot;</span><br><span class="line">            url: &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 设备类型</span><br><span class="line">enum ApiIMDeviceType &#123;</span><br><span class="line">    API_IM_UNKNOWN &#x3D; 0;</span><br><span class="line">    API_IM_Android &#x3D; 1;</span><br><span class="line">    API_IM_IOS &#x3D; 2;</span><br><span class="line">    API_IM_Window &#x3D; 3;</span><br><span class="line">    API_IM_MacOS &#x3D; 4;</span><br><span class="line">    API_IM_Web &#x3D; 5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ApiIMRegisterDeviceReq &#123;</span><br><span class="line">    ApiIMDeviceType type &#x3D; 1; &#x2F;&#x2F; 设备类型</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message ApiIMRegisterDeviceResp &#123;</span><br><span class="line">    int64 device_id &#x3D; 1; &#x2F;&#x2F; 设备id</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到这一个<code>proto</code>文件，常规的我就不说了。主要是看到<code>import &quot;unknow.proto&quot;</code>, <code>option (unknow.api.http)</code></p><p>可以看到，我这里引入一个<code>unknow.proto</code>的文件。</p><p>我希望最终生成一个<code>api.unknow.go</code>的文件。里面的内容期待如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2021, whiteCcinn Inc.</span></span><br><span class="line"><span class="comment">// Code generated by protoc-gen-unknow. DO NOT EDIT.</span></span><br><span class="line"><span class="comment">// source: test.proto</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pb</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Api <span class="keyword">struct</span> &#123;</span><br><span class="line">Name   <span class="keyword">string</span></span><br><span class="line">Method <span class="keyword">string</span></span><br><span class="line">Url    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newApi</span><span class="params">(name, method, url <span class="keyword">string</span>)</span> *<span class="title">Api</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Api&#123;</span><br><span class="line">name, method, url,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">RegisterDeviceApi = newApi(<span class="string">"RegisterDevice"</span>, <span class="string">"post"</span>, <span class="string">"/v1/im/register_device"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>生成的文件，我可以在项目通过<code>pb.RegisterDeviceApi</code>拿到在<code>proto</code>定义好的API内容。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; unknow.proto</span><br><span class="line"></span><br><span class="line">syntax &#x3D; &quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package unknow.api;</span><br><span class="line"></span><br><span class="line">option go_package &#x3D; &quot;&#x2F;;pb&quot;;</span><br><span class="line"></span><br><span class="line">import &quot;google&#x2F;protobuf&#x2F;descriptor.proto&quot;;</span><br><span class="line"></span><br><span class="line">extend google.protobuf.MethodOptions &#123;</span><br><span class="line">    &#x2F;&#x2F; See &#96;HttpRule&#96;.</span><br><span class="line">    HttpRule http &#x3D; 72295728;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HttpRule &#123;</span><br><span class="line">    string url &#x3D; 1;</span><br><span class="line">    string method &#x3D; 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/googleapis/googleapis/blob/master/google/api/annotations.proto" target="_blank" rel="noopener">google/api/annotations.proto</a></li><li><a href="https://github.com/googleapis/googleapis/blob/master/google/api/http.proto" target="_blank" rel="noopener">google/api/http.proto</a></li><li><a href="https://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/descriptor.proto" target="_blank" rel="noopener">google/protobuf/descriptor.proto</a></li></ul><p>如果有了解过<code>google/api/annotations.proto</code> 和 <code>google/api/http.proto</code>的人应该不会陌生，当你需要用到<code>grpc-gateway</code>或者<code>proto-gen-swaager</code>的时候，都会有介绍到<code>option(goggle.api.http)</code>的用法。</p><p>这里我们看到<code>unknow.proto</code>的结构体，这就是一个简化版本。用于实现<code>自定义的option</code>用的。</p><h3 id="unknow-proto"><a href="#unknow-proto" class="headerlink" title="unknow.proto"></a>unknow.proto</h3><p>对于基础的语法规则来说，我们来看剖析一下<code>unknow.proto</code>，常规的就不说了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package unknow.api;</span><br><span class="line"></span><br><span class="line">extend google.protobuf.MethodOptions &#123;</span><br><span class="line">    &#x2F;&#x2F; See &#96;HttpRule&#96;.</span><br><span class="line">    HttpRule http &#x3D; 72295728;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HttpRule &#123;</span><br><span class="line">    string url &#x3D; 1;</span><br><span class="line">    string method &#x3D; 2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对于<code>extend</code>的用法，我这里列一下官方的链接。</p><ul><li><a href="https://developers.google.com/protocol-buffers/docs/overview#customoptions" target="_blank" rel="noopener">Custom Options</a></li></ul><p>我们看到这里，<code>extend google.protobuf.MethodOptions</code>。</p><p>代表着，我这里自定义个作用于<code>Method</code>的<code>option</code>。所以在真正的<code>proto</code>文件中，我就可以使用<code>unknow.api.option</code>的标签。也就是<code>option (unknow.api.http)</code>。</p><p>接着我们看到，这个option我们定义了一个元素，类型是<code>Message HttpRule</code>，命名为<code>http</code>，并且给它定义一个唯一的<code>Number</code>。</p><p>接着我们看到<code>HttpRule</code>，内部存在2个元素，一个是<code>string url</code> 和 <code>string method</code>，这意味着我们可以使用<code>独立行写法</code>：<code>option (unknow.api.http).url = &quot;/v1/im/register_device&quot;</code>，然后再下一行使用 <code>option (unknow.api.http).method = &quot;post&quot;</code>，一个完整的例如如下：</p><p>刚才说到，这是一个<code>method</code>的<code>option</code>，也就是我们这里定义的<code>rpc</code>下的 <code>option</code>。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http).method &#x3D; &quot;post&quot;</span><br><span class="line">        option (unknow.api.http).url &#x3D; &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>除了这个写法，我更推荐如下更简洁的写法，用<code>map</code>的写法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">service ApiIMService &#123;</span><br><span class="line">    rpc RegisterDevice (ApiIMRegisterDeviceReq) returns (ApiIMRegisterDeviceResp) &#123;</span><br><span class="line">        option (unknow.api.http) &#x3D; &#123;</span><br><span class="line">            method: &quot;post&quot;</span><br><span class="line">            url: &quot;&#x2F;v1&#x2F;im&#x2F;register_device&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样子，我们就看懂了<code>test.proto</code>的内容了对吧。连贯起来，那么我们的这个<code>unknow.proto</code>就是用于实现<code>option(unknow.api.http)</code>。而<code>option(unknow.api.http)</code>的使用则在<code>test.proto</code>进行采用。</p><p>好了，有了定义的文件，那么接下来就是我们的重点了，如何编写一个实现<code>自定义代码的protobuf插件扩展</code></p><h3 id="扩展实现"><a href="#扩展实现" class="headerlink" title="扩展实现"></a>扩展实现</h3><p><img src="/images/Go/protobuf.png" alt="protobuf解析流程图"></p><blockquote><p>protobuf解析旧版的流程图，便于我们理解。新版的后续我抽空再画画</p></blockquote><h3 id="不科学的例子"><a href="#不科学的例子" class="headerlink" title="不科学的例子"></a>不科学的例子</h3><p>第一个例子，以golang旧版<code>proto-gen-go</code>为例。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;io&#x2F;ioutil&quot;</span><br><span class="line">&quot;os&quot;</span><br><span class="line"></span><br><span class="line">&quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;proto&quot;</span><br><span class="line">&quot;github.com&#x2F;golang&#x2F;protobuf&#x2F;protoc-gen-go&#x2F;generator&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">&#x2F;&#x2F; Begin by allocating a generator. The request and response structures are stored there</span><br><span class="line">&#x2F;&#x2F; so we can do error handling easily - the response structure contains the field to</span><br><span class="line">&#x2F;&#x2F; report failure.</span><br><span class="line">g :&#x3D; generator.New()</span><br><span class="line"></span><br><span class="line">data, err :&#x3D; ioutil.ReadAll(os.Stdin)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">g.Error(err, &quot;reading input&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if err :&#x3D; proto.Unmarshal(data, g.Request); err !&#x3D; nil &#123;</span><br><span class="line">g.Error(err, &quot;parsing input proto&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if len(g.Request.FileToGenerate) &#x3D;&#x3D; 0 &#123;</span><br><span class="line">g.Fail(&quot;no files to generate&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.CommandLineParameters(g.Request.GetParameter())</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Create a wrapped version of the Descriptors and EnumDescriptors that</span><br><span class="line">&#x2F;&#x2F; point to the file that defines them.</span><br><span class="line">g.WrapTypes()</span><br><span class="line"></span><br><span class="line">g.SetPackageNames()</span><br><span class="line">g.BuildTypeNameMap()</span><br><span class="line"></span><br><span class="line">g.GenerateAllFiles()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Send back the results.</span><br><span class="line">data, err &#x3D; proto.Marshal(g.Response)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">g.Error(err, &quot;failed to marshal output proto&quot;)</span><br><span class="line">&#125;</span><br><span class="line">_, err &#x3D; os.Stdout.Write(data)</span><br><span class="line">if err !&#x3D; nil &#123;</span><br><span class="line">g.Error(err, &quot;failed to write output proto&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我发现现在网上很多教程都会以旧版的为主，并且都是沿用参考了<code>proto-gen-go</code>的这个旧版的写法，所以导致，我们在学习写的时候，会出现一些问题。并且其实你用了旧版的这个写法，当你在用<code>protoc</code>去编译的情况下，<code>protoc</code>也会友好的提示你，该API已经被废弃，将在未来的版本下移除，请使用新的写法。虽然你还是能编译通过，但是你不敢保证未来哪一个版本就直接不向后兼容了。</p><p>第二个例子。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">input, _ := ioutil.ReadAll(os.Stdin)</span><br><span class="line"><span class="keyword">var</span> req pluginpb.CodeGeneratorRequest</span><br><span class="line">proto.Unmarshal(input, &amp;req)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认选项初始化我们的插件</span></span><br><span class="line">opts := protogen.Options&#123;&#125;</span><br><span class="line">plugin, err := opts.New(&amp;req)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">   <span class="built_in">panic</span>(err)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>这种方式就是从头到尾都自己写，把整个<code>pipeline</code>的流程都自己处理。但是大可不必，因为其实有很多流程化的东西，在新版的<code>genpro</code>下已经封装成了一个<code>Run</code>传递回调函数即可。</p><h3 id="正确的例子"><a href="#正确的例子" class="headerlink" title="正确的例子"></a>正确的例子</h3><p>如果真的要参考的话，推荐参考最新版本的<a href="https://github.com/golang/protobuf/blob/master/protoc-gen-go/main.go" target="_blank" rel="noopener">proto-gen-go</a></p><p>首先，我们需要知道一点，我们在采用<code>protoc</code>对<code>proto</code>文件进行编译的时候，经常是执行类似如下代码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc -I.:$&#123;GOGO_PROTOBUF&#125; \</span><br><span class="line">--gofast_out=plugins=grpc:./go-pb</span><br></pre></td></tr></table></figure><p><br>由于这里我用的是<code>gogoprotobuf</code>，所以你会看到我这里的是<code>--gofast_out=plugins=grpc:./go-pb</code>，如果你是<code>protobuf</code>的官方的<code>proto-gen</code>的话，那么你这里应该是<code>--go_out=plugins=grpc:./go-pb</code></p><p>这里我们需要注意的是什么呢，就是<code>插件二进制文件名</code>，这是有一定规则的，这是我之前在<code>自定义git凭据</code>文章中说明的一样，这二进制文件需要在你的环境变量中，否则你就需要通过<code>-I</code>来指定文件路径。然后命名规则为<code>proto-gen-xxx</code>，而这个<code>xxx</code>就是你的自定义的名字。在本例子中，我的扩展名字就是<code>proto-gen-unknow</code>。</p><p>因此，最终如果我要执行的话，那么就是执行如下命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protoc -I.:$&#123;GOGO_PROTOBUF&#125; \</span><br><span class="line">--unknow_out=./go-pb</span><br></pre></td></tr></table></figure><p>其实如果有接触过<code>thrift</code> 或者 <code>Rust</code>的<code>元编程</code> 甚至是 <code>Python</code>的 <code>lark-parser</code>自定义抽象语法树，或者其他经由<code>AST</code>抽象语法树写代码的同学应该都知道，这其实抽象出来就是一个<code>AST</code>的解析处理而已。所以我首先需要了解他的部署。</p><p>一个简陋的<code>AST</code>定义如下（哈哈，略显简陋，但是了解AST是啥的应该多少能看懂一些）：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">FileDescriptor -&gt; ServiceDescriptor</span><br><span class="line">-&gt; ServiceOptionDescriptor</span><br><span class="line">-&gt; MethodDescriptor</span><br><span class="line">-&gt; MethodOptionDescriptor</span><br><span class="line">    -&gt; [MessageDescriptor]</span><br><span class="line">               -&gt; MessageDescriptor</span><br><span class="line">-&gt; MessageOptionDescriptor</span><br><span class="line">-&gt; FieldDescriptor</span><br><span class="line">-&gt; FieldOptionDescriptor</span><br><span class="line">   -&gt; FieldOptionDescriptor</span><br></pre></td></tr></table></figure><p>知道怎么执行了，和<code>AST</code>, 我们就来看看怎么编写代码。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  protoc-gen-unknow git:(main) tree</span><br><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── internal</span><br><span class="line">│   └── unknow.go</span><br><span class="line">├── main.go</span><br><span class="line">├── out</span><br><span class="line">│   └── unknow.pb.go</span><br><span class="line">└── proto</span><br><span class="line">    ├── descriptor.proto</span><br><span class="line">    └── unknow.proto</span><br></pre></td></tr></table></figure><p>可以看到，这是我的一个代码结构目录</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"internal"</span></span><br><span class="line"><span class="string">"google.golang.org/protobuf/compiler/protogen"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">u := internal.Unknow&#123;&#125;</span><br><span class="line">protogen.Options&#123;&#125;.Run(u.Generate)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里，我们借助<code>protobuf</code> 编译包下的 <code>protogen</code> 工具来解析 <code>proto</code> 文件。我们接下来看一下 <code>internal</code> 包下具体的写法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> internal</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">pb <span class="string">"out"</span></span><br><span class="line"><span class="string">"google.golang.org/protobuf/compiler/protogen"</span></span><br><span class="line"><span class="string">"google.golang.org/protobuf/proto"</span></span><br><span class="line"><span class="string">"google.golang.org/protobuf/types/descriptorpb"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Unknow <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">Generate</span><span class="params">(plugin *protogen.Plugin)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(plugin.Files) &lt; <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 指定生成文件的文件名</span></span><br><span class="line">filename := <span class="string">"/api.unknow.go"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个文件生成器对象</span></span><br><span class="line">g := plugin.NewGeneratedFile(filename, plugin.Files[<span class="built_in">len</span>(plugin.Files)<span class="number">-1</span>].GoImportPath)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用g.P就是往文件开始写入自己期待的代码</span></span><br><span class="line">g.P(<span class="string">`// Copyright (c) 2021, whiteCcinn Inc.`</span>)</span><br><span class="line">g.P(<span class="string">"// Code generated by protoc-gen-unknow. DO NOT EDIT."</span>)</span><br><span class="line">g.P(<span class="string">"// source: all MethodOptions(unknow.api.http) in proto file"</span>)</span><br><span class="line">g.P()</span><br><span class="line">g.P(<span class="string">"package "</span>, plugin.Files[<span class="built_in">len</span>(plugin.Files)<span class="number">-1</span>].GoPackageName)</span><br><span class="line"></span><br><span class="line">g.P(<span class="string">`</span></span><br><span class="line"><span class="string">type Api struct &#123;</span></span><br><span class="line"><span class="string">Name   string</span></span><br><span class="line"><span class="string">Method string</span></span><br><span class="line"><span class="string">Url    string</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">func newApi(name, method, url string) *Api &#123;</span></span><br><span class="line"><span class="string">return &amp;Api&#123;</span></span><br><span class="line"><span class="string">name, method, url,</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span>)</span><br><span class="line"></span><br><span class="line">g.P(<span class="string">"var ("</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过plugin.Fiels，我们可以拿到所有的输入的proto文件</span></span><br><span class="line"><span class="comment">// 如果我们需要对这个文件生成代码的话，那么就进入到generateFile()逻辑</span></span><br><span class="line"><span class="comment">// 并且把g和f一起传递过去</span></span><br><span class="line"><span class="keyword">for</span> _, f := <span class="keyword">range</span> plugin.Files &#123;</span><br><span class="line"><span class="keyword">if</span> f.Generate &#123;</span><br><span class="line"><span class="keyword">if</span> _, err := u.generateFile(g, f); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.P(<span class="string">")"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">generateFile</span><span class="params">(g *protogen.GeneratedFile, file *protogen.File)</span> <span class="params">(*protogen.GeneratedFile, error)</span></span> &#123;</span><br><span class="line"><span class="comment">// 这一段代码仅仅只是为了忽略包含proto文件中包含了streamClient和streamServer的代码</span></span><br><span class="line">isGenerated := <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> _, srv := <span class="keyword">range</span> file.Services &#123;</span><br><span class="line"><span class="keyword">for</span> _, method := <span class="keyword">range</span> srv.Methods &#123;</span><br><span class="line"><span class="keyword">if</span> method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">isGenerated = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !isGenerated &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file 的下一层级就是 services 层级</span></span><br><span class="line"><span class="keyword">for</span> _, srv := <span class="keyword">range</span> file.Services &#123;</span><br><span class="line"><span class="keyword">if</span> err := u.genService(g, srv); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> g, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">genService</span><span class="params">(g *protogen.GeneratedFile, srv *protogen.Service)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// service 内部有很多 rpc 关键字的方法</span></span><br><span class="line"><span class="keyword">for</span> _, method := <span class="keyword">range</span> srv.Methods &#123;</span><br><span class="line"><span class="keyword">if</span> method.Desc.IsStreamingClient() || method.Desc.IsStreamingServer() &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于我们自定义的是就是MethodOptions，所以就来到了这里来进行判断</span></span><br><span class="line"><span class="keyword">if</span> err := u.genMethodHTTPRule(g, method); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u Unknow)</span> <span class="title">genMethodHTTPRule</span><span class="params">(g *protogen.GeneratedFile, method *protogen.Method)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// 因为我们通过method.Desc.Options() 拿到的数据类型是`interface&#123;&#125;` 类型</span></span><br><span class="line"><span class="comment">// 所以这里我们需要对Options，明确指定转换为 *descriptorpb.MethodOptions 类型</span></span><br><span class="line"><span class="comment">// 这样子就能拿到我们的MethodOption对象</span></span><br><span class="line">options, ok := method.Desc.Options().(*descriptorpb.MethodOptions)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PS：重点</span></span><br><span class="line"><span class="comment">// 这里我们看到我们借助了一个非protogen下的包的内容</span></span><br><span class="line"><span class="comment">// 原因就是，protobuf编译器会把自定义的Option全部指定为Extension，由于并非内置的属性和值</span></span><br><span class="line"><span class="comment">// protobuf官方是没办法拿到和你对应的可读的内容的，只能通过拿到经过序列化之后的数据。</span></span><br><span class="line"><span class="comment">// 因此，我们这里通过 proto.GetExtension的方法，把刚才unknow.proto单独编译好的 unknow.pb.proto 文件下的 pb. E_HTTP 加载进来，指定了我需要在自定义扩展的MethodOptions中，拿到该Http下里面的value</span></span><br><span class="line"><span class="comment">// 也因此，我们可以再经过一次类型转换，就可以拿到了具体的httpRule</span></span><br><span class="line">httpRule, ok := proto.GetExtension(options, pb.E_Http).(*pb.HttpRule)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接下来，我们就可以通过GetXxx的方式，来获取我们设置在其Message内部filed</span></span><br><span class="line">m := httpRule.GetMethod()</span><br><span class="line">url := httpRule.GetUrl()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(m) == <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(url) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g.P(<span class="string">"     "</span>, method.GoName, <span class="string">"Api = "</span>, <span class="string">"newApi(\""</span>, method.GoName, <span class="string">"\", \""</span>, m, <span class="string">"\", \""</span>, url, <span class="string">"\")"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>请跟着说明中注释一步步查看详解</p></blockquote><p>查看这段代码逻辑，也是非常简单，因为没有特别复杂的逻辑，尽量不要跳过，因为里面涉及到如何读取自定义的Option的问题。代码大致定位在 <code>proto.GetExtension</code>方法附近。</p><p>因为这里的demo生成的代码比较简单。最终，我们生成的代码就是：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Copyright (c) 2021, whiteCcinn Inc.</span></span><br><span class="line"><span class="comment">// Code generated by protoc-gen-unknow. DO NOT EDIT.</span></span><br><span class="line"><span class="comment">// source: source: all MethodOptions(unknow.api.http) in proto file</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> pb</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Api <span class="keyword">struct</span> &#123;</span><br><span class="line">Name   <span class="keyword">string</span></span><br><span class="line">Method <span class="keyword">string</span></span><br><span class="line">Url    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newApi</span><span class="params">(name, method, url <span class="keyword">string</span>)</span> *<span class="title">Api</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;Api&#123;</span><br><span class="line">name, method, url,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">RegisterDeviceApi = newApi(<span class="string">"RegisterDevice"</span>, <span class="string">"post"</span>, <span class="string">"/v1/im/register_device"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>放一下完整的测试命令:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go install . &amp;&amp; protoc --proto_path proto/ -I=. test.proto  test2.proto --unknow_out=./out --go_out=./out</span><br></pre></td></tr></table></figure><p>最后生成的文件目录结构如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  protoc-gen-unknow git:(main) tree</span><br><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── internal</span><br><span class="line">│   └── unknow.go</span><br><span class="line">├── main.go</span><br><span class="line">├── out</span><br><span class="line">│   ├── api.unknow.go</span><br><span class="line">│   ├── test.pb.go</span><br><span class="line">│   ├── test2.pb.go</span><br><span class="line">│   └── unknow.pb.go</span><br><span class="line">└── proto</span><br><span class="line">    ├── descriptor.proto</span><br><span class="line">    ├── test.proto</span><br><span class="line">    ├── test2.proto</span><br><span class="line">    └── unknow.protos</span><br></pre></td></tr></table></figure><p>最后推荐几个扩展库写得不错的扩展插件: </p><ul><li><a href="https://github.com/grpc-ecosystem/grpc-gateway/tree/master/protoc-gen-grpc-gateway" target="_blank" rel="noopener">protoc-gen-grpc-gateway</a></li><li><a href="https://github.com/grpc-ecosystem/grpc-gateway/tree/master/protoc-gen-openapiv2" target="_blank" rel="noopener">protoc-gen-grpc-openapiv2</a></li><li><a href="https://github.com/nametake/protoc-gen-gohttp" target="_blank" rel="noopener">protoc-gen-grpc-gohttp</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近，项目需要用到protobuf来定义消息，但是我们需要一个更灵活的代码片段，如何通过&lt;code&gt;proto&lt;/code&gt;文件来创建自定义的代码呢？&lt;br&gt;可以通过proto的&lt;code&gt;plugin&lt;/code&gt;对方式来自己是一个&lt;code&gt;proto-gen&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;在网上看了一些教程，发现有一些教程已经过时了，而且过于片面，没有把整套思想很好的说明。并且也有一些功能点并没有完全实现。&lt;br&gt;这里总结一下相关的内容，并且说一下最近实现的一个插件。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;对于已经了解大概&lt;code&gt;proto&lt;/code&gt;的人来说，相对简单，但是如果是&lt;code&gt;自定义option&lt;/code&gt;呢？你又了解吗？&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>【Golang】- []byte在结构体的友好可读性处理</title>
    <link href="http://blog.crazylaw.cn/2021/09/03/Golang/[]byte%E5%9C%A8%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%8F%8B%E5%A5%BD%E5%8F%AF%E8%AF%BB%E6%80%A7%E5%A4%84%E7%90%86/"/>
    <id>http://blog.crazylaw.cn/2021/09/03/Golang/[]byte%E5%9C%A8%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%8F%8B%E5%A5%BD%E5%8F%AF%E8%AF%BB%E6%80%A7%E5%A4%84%E7%90%86/</id>
    <published>2021-09-03T03:16:51.000Z</published>
    <updated>2021-09-03T05:55:43.831Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>有些时候，我们会发现，<code>[]byte</code> 类型在 <code>struct</code> 中，是必不可少的结构体，因为用了<code>[]byte</code>代表可以存储字节数据，也可以叫做二进制安全的存储。代表可以存储任何数据。</p><p>如何才能做到在序列化json的情况下，可以<code>Println</code>出一个可读性的在<code>struct</code>的<code>[]byte</code>呢？</p><a id="more"></a><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>最近我在开发我们的部门的配置服务，需要提供一个配置工具。里面设计的一个struct，有一个<code>[]byte</code>类型，就是用来存储实际数据的。但是我们在这里的时候，我们有一个查看原始数据的需求，因为我们的数据经过了<code>加密</code>，和<code>压缩</code>，最终才会放到该结构体。</p><p>简化结构体，这里列举一下例子：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> V []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Value <span class="keyword">struct</span> &#123;</span><br><span class="line">PublishTime     <span class="keyword">int64</span></span><br><span class="line">PublishDateTime <span class="keyword">string</span></span><br><span class="line">Value           V</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们看到，我们这里的<code>Value</code>实际就是一个<code>[]byte</code>，我们把这个结构体经过<code>json.Marshal</code>之后推送到远端<code>kv</code>服务中，一切都正常。</p><p>但是当我们需要查看的时候，就需要从远端的<code>kv</code>拉回来，经过<code>json.Unmarsha</code>处理，这个时候，我们会发现：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"PublishTime"</span>:<span class="number">1630636657</span>,<span class="attr">"PublishDateTime"</span>:<span class="string">"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101"</span>,<span class="attr">"Value"</span>:<span class="string">"MTIzCg=="</span>&#125;</span><br></pre></td></tr></table></figure><p>这里，我们看到<code>Value</code>是一个经过<code>base64</code>加密过的数据，这是因为默认情况下<code>[]byte</code>将会把数据经过<code>base64</code>变成<code>字符串</code>来符合<code>json数据类型</code>。那么我们有什么版本让他显示出原来真是的数据呢？</p><p>这里我使用了一个方案，借助多一个数据结构，对<code>T V</code>进行一个<code>重组</code>。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> VO []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ValueReadable <span class="keyword">struct</span> &#123;</span><br><span class="line">PublishTime     <span class="keyword">int64</span></span><br><span class="line">PublishDateTime <span class="keyword">string</span></span><br><span class="line">Value           VO</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *VO)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> *b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *VO)</span> <span class="title">UnmarshalJSON</span><span class="params">(input []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">*b = input</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>定义多一个<code>大体上一致</code>的结构体，注意此时的<code>Value</code>不再是<code>V</code>，而是<code>VO</code>，我们对<code>VO</code>自定义json序列化的行为，那就是把<code>base64</code>的行为给去掉。</p><p>这样子，我们得到的数据就会是</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"PublishTime"</span>:<span class="number">1630636657</span>,<span class="attr">"PublishDateTime"</span>:<span class="string">"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101"</span>,<span class="attr">"Value"</span>:<span class="number">123</span>&#125;</span><br></pre></td></tr></table></figure><p>细心的朋友一定发现了问题所在，那就是<code>Value</code>和<code>ValueReadable</code>怎么进行转换。</p><p>因为你存的时候是通过<code>Value</code>进行<code>marshal</code>的，那么你的<code>unmarsha</code>行为一定要对应才能解到正确的数据。</p><p>所以这里，就是我们的一个重点，我们需要借助<code>unsafe.Pointer</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// because []byte in struct will be base64encode</span></span><br><span class="line"><span class="comment">// so you will see such as "Ik1USXpDZz09Ig=="</span></span><br><span class="line"><span class="comment">// we should base64decode, so we custom a struct do not base64encode</span></span><br><span class="line"><span class="comment">// struct type transform use unsafe.Pointer</span></span><br><span class="line">p := unsafe.Pointer(&amp;persistenceValue)</span><br><span class="line">vr := (*config_sync.ValueReadable)(p)</span><br><span class="line">tv, err := json.Marshal(vr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="keyword">string</span>(tv))</span><br></pre></td></tr></table></figure><p>我们利用<code>unsafe</code>的<code>指针</code>数据类型，进行一个强制转换，为什么会成功呢，因为在内存对齐的结构上，这2个对象的内存是一致的，所以我们就可以进行强制转换，而不用担心有<code>panic</code>的产生。这只是<code>unsafe</code>指针的一个灵活运用。但是可以达到我们的目的，十分的有效果。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"PublishTime"</span>:<span class="number">1630636657</span>,<span class="attr">"PublishDateTime"</span>:<span class="string">"2021-09-03 02:37:37.8693941 +0000 UTC m=+0.015759101"</span>,<span class="attr">"Value"</span>:<span class="number">123</span>&#125;</span><br></pre></td></tr></table></figure><p>转换后，就可以看到我原本的数据了 <code>123</code>.</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;有些时候，我们会发现，&lt;code&gt;[]byte&lt;/code&gt; 类型在 &lt;code&gt;struct&lt;/code&gt; 中，是必不可少的结构体，因为用了&lt;code&gt;[]byte&lt;/code&gt;代表可以存储字节数据，也可以叫做二进制安全的存储。代表可以存储任何数据。&lt;/p&gt;
&lt;p&gt;如何才能做到在序列化json的情况下，可以&lt;code&gt;Println&lt;/code&gt;出一个可读性的在&lt;code&gt;struct&lt;/code&gt;的&lt;code&gt;[]byte&lt;/code&gt;呢？&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>【kubernetes】k8s-docker-for-mac-磁盘挂载</title>
    <link href="http://blog.crazylaw.cn/2021/08/18/k8s/k8s-docker-for-mac-%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD/"/>
    <id>http://blog.crazylaw.cn/2021/08/18/k8s/k8s-docker-for-mac-%E7%A3%81%E7%9B%98%E6%8C%82%E8%BD%BD/</id>
    <published>2021-08-18T09:47:30.000Z</published>
    <updated>2021-08-18T14:45:43.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上一次，我们说到了<code>docker-for-mac</code> 已经内置了最小化的k8s。我们在本地开发的时候，或多或少希望<code>yaml配置</code>是最接近线上环境的配置。</p><p>因此，上一次，教会了大家，如何在mac上开启nfs,把我们的pv和本地mac的nfs进行一个通信。</p><p>这一次，我们来聊聊<code>docker-for-mac</code>磁盘挂在的相关内容。</p><a id="more"></a><h2 id="虚拟机"><a href="#虚拟机" class="headerlink" title="虚拟机"></a>虚拟机</h2><p><code>Docker for Mac</code>是一个原生的苹果应用程序，被安装到 <code>/Application 目录</code>，安装时会创建 <code>/usr/local/bin</code> 目录下的 <code>docker、docker-compose</code> 符号链接。</p><p><code>Docker for Mac</code> 使用通过 Hypervisor.framework 提供的轻量级的 xhyve 虚拟化技术<br><code>Docker for Mac</code> <code>不使用</code> <code>docker-machine</code> 管理虚拟机<br><code>Docker for Mac</code> <code>不通过 TCP 端口通信</code>，反而使用 <code>docker.sock</code> 套接字文件通信（实际上是将 /var/tmp 目录挂载到了虚拟机中，虚拟机在其中生成套接字文件）</p><p>但是尽管如此，你可以理解为还是存在虚拟机的。这个虚拟机的作用就是允许在macos上运行docker。</p><h2 id="docker-for-mac"><a href="#docker-for-mac" class="headerlink" title="docker for mac"></a>docker for mac</h2><p><img src="/images/k8s/docker-for-mac-1.png" alt="docker for mac 1"></p><p>这个就是我们的<code>docker-for-mac</code>的桌面版客户端。</p><p><img src="/images/k8s/docker-for-mac-2.png" alt="docker for mac 2"></p><p>根据上面这个图，我们可以发现，所有的镜像都存储在。</p><ul><li><code>/Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/data</code> (记得修改为自己的路径，就是我这里的<code>caiwenhui</code>)</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ll /Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/data</span><br><span class="line">total 103652496</span><br><span class="line">-rw-r--r--  1 caiwenhui  staff    96G  8 18 20:21 Docker.raw</span><br><span class="line"></span><br><span class="line">➜  ~ head -n 10 /Users/caiwenhui/Library/Containers/com.docker.docker/Data/vms/0/data/Docker.raw</span><br><span class="line">�D��?���</span><br><span class="line">        U�`�&amp;3�Ѻ`1O�� �ha�ha��S�J�#`</span><br><span class="line">                                     &lt;�kD*�&lt;O5K�VS�~~�/var/lib��B�uK����J�1�@</span><br><span class="line">                                                                             ]�#`</span><br><span class="line">���p��q  Z�]J,)NL������w</span><br><span class="line">)��%�</span><br><span class="line">z?fw</span><br><span class="line">    G/�%|gCԬ?f�u</span><br><span class="line">                )</span><br><span class="line">)�% �.?f</span><br><span class="line">  �% |?f) �% ��?f)� (L � X %X i;�F!)D0 M %@�")� �� ֑@#)� � �f�H$)" - :,�%)�</span><br><span class="line"> �e LE��()"h �a ��SnU&amp;43�%�C4k�?f �% &#123; �% �D WA T қ                            �� ��v&amp;)�" t� FW�D') &#125;</span><br><span class="line">�1 &amp;� � �</span><br><span class="line">       (A �� =�97 �; �&amp;N � _Z˭� � ��</span><br><span class="line"> �% F?f</span><br><span class="line">      �0 �V��</span><br><span class="line">           s</span><br><span class="line"> �% ԇ �% X� �% s�?f �RiDX0�m�&#125;�u �</span><br><span class="line">                                  �@$���w?�  �% ��?f  �% ��?f. � Շ�</span><br><span class="line"> �% MS?f</span><br><span class="line">         W s �w� � ! �o�</span><br><span class="line">  �% E�?f  �% n�?f</span><br></pre></td></tr></table></figure><p>我们这里可以看到，这个文件，占用了<code>96G</code>，就是我所分配的磁盘大小。并且这是一个经过了字节压缩的二进制文件。</p><p><img src="/images/k8s/docker-for-mac-3.png" alt="docker for mac 3"></p><p><img src="/images/k8s/docker-for-mac-4.png" alt="docker for mac 4"></p><p>这张图，算得上是我们今天的重点。</p><p>使用文件共享允许 Mac 上的本地目录与 Linux 容器共享。默认情况下<code>/Users</code>，<code>/Volume</code>、<code>/private</code>、<code>/tmp</code>和<code>/var/folders</code>目录是共享的。如果您的项目在此目录之外，则必须将其添加到列表中。否则，您可能会在运行时得到<code>Mounts denied</code>或<code>cannot start service</code>出错。</p><p>因此，我们可以看到在默认情况下，有几个目录是已经被共享的了。我们重点需要关注的是<code>/Users</code>目录，因为我们常常把我们的所有个人用户相关的东西，都会放在对应用户下，就我而言，我会把所有的代码都在 <code>/Users/caiwenhui/www</code> 下，这也意味着，我的所有代码，都将会被<code>虚拟机</code>同步到<code>linux系统</code>中，也正是因此，当你在MAC系统下，执行<code>docker run -v $(PWD):/www xxx</code>之类的命令的时候，你可以成功的挂载到容器中。<strong>如果你把挂载的目录放在上述的几个目录之外</strong>，docker命令将会<code>挂载失败</code>。</p><p>也是因为这个原因，你会发现，当你的代码，在下载大量依赖，或者在构建一堆索引的时候，或者你的<code>/Users</code>目录下有很多文件在变动的时候，你会发现你的<code>CPU</code>变成异常的高，而且会特别卡，可能你会觉得怎么那么卡。如果你不去查看哪个进程占用那么多cpu的话，你永远不会知道，其实大多数，显示出来都是docker的<code>虚拟机</code>占用的cpu为大头就是因为这个原因。</p><h2 id="获取虚拟机shell"><a href="#获取虚拟机shell" class="headerlink" title="获取虚拟机shell"></a>获取虚拟机shell</h2><p>既然，我们知道了上述的共享文件了，那么我们就会想知道，我要怎么去看，怎么去调试，或者我有什么更深的理解呢？</p><p>其实是有的，例如，我想看看，整个虚拟化技术，都挂载了什么数据卷构成我们的文件系统。</p><p>我们知道<code>MacOS</code>上的<code>Docker Desktop for mac</code>实际上是在Linux虚拟机中运行的Docker容器，这对于macOS主机上使用Docker<code>多了一层虚拟化</code>。有些情况下，我们需要能够访问这个Linux虚拟机，以便实现一些<code>hack</code>操作。</p><h3 id="netcat"><a href="#netcat" class="headerlink" title="netcat"></a>netcat</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ll ~/Library/Containers/com.docker.docker/Data/debug-shell.sock</span><br><span class="line">srwxr-xr-x  1 caiwenhui  staff     0B  8 16 21:31 /Users/caiwenhui/Library/Containers/com.docker.docker/Data/debug-shell.sock</span><br></pre></td></tr></table></figure><p>我们可以看到，这里有一个名字叫<code>debug-shell.sock</code>的文件，这是一个可执行的sock文件。</p><p>使用 <code>nc</code> 命令连接Docker的<code>debug-shell socket</code>文件:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ nc -U ~/Library/Containers/com.docker.docker/Data/debug-shell.sock</span><br><span class="line">/ # ^[[49;5R</span><br></pre></td></tr></table></figure><blockquote><p>显示的提示符比较奇怪，不过不影响使用</p></blockquote><p>我们使用 <code>df -h</code> 命令可以看到Docker虚拟机的存储挂载:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/ # ^[[49;5Rdf -h</span><br><span class="line">df -h</span><br><span class="line">Filesystem                Size      Used Available Use% Mounted on</span><br><span class="line">overlay                   3.9G      4.0K      3.9G   0% /</span><br><span class="line">tmpfs                     3.9G      8.0K      3.9G   0% /containers/onboot/000-dhcpcd/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/001-sysfs/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/002-sysctl/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/003-format/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/004-extend/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/005-mount/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/006-metadata/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/007-services0/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/008-services1/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/009-swap/tmp</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/010-mount-docker/tmp</span><br><span class="line">/dev/vda1                94.2G     48.2G     41.2G  54% /containers/services</span><br><span class="line">/dev/vda1                94.2G     48.2G     41.2G  54% /containers/services/docker</span><br><span class="line">tmpfs                     3.9G      4.0K      3.9G   0% /containers/services/acpid/tmp</span><br><span class="line">overlay                   3.9G      4.0K      3.9G   0% /containers/services/acpid/rootfs</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/services/binfmt/tmp</span><br><span class="line">overlay                   3.9G         0      3.9G   0% /containers/services/binfmt/rootfs</span><br><span class="line">tmpfs                     3.9G      8.0K      3.9G   0% /containers/services/dhcpcd/tmp</span><br><span class="line">overlay                   3.9G      8.0K      3.9G   0% /containers/services/dhcpcd/rootfs</span><br><span class="line">tmpfs                     3.9G      4.0K      3.9G   0% /containers/services/diagnose/tmp</span><br><span class="line">overlay                   3.9G      4.0K      3.9G   0% /containers/services/diagnose/rootfs</span><br><span class="line">overlay                   3.9G      4.0K      3.9G   0% /containers/services/diagnose/rootfs</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /containers/onboot/011-bridge/tmp</span><br><span class="line">tmpfs                    64.0M         0     64.0M   0% /dev</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/resolvconf/resolv.conf</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/config</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/containerd</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/guest-services</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/host-services</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /run/resolvconf/resolv.conf</span><br><span class="line">tmpfs                     3.9G         0      3.9G   0% /sys/fs/cgroup</span><br><span class="line">/dev/vda1                94.2G     48.2G     41.2G  54% /var/lib/containerd</span><br><span class="line">/dev/vda1                94.2G     48.2G     41.2G  54% /var/lib/docker</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /var/run</span><br><span class="line">tmpfs                   796.2M    528.0K    795.7M   0% /var/run/linuxkit-containerd/containerd.sock</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>使用命令 <code>exit</code> 或者<code>^C</code> 可以退出这个shell</p><p>进入shell，可以执行 <code>. /etc/profile</code> 获得环境</p><h3 id="nsenter"><a href="#nsenter" class="headerlink" title="nsenter"></a>nsenter</h3><p>使用nsenter从容器内部进入host主机的<code>名字空间(namespace)</code>，但是对文件系统是只读</p><p>另外一种巧妙的方法是运行一个debian容器，然后在这个<code>debian</code>容器中执行 <code>nsenter</code> 通过 <code>pid=host</code> 来实现进入到运行 <code>Docker4Mac</code> 的<code>mini VM</code>的进程空间，这样就相当于进入了macOS的Docker虚拟机</p><p>在这个运行的debian容器中通过 nsenter 进入到host主机，也就是Docker VM名字空间以后，就可以看到虚拟机的提示符:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker run -it --rm --privileged --pid=host debian nsenter -t 1 -m -u -n -i bash</span><br><span class="line">bash-5.0#</span><br></pre></td></tr></table></figure><p>我们可以在这个Docker VM中执行网络检查</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 brd 127.255.255.255 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 02:50:00:00:00:01 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.65.3/24 brd 192.168.65.255 scope global dynamic noprefixroute eth0</span><br><span class="line">       valid_lft 1576sec preferred_lft 136sec</span><br><span class="line">    inet6 fe80::50:ff:fe00:1/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: tunl0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">4: ip6tnl0@NONE: &lt;NOARP&gt; mtu 1452 qdisc noop state DOWN group default qlen 1000</span><br><span class="line">    link/tunnel6 :: brd ::</span><br><span class="line">5: services1@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 42:2f:8d:45:a3:03 brd ff:ff:ff:ff:ff:ff link-netns services</span><br><span class="line">    inet 192.168.65.4 peer 192.168.65.5/32 scope global services1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::402f:8dff:fe45:a303/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">7: br-3a4b2ff7a5cb: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:11:9a:3a:8f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.7.1/24 brd 192.168.7.255 scope global br-3a4b2ff7a5cb</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">8: br-ef48d4809428: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:10:cb:22:b6 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-ef48d4809428</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">9: br-f6b05f844262: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:f4:ec:b5:c4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.19.0.1/16 brd 172.19.255.255 scope global br-f6b05f844262</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">10: br-ff0c8e959ac0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:48:7f:f8:bb brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.110.1/24 brd 192.168.110.255 scope global br-ff0c8e959ac0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:b9:db:7e:59 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:b9ff:fedb:7e59/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>因为信息比较多，我们重点关注几个网卡信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 02:50:00:00:00:01 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.65.3/24 brd 192.168.65.255 scope global dynamic noprefixroute eth0</span><br><span class="line">       valid_lft 1576sec preferred_lft 136sec</span><br><span class="line">    inet6 fe80::50:ff:fe00:1/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:b9:db:7e:59 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:b9ff:fedb:7e59/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure><p><img src="/images/k8s/docker-for-mac-5.png" alt="docker for mac 5"></p><p>上面的信息，结合来看，我们在<code>docker-for-mac</code>客户端设置了我们的虚拟机的网段 <code>192.168.65.0/24</code>，结合<code>eth0</code>和<code>docker0</code>这2个网卡信息，我们会发现，<code>eth0</code> 的 <code>192.168.65.3</code>, 就是我们这是的网段的信息，所以，这个虚拟机和macOS物理主机上对应的IP地址 <code>192.168.65.1</code> 对应，也就是说，如果我们使用 <code>NFS 方式</code>挂载物理主机上的NFS卷，访问的NFS服务器端地址就是这样获得的。</p><p>这里还可以看到在<code>Docker VM</code>上运行的<code>Docker网络</code>是 <code>172.17.xx.xx/16</code> ，是一个<code>NAT网络</code>，我们可以看到在<code>Docker VM端</code>分配的IP地址是 <code>172.17.0.1</code> 。这也验证了我们的<code>Docker VM</code>上实际上有<code>2个网络</code>。</p><ul><li><code>192.168.65.x/24</code> =&gt; 和<code>物理主机macOS</code>连接的NAT网络，用于虚拟机</li><li><code>172.17.x.x/16</code> =&gt; 和<code>Docker0</code>连接的NAT网络，用于容器</li></ul><p>在Docker容器中，通过两层NAT，依然可以访问外界Internet。不过，反过来，外部需要访问Docker容器就比较麻烦了，需要做<code>端口映射</code>。</p><h2 id="挂载"><a href="#挂载" class="headerlink" title="挂载"></a>挂载</h2><p>我们前面说到了，当你通过 <code>docker run -v</code>的时候，你可以指定在<code>共享目录</code>下的所有文件下，进行挂载进去。那么我们反过来想一下，既然是共享目录的话，那么容器是如何做到查找这些目录的呢？</p><p>通过<code>mount -l</code>，我们可以看到挂载点。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# mount -l</span><br><span class="line">rootfs on / type tmpfs (ro,relatime)</span><br><span class="line">proc on /proc type proc (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">tmpfs on /run type tmpfs (rw,nosuid,nodev,noexec,relatime,size=815300k,mode=755)</span><br><span class="line">tmpfs on /tmp type tmpfs (rw,nosuid,nodev,noexec,relatime,size=815300k)</span><br><span class="line">tmpfs on /var type tmpfs (rw,nosuid,nodev,noexec,relatime,mode=755)</span><br><span class="line">dev on /dev type devtmpfs (rw,nosuid,noexec,relatime,size=4008488k,nr_inodes=1002122,mode=755)</span><br><span class="line">mqueue on /dev/mqueue type mqueue (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">shm on /dev/shm type tmpfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">devpts on /dev/pts type devpts (rw,nosuid,noexec,relatime,gid=5,mode=620,ptmxmode=000)</span><br><span class="line">sysfs on /sys type sysfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">securityfs on /sys/kernel/security type securityfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">debugfs on /sys/kernel/debug type debugfs (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">fusectl on /sys/fs/fuse/connections type fusectl (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">pstore on /sys/fs/pstore type pstore (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">none on /sys/fs/bpf type bpf (rw,nodev,relatime)</span><br><span class="line">binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,nosuid,nodev,noexec,relatime)</span><br><span class="line">cgroup_root on /sys/fs/cgroup type tmpfs (rw,nosuid,nodev,noexec,relatime,size=10240k,mode=755)</span><br><span class="line">cpuset on /sys/fs/cgroup/cpuset type cgroup (rw,nosuid,nodev,noexec,relatime,cpuset)</span><br><span class="line">cpu on /sys/fs/cgroup/cpu type cgroup (rw,nosuid,nodev,noexec,relatime,cpu)</span><br><span class="line">cpuacct on /sys/fs/cgroup/cpuacct type cgroup (rw,nosuid,nodev,noexec,relatime,cpuacct)</span><br><span class="line">blkio on /sys/fs/cgroup/blkio type cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">memory on /sys/fs/cgroup/memory type cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">devices on /sys/fs/cgroup/devices type cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">freezer on /sys/fs/cgroup/freezer type cgroup (rw,nosuid,nodev,noexec,relatime,freezer)</span><br><span class="line">net_cls on /sys/fs/cgroup/net_cls type cgroup (rw,nosuid,nodev,noexec,relatime,net_cls)</span><br><span class="line">perf_event on /sys/fs/cgroup/perf_event type cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">net_prio on /sys/fs/cgroup/net_prio type cgroup (rw,nosuid,nodev,noexec,relatime,net_prio)</span><br><span class="line">hugetlb on /sys/fs/cgroup/hugetlb type cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">pids on /sys/fs/cgroup/pids type cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>可以看到，我们这里有大量的挂载点，这些挂载点，组合成了一个独立的文件系统，或者各种命名空间。</p><p>现在有一个需求。例如，我们知道在使用k8s的时候，当我们用<code>pv</code>的<code>type</code>为<code>hostPath</code>的时候，是可以做到持久化数据磁盘的，那么我能不能做到，数据存放在<code>Docker VM 非共享目录</code>中呢？</p><p>就是我的物理主机，并不希望同步这些数据。这些数据仅仅只需要存在<code>Docker VM</code>中就好了。</p><p>当然，这个场景就是我们经常说，我们想要看一些容器的配置或者目录的时候，会发现输出的路径，在我们的宿主机上找不到，为什么会这样子？难道是出错了吗？其实只是这些文件都在<code>Docker VM</code>中，其实就是因为这个原因导致的。只要我们进入到 <code>Docker VM</code>就可以看到这些文件。</p><p>例如，以我目前的例子为例子，我需要采集我本地所有<code>k8s-pods</code>的输出在终端的日志信息，我想通过<code>promtail</code>来进行日志采集，然后通过<code>loki</code>作为存储和查询服务器，再通过<code>grafna</code>来进行展示。我们的服务以前台的方式进行启动，所以我们那么首先我需要解决的第一个问题，就是pods的标准输出到哪里？后来发现<code>/var/log/pods/</code>。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# ls -l /var/log/pods/</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 18 09:05 default_dev-grafana-7cd4c89fd4-wdkpb_cf869741-be0d-44d2-b776-3239dd276069</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 18 09:05 default_dev-loki-statefulset-0_1d34dcac-a763-478a-b17b-addb082462ef</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 18 09:05 default_dev-loki-statefulset-1_c82d61e9-c66f-4b6a-960a-a8f7a1d5a8e2</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 18 09:05 default_dev-promtail-n6jgs_51afda31-be9c-4377-8167-8e29e991d9b0</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_coredns-558bd4d5db-g2m9h_67ec7c7f-2e48-4cd7-8298-86295073072b</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_coredns-558bd4d5db-jk9bp_b9d8b64f-dda8-426a-8f55-029298828333</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_etcd-docker-desktop_5d9d97b8d8daed31d6fd5c6d386c29c5</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_kube-apiserver-docker-desktop_6fcd2fd42808f86960df2a06a72d6dc0</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_kube-controller-manager-docker-desktop_bed77ee1871d9eabd1710836ad671f32</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_kube-proxy-4wbs6_8bece9c8-e5fb-41f5-8869-2d408e71ba31</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_kube-scheduler-docker-desktop_a52842863dff28cb2f7d4171a9f614a0</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_storage-provisioner_79a3e8e5-6a93-43c1-abf3-c916384a4018</span><br><span class="line">drwxr-xr-x    3 root     root            60 Aug 16 13:32 kube-system_vpnkit-controller_3742d607-ea8f-43df-aecf-4f925accbc3e</span><br></pre></td></tr></table></figure><p>我们随便找一个pods，去查看日志。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bash-5.0# tail -n 10 /var/log/pods/default_dev-grafana-7cd4c89fd4-wdkpb_cf869741-be0d-44d2-b776-3239dd276069/grafana/0.log</span><br><span class="line">&#123;"log":"&#123;\"@level\":\"debug\",\"@message\":\"datasource: registering query type handler\",\"@timestamp\":\"2021-08-18T09:05:05.385825Z\",\"queryType\":\"node_graph\"&#125;\n","stream":"stderr","time":"2021-08-18T09:05:05.3860495Z"&#125;</span><br><span class="line">&#123;"log":"&#123;\"@level\":\"debug\",\"@message\":\"datasource: registering query type fallback handler\",\"@timestamp\":\"2021-08-18T09:05:05.385855Z\"&#125;\n","stream":"stderr","time":"2021-08-18T09:05:05.3860803Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:05:05+0000 lvl=info msg=\"HTTP Server Listen\" logger=http.server address=[::]:3000 protocol=http subUrl= socket=\n","stream":"stdout","time":"2021-08-18T09:05:05.3939314Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:07:52+0000 lvl=eror msg=\"Failed to look up user based on cookie\" logger=context error=\"user token not found\"\n","stream":"stdout","time":"2021-08-18T09:07:52.5402974Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:07:52+0000 lvl=info msg=\"Request Completed\" logger=context userId=0 orgId=0 uname= method=GET path=/dashboard/new status=302 remote_addr=192.168.65.3 time_ms=0 size=29 referer=\n","stream":"stdout","time":"2021-08-18T09:07:52.5403468Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:07:56+0000 lvl=info msg=\"Successful Login\" logger=http.server User=admin@localhost\n","stream":"stdout","time":"2021-08-18T09:07:56.6167821Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:08:00+0000 lvl=info msg=\"Request Completed\" logger=context userId=1 orgId=1 uname=admin method=GET path=/login status=302 remote_addr=192.168.65.3 time_ms=11 size=24 referer=\n","stream":"stdout","time":"2021-08-18T09:08:00.7292107Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:09:50+0000 lvl=info msg=\"Request Completed\" logger=context userId=1 orgId=1 uname=admin method=GET path=/api/datasources/proxy/1/loki/api/v1/query_range status=400 remote_addr=192.168.65.3 time_ms=2 size=57 referer=\"http://localhost:3000/dashboard/new?editPanel=2\u0026orgId=1\"\n","stream":"stdout","time":"2021-08-18T09:09:50.7530735Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:14:53+0000 lvl=eror msg=\"Data proxy error\" logger=data-proxy-log userId=1 orgId=1 uname=admin path=/api/datasources/proxy/1/loki/api/v1/label/filename/values remote_addr=192.168.65.3 referer=\"http://localhost:3000/d/UWO8RT7nk/new-dashboard-copy?editPanel=2\u0026viewPanel=2\u0026orgId=1\" error=\"http: proxy error: EOF\"\n","stream":"stdout","time":"2021-08-18T09:14:53.0497419Z"&#125;</span><br><span class="line">&#123;"log":"t=2021-08-18T09:14:53+0000 lvl=eror msg=\"Request Completed\" logger=context userId=1 orgId=1 uname=admin method=GET path=/api/datasources/proxy/1/loki/api/v1/label/filename/values status=502 remote_addr=192.168.65.3 time_ms=79695 size=0 referer=\"http://localhost:3000/d/UWO8RT7nk/new-dashboard-copy?editPanel=2\u0026viewPanel=2\u0026orgId=1\"\n","stream":"stdout","time":"2021-08-18T09:14:53.0502414Z"&#125;</span><br></pre></td></tr></table></figure><p>现在，我们知道了日志是存储在这里了，那么我们就可以知道，在<code>Docker VM</code>中，我们只需要挂载<code>/var/log/pods</code>到我们的容器<code>promtail</code>中，然后进行采集再推送到<code>loki</code>，就可以通过<code>grafna</code>查询了。</p><p>这个思路是没问题的，那么我们再往深程度的角度想，那么这个时候，我们的<code>k8s-pv-type</code>应该填什么呢？刚才不是说了<code>hostPath</code>是可以持久化到本地吗？但是那是针对物理主机<code>macos</code>来说的，况且这个目录，我们并非在<code>Docker VM</code>之下，这就回到了我们上面说的，在<code>Docker VM</code>存在，在<code>物理主机</code>不存在的需求。</p><p>那么我们这个时候，其实还是可以使用<code>hostPath</code>的，理由很简单，因为k8s会识别路径，如果是在共享目录下的话，那么他会从共享目录的数据卷中找到对应的磁盘路径，如果不在共享目录下的，则从<code>Docker VM</code>中查找，因此，这就是解开了我们这个疑惑了。可以大胆的放心使用<code>hostPath</code>来创建<code>pv</code>资源。</p><p>最后，附上一张最终的效果图：</p><p><img src="/images/k8s/docker-for-mac-6.png" alt="docker-for-mac-6"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;上一次，我们说到了&lt;code&gt;docker-for-mac&lt;/code&gt; 已经内置了最小化的k8s。我们在本地开发的时候，或多或少希望&lt;code&gt;yaml配置&lt;/code&gt;是最接近线上环境的配置。&lt;/p&gt;
&lt;p&gt;因此，上一次，教会了大家，如何在mac上开启nfs,把我们的pv和本地mac的nfs进行一个通信。&lt;/p&gt;
&lt;p&gt;这一次，我们来聊聊&lt;code&gt;docker-for-mac&lt;/code&gt;磁盘挂在的相关内容。&lt;/p&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>【kubernetes】k8s-glp</title>
    <link href="http://blog.crazylaw.cn/2021/08/16/k8s/k8s-glp/"/>
    <id>http://blog.crazylaw.cn/2021/08/16/k8s/k8s-glp/</id>
    <published>2021-08-16T14:45:30.000Z</published>
    <updated>2021-08-19T02:58:22.026Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们经常有一些日志采集的需求，采集完毕之后，希望有一个中心WebUi来方便的查看很多不同节点，不同服务的日志。</p><p>按照传统的方式，一般都是会采用<code>ELK</code>,就是<code>elasticsearch+logstash+kibana</code>，但是由于<code>JVM</code>对资源的消耗太大，加上<code>ES</code>是通过全文搜索的方式需要进行倒排索引的分词，所以这些功能几乎是用不上，我们查询日志一般都可以通过定制常规的<code>label</code>信息，然后搜索即可，大可不必进行分词的行为。尽管后续又由于<code>logstash</code>的资源占用过大问题，作者又利用go语言开发出了<code>filebeat</code>，来辅助日志采集体系，后续加入了某公司之后，被集成到了<code>beats</code>的项目中，因为也可以交<code>efk/ebk</code>，都可以。</p><p>鉴于这一点，随之而来的就是<code>GLP</code>，就是<code>grafna+loki+promtail</code>。这是一套完全基于go语言生态写的，更贴近云原生。一套体系都是经过<code>grafna lab</code>云原生孕育而生。资源占用少，效率高，能够解决痛点，天生支持k8s等等特性。都让他成为新的崛起之秀。</p><a id="more"></a><h2 id="Kubernetes-Logs"><a href="#Kubernetes-Logs" class="headerlink" title="Kubernetes Logs"></a>Kubernetes Logs</h2><p><img src="/images/k8s/glp-1.webp" alt="glp-1"></p><p>默认情况下，容器日志会存储在 <code>/var/log/pods</code> 路径下。</p><p>每个文件夹对应一个 Pod，Pod 下级目录为容器名，再下级即为容器日志。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tree kube-system_kube-flannel-ds-amd64-9x66j_28e71490-d614-4cd8-9ea7-af23cc7b9bff/</span><br><span class="line"></span><br><span class="line">kube-system_kube-flannel-ds-amd64-9x66j_28e71490-d614-4cd8-9ea7-af23cc7b9bff/</span><br><span class="line">├── install-cni</span><br><span class="line">│   └── 3.log -&gt; /data/docker/containers/6accaa2d6890df8ca05d1f40aaa9b8da69ea0a00a8e4b07a0949cdc067843e37/6accaa2d6890df8ca05d1f40aaa9b8da69ea0a00a8e4b07a0949cdc067843e37-json.log</span><br><span class="line">└── kube-flannel</span><br><span class="line">    ├── 2.log -&gt; /data/docker/containers/9e8eea717cc3efd0804900a53244a32286d9e04767f76d9c8a8cc3701c83ece5/9e8eea717cc3efd0804900a53244a32286d9e04767f76d9c8a8cc3701c83ece5-json.log</span><br><span class="line">    └── 3.log -&gt; /data/docker/containers/06389981d26cbe60328cd5a46af7b003c8d687d1c411704784aa12d4d82672b8/06389981d26cbe60328cd5a46af7b003c8d687d1c411704784aa12d4d82672b8-json.log</span><br></pre></td></tr></table></figure><p>日志文件 <code>kube-flannel/3.log</code> 只是对 <code>/var/lib/docker/containers/***/***.log</code> 文件的<code>软链接</code>，本质上还是 Docker 维护日志， k8s 对其<code>引用</code>而已。</p><p>日志是 JSON 格式的，每一行包含如下三个信息：</p><ul><li><code>log</code>：日志内容</li><li><code>stream</code>：stderr(异常输出)、stdout(正常输出)</li><li><code>time</code>：时间</li></ul><p><code>/var/lib/docker/containers</code> 是通过 <code>/etc/docker/daemon.json</code> 配置的，并且也是默认路径。</p><h2 id="grafna"><a href="#grafna" class="headerlink" title="grafna"></a>grafna</h2><p>由于k8s的网络架构的原因，我们访问的时候都是通过访问<code>service</code>的名字的，和docker-compose下的访问方式不太一样。</p><p>例如.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  whiteccinn.github.io git:(master) ✗ kubectl get svc</span><br><span class="line">NAME           TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">dev-grafana    LoadBalancer   10.102.248.247   localhost     3000:32695/TCP   17h</span><br><span class="line">dev-loki       ClusterIP      10.106.32.224    &lt;none&gt;        3100/TCP         17h</span><br><span class="line">dev-promtail   ClusterIP      10.108.116.190   &lt;none&gt;        9080/TCP         17h</span><br><span class="line">kubernetes     ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          3d9h</span><br></pre></td></tr></table></figure><p>那么，容器中的访问方式就是通过<code>dev-loki</code>, <code>dev-promtail</code>, <code>dev-grafna</code>来对pod进行访问，service的port再映射到对应的容器的port上</p><h3 id="depployment"><a href="#depployment" class="headerlink" title="depployment"></a>depployment</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">472</span></span><br><span class="line">        <span class="attr">supplementalGroups:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/grafana:7.5.2</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http-grafana</span></span><br><span class="line">              <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">readinessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">httpGet:</span></span><br><span class="line">              <span class="attr">path:</span> <span class="string">/robots.txt</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">              <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">          <span class="attr">livenessProbe:</span></span><br><span class="line">            <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">            <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">            <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">            <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">tcpSocket:</span></span><br><span class="line">              <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">750Mi</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">grafana-pv</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-pv</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">grafana-pvc</span></span><br></pre></td></tr></table></figure><h3 id="pvc"><a href="#pvc" class="headerlink" title="pvc"></a>pvc</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-grafana</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure><h2 id="loki"><a href="#loki" class="headerlink" title="loki"></a>loki</h2><h3 id="config-map"><a href="#config-map" class="headerlink" title="config-map"></a>config-map</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">loki-config.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">auth_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">      <span class="attr">http_listen_port:</span> <span class="number">3100</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">ingester:</span></span><br><span class="line">      <span class="attr">lifecycler:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">ring:</span></span><br><span class="line">          <span class="attr">kvstore:</span></span><br><span class="line">            <span class="attr">store:</span> <span class="string">inmemory</span></span><br><span class="line">          <span class="attr">replication_factor:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">final_sleep:</span> <span class="string">0s</span></span><br><span class="line">      <span class="attr">chunk_idle_period:</span> <span class="string">5m</span></span><br><span class="line">      <span class="attr">chunk_retain_period:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">schema_config:</span></span><br><span class="line">      <span class="attr">configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">from:</span> <span class="number">2020</span><span class="number">-05</span><span class="number">-15</span></span><br><span class="line">        <span class="attr">store:</span> <span class="string">boltdb</span></span><br><span class="line">        <span class="attr">object_store:</span> <span class="string">filesystem</span></span><br><span class="line">        <span class="attr">schema:</span> <span class="string">v11</span></span><br><span class="line">        <span class="attr">index:</span></span><br><span class="line">          <span class="attr">prefix:</span> <span class="string">index_</span></span><br><span class="line">          <span class="attr">period:</span> <span class="string">168h</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">storage_config:</span></span><br><span class="line">      <span class="attr">boltdb:</span></span><br><span class="line">        <span class="attr">directory:</span> <span class="string">/tmp/loki/index</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">filesystem:</span></span><br><span class="line">        <span class="attr">directory:</span> <span class="string">/tmp/loki/chunks</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">limits_config:</span></span><br><span class="line">      <span class="attr">enforce_metric_name:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">reject_old_samples:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">reject_old_samples_max_age:</span> <span class="string">168h</span></span><br></pre></td></tr></table></figure><h3 id="pvc-1"><a href="#pvc-1" class="headerlink" title="pvc"></a>pvc</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure><h3 id="service-1"><a href="#service-1" class="headerlink" title="service"></a>service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3100</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-loki</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">loki</span></span><br></pre></td></tr></table></figure><h3 id="statefulet"><a href="#statefulet" class="headerlink" title="statefulet"></a>statefulet</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">loki-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">loki</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">loki</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/loki:2.3.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-config.file=/mnt/config/loki-config.yml</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3100</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http-loki</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp/loki</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/config</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">loki-pvc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">loki-config</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">loki-config.yml</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">loki-config.yml</span></span><br></pre></td></tr></table></figure><h2 id="promtail"><a href="#promtail" class="headerlink" title="promtail"></a>promtail</h2><h3 id="config-map-1"><a href="#config-map-1" class="headerlink" title="config-map"></a>config-map</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">promtail-config.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">      <span class="attr">http_listen_port:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">grpc_listen_port:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">positions:</span></span><br><span class="line">      <span class="attr">filename:</span> <span class="string">/tmp/positions.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># clients:</span></span><br><span class="line">    <span class="comment"># - url: http://dev-loki:3100/loki/api/v1/push</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">containers</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">log_from:</span> <span class="string">static_pods</span></span><br><span class="line">          <span class="attr">__path__:</span> <span class="string">/var/log/pods/*/*/*.log</span></span><br><span class="line">      <span class="attr">pipeline_stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">docker:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;log_from="static_pods"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">filename</span></span><br><span class="line">              <span class="attr">expression:</span> <span class="string">"(?:pods)/(?P&lt;namespace&gt;\\S+?)_(?P&lt;pod&gt;\\S+)-\\S+?-\\S+?_\\S+?/(?P&lt;container&gt;\\S+?)/"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">namespace:</span></span><br><span class="line">              <span class="attr">pod:</span></span><br><span class="line">              <span class="attr">container:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;namespace!~"(default|kube-system)"&#125;'</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">          <span class="attr">drop_counter_reason:</span> <span class="string">no_use</span></span><br></pre></td></tr></table></figure><h3 id="daemonest"><a href="#daemonest" class="headerlink" title="daemonest"></a>daemonest</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">promtail</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">promtail</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">grafana/promtail:2.3.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-config.file=/mnt/config/promtail-config.yml</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-client.url=http://dev-loki:3100/loki/api/v1/push</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-client.external-labels=hostname=$(NODE_NAME)</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9080</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">http-promtail</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">containers-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/pods</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">pods-volume</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/config</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">fieldRef:</span></span><br><span class="line">                  <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">          <span class="attr">securityContext:</span></span><br><span class="line">            <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">            <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">containers-volume</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pods-volume</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/log/pods</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">promtail-config</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">promtail-config.yml</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">promtail-config.yml</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">          <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br></pre></td></tr></table></figure><p><strong>注意</strong>：上述提到 <code>/var/log/pods</code> 下的日志只是对 <code>/var/lib/docker/containers</code> 下日志的<code>软链接</code>，所以 Promtail 部署时需要<code>同时挂载这两个目录</code>。</p><h3 id="service-2"><a href="#service-2" class="headerlink" title="service"></a>service</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="string">http-promtail</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">promtail</span></span><br></pre></td></tr></table></figure><p>这些详情的参数就不解释的，这就是一整套<code>GLP</code>的k8s的部署文件。由于我这里是采用<code>kustomize</code>来部署的。所以会有多层结构。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜  kustomize git:(main) tree</span><br><span class="line">.</span><br><span class="line">├── base</span><br><span class="line">│   ├── grafna</span><br><span class="line">│   │   ├── deployment.yaml</span><br><span class="line">│   │   ├── kustomization.yml</span><br><span class="line">│   │   ├── pvc.yaml</span><br><span class="line">│   │   └── service.yaml</span><br><span class="line">│   ├── kustomization.yml</span><br><span class="line">│   ├── loki</span><br><span class="line">│   │   ├── config-map.yaml</span><br><span class="line">│   │   ├── kustomization.yml</span><br><span class="line">│   │   ├── pvc.yaml</span><br><span class="line">│   │   ├── service.yaml</span><br><span class="line">│   │   └── statefulset.yaml</span><br><span class="line">│   └── promtail</span><br><span class="line">│       ├── config-map.yaml</span><br><span class="line">│       ├── daemonset.yaml</span><br><span class="line">│       ├── kustomization.yml</span><br><span class="line">│       └── service.yaml</span><br><span class="line">└── overlays</span><br><span class="line">    ├── dev</span><br><span class="line">    │   ├── kustomization.yml</span><br><span class="line">    │   └── patch.yaml</span><br><span class="line">    └── prod</span><br><span class="line">        ├── kustomization.yml</span><br><span class="line">        └── patch.yaml</span><br></pre></td></tr></table></figure><p>一整套的运行就是:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">kustomize</span> <span class="string">git:(main)</span> <span class="string">kustomize</span> <span class="string">build</span> <span class="string">overlays/dev</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">promtail-config.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">      <span class="attr">http_listen_port:</span> <span class="number">9080</span></span><br><span class="line">      <span class="attr">grpc_listen_port:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">positions:</span></span><br><span class="line">      <span class="attr">filename:</span> <span class="string">/tmp/positions.yaml</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># clients:</span></span><br><span class="line">    <span class="comment"># - url: http://dev-loki:3100/loki/api/v1/push</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">containers</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">localhost</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">log_from:</span> <span class="string">static_pods</span></span><br><span class="line">          <span class="attr">__path__:</span> <span class="string">/var/log/pods/*/*/*.log</span></span><br><span class="line">      <span class="attr">pipeline_stages:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">docker:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;log_from="static_pods"&#125;'</span></span><br><span class="line">          <span class="attr">stages:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">regex:</span></span><br><span class="line">              <span class="attr">source:</span> <span class="string">filename</span></span><br><span class="line">              <span class="attr">expression:</span> <span class="string">"(?:pods)/(?P&lt;namespace&gt;\\S+?)_(?P&lt;pod&gt;\\S+)-\\S+?-\\S+?_\\S+?/(?P&lt;container&gt;\\S+?)/"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labels:</span></span><br><span class="line">              <span class="attr">namespace:</span></span><br><span class="line">              <span class="attr">pod:</span></span><br><span class="line">              <span class="attr">container:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">          <span class="attr">selector:</span> <span class="string">'&#123;namespace!~"(default|kube-system)"&#125;'</span></span><br><span class="line">          <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">          <span class="attr">drop_counter_reason:</span> <span class="string">no_use</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-promtail-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">loki-config.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">auth_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">server:</span></span><br><span class="line">      <span class="attr">http_listen_port:</span> <span class="number">3100</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">ingester:</span></span><br><span class="line">      <span class="attr">lifecycler:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">        <span class="attr">ring:</span></span><br><span class="line">          <span class="attr">kvstore:</span></span><br><span class="line">            <span class="attr">store:</span> <span class="string">inmemory</span></span><br><span class="line">          <span class="attr">replication_factor:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">final_sleep:</span> <span class="string">0s</span></span><br><span class="line">      <span class="attr">chunk_idle_period:</span> <span class="string">5m</span></span><br><span class="line">      <span class="attr">chunk_retain_period:</span> <span class="string">30s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">schema_config:</span></span><br><span class="line">      <span class="attr">configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">from:</span> <span class="number">2020</span><span class="number">-05</span><span class="number">-15</span></span><br><span class="line">        <span class="attr">store:</span> <span class="string">boltdb</span></span><br><span class="line">        <span class="attr">object_store:</span> <span class="string">filesystem</span></span><br><span class="line">        <span class="attr">schema:</span> <span class="string">v11</span></span><br><span class="line">        <span class="attr">index:</span></span><br><span class="line">          <span class="attr">prefix:</span> <span class="string">index_</span></span><br><span class="line">          <span class="attr">period:</span> <span class="string">168h</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">storage_config:</span></span><br><span class="line">      <span class="attr">boltdb:</span></span><br><span class="line">        <span class="attr">directory:</span> <span class="string">/tmp/loki/index</span></span><br><span class="line"></span><br><span class="line">      <span class="attr">filesystem:</span></span><br><span class="line">        <span class="attr">directory:</span> <span class="string">/tmp/loki/chunks</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">limits_config:</span></span><br><span class="line">      <span class="attr">enforce_metric_name:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">reject_old_samples:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">reject_old_samples_max_age:</span> <span class="string">168h</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-loki-config</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-grafana</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-loki</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3100</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-loki</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">http-promtail</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-grafana-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-loki-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">      <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">      <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">        <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">        <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">grafana/grafana:7.5.2</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">tcpSocket:</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-grafana</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/robots.txt</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">250m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">750Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">grafana-pv</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">472</span></span><br><span class="line">        <span class="attr">supplementalGroups:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-pv</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">dev-grafana-pvc</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-loki-statefulset</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">      <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">      <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">dev-loki</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">        <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">        <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-config.file=/mnt/config/loki-config.yml</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/loki:2.3.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">loki</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3100</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-loki</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp/loki</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">storage-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">dev-loki-pvc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">loki-config.yml</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">loki-config.yml</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">dev-loki-config</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">    <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">    <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dev-promtail</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">      <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">      <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">note:</span> <span class="string">Hello,</span> <span class="string">I</span> <span class="string">am</span> <span class="string">dev!</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">amyris</span></span><br><span class="line">        <span class="attr">org:</span> <span class="string">unknow-x</span></span><br><span class="line">        <span class="attr">variant:</span> <span class="string">dev</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-config.file=/mnt/config/promtail-config.yml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-client.url=http://dev-loki:3100/loki/api/v1/push</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-client.external-labels=hostname=$(NODE_NAME)</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">grafana/promtail:2.3.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">promtail</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">http-promtail</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">runAsGroup:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">containers-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/log/pods</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pods-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/mnt/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">containers-volume</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log/pods</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">pods-volume</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">items:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">promtail-config.yml</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">promtail-config.yml</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">dev-promtail-config</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-volume</span></span><br></pre></td></tr></table></figure><p>采用 <code>kustomize build overlays/dev | kubectl apply -f -</code> 来运行我们的<code>dev</code>环境的k8s所有的服务。</p><p>通过<code>kubectl port-forward deployment.apps/dev-grafana 3000:3000</code> 来做端口的转发。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  whiteccinn.github.io git:(master) ✗ kubectl port-forward deployment.apps/dev-grafana 3000:3000</span><br><span class="line">Forwarding from 127.0.0.1:3000 -&gt; 3000</span><br><span class="line">Forwarding from [::1]:3000 -&gt; 3000</span><br></pre></td></tr></table></figure><p>通过 <code>kubectl get svc</code> 查看端口转发情况。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  whiteccinn.github.io git:(master) ✗ kubectl get svc</span><br><span class="line">NAME           TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">dev-grafana    LoadBalancer   10.102.248.247   localhost     3000:32695/TCP   17h</span><br><span class="line">dev-loki       ClusterIP      10.106.32.224    &lt;none&gt;        3100/TCP         17h</span><br><span class="line">dev-promtail   ClusterIP      10.108.116.190   &lt;none&gt;        9080/TCP         17h</span><br><span class="line">kubernetes     ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP          3d10h</span><br></pre></td></tr></table></figure><p>最终通过命令 <code>kubectl get pods -o wide</code> 看到所有的pods都在正常运作了。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  whiteccinn.github.io git:(master) ✗ kubectl get pods -o wide</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP          NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">dev-grafana-7cd4c89fd4-wdkpb   1/1     Running   0          17h   10.1.0.16   docker-desktop   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">dev-loki-statefulset-0         1/1     Running   0          17h   10.1.0.18   docker-desktop   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">dev-loki-statefulset-1         1/1     Running   0          17h   10.1.0.19   docker-desktop   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">dev-promtail-n6jgs             1/1     Running   0          17h   10.1.0.17   docker-desktop   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure><p>然后在浏览器打开<code>localhost:3000</code>，即可访问到<code>grafna</code>了。</p><p>grafna默认的账号密码就是<code>admin</code>。</p><p>1.我们先来配置grafna的Dashboard。</p><p><img src="/images/k8s/glp-3.png" alt="数据源"></p><p>2.对日志进行可视化配置。</p><p><img src="/images/k8s/glp-2.png" alt="log panel"></p><p>3.配置搜索栏。</p><p><img src="/images/k8s/glp-4.png" alt="搜索栏"></p><p>4.可以看到搜索栏了，并且需要更新一下查询的公式</p><p><img src="/images/k8s/glp-5.png" alt="公式"></p><p>这里就是我希望利用k8s的<code>glp</code>来采集我的所有的pods在标准输出的所有的日志信息，做一个汇总和日志中心查询的web-ui。</p><p><img src="/images/k8s/docker-for-mac-6.png" alt="docker-for-mac-6"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;我们经常有一些日志采集的需求，采集完毕之后，希望有一个中心WebUi来方便的查看很多不同节点，不同服务的日志。&lt;/p&gt;
&lt;p&gt;按照传统的方式，一般都是会采用&lt;code&gt;ELK&lt;/code&gt;,就是&lt;code&gt;elasticsearch+logstash+kibana&lt;/code&gt;，但是由于&lt;code&gt;JVM&lt;/code&gt;对资源的消耗太大，加上&lt;code&gt;ES&lt;/code&gt;是通过全文搜索的方式需要进行倒排索引的分词，所以这些功能几乎是用不上，我们查询日志一般都可以通过定制常规的&lt;code&gt;label&lt;/code&gt;信息，然后搜索即可，大可不必进行分词的行为。尽管后续又由于&lt;code&gt;logstash&lt;/code&gt;的资源占用过大问题，作者又利用go语言开发出了&lt;code&gt;filebeat&lt;/code&gt;，来辅助日志采集体系，后续加入了某公司之后，被集成到了&lt;code&gt;beats&lt;/code&gt;的项目中，因为也可以交&lt;code&gt;efk/ebk&lt;/code&gt;，都可以。&lt;/p&gt;
&lt;p&gt;鉴于这一点，随之而来的就是&lt;code&gt;GLP&lt;/code&gt;，就是&lt;code&gt;grafna+loki+promtail&lt;/code&gt;。这是一套完全基于go语言生态写的，更贴近云原生。一套体系都是经过&lt;code&gt;grafna lab&lt;/code&gt;云原生孕育而生。资源占用少，效率高，能够解决痛点，天生支持k8s等等特性。都让他成为新的崛起之秀。&lt;/p&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>【kubernetes】k8s-pv-nfs-for-mac</title>
    <link href="http://blog.crazylaw.cn/2021/08/16/k8s/k8s-mac-pv-nfs/"/>
    <id>http://blog.crazylaw.cn/2021/08/16/k8s/k8s-mac-pv-nfs/</id>
    <published>2021-08-16T06:18:30.000Z</published>
    <updated>2021-08-16T07:06:32.263Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>docker-for-mac 现在已经内置了k8s，我们可以轻松的开启这个功能，然后就可以通过kubectl来执行我们的k8s的命令来对容器资源进行管理。</p><p>但是有一个比较头疼的点，那就是我们的pv资源。我们平时用docker的时候，有一些信息例如，日志之类的，需要持久化下来，这个时候，这个日志文件持久化会和容器所在的物理机在同一个机器下，因此，并不能很好的做到“存”，“算”分离的目的。并且没办法利用了网络上的其他资源。</p><p>再者就是还有一种情况就是，我需要利用k8s部署一些基础服务，例如mysql，例如redis，这些基础数据都是需要持久化的，因此，和物理机器强行绑定在一起的话，下次数据在哪个数据卷都不清楚了，更没办法重新回复数据，这是一个很严重的问题。</p><p>所以我们这里的pv，不能简单的使用<code>hostPath</code>或者<code>local</code>类型，根据服务器上用的比较多的或许是自己搭建一个<code>nfs</code> 服务器，因此，我们也希望在本地开发的时候定义资源文件<code>的yaml</code>也是用<code>nfs</code>来作为我们的<code>pv-type</code>。</p><p>但是也因此，我们需要在mac上开启一个<code>nfs-server</code>。尝试过<a href="https://github.com/ehough/docker-nfs-server" target="_blank" rel="noopener">docker-nfs-server</a>，但是由于mac系统的架构问题，无法顺利的运行起来，需要处理modpre模块，处理那么多内核的东西不太合理。</p><a id="more"></a><h2 id="built-in-nfs"><a href="#built-in-nfs" class="headerlink" title="built-in-nfs"></a>built-in-nfs</h2><p>后来查阅资料，发现了原来我们的macos，内置了nfs，我们只需要添加对应的配置和开启服务即可，十分的方便。</p><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>这个文件默认是不存在的，需要我们手动去创建和添加里面的内容，不熟悉nfs的朋友需要去看一下nfs的配置文件。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/exports</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 追加以下文件到文件中</span></span></span><br><span class="line">/Users/caiwenhui/nas_a -alldirs -maproot=caiwenhui:staff</span><br></pre></td></tr></table></figure><p>其中的含义是:</p><ul><li>/Users/caiwenhui/nas_a 指定共享目录</li><li>-alldirs 共享目录下的所有目录</li><li>-maproot 把client端的caiwenhui用户映射为MacOS上的root，client端的staff组映射为MacOS上的wheel (gid=0) 组</li></ul><h3 id="检查配置是否正确"><a href="#检查配置是否正确" class="headerlink" title="检查配置是否正确"></a>检查配置是否正确</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nfsd checkexports</span><br></pre></td></tr></table></figure><p>如果都正确的话，默认什么都不会输出。如果存在问题的话，则会弹出错误配置信息。</p><h3 id="etc-nfs-conf"><a href="#etc-nfs-conf" class="headerlink" title="/etc/nfs.conf"></a>/etc/nfs.conf</h3><p>如果k8s需要运用nfs，还需要添加一行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs.server.mount.require_resv_port &#x3D; 0</span><br></pre></td></tr></table></figure><h3 id="服务命令"><a href="#服务命令" class="headerlink" title="服务命令"></a>服务命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo nfsd start # 启动服务</span><br><span class="line">sudo nfsd stop # 停止服务</span><br><span class="line">sudo nfsd restart # 重启服务</span><br><span class="line">sudo nfsd status # 查看状态</span><br><span class="line">sudo nfsd enable # 开机自启</span><br><span class="line">sudo nfsd disable # 禁止开机自启</span><br></pre></td></tr></table></figure><h3 id="查看配置是否生效"><a href="#查看配置是否生效" class="headerlink" title="查看配置是否生效"></a>查看配置是否生效</h3><p><code>showmount -e</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ showmount -e</span><br><span class="line">Exports list on localhost:</span><br><span class="line">&#x2F;Users&#x2F;caiwenhui&#x2F;nas_a              Everyone</span><br></pre></td></tr></table></figure><p>这里，可以看到，我们挂在的数据卷已经生效，并且是everyone(任何网段，任何用户)都可以进行<code>读写</code>。因为是本地开发，所以这么设置最方便，如果是服务器上的，就需要针对特定的网段或者ip以及user了。详情查看nfs配置。</p><h3 id="本地测试"><a href="#本地测试" class="headerlink" title="本地测试"></a>本地测试</h3><blockquote><p>这一步你大可不必测试，因为是第一次，所以我想先确保nfs的服务的正常。</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 创建client角色的目录，就是被挂载的目录</span></span></span><br><span class="line">mkdir /Users/caiwenhui/nas_a2</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 模拟client挂载nfs数据卷命令</span></span></span><br><span class="line">sudo mount -t nfs -o nolock,nfsvers=3,vers=3 127.0.0.1:/Users/caiwenhui/nas_a /Users/caiwenhui/nas_a2</span><br></pre></td></tr></table></figure><p>这里的意思是：</p><ul><li>挂载类型：nfs</li><li>采用nfs-v3协议: nfsvers=3,vers=3</li><li>nfs-server的目录: 127.0.0.1:/Users/caiwenhui/nas_a （这个就是我们<code>showmount -e</code>查看到的路径）</li><li>nfs-client的目录：/Users/caiwenhui/nas_a2</li></ul><p>挂载成功之后，尝试在client目录添加文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch /Users/caiwenhui/nas_a2/hello</span><br></pre></td></tr></table></figure><p>查看server目录是否有文件同步</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /Users/caiwenhui/nas_a</span><br><span class="line">hello</span><br></pre></td></tr></table></figure><p>这个时候会发现nas_a目录下，自动多了一个<code>hello</code>的文件</p><p>取消挂在，可以在<code>finder中直接弹出挂载</code>，或者<code>使用如下命令</code>即可。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /Users/caiwenhui/nas_a2</span><br></pre></td></tr></table></figure><p>这个时候你再去看 <code>/Users/caiwenhui/nas_a2</code> 目录下，<code>hello</code>文件不见了，但是<code>/Users/caiwenhui/nas_a/hello</code>依旧存在。</p><h2 id="k8s中测试nfs"><a href="#k8s中测试nfs" class="headerlink" title="k8s中测试nfs"></a>k8s中测试nfs</h2><h3 id="NFS-PersistentVolume"><a href="#NFS-PersistentVolume" class="headerlink" title="NFS PersistentVolume"></a>NFS PersistentVolume</h3><p>前面我们已经在mac上启动了一个NFS服务，现在通过在k8s上创建一个PersistentVolume来使用NFS。</p><p>创建一个PV，编辑配置文件<code>nfs-pv-1.yaml</code>，内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">~</span> <span class="string">cat</span> <span class="string">nfs-pv-1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspv1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nfsvers=3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nolock</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/Users/caiwenhui/nas_a</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">docker.for.mac.host.internal</span></span><br></pre></td></tr></table></figure><p>nfs相关的配置：</p><ul><li>nfsvers=3 使用v3协议</li><li>路径就是nfs上的目录</li><li>注意这里，我们的服务器ip，如果不能明确的目前现在的网络通信情况的下，请使用<code>docker.for.mac.host.internal</code></li></ul><p>申请资源PV。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nfs-pv-1.yaml</span><br></pre></td></tr></table></figure><p>查看资源状态。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ kubectl get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">nfspv1   2Gi        RWO            Recycle          Available           nfs                     13h</span><br></pre></td></tr></table></figure><p>STATUS为<code>Available</code>表示nfspv1就绪，可以被PVC申请。</p><h3 id="PersistentVolumeClaim"><a href="#PersistentVolumeClaim" class="headerlink" title="PersistentVolumeClaim"></a>PersistentVolumeClaim</h3><p>下面创建PVC，编辑nfs-pvc-1.yaml文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">~</span> <span class="string">cat</span> <span class="string">nfs-pvc-1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfspvc1</span> </span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br></pre></td></tr></table></figure><p>申请资源PVC。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nfs-pvc-1.yaml</span><br></pre></td></tr></table></figure><p>查看pvc状态/查看pv状态。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ kubectl get pvc</span><br><span class="line">NAME      STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">nfspvc1   Bound    nfspv1   10Gi       RWO            nfs            85s</span><br><span class="line"></span><br><span class="line">➜  ~ kubectl get pv</span><br><span class="line">NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM             STORAGECLASS   REASON   AGE</span><br><span class="line">nfspv1   2Gi        RWO            Recycle          Bound    default/nfspvc1   nfs                     13h</span><br></pre></td></tr></table></figure><p>这里，我们可以看到 <code>status = bound</code>，代表此时<code>pv</code>和<code>pvc</code>已经绑定在一起了。这样子我们就可以把<code>pod</code>和<code>pvc</code>绑定。</p><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>编辑pod1.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">➜</span>  <span class="string">~</span> <span class="string">cat</span> <span class="string">pod1.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod1</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">30000</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/mydata"</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">nfspvc1</span></span><br></pre></td></tr></table></figure><p>申请资源pod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f pod1.yaml</span><br></pre></td></tr></table></figure><p>查看pod状态</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ kubectl describe pod</span><br><span class="line">Name:         mypod1</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         docker-desktop&#x2F;192.168.65.4</span><br><span class="line">Start Time:   Mon, 16 Aug 2021 01:07:01 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">Status:       Running</span><br><span class="line">IP:           10.1.0.6</span><br><span class="line">IPs:</span><br><span class="line">  IP:  10.1.0.6</span><br><span class="line">Containers:</span><br><span class="line">  mypod1:</span><br><span class="line">    Container ID:  docker:&#x2F;&#x2F;0351e0c89fb94a3a1c8888939c641fc7b9b48d1f915f3653ca0ac188c50ae242</span><br><span class="line">    Image:         busybox</span><br><span class="line">    Image ID:      docker-pullable:&#x2F;&#x2F;busybox@sha256:0f354ec1728d9ff32edcd7d1b8bbdfc798277ad36120dc3dc683be44524c8b60</span><br><span class="line">    Port:          &lt;none&gt;</span><br><span class="line">    Host Port:     &lt;none&gt;</span><br><span class="line">    Args:</span><br><span class="line">      &#x2F;bin&#x2F;sh</span><br><span class="line">      -c</span><br><span class="line">      sleep 30000</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Mon, 16 Aug 2021 01:07:08 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      &#x2F;mydata from mydata (rw)</span><br><span class="line">      &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount from kube-api-access-pftwg (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             True</span><br><span class="line">  ContainersReady   True</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  mydata:</span><br><span class="line">    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)</span><br><span class="line">    ClaimName:  nfspvc1</span><br><span class="line">    ReadOnly:   false</span><br><span class="line">  kube-api-access-pftwg:</span><br><span class="line">    Type:                    Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    TokenExpirationSeconds:  3607</span><br><span class="line">    ConfigMapName:           kube-root-ca.crt</span><br><span class="line">    ConfigMapOptional:       &lt;nil&gt;</span><br><span class="line">    DownwardAPI:             true</span><br><span class="line">QoS Class:                   BestEffort</span><br><span class="line">Node-Selectors:              &lt;none&gt;</span><br><span class="line">Tolerations:                 node.kubernetes.io&#x2F;not-ready:NoExecute op&#x3D;Exists for 300s</span><br><span class="line">                             node.kubernetes.io&#x2F;unreachable:NoExecute op&#x3D;Exists for 300s</span><br><span class="line">Events:                      &lt;none&gt;</span><br></pre></td></tr></table></figure><p>我们看到<code>Mounts</code>相关的内容已经挂载正确，并且容器也正确在运行了。我们对挂载好的数据卷操作。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec mypod1 touch /mydata/hello2</span><br></pre></td></tr></table></figure><p>这个时候我们在本地的nfs-server的目录<code>/Users/caiwenhui/nas_a</code> 查看一下是否多了<code>hello2</code>的文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /Users/caiwenhui/nas_a</span><br><span class="line">hello hello2</span><br></pre></td></tr></table></figure><p>这个时候，我们看到，hello2被成功创建，pod能正确的访问的pv挂载链接本地nfs-server了。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;docker-for-mac 现在已经内置了k8s，我们可以轻松的开启这个功能，然后就可以通过kubectl来执行我们的k8s的命令来对容器资源进行管理。&lt;/p&gt;
&lt;p&gt;但是有一个比较头疼的点，那就是我们的pv资源。我们平时用docker的时候，有一些信息例如，日志之类的，需要持久化下来，这个时候，这个日志文件持久化会和容器所在的物理机在同一个机器下，因此，并不能很好的做到“存”，“算”分离的目的。并且没办法利用了网络上的其他资源。&lt;/p&gt;
&lt;p&gt;再者就是还有一种情况就是，我需要利用k8s部署一些基础服务，例如mysql，例如redis，这些基础数据都是需要持久化的，因此，和物理机器强行绑定在一起的话，下次数据在哪个数据卷都不清楚了，更没办法重新回复数据，这是一个很严重的问题。&lt;/p&gt;
&lt;p&gt;所以我们这里的pv，不能简单的使用&lt;code&gt;hostPath&lt;/code&gt;或者&lt;code&gt;local&lt;/code&gt;类型，根据服务器上用的比较多的或许是自己搭建一个&lt;code&gt;nfs&lt;/code&gt; 服务器，因此，我们也希望在本地开发的时候定义资源文件&lt;code&gt;的yaml&lt;/code&gt;也是用&lt;code&gt;nfs&lt;/code&gt;来作为我们的&lt;code&gt;pv-type&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;但是也因此，我们需要在mac上开启一个&lt;code&gt;nfs-server&lt;/code&gt;。尝试过&lt;a href=&quot;https://github.com/ehough/docker-nfs-server&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;docker-nfs-server&lt;/a&gt;，但是由于mac系统的架构问题，无法顺利的运行起来，需要处理modpre模块，处理那么多内核的东西不太合理。&lt;/p&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>【DevOps】自定义git凭据存取器</title>
    <link href="http://blog.crazylaw.cn/2021/08/02/DevOps/%E8%87%AA%E5%AE%9A%E4%B9%89git%E5%87%AD%E6%8D%AE%E5%AD%98%E5%8F%96%E5%99%A8/"/>
    <id>http://blog.crazylaw.cn/2021/08/02/DevOps/%E8%87%AA%E5%AE%9A%E4%B9%89git%E5%87%AD%E6%8D%AE%E5%AD%98%E5%8F%96%E5%99%A8/</id>
    <published>2021-08-02T06:35:30.000Z</published>
    <updated>2021-08-02T07:09:57.437Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近，在处理公司到代码仓库，公司由<code>gitbucket</code>迁移到<code>gitlab</code>后，业务项目拉取私有<code>vcs</code>的代码依赖包的方式发生了改变。</p><p>以前可能是一个“权限较大”的用户，拥有多个项目组的访问权限，所以可以访问私有的<code>vcs</code>的代码。</p><p>但是迁移到gitlab之后，每个group下，owner都可以针对这个group生成对应都<code>deploy-key</code>，所以变成了一个group下一个deploy-key。</p><p>这就意味着，我们都<code>go/php/node</code>项目，在拉取不同项目都依赖包都时候，需要把<code>git-credential</code>的账号信息切换。</p><a id="more"></a><h2 id="git-build-in"><a href="#git-build-in" class="headerlink" title="git-build-in"></a>git-build-in</h2><p>Git 有一个内部接口,用于存储和检索系统特定助手的证书,以及提示用户输入用户名和密码。<code>git-credential</code> 命令向脚本开放了这个接口,脚本可以像 Git 一样检索、存储或提示用户输入凭证。这个可脚本接口的设计与内部的 C API 一样,请参见 <code>credential.h</code> 以了解更多的概念背景。</p><p>git-credential在命令行上使用“操作”选项（ fill ， approve 或 reject 之一），并在stdin上读取凭据描述（请参阅<code>INPUT / OUTPUT FORMAT</code>）。</p><p>如果操作为 fill ，则git-credential将尝试通过读取配置文件，联系任何已配置的凭据帮助程序或提示用户来向描述中添加“用户名”和“密码”属性。然后将凭证描述的用户名和密码属性与已经提供的属性一起打印到stdout。</p><p>如果操作被 <code>approve</code> ，则git-credential会将描述发送给任何已配置的凭据帮助器，该帮助器可以存储该凭据以供以后使用。</p><p>如果该操作被 <code>reject</code> ，则git-credential会将描述发送给任何已配置的凭据帮助器，这些帮助器可能会删除所有与该描述匹配的存储凭据。</p><p>如果操作是 <code>approve 或 reject</code> ，则不应发出任何输出。</p><h2 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h2><p>我们知道，在<code>window</code>和<code>mac</code>下，分别对应的多凭据管理器，分别是<code>git credential for window</code> 和 <code>oschinakey</code>，可以做到精确的记录下我们的所有凭据。但是在linux下就只有<br><code>build-in(内置)</code>的存取器，分别是 <code>cache</code>, <code>store</code> 。</p><p>经过实现，在<code>.gitconfig</code>默认的配置的情况下，每次都会只读取 <code>.git-credential</code> 的第一行数据，如果不正确，则触发 git 的 <code>build-in</code> 的 <code>reject</code> 方法，清理掉这一行的凭据，这使得我们在多凭据下无法正常的工作。我们需要<code>.git-credentital</code>能根据<code>vcs</code>的地址特点，例如根据<code>group</code>来识别凭据。为了实现这一点，我们就需要借助<code>自定义存取器</code>。</p><h2 id="自定义存储器"><a href="#自定义存储器" class="headerlink" title="自定义存储器"></a>自定义存储器</h2><p>要实现自定义存储器，就需要知道他是什么东西，和怎么实现。</p><p><code>自定义存储器</code>允许你用<code>任何语言</code>来编写，你用<code>c/c++/python/php/java/go/rust/erlang</code>等等的语言写都是可以的，只需要程序能直接运行，并且符合<code>输入/输出格式</code>和在<code>PATH</code>的系统环境下能找到的情况下，都是可行的。我记得<code>git-scm</code>的例子采用的是ruby的写法，但是由于考虑到<code>python2</code>一般是每个系统都自带的，我们也采用了<code>python2</code>的写法来实现一个<code>根据组织来智能区分git账号和密码的自定义存取器</code></p><p>这里，我们可以记住，把自定义存储器想像成一个<code>管道(pipe)</code>的概念，有<code>输入端</code>，也有<code>输出端</code>，他们都有自己对应的规则（协议/格式）。</p><h3 id="输入-输出格式"><a href="#输入-输出格式" class="headerlink" title="输入/输出格式"></a>输入/输出格式</h3><p>git credential 在其<code>标准输入/输出</code>中读取或写入（取决于使用的操作）<code>凭证信息</code>。此信息可以对应于 <code>git credential</code> 将为其获取登录信息的密钥（例如主机，协议，路径），也可以<code>对应</code>于将要获取的实际凭证数据（用户名/密码）。</p><p>凭证分为一组命名属性，<code>每行一个属性</code>。每个属性均由键值对指定，并以 <code>= （等号）分隔</code>，后跟<code>换行符</code>。</p><p>密钥可以包含除 = ，换行符或NUL之外的任何字节。该值可以包含除换行符或NUL之外的任何字节。</p><p>在这两种情况下,所有的字节都按原样处理(即没有引号,也不能传输带有换行或NUL的值)。属性列表以空行或文件末尾结束。</p><p>Git了解以下属性。</p><ul><li><p>protocol 将使用凭证的协议（例如 https ）。</p></li><li><p>host 网络凭证的远程主机名,包括指定的端口号(如 “example.com:8088”)。如果指定了端口号,则包括端口号(例如 “example.com:8088”)。</p></li><li><p>path 凭据将使用的路径。例如，对于访问远程https资源库，这将是服务器上资源库的路径。(只有开启了<code>useHttpPath=true</code>的情况下，输入格式才会携带这个参数)</p></li><li><p>username 凭据的用户名（如果已经有）（例如，来自URL，配置，用户或先前运行的帮助程序）。</p></li><li><p>password 凭据的密码（如果我们要求将其存储）。</p></li><li><p>url 当 git credential 读取此特殊属性时，该值将解析为URL，并被视为已读取其组成部分（例如， url=<a href="https://example.com" target="_blank" rel="noopener">https://example.com</a> 的行为就好像 protocol=https 和 host=example.com 已提供）。这可以帮助呼叫者避免自己解析URL。</p></li></ul><blockquote><p>请注意，指定协议是强制性的，并且如果URL未指定主机名（例如，“ cert：/// path / to / file”），则凭证将包含其主机名属性，其值为空字符串。</p></blockquote><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>了解了<code>输入/输出格式</code>后。我们通过实战例子来说明。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> git-credential.example</span></span><br><span class="line">https://caiwenhui:testpass@gitlab.mingchao.com/group1</span><br><span class="line">https://caiwenhui:testpass2@gitlab.mingchao.com/group2</span><br><span class="line">https://caiwenhui:testpass3@gitlab.mingchao.com/group3</span><br></pre></td></tr></table></figure><p>以下文件，命名为 <code>git-credential-mc</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Date    : 2021-07-30 10:58:53</span></span><br><span class="line"><span class="comment"># @Author  : caiwenhui</span></span><br><span class="line"><span class="comment"># @Version : 1.0</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">"get credentials by https://gitlab.mimgchao.com/&#123;group&#125;"</span>,</span><br><span class="line">                                 prog=<span class="string">'git-credential-mc'</span>,</span><br><span class="line">                                 usage=<span class="string">'%(prog)s [options] &lt;action&gt;'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'-f'</span>, <span class="string">'--file'</span>, help=<span class="string">'Specify path for backing store'</span>, required=<span class="literal">True</span>, default=<span class="string">"~/.git-credentials"</span>,</span><br><span class="line">                    type=str)</span><br><span class="line">parser.add_argument(<span class="string">'action'</span>, metavar=<span class="string">"action"</span>, help=<span class="string">'just support &lt;get&gt;'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CredentialsHelper</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, credential_file=<span class="string">''</span>)</span>:</span></span><br><span class="line">        self.inputs = dict()</span><br><span class="line">        self.file = credential_file</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_input</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            line = sys.stdin.readline()</span><br><span class="line">            <span class="keyword">if</span> line.strip() == <span class="string">''</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            k, v = line.strip().split(<span class="string">'='</span>, <span class="number">2</span>)</span><br><span class="line">            self.inputs[k] = v</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 需要开启useHttpPath = true</span></span><br><span class="line">        <span class="keyword">if</span> self.inputs[<span class="string">'path'</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 解析path参数</span></span><br><span class="line">        self.inputs[<span class="string">'group'</span>] = self.inputs[<span class="string">'path'</span>].split(<span class="string">'/'</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_output</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(self.file, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            lines = f.readlines()</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">                m = re.match(<span class="string">r'^(?P&lt;protocol&gt;.*?)://(?P&lt;username&gt;.*?):(?P&lt;password&gt;.*?)@(?P&lt;host&gt;.*)/(?P&lt;group&gt;.*)$'</span>,</span><br><span class="line">                             line)</span><br><span class="line">                gd = m.groupdict()</span><br><span class="line">                <span class="keyword">if</span> self.inputs[<span class="string">'protocol'</span>] == gd[<span class="string">'protocol'</span>] <span class="keyword">and</span> self.inputs[<span class="string">'host'</span>] == gd[<span class="string">'host'</span>] <span class="keyword">and</span> self.inputs[</span><br><span class="line">                    <span class="string">'group'</span>] == gd[<span class="string">'group'</span>]:</span><br><span class="line">                    sys.stdout.write(<span class="string">'protocol=&#123;protocol&#125;\n'</span>.format(protocol=gd[<span class="string">'protocol'</span>]))</span><br><span class="line">                    sys.stdout.write(<span class="string">'host=&#123;host&#125;\n'</span>.format(host=gd[<span class="string">'host'</span>]))</span><br><span class="line">                    sys.stdout.write(<span class="string">'username=&#123;username&#125;\n'</span>.format(username=gd[<span class="string">'username'</span>]))</span><br><span class="line">                    sys.stdout.write(<span class="string">'password=&#123;password&#125;\n'</span>.format(password=gd[<span class="string">'password'</span>]))</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._input()</span><br><span class="line">        self._output()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &lt;= <span class="number">1</span>:</span><br><span class="line">        parser.print_help()</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> args.action != <span class="string">"get"</span>:</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(args.file):</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    credentialsHelper = CredentialsHelper(credential_file=args.file)</span><br><span class="line">    credentialsHelper.execute()</span><br></pre></td></tr></table></figure><p>直接运行下，脚本输出如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  python git:(master) ./git-credential-mc</span><br><span class="line">usage: git-credential-mc [options] &lt;action&gt;</span><br><span class="line"></span><br><span class="line">get credentials by https://gitlab.mimgchao.com/&#123;group&#125;</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  action                just support &lt;get&gt;</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -f FILE, --file FILE  Specify path for backing store</span><br></pre></td></tr></table></figure><p>我们来模拟git的一个输入过程，然后让自定义存储器输出正确的输出格式告诉git凭据要用的账号密码：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜  python git-credential-mc -f git-credential.example  get</span><br><span class="line">protocol=https</span><br><span class="line">host=gitlab.mingchao.com</span><br><span class="line">path=group1/repo1.git</span><br><span class="line"></span><br><span class="line">protocol=https</span><br><span class="line">host=gitlab.mingchao.com</span><br><span class="line">username=caiwenhui</span><br><span class="line">password=testpass</span><br><span class="line"></span><br><span class="line">➜  python git-credential-mc -f git-credential.example  get</span><br><span class="line">protocol=https</span><br><span class="line">host=gitlab.mingchao.com</span><br><span class="line">path=group2/repo1.git</span><br><span class="line"></span><br><span class="line">protocol=https</span><br><span class="line">host=gitlab.mingchao.com</span><br><span class="line">username=caiwenhui</span><br><span class="line">password=testpass2</span><br></pre></td></tr></table></figure><p>这里，我们看到，我们根据不同的<code>group</code>，已经返回了不同的账号密码了。达到这个效果，我们的自定义读取器就算是完成了。但是系统化的整理起来，还需要把这个脚本，放在<code>PATH</code>路径下，并且，并且记得必须以<code>git-credential-*</code>来命令程序的文件名。因为git源码的credential模块中的源码读取自定义规则存储器就是这样子调用外部程序的。</p><h3 id="配置git"><a href="#配置git" class="headerlink" title="配置git"></a>配置git</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global credential.https:&#x2F;&#x2F;gitlab.mingchao.com.useHttpPath true</span><br><span class="line">git config --global credential.https:&#x2F;&#x2F;gitlab.mingchao.com.helper &quot;mc --file ~&#x2F;.git-credential.example&quot;</span><br></pre></td></tr></table></figure><p>这样子，git就可以针对<code>https://gitlab.mingchao.com</code>的时候，采用<code>git-credential-mc</code>的程序来读取凭据。达到我们的<code>多组/多凭据</code>的情况下<code>正确</code>的<code>读取账号和密码</code>。</p><p>这里只是一个简单的用法，后续如果有复杂的用法，都可以扩展这个自定义存取器，十分的灵活。</p><h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><ul><li><a href="https://github.com/git/git" target="_blank" rel="noopener">https://github.com/git/git</a></li><li><a href="https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%87%AD%E8%AF%81%E5%AD%98%E5%82%A8" target="_blank" rel="noopener">https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%87%AD%E8%AF%81%E5%AD%98%E5%82%A8</a></li><li><a href="https://revs.runtime-revolution.com/extending-git-with-ruby-874fddffd069" target="_blank" rel="noopener">https://revs.runtime-revolution.com/extending-git-with-ruby-874fddffd069</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近，在处理公司到代码仓库，公司由&lt;code&gt;gitbucket&lt;/code&gt;迁移到&lt;code&gt;gitlab&lt;/code&gt;后，业务项目拉取私有&lt;code&gt;vcs&lt;/code&gt;的代码依赖包的方式发生了改变。&lt;/p&gt;
&lt;p&gt;以前可能是一个“权限较大”的用户，拥有多个项目组的访问权限，所以可以访问私有的&lt;code&gt;vcs&lt;/code&gt;的代码。&lt;/p&gt;
&lt;p&gt;但是迁移到gitlab之后，每个group下，owner都可以针对这个group生成对应都&lt;code&gt;deploy-key&lt;/code&gt;，所以变成了一个group下一个deploy-key。&lt;/p&gt;
&lt;p&gt;这就意味着，我们都&lt;code&gt;go/php/node&lt;/code&gt;项目，在拉取不同项目都依赖包都时候，需要把&lt;code&gt;git-credential&lt;/code&gt;的账号信息切换。&lt;/p&gt;
    
    </summary>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/categories/DevOps/"/>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/tags/DevOps/"/>
    
  </entry>
  
  <entry>
    <title>【rust】序列化框架serde</title>
    <link href="http://blog.crazylaw.cn/2021/04/13/Rust%E8%AF%AD%E8%A8%80/rust-%E5%BA%8F%E5%88%97%E5%8C%96%E6%A1%86%E6%9E%B6serde/"/>
    <id>http://blog.crazylaw.cn/2021/04/13/Rust%E8%AF%AD%E8%A8%80/rust-%E5%BA%8F%E5%88%97%E5%8C%96%E6%A1%86%E6%9E%B6serde/</id>
    <published>2021-04-13T02:43:43.000Z</published>
    <updated>2021-04-22T07:44:11.893Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Rust 中有一个 99%的程序员或许都会用到的组件，那就是序列化组件: serde。</p><p>众所周知，rust的静态语言，所以这让我们在序列化上繁琐了很多，但是有了serde，它帮助我们更好的序列化结构体，生产对应的数据。它实现了各种<code>声明宏</code> 以及 <code>过程宏</code> 来协助我们序列化。</p><p>围绕着<code>serde</code>，也有很多衍生的子组件，例如<code>serde-json</code>, <code>serde-yaml</code>, <code>serde-qs</code> 等等。</p><p>由于我目前在开发 <code>gitlab-rs</code>，在生成对应的query_string 以及form的数据的时候，就比较棘手。</p><p>所以我在<code>gitlab-rs</code> 生成的过程宏中，借助了 <code>seder</code> 出色的序列化生态来完成功能。</p><a id="more"></a><h2 id="目前围绕serde支持的序列化的数据格式组件有："><a href="#目前围绕serde支持的序列化的数据格式组件有：" class="headerlink" title="目前围绕serde支持的序列化的数据格式组件有："></a>目前围绕serde支持的序列化的数据格式组件有：</h2><ul><li><a href="https://github.com/serde-rs/json" target="_blank" rel="noopener">JSON</a>，许多HTTP api都使用的JavaScript对象符号。</li><li><a href="https://github.com/servo/bincode" target="_blank" rel="noopener">Bincode</a>，一个紧凑的二进制格式，用于伺服渲染的IPC<br>引擎。</li><li><a href="https://github.com/pyfisch/cbor" target="_blank" rel="noopener">CBOR</a>，一种简洁的二进制对象表示，专为小消息大小设计<br>而不需要版本协商。</li><li><a href="https://github.com/dtolnay/serde-yaml" target="_blank" rel="noopener">YAML</a>，一个自称对人类友好的配置语言，其实不是<br>标记语言。</li><li><a href="https://github.com/3Hren/msgpack-rust" target="_blank" rel="noopener">MessagePack</a>，一个高效的二进制格式，类似于一个紧凑的JSON。</li><li><a href="https://github.com/alexcrichton/toml-rs" target="_blank" rel="noopener">TOML</a>， <a href="http://doc.crates.io/manifest.html" target="_blank" rel="noopener">Cargo</a>使用的最小配置格式。</li><li><a href="https://github.com/birkenfeld/serde-pickle" target="_blank" rel="noopener">Pickle</a>， Python世界中常见的格式。</li><li>[罗恩]，一个生锈的符号。<br>—<a href="https://github.com/zonyitoo/bson-rs" target="_blank" rel="noopener">BSON</a>， MongoDB使用的数据存储和网络传输格式。</li><li><a href="https://github.com/flavray/avro-rs" target="_blank" rel="noopener">Avro</a>，在Apache Hadoop中使用的二进制格式，支持schema<br>定义。</li><li><a href="https://github.com/callum-oakley/json5-rs" target="_blank" rel="noopener">JSON5</a>，一个JSON的超集，包括一些来自ES5的产品。</li><li>[明信片]，一个不_std和嵌入式系统友好的紧凑二进制格式。<br>—<a href="https://docs.rs/serde_qs" target="_blank" rel="noopener">URL</a>查询字符串，格式为x-www-form-urlencoded。</li><li><a href="https://github.com/softprops/envy" target="_blank" rel="noopener">Envy</a>，一种将环境变量反序列化为锈蚀结构的方法。</li></ul><p><em>(反序列化)</em></p><ul><li><a href="https://github.com/softprops/envy-store" target="_blank" rel="noopener">Envy Store</a>，一种反序列化<a href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-paramstore.html" target="_blank" rel="noopener">AWS Parameter Store</a>参数到Rust的方法<br>结构体。<em>(反序列化)</em></li><li><a href="https://github.com/rotty/lexpr-rs" target="_blank" rel="noopener">S-expressions</a>， Lisp使用的代码和数据的文本表示形式<br>语言的家庭。</li><li><a href="https://docs.rs/zvariant" target="_blank" rel="noopener">D-Bus</a>的二进制线格式。</li><li><a href="https://github.com/google/flatbuffers/tree/master/rust/flexbuffers" target="_blank" rel="noopener">FlexBuffers</a>，谷歌的FlatBuffers 0 -copy的无模式表兄弟<br>序列化格式。</li><li><a href="https://github.com/P3KI/bendy" target="_blank" rel="noopener">Bencode</a>，在BitTorrent协议中使用的一个简单的二进制格式。<br>—<a href="https://docs.rs/serde_dynamo" target="_blank" rel="noopener">DynamoDB Items</a>， <a href="https://docs.rs/rusoto_dynamodb" target="_blank" rel="noopener">rusoto_dynamodb</a>用来传输数据的格式<br>和DynamoDB。</li><li><a href="https://github.com/Canop/deser-hjson" target="_blank" rel="noopener">Hjson</a>，一个JSON的语法扩展，围绕人类阅读和编辑而设计。<em>(反序列化)</em></li></ul><h3 id="最简单的一个实例"><a href="#最简单的一个实例" class="headerlink" title="最简单的一个实例"></a>最简单的一个实例</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Point</span></span> &#123;</span><br><span class="line">    x: <span class="built_in">i32</span>,</span><br><span class="line">    y: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> point = Point &#123; x: <span class="number">1</span>, y: <span class="number">2</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Convert the Point to a JSON string.</span></span><br><span class="line">    <span class="keyword">let</span> serialized = serde_json::to_string(&amp;point).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prints serialized = &#123;"x":1,"y":2&#125;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"serialized = &#123;&#125;"</span>, serialized);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Convert the JSON string back to a Point.</span></span><br><span class="line">    <span class="keyword">let</span> deserialized: Point = serde_json::from_str(&amp;serialized).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prints deserialized = Point &#123; x: 1, y: 2 &#125;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"deserialized = &#123;:?&#125;"</span>, deserialized);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.01s</span><br><span class="line">     Running `target/debug/serde_test`</span><br><span class="line">serialized = &#123;"x":1,"y":2&#125;</span><br><span class="line">deserialized = Point &#123; x: 1, y: 2 &#125;</span><br></pre></td></tr></table></figure><h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><p>serde-device种支持 <code>3种</code> 属性，分别是:</p><ul><li>容器属性  用于结构体或者枚举</li><li>字体属性  用于枚举的变体</li><li>字段属性  用于结构体或者枚举种的字段 </li></ul><blockquote><p>字体属性 仅 用于枚举</p></blockquote><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="meta">#[serde(deny_unknown_fields)]</span>  <span class="comment">// &lt;-- this is a container attribute</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span></span> &#123;</span><br><span class="line">    <span class="meta">#[serde(default)]</span>  <span class="comment">// &lt;-- this is a field attribute</span></span><br><span class="line">    f: <span class="built_in">i32</span>,</span><br><span class="line">    s_e: E</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="meta">#[serde(rename = <span class="meta-string">"e"</span>)]</span>  <span class="comment">// &lt;-- this is also a container attribute</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">E</span></span> &#123;</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="meta-string">"a"</span>)]</span>  <span class="comment">// &lt;-- this is a variant attribute</span></span><br><span class="line">    A(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> point_s = S &#123; f: <span class="number">1</span> , s_e: E::A(<span class="built_in">String</span>::from(<span class="string">"inner-enum"</span>))&#125;;</span><br><span class="line">    <span class="comment">// Convert the Point to a JSON string.</span></span><br><span class="line">    <span class="keyword">let</span> serialized_a = serde_json::to_string(&amp;point_s).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"serialized_a: &#123;&#125;"</span>, serialized_a);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> point_e = E::A(<span class="built_in">String</span>::from(<span class="string">"my-enum"</span>));</span><br><span class="line">    <span class="comment">// Convert the Point to a JSON string.</span></span><br><span class="line">    <span class="keyword">let</span> serialized_e = serde_json::to_string(&amp;point_e).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"serialized_e: &#123;&#125;"</span>, serialized_e)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.01s</span><br><span class="line">     Running `target/debug/serde_test`</span><br><span class="line">serialized_a: &#123;"f":1,"s_e":&#123;"a":"inner-enum"&#125;&#125;</span><br><span class="line">serialized_e: &#123;"a":"my-enum"&#125;</span><br></pre></td></tr></table></figure><p>既然我们知道了serde有种类型的属性，具体都有哪些属性，大家一定也感兴趣。</p><h4 id="容器属性-Container-attributes"><a href="#容器属性-Container-attributes" class="headerlink" title="容器属性(Container attributes)"></a>容器属性(Container attributes)</h4><h5 id="serde-rename-“name”"><a href="#serde-rename-“name”" class="headerlink" title="#[serde(rename = “name”)]"></a>#[serde(rename = “name”)]</h5><p><code>#[serde(rename = &quot;name&quot;)]</code></p><p>序列化和反序列化的时候用一个名字来代替Rust结构体的名字</p><p>当然，也允许独立设置和分别设置:</p><ul><li><code>#[serde(rename(serialize = &quot;ser_name&quot;))]</code></li><li><code>#[serde(rename(deserialize = &quot;de_name&quot;))]</code></li><li><code>#[serde(rename(serialize = &quot;ser_name&quot;, deserialize = &quot;de_name&quot;))]</code></li></ul><h5 id="serde-rename-all-“…”"><a href="#serde-rename-all-“…”" class="headerlink" title="#[serde(rename_all = “…”)]"></a>#[serde(rename_all = “…”)]</h5><p><code>#[serde(rename_all = &quot;...&quot;)]</code></p><p>根据给定的大小写约定重命名所有字段（如果这是一个结构）或变量（如果这是一个枚举）。可能的值是<code>&quot;lowercase&quot;</code>,<br>  <code>&quot;UPPERCASE&quot;</code>, <code>&quot;PascalCase&quot;</code>, <code>&quot;camelCase&quot;</code>, <code>&quot;snake_case&quot;</code>,<br>  <code>&quot;SCREAMING_SNAKE_CASE&quot;</code>, <code>&quot;kebab-case&quot;</code>, <code>&quot;SCREAMING-KEBAB-CASE&quot;</code>。</p><p>顾名思义，这个容器属性主要是允许你定义驼峰，蛇形等序列化以及反序列化的字段</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="meta">#[serde(deny_unknown_fields)]</span>  <span class="comment">// &lt;-- this is a container attribute</span></span><br><span class="line"><span class="meta">#[serde(rename_all = <span class="meta-string">"UPPERCASE"</span>)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span></span> &#123;</span><br><span class="line">    <span class="meta">#[serde(default)]</span>  <span class="comment">// &lt;-- this is a field attribute</span></span><br><span class="line">    f: <span class="built_in">i32</span>,</span><br><span class="line">    hello_world: E</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="meta">#[serde(rename = <span class="meta-string">"e"</span>)]</span>  <span class="comment">// &lt;-- this is also a container attribute</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">E</span></span> &#123;</span><br><span class="line">    <span class="meta">#[serde(rename = <span class="meta-string">"a"</span>)]</span>  <span class="comment">// &lt;-- this is a variant attribute</span></span><br><span class="line">    A(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> point_s = S &#123; f: <span class="number">1</span> , hello_world: E::A(<span class="built_in">String</span>::from(<span class="string">"inner-enum"</span>))&#125;;</span><br><span class="line">    <span class="comment">// Convert the Point to a JSON string.</span></span><br><span class="line">    <span class="keyword">let</span> serialized_a = serde_json::to_string(&amp;point_s).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// normal output =&gt; serialized_a: &#123;"f":1,"hello_world":&#123;"a":"inner-enum"&#125;&#125;</span></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"serialized_a: &#123;&#125;"</span>, serialized_a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.02s</span><br><span class="line">     Running `target/debug/serde_test`</span><br><span class="line">serialized_a: &#123;"F":1,"HELLO_WORLD":&#123;"a":"inner-enum"&#125;&#125;</span><br></pre></td></tr></table></figure><h5 id="serde-deny-unknown-fields"><a href="#serde-deny-unknown-fields" class="headerlink" title="#[serde(deny_unknown_fields)]"></a>#[serde(deny_unknown_fields)]</h5><p>遇到未知字段时，在反序列化期间始终会出错。当此属性不存在时，默认情况下，对于诸如JSON之类的自描述格式，未知字段将被忽略。</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span></span> &#123;</span><br><span class="line">    <span class="meta">#[serde(default)]</span></span><br><span class="line">    f: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s = r#<span class="string">"</span></span><br><span class="line"><span class="string">    &#123;"</span>f<span class="string">":1,"</span>s_e<span class="string">":&#123;"</span>a<span class="string">":"</span>inner-<span class="class"><span class="keyword">enum</span>"&#125;&#125;</span></span><br><span class="line"><span class="class">    "#;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">let</span></span> uns: S = serde_json::from_str(&amp;s).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"un: &#123;:?&#125;"</span>, uns);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.02s</span><br><span class="line">     Running `target/debug/serde_test`</span><br><span class="line">un: S &#123; f: 1&#125;</span><br></pre></td></tr></table></figure><p>可以看到成功输出。如果没有匹配到字段到话会自动忽略。但是如果你希望严格到匹配的话。那么就可以加上此容器属性.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> serde::&#123;Serialize, Deserialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, Debug)]</span></span><br><span class="line"><span class="meta">#[serde(deny_unknown_fields)]</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span></span> &#123;</span><br><span class="line">    <span class="meta">#[serde(default)]</span></span><br><span class="line">    f: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> s = r#<span class="string">"</span></span><br><span class="line"><span class="string">    &#123;"</span>f<span class="string">":1,"</span>s_e<span class="string">":&#123;"</span>a<span class="string">":"</span>inner-<span class="class"><span class="keyword">enum</span>"&#125;&#125;</span></span><br><span class="line"><span class="class">    "#;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">    <span class="title">let</span></span> uns: S = serde_json::from_str(&amp;s).unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"un: &#123;:?&#125;"</span>, uns);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/Users/caiwenhui/.cargo/bin/cargo run --color=always --package serde_test --bin serde_test</span><br><span class="line">    Finished dev [unoptimized + debuginfo] target(s) in 0.02s</span><br><span class="line">     Running `target/debug/serde_test`</span><br><span class="line">thread 'main' panicked at 'called `Result::unwrap()` on an `Err` value: Error("unknown field `s_e`, expected `f` or `s_e`", line: 2, column: 44)', src/main.rs:34:43</span><br><span class="line">stack backtrace:</span><br><span class="line">   0: rust_begin_unwind</span><br><span class="line">             at /rustc/e1884a8e3c3e813aada8254edfa120e85bf5ffca/library/std/src/panicking.rs:495:5</span><br><span class="line">   1: core::panicking::panic_fmt</span><br><span class="line">             at /rustc/e1884a8e3c3e813aada8254edfa120e85bf5ffca/library/core/src/panicking.rs:92:14</span><br><span class="line">   2: core::option::expect_none_failed</span><br><span class="line">             at /rustc/e1884a8e3c3e813aada8254edfa120e85bf5ffca/library/core/src/option.rs:1268:5</span><br><span class="line">   3: core::result::Result&lt;T,E&gt;::unwrap</span><br><span class="line">             at /Users/caiwenhui/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/core/src/result.rs:973:23</span><br><span class="line">   4: serde_test::main</span><br><span class="line">             at ./src/main.rs:34:18</span><br><span class="line">   5: core::ops::function::FnOnce::call_once</span><br><span class="line">             at /Users/caiwenhui/.rustup/toolchains/stable-x86_64-apple-darwin/lib/rustlib/src/rust/library/core/src/ops/function.rs:227:5</span><br><span class="line">note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.</span><br></pre></td></tr></table></figure><p>可以看到这里会报错.</p><h5 id="serde-tag-“type”"><a href="#serde-tag-“type”" class="headerlink" title="#[serde(tag = “type”)]"></a>#[serde(tag = “type”)]</h5><p>该属性只适用于枚举体，具体用法详见:[ enum representations ](<a href="https://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md" target="_blank" rel="noopener">https://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md</a>)</p><h5 id="serde-tag-“t”-content-“c”"><a href="#serde-tag-“t”-content-“c”" class="headerlink" title="#[serde(tag = “t”, content = “c”)]"></a>#[serde(tag = “t”, content = “c”)]</h5><p>该属性只适用于枚举体，具体用法详见:[ enum representations ](<a href="https://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md" target="_blank" rel="noopener">https://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md</a>)</p><h5 id="serde-untagged"><a href="#serde-untagged" class="headerlink" title="#[serde(untagged)]"></a>#[serde(untagged)]</h5><p>该属性只适用于枚举体，具体用法详见:[ enum representations ](<a href="https://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md" target="_blank" rel="noopener">https://github.com/serde-rs/serde-rs.github.io/blob/master/_src/enum-representations.md</a>)</p><h2 id="serde"><a href="#serde" class="headerlink" title="serde"></a>serde</h2><h2 id="serde-qs"><a href="#serde-qs" class="headerlink" title="serde-qs"></a>serde-qs</h2>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;Rust 中有一个 99%的程序员或许都会用到的组件，那就是序列化组件: serde。&lt;/p&gt;
&lt;p&gt;众所周知，rust的静态语言，所以这让我们在序列化上繁琐了很多，但是有了serde，它帮助我们更好的序列化结构体，生产对应的数据。它实现了各种&lt;code&gt;声明宏&lt;/code&gt; 以及 &lt;code&gt;过程宏&lt;/code&gt; 来协助我们序列化。&lt;/p&gt;
&lt;p&gt;围绕着&lt;code&gt;serde&lt;/code&gt;，也有很多衍生的子组件，例如&lt;code&gt;serde-json&lt;/code&gt;, &lt;code&gt;serde-yaml&lt;/code&gt;, &lt;code&gt;serde-qs&lt;/code&gt; 等等。&lt;/p&gt;
&lt;p&gt;由于我目前在开发 &lt;code&gt;gitlab-rs&lt;/code&gt;，在生成对应的query_string 以及form的数据的时候，就比较棘手。&lt;/p&gt;
&lt;p&gt;所以我在&lt;code&gt;gitlab-rs&lt;/code&gt; 生成的过程宏中，借助了 &lt;code&gt;seder&lt;/code&gt; 出色的序列化生态来完成功能。&lt;/p&gt;
    
    </summary>
    
    
      <category term="rust" scheme="http://blog.crazylaw.cn/categories/rust/"/>
    
    
      <category term="rust" scheme="http://blog.crazylaw.cn/tags/rust/"/>
    
  </entry>
  
  <entry>
    <title>【数据库开发】msource</title>
    <link href="http://blog.crazylaw.cn/2021/03/27/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/msource/"/>
    <id>http://blog.crazylaw.cn/2021/03/27/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/msource/</id>
    <published>2021-03-26T17:16:43.000Z</published>
    <updated>2021-03-31T09:00:10.369Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>CAP</code>原则又称CAP定理，指的是在一个分布式系统中，<code>一致性（Consistency）</code>、<code>可用性（Availability）</code>、<code>分区容错性（Partition tolerance）</code>。CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。</p><p><code>msource</code> 是我们的一个 <code>数据源组件</code>，我们所有的大数据ETL服务都构建在此之上，所以我们msource可以说是所有业务系统的核心。他维护着一个稳定，可靠，高性能的数据传输机制。让我们 <code>业务层</code> 中可以做各种操作，同步，异步等等。</p><p>msource 的角色我大体分为了2种：</p><ul><li>spout （数据推送组件)</li><li>db （数据存储组件）</li></ul><a id="more"></a><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/spout_db_relation.png" alt=" spout和db的关系 "></p><p>在这个图中，我们可以看到，db可以独立出来应用，他不依赖于spout。spout默认的传输机制是我们golang中的channel模式，但是它可以选择使用db模式。</p><h1 id="MSOURCE-DB"><a href="#MSOURCE-DB" class="headerlink" title="MSOURCE_DB"></a>MSOURCE_DB</h1><h2 id="RockesDB的基础知识"><a href="#RockesDB的基础知识" class="headerlink" title="RockesDB的基础知识"></a>RockesDB的基础知识</h2><p>rocksdb 我们知道他是支持WAL（Write Ahead Log）的，一般的log文件中通常包括 <code>redo log</code> 和 <code>undo log</code>。其实这不仅仅是rocksdb独有的，这是一种可靠性的保证，像mysql一样有这种机制，也是分为<code>redo log</code>, <code>undo log</code>, <code>binlog</code>，区别就在于 <code>binlog</code> 属于逻辑日志，<code>redo log</code>和<code>undo log</code>属于物理日志。</p><p>rocksdb是facebook开发的一个<code>kv存储引擎</code>。他的机构模式是基于<code>LSM</code>的。基于LSM的架构都需要经过一个叫 <code>Compaction</code>  过程，通常Compaction涉及到三个放大因子。</p><p>Compaction需要在三者之间做取舍。</p><ul><li>写放大 （Write Amplification）</li><li>读放大（Read Amplification）</li><li>空间放大 （Space Amplification）</li></ul><p>后台的 compaction 来减少读放大（减少 SST 文件数量）和空间放大（清理过期数据），但也因此带来了写放大（Write Amplification）的问题。</p><h3 id="Compaction"><a href="#Compaction" class="headerlink" title="Compaction"></a>Compaction</h3><h4 id="写放大"><a href="#写放大" class="headerlink" title="写放大"></a>写放大</h4><p>假设每秒写入10MB的数据，但观察到硬盘的写入是30MB/s，那么写放大就是3。写分为<code>立即写</code>和<code>延迟写</code>，比如<code>redo log</code>是立即写，传统基于B-Tree数据库<code>刷脏页</code>和<code>LSM Compaction</code>是延迟写。<code>redo log</code>使用<code>direct IO</code>写时至少以512字节对齐，假如log记录为100字节，磁盘需要写入512字节，写放大为5。</p><blockquote><p>DirectIO是直接操作IO，不经过BufferIO。<br>BufferIO也称为标准IO，两个系统调用实现的：read() 和 write()。BufferIO用了操作系统内核的页缓存，保护了磁盘，减少读盘的次数，提高了读取速度。但是由于使用了页缓存，它是处于内核空间的，无法被用户直接操作，所以需要经历一次数据拷贝复制。<br>DirectIO 数据均直接在用户地址空间的缓冲区和磁盘之间直接进行传输，中间少了页缓存的支持。读写数据的时候获得更好的性能。使用直接 I/O 读写数据必须要注意缓冲区对齐。</p></blockquote><h4 id="读放大"><a href="#读放大" class="headerlink" title="读放大"></a>读放大</h4><p>对应于一个简单query需要读取硬盘的次数。比如一个简单query读取了5个页面，发生了5次IO，那么读放大就是 5。假如B-Tree的非叶子节点都缓存在内存中，point read-amp 为1，一次磁盘读取就可以获取到Leaf Block；short range read-amp 为1<del>2，1</del>2次磁盘读取可以获取到所需的Leaf Block。</p><p>操作需要从新到旧（从上到下）一层一层查找，直到找到想要的数据。这个过程可能需要<code>不止一次 I/O</code>。特别是 range query 的情况，影响很明显。</p><h4 id="空间放大"><a href="#空间放大" class="headerlink" title="空间放大"></a>空间放大</h4><p>假设我需要存储10MB数据，但实际硬盘占用了30MB，那么空间放大就是3。有比较多的因素会影响空间放大，比如在Compaction过程中需要临时存储空间，空间碎片，Block中有效数据的比例小，旧版本数据未及时删除等等。</p><p>所有的写入都是顺序写 <code>append-only</code> 的，不是 <code>in-place update</code>，所以过期数据不会马上被清理掉。</p><h3 id="LSM-树"><a href="#LSM-树" class="headerlink" title="LSM 树"></a>LSM 树</h3><p>LSM 树的设计思想非常朴素, 它的原理是把一颗大树拆分成N棵小树， 它首先写入到内存中（内存没有寻道速度的问题，随机写的性能得到大幅提升），在内存中构建一颗有序小树，随着小树越来越大，内存的小树会flush到磁盘上。磁盘中的树定期可以做 merge 操作，合并成一棵大树，以优化读性能【读数据的过程可能需要从内存 memtable 到磁盘 sstfile 读取多次，称之为读放大】。RocksDB 的 LSM 体现在多 level 文件格式上，最热最新的数据尽在 L0 层，数据在内存中，最冷最老的数据尽在 LN 层，数据在磁盘或者固态盘上。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/log_structured_merge_tree.png" alt=" LSM合并过程 "></p><h3 id="Rocksdb"><a href="#Rocksdb" class="headerlink" title="Rocksdb"></a>Rocksdb</h3><p>RocksDB的三种基本文件格式是 <code>memtable</code> / <code>sstfile</code> / <code>logfile</code>，<code>memtable</code> 是一种内存文件数据系统，新写数据会被写进 <code>memtable</code>，部分请求内容会被写进 <code>logfile</code>。<code>logfile</code> 是一种有利于顺序写的文件系统。<code>memtable</code> 的内存空间被填满之后，会有一部分老数据被转移到 <code>sstfile</code> 里面，这些数据对应的 <code>logfile</code> 里的 <code>log</code> 就会被安全删除</p><p>单独的 Get/Put/Delete 是原子操作，要么成功要么失败，不存在中间状态。</p><p>如果需要进行批量的 Get/Put/Delete 操作且需要操作保持原子属性，则可以使用 WriteBatch。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/L0.png" alt=" LSM合并过程0 "></p><p>L0 -&gt; L1</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/L1.png" alt=" LSM合并过程1 "></p><p>L1 -&gt; L2</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/L2.png" alt=" LSM合并过程2 "></p><p>L1 -&gt; L2</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/write_process.png" alt=" 写入过程 "></p><p>可以看到主要的三个组成部分，内存结构<code>memtable</code>，类似事务日志角色的<code>WAL文件</code>，持久化的<code>SST文件</code>。</p><p>数据会放到内存结构<code>memtable</code>，当<code>memtable</code>的数据大小超过阈值(write_buffer_size)后，会<code>新生成一个memtable</code>继续写，将前一个memtable保存为<code>只读memtable</code>。当只读memtable的数量超过阈值后，会将<code>所有的只读memtable</code>合并并flush到磁盘生成一个<code>SST文件</code>。</p><p>这里的SST属于level0， level0中的每个SST有序，可能会有交叉。写入WAL文件是<code>可选的</code>，用来<code>恢复未写入到磁盘的memtable</code>。</p><p>memtable如其名为一种内存的数据结构。通过设置memtable的大小、总大小来控制何时flush到SST文件。大部分格式的memtable不支持并发写入，并发调用依然会依次写入。目前仅支持<code>skiplist</code>。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rocksdb:</span></span><br><span class="line">  <span class="attr">options:</span></span><br><span class="line">    <span class="comment"># 如果数据库不存在是否自动建立</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">create.if.missing:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 如果数据库已经存在是否直接抛出异常</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">error.if.exists:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">paranoid.checks:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 日志等级</span></span><br><span class="line">    <span class="comment"># Debug = 0/Info  = 1/Warn  = 2/Error = 3/Fatal = 4</span></span><br><span class="line">    <span class="attr">info.log.level:</span> <span class="number">3</span></span><br><span class="line">    <span class="comment"># 最佳值是内核（cpu）数</span></span><br><span class="line">    <span class="comment"># 默认RocksDB只使用一个后台线程进行flush和compaction</span></span><br><span class="line">    <span class="comment"># default: 1</span></span><br><span class="line">    <span class="attr">increase.parallelism:</span> <span class="number">4</span></span><br><span class="line">    <span class="comment"># 是否允许并发写入memtabe，目前仅支持skiplist</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">allow.concurrent.memtable.writes:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 更大的值可以提高性能，特别是在批量加载时</span></span><br><span class="line">    <span class="comment"># 此外，更大的写缓冲区在下次打开数据库时将导致更长的恢复时间</span></span><br><span class="line">    <span class="attr">write.buffer.size:</span> <span class="number">64</span> <span class="string">*</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">1024</span></span><br><span class="line">    <span class="comment"># 最大写缓冲区数, 当一个写缓冲区被刷新到存储时，新的写操作可以继续到另一个写缓冲区</span></span><br><span class="line">    <span class="comment"># default: 2</span></span><br><span class="line">    <span class="attr">max.write.buffer.number:</span> <span class="number">4</span></span><br><span class="line">    <span class="attr">min.write.buffer.number.to.merge:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">max.open.files:</span> <span class="number">1000</span></span><br><span class="line">    <span class="attr">max.file.opening.threads:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># 数据压缩方式</span></span><br><span class="line">    <span class="comment"># No = 0/ Snappy = 1 / ZLib = 2 / Bz2 = 3 / LZ4 = 4 / LZ4HC = 5 / Xpress = 6 / ZSTD = 7</span></span><br><span class="line">    <span class="attr">compression:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># 设置数据库的level的数量</span></span><br><span class="line">    <span class="comment"># 默认值为7层</span></span><br><span class="line">    <span class="attr">num.levels:</span> <span class="number">7</span></span><br><span class="line">    <span class="comment"># level-0 触发合并的的文件数条件</span></span><br><span class="line">    <span class="attr">level0.file.num.compaction.trigger:</span> <span class="number">4</span></span><br><span class="line">    <span class="comment"># level-0 放慢写入速度的文件数条件</span></span><br><span class="line">    <span class="attr">level0.slowdown.writes.trigger:</span> <span class="number">8</span></span><br><span class="line">    <span class="comment"># level-0 停止写入的文件数条件</span></span><br><span class="line">    <span class="attr">level0.stop.writes.trigger:</span> <span class="number">12</span></span><br><span class="line">    <span class="comment"># 尝试从mem到sst的最大级别</span></span><br><span class="line">    <span class="attr">max.mem.compaction.level:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># 目标文件基础大小</span></span><br><span class="line">    <span class="comment"># 如果 target_file_size_base是2MB,</span></span><br><span class="line">    <span class="comment"># target_file_size_multiplier是10，</span></span><br><span class="line">    <span class="comment"># 那么第1级的每个文件都是2MB</span></span><br><span class="line">    <span class="comment"># 第2级的每个文件是20MB</span></span><br><span class="line">    <span class="comment"># 第3级的每个文件是200MB</span></span><br><span class="line">    <span class="attr">target.file.size.base:</span> <span class="string">&amp;target_file_size_base</span> <span class="number">2</span> <span class="string">*</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">1024</span></span><br><span class="line">    <span class="comment"># 目标基础文件倍数</span></span><br><span class="line">    <span class="attr">target.file.size.multiplier:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># 所在level所有文件总大小</span></span><br><span class="line">    <span class="comment"># 例如，max_bytes_for_level_base为20MB,</span></span><br><span class="line">    <span class="comment"># max_bytes_for_level_multiplier为10，则第1级的总数据大小为20MB</span></span><br><span class="line">    <span class="comment"># 第2级的总文件大小为200MB</span></span><br><span class="line">    <span class="comment"># 第3级的总文件大小为2GB</span></span><br><span class="line">    <span class="comment"># default: 10M</span></span><br><span class="line">    <span class="attr">max.bytes.for.level.base:</span> <span class="number">10</span> <span class="string">*</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">1024</span></span><br><span class="line">    <span class="comment"># 目标所在level总文件大小</span></span><br><span class="line">    <span class="comment"># default: 10</span></span><br><span class="line">    <span class="attr">max.bytes.for.level.multiplier:</span> <span class="number">10.0</span></span><br><span class="line">    <span class="attr">level.compaction.dynamic.level.bytes:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 一次性最大打压缩字节</span></span><br><span class="line">    <span class="comment"># Default: target.file.size.base * 25</span></span><br><span class="line">    <span class="attr">max.compaction.bytes:</span> <span class="string">*target_file_size_base</span> <span class="string">*</span> <span class="number">25</span></span><br><span class="line">    <span class="comment"># 软限制：当需要压缩的估计字节数超过这个阈值时，所有的写都会被减速到至少 delayed_write_rate</span></span><br><span class="line">    <span class="comment"># default: 64GB</span></span><br><span class="line">    <span class="attr">soft.pending.compaction.bytes.limit:</span> <span class="number">64</span> <span class="string">*</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">1024</span></span><br><span class="line">    <span class="comment"># 硬限制：当需要压缩的估计字节数超过这个阈值时，所有的写都停止</span></span><br><span class="line">    <span class="comment"># default: 256GB</span></span><br><span class="line">    <span class="attr">hard.pending.compaction.bytes.limit:</span> <span class="number">256</span> <span class="string">*</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">1024</span></span><br><span class="line">    <span class="comment"># 是否使用fsync刷盘</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">use.fsync:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 指定数据库的日志目录的绝对路径，如果为空则和数据放在同一个目录</span></span><br><span class="line">    <span class="comment"># default: empty</span></span><br><span class="line">    <span class="attr">db.log.dir:</span> <span class="string">""</span></span><br><span class="line">    <span class="comment"># 指定数据库的WAL(预写入日志)的目录的绝对路径，如果为空则和数据放在同一个目录</span></span><br><span class="line">    <span class="attr">wal.dir:</span> <span class="string">""</span></span><br><span class="line">    <span class="comment"># 设置过期文件被删除的周期</span></span><br><span class="line">    <span class="comment"># 通过压缩过程超出作用域的文件在每次压缩时仍然会被自动删除，不管这个设置是什么</span></span><br><span class="line">    <span class="comment"># default: 6 hours</span></span><br><span class="line">    <span class="attr">delete.obsolete.files.period.micros:</span> <span class="number">6</span> <span class="string">*</span> <span class="number">60</span> <span class="string">*</span> <span class="number">60</span> <span class="string">*</span> <span class="number">1000</span> <span class="string">*</span> <span class="number">1000</span></span><br><span class="line">    <span class="comment"># 设置后台任务的最大并发数，作用与低优先级线程池</span></span><br><span class="line">    <span class="comment"># default: 1</span></span><br><span class="line">    <span class="attr">max.background.compactions:</span> <span class="number">2</span></span><br><span class="line">    <span class="comment"># 高优先级线程池的后台 memtable 的 flush 任务的最大并发数</span></span><br><span class="line">    <span class="comment"># 默认所有任务都在低优先级池</span></span><br><span class="line">    <span class="comment"># default: 0</span></span><br><span class="line">    <span class="attr">max.background.flushes:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 设置日志文件的最大大小，如果日志文件大于这个值将会被创建一个新的日志文件</span></span><br><span class="line">    <span class="comment"># 如果等于0，则日志只会写入一个日志文件</span></span><br><span class="line">    <span class="comment"># default: 0</span></span><br><span class="line">    <span class="attr">max.log.file.size:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 日志文件滚动的时间(以秒为单位)，日志按一定时间轮转</span></span><br><span class="line">    <span class="comment"># default: 0 (禁用状态)</span></span><br><span class="line">    <span class="attr">log.file.time.to.roll:</span> <span class="number">24</span> <span class="string">*</span> <span class="number">60</span> <span class="string">*</span> <span class="number">60</span></span><br><span class="line">    <span class="comment"># 最多保留的日志文件数</span></span><br><span class="line">    <span class="comment"># default: 1000</span></span><br><span class="line">    <span class="attr">keep.log.file.num:</span> <span class="number">30</span></span><br><span class="line">    <span class="comment"># 软速率限制</span></span><br><span class="line">    <span class="comment"># 当任何level的压缩分数超过soft_rate_limit时，put被延迟0-1毫秒。当 等于 0.0时，此参数将被忽略</span></span><br><span class="line">    <span class="comment"># soft_rate_limit &lt;= hard_rate_limit。如果此约束不存在，RocksDB将设置soft_rate_limit = hard_rate_limit</span></span><br><span class="line">    <span class="comment"># default: 0.0(禁用状态)</span></span><br><span class="line">    <span class="attr">soft.rate.limit:</span> <span class="number">0.0</span></span><br><span class="line">    <span class="comment"># 硬速率限制</span></span><br><span class="line">    <span class="comment"># 当任何level的压缩分数超过hard_rate_limit时，put每次延迟1ms。当 小于等于 1.0 时，此参数被忽略</span></span><br><span class="line">    <span class="comment"># default: 0.0(禁用状态)</span></span><br><span class="line">    <span class="attr">hard.rate.limit:</span> <span class="number">0.0</span></span><br><span class="line">    <span class="comment"># 设置当强制执行hard_rate_limit时，put被停止的最大时间, 0 = 没有限制</span></span><br><span class="line">    <span class="comment"># default: 1000</span></span><br><span class="line">    <span class="attr">rate.limit.delay.max.milliseconds:</span> <span class="number">1000</span></span><br><span class="line">    <span class="comment"># 设置最大清单文件大小，直到滚动为止, 会删除旧的清单文件</span></span><br><span class="line">    <span class="comment"># 默认值:MAX_INT，这样滚动就不会发生</span></span><br><span class="line">    <span class="attr">max.manifest.file.size:</span> <span class="number">1</span><span class="string">&lt;&lt;64</span> <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># 设置表缓存使用的分片数量</span></span><br><span class="line">    <span class="comment"># default: 4</span></span><br><span class="line">    <span class="attr">table.cache.numshardbits:</span> <span class="number">4</span></span><br><span class="line">    <span class="comment"># 设置扫描过程中的计数限制</span></span><br><span class="line">    <span class="comment"># 在表的LRU缓存数据回收时，严格遵循LRU是低效的，因为这块内存不会真正被释放，除非它的refcount降到零。</span></span><br><span class="line">    <span class="comment"># 相反，进行两次传递:第一次传递将释放refcount = 1的项，如果在扫描该参数指定的元素数量后没有足够的空间释放，将按LRU顺序删除项</span></span><br><span class="line">    <span class="comment"># default: 16</span></span><br><span class="line">    <span class="attr">table.cache.remove.scan.count.limit:</span> <span class="number">16</span></span><br><span class="line">    <span class="comment"># default: 0 (自动计算一个合适的值)</span></span><br><span class="line">    <span class="attr">arena.block.size:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 启用/禁用自动压缩</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">disable.auto.compactions:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 设置 Wal 的恢复模式</span></span><br><span class="line">    <span class="comment"># TolerateCorruptedTailRecordsRecovery = 0 / AbsoluteConsistencyRecovery = 1</span></span><br><span class="line">    <span class="comment"># PointInTimeRecovery = 2 / SkipAnyCorruptedRecordsRecovery = 3</span></span><br><span class="line">    <span class="comment"># default: 0</span></span><br><span class="line">    <span class="attr">w.a.l.recovery.mode:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 设置wal的ttl时间</span></span><br><span class="line">    <span class="comment"># 有2个值影响 归档的 wal 是否会被删除</span></span><br><span class="line">    <span class="comment"># 1。如果两者都设置为0，日志将被尽快删除，并且不会进入存档。</span></span><br><span class="line">    <span class="comment"># 2。如果wal_ttl_seconds为0,wal_size_limit_mb不为0，则每10分钟检查一次WAL文件，如果总大小大于wal_size_limit_mb，则从最早的文件开始删除，直到满足size_limit。所有的空文件将被删除。</span></span><br><span class="line">    <span class="comment"># 3。如果wal_ttl_seconds不为0,wall_size_limit_mb为0，那么每个wal_ttl_seconds / 2都会检查WAL文件，比wal_ttl_seconds老的文件会被删除。</span></span><br><span class="line">    <span class="comment"># 4。如果两个都不是0，则每10分钟检查一次WAL文件，并且两个检查都将在ttl优先的情况下执行。</span></span><br><span class="line">    <span class="comment"># default: 0</span></span><br><span class="line">    <span class="attr">w.a.l.ttl.seconds:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 设置WAL大小限制，单位为MB</span></span><br><span class="line">    <span class="comment"># 如果WAL文件的总大小大于wal_size_limit_mb，则从最早的文件开始删除，直到满足size_limit值为止</span></span><br><span class="line">    <span class="comment"># default: 0</span></span><br><span class="line">    <span class="attr">wal.size.limit.mb:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 允许管道写入</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">enable.pipelined.write:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 设置预分配(通过fallocate) manifest文件的字节数</span></span><br><span class="line">    <span class="comment"># 默认值是4mb，这对于减少随机IO以及防止预分配大量数据的挂载(例如xfs的allocsize选项)过度分配是合理的</span></span><br><span class="line">    <span class="comment"># default: 4mb</span></span><br><span class="line">    <span class="attr">manifest.preallocation.size:</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">1024</span> <span class="string">*</span> <span class="number">4</span></span><br><span class="line">    <span class="comment"># 当memtable被刷新到存储中时[启用|禁用] 清除 [重复\被删除]的 键</span></span><br><span class="line">    <span class="comment"># default: true</span></span><br><span class="line">    <span class="attr">purge.redundant.kvs.while.flush:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 开启/关闭sst表的mmap读功能</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">allow.mmap.reads:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 开启/关闭sst表的mmap写功能</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">allow.mmap.writes:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 启用/禁用读操作的直接I/O模式(O_DIRECT)</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">use.direct.reads:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 启用/禁用后台flush和compaction的直接I/O模式(O_DIRECT)</span></span><br><span class="line">    <span class="comment"># 当为true时，new_table_reader_for_compaction_inputs被强制为true。</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">use.direct.i.o.for.flush.and.compaction:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># [开启|禁用] 子进程继承打开的文件</span></span><br><span class="line">    <span class="comment"># default: true</span></span><br><span class="line">    <span class="attr">is.fd.close.on.exec:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># [启用|禁用]在恢复时跳过日志损坏错误(如果客户端可以丢失最近的更改)</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">skip.log.error.on.recovery:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 设置统计转储周期，以秒为单位</span></span><br><span class="line">    <span class="comment"># default: 3600 (1 hour)</span></span><br><span class="line">    <span class="attr">stats.dump.period.sec:</span> <span class="number">3600</span></span><br><span class="line">    <span class="comment"># 当打开sst文件时，是否会提示底层文件系统文件访问模式是随机的</span></span><br><span class="line">    <span class="comment"># default: true</span></span><br><span class="line">    <span class="attr">advise.random.on.open:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 设置所有列族写入磁盘之前在memtables中建立的数据量。</span></span><br><span class="line">    <span class="comment"># 这与write_buffer_size不同，后者强制对单个memtable进行限制</span></span><br><span class="line">    <span class="comment"># default: 0(禁用)</span></span><br><span class="line">    <span class="attr">db.write.buffer.size:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 压缩启动后的文件访问模式</span></span><br><span class="line">    <span class="comment"># NoneCompactionAccessPattern = 0, NormalCompactionAccessPattern = 1</span></span><br><span class="line">    <span class="comment"># SequentialCompactionAccessPattern = 2, WillneedCompactionAccessPattern = 3</span></span><br><span class="line">    <span class="comment"># default: NormalCompactionAccessPattern</span></span><br><span class="line">    <span class="attr">access.hint.on.compaction.start:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># 启用/禁用自适应互斥锁，它在求助于内核之前在用户空间旋转</span></span><br><span class="line">    <span class="comment"># 当互斥锁不是严重竞争时，可以减少上下文切换。但是，如果互斥对象是热的，最终可能会浪费旋转时间</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">use.adaptive.mutex:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 允许操作系统在后台异步写入文件时增量同步文件到磁盘</span></span><br><span class="line">    <span class="comment"># 对每写一个bytes_per_sync发出一个请求。</span></span><br><span class="line">    <span class="comment"># default: 0(禁用)</span></span><br><span class="line">    <span class="attr">bytes.per.sync:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 设置压缩样式</span></span><br><span class="line">    <span class="comment"># LevelCompactionStyle = 0 / UniversalCompactionStyle = 1 / FIFOCompactionStyle = 2</span></span><br><span class="line">    <span class="comment"># default: LevelCompactionStyle</span></span><br><span class="line">    <span class="attr">compaction.style:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 指定迭代-&gt;Next()是否按顺序跳过具有相同user-key的键</span></span><br><span class="line">    <span class="comment"># 这个数字指定在重寻之前将被连续跳过的键数(与userkey相同)</span></span><br><span class="line">    <span class="comment"># default: 8</span></span><br><span class="line">    <span class="attr">max.sequential.skip.in.iterations:</span> <span class="number">8</span></span><br><span class="line">    <span class="comment">#[启用|禁用]线程安全的就地更新</span></span><br><span class="line">    <span class="comment"># default: false</span></span><br><span class="line">    <span class="attr">inplace.update.support:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 用于就地更新的锁的数量</span></span><br><span class="line">    <span class="comment"># default: 0, ，如果 inplace_update_support = true ，则为 10000</span></span><br><span class="line">    <span class="attr">inplace.update.num.locks:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 设置memtable使用的arena的大页大小</span></span><br><span class="line">    <span class="comment"># 如果&lt;=0，它不会从大页分配，而是从malloc分配。用户有责任为它预留巨大的页面以供分配。</span></span><br><span class="line">    <span class="comment"># 例如:sysctl -w vm.nr_hugepages=20</span></span><br><span class="line">    <span class="comment"># 参见linux doc Documentation/vm/hugetlbpage.txt</span></span><br><span class="line">    <span class="comment"># 如果没有足够的空闲大页，它会退回到malloc</span></span><br><span class="line">    <span class="comment"># 通过SetOptions() API动态更改</span></span><br><span class="line">    <span class="attr">memtable.huge.page.size:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 设置布隆过滤器的指针位置</span></span><br><span class="line">    <span class="comment"># 控制bloom filter探针的位置，以提高缓存遗漏率。</span></span><br><span class="line">    <span class="comment"># 该选项仅适用于memtable前缀bloom和plain前缀bloom。</span></span><br><span class="line">    <span class="comment"># 它本质上限制了每个bloom filter检查可以触及的缓存线的最大数量。</span></span><br><span class="line">    <span class="comment"># 设置为0时，此优化被关闭。这个数目不应该大于探测的数目。</span></span><br><span class="line">    <span class="comment"># 这个选项可以提高内存工作负载的性能，但应该小心使用，因为它可能会导致更高的误报率。</span></span><br><span class="line">    <span class="comment"># default: 0</span></span><br><span class="line">    <span class="attr">bloom.locality:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 设置memtable中一个键的最大连续合并操作数</span></span><br><span class="line">    <span class="comment"># default: 0 (禁用状态)</span></span><br><span class="line">    <span class="attr">max.successive.merges:</span> <span class="number">0</span></span><br><span class="line">    <span class="comment"># 开启统计</span></span><br><span class="line">    <span class="comment"># default: 无参数，false代表不启动，true则会调用对应的api</span></span><br><span class="line">    <span class="attr">enable.statistics:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 预加载数据库为了批量加载</span></span><br><span class="line">    <span class="comment"># 所有数据将在0级没有任何自动压缩</span></span><br><span class="line">    <span class="comment"># 建议在从数据库读取数据之前手动调用CompactRange(NULL, NULL)，否则读取速度会非常慢</span></span><br><span class="line">    <span class="comment"># default: 无参数，false代表不启动，true则会调用对应的api</span></span><br><span class="line">    <span class="attr">prepare.for.bulk.load:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 设置一个MemTableRep，它由一个向量支持</span></span><br><span class="line">    <span class="comment"># 在迭代时，向量被排序，这对于迭代非常少且读操作开始后通常不执行写操作的工作负载非常有用</span></span><br><span class="line">    <span class="comment"># default: 无参数，false代表不启动，true则会调用对应的api</span></span><br><span class="line">    <span class="attr">memtable.vector.rep:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 如果不存在列族是否自动建立</span></span><br><span class="line">    <span class="comment"># default: true</span></span><br><span class="line">    <span class="attr">create.if.missing.column.families:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="SQL-AST的支持"><a href="#SQL-AST的支持" class="headerlink" title="SQL-AST的支持"></a>SQL-AST的支持</h2><p>我们的db希望能做到与语言无关，不仅仅是我们的目前的golang，就算是php也可以用到本地持久化的方式的话，就需要借助<code>RPC协议</code>或者<code>特定DSL</code>来实现，但是既然是数据库，这里优先选择了以<code>sql语法</code>来管理数据。</p><p>那么我们就需要拿到<code>sql</code>的抽象语法树(<code>sql-ast</code>)，拿到<code>sql-ast</code>之后，我们就可以拿到我们所需要的信息去<code>hit data</code>。</p><p><a href="github.com/pingcap/parser">Pingcap-parser</a></p><p>这里我们用到了pingcap公司的<code>parser</code>库，该库同样是<code>TiDB</code>的sql解析库，借助该库，我们可以很方便的拿到<code>sql-ast</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"github.com/pingcap/parser"</span></span><br><span class="line">_ <span class="string">"github.com/pingcap/parser/test_driver"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> visitor <span class="keyword">struct</span> &#123;</span><br><span class="line">table  <span class="keyword">string</span></span><br><span class="line">fields []<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *visitor)</span> <span class="title">Enter</span><span class="params">(in ast.Node)</span> <span class="params">(out ast.Node, skipChildren <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line"><span class="comment">//fmt.Printf("Enter: %T\n", in)</span></span><br><span class="line"><span class="keyword">switch</span> n := in.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> *ast.SelectStmt:</span><br><span class="line"><span class="keyword">case</span> *ast.FieldList:</span><br><span class="line"><span class="keyword">case</span> *ast.SelectField:</span><br><span class="line"><span class="keyword">case</span> *ast.ColumnNameExpr:</span><br><span class="line"><span class="comment">//fmt.Printf("Enter: %v\n", n.Name)</span></span><br><span class="line"><span class="keyword">case</span> *ast.ColumnName:</span><br><span class="line"><span class="comment">//v.fields = append(v.fields, n.Name.L)</span></span><br><span class="line"><span class="keyword">case</span> *ast.TableName:</span><br><span class="line"><span class="comment">//v.table = n.Name.L</span></span><br><span class="line"><span class="keyword">case</span> *ast.BinaryOperationExpr:</span><br><span class="line"><span class="comment">//fmt.Printf("Enter: %v\n", n.Op)</span></span><br><span class="line"><span class="keyword">case</span> *ast.Join:</span><br><span class="line"><span class="comment">//fmt.Printf("Enter: %v\n", n.Left)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> in, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v *visitor)</span> <span class="title">Leave</span><span class="params">(in ast.Node)</span> <span class="params">(out ast.Node, ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"Leave: %T\n"</span>, in)</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> n := in.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> *ast.SelectStmt:</span><br><span class="line"><span class="keyword">case</span> *ast.FieldList:</span><br><span class="line"><span class="keyword">case</span> *ast.SelectField:</span><br><span class="line"><span class="keyword">case</span> *ast.ColumnNameExpr:</span><br><span class="line"><span class="keyword">case</span> *ast.ColumnName:</span><br><span class="line"><span class="keyword">case</span> *ast.TableName:</span><br><span class="line">v.table = n.Name.L</span><br><span class="line"><span class="keyword">case</span> *ast.BinaryOperationExpr:</span><br><span class="line"><span class="comment">//fmt.Printf("Leave: %v\n", n.L)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> in, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">p := parser.New()</span><br><span class="line"></span><br><span class="line">sql := <span class="string">"SELECT emp_no, first_name, last_name "</span> +</span><br><span class="line"><span class="string">"FROM employees "</span> +</span><br><span class="line"><span class="string">"where id='Aamodt' and (create_time &gt; 0 or last_name ='caiwenhui')"</span></span><br><span class="line">stmtNodes, _, err := p.Parse(sql, <span class="string">""</span>, <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"parse error:\n%v\n%s"</span>, err, sql)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, stmtNode := <span class="keyword">range</span> stmtNodes &#123;</span><br><span class="line">v := visitor&#123;&#125;</span><br><span class="line">stmtNode.Accept(&amp;v)</span><br><span class="line">fmt.Printf(<span class="string">"%v\n"</span>, v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里用到了<code>github.com/pingcap/parser/test_driver</code> 的原因是因为该库和tidb的driver存在依赖关系，tidb在设计的时候，并未做到很好的分离，所以当其他项目需要使用该库的时候，需要引入这个驱动。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Visitor visits a Node.</span></span><br><span class="line"><span class="keyword">type</span> Visitor <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// Enter is called before children nodes are visited.</span></span><br><span class="line"><span class="comment">// The returned node must be the same type as the input node n.</span></span><br><span class="line"><span class="comment">// skipChildren returns true means children nodes should be skipped,</span></span><br><span class="line"><span class="comment">// this is useful when work is done in Enter and there is no need to visit children.</span></span><br><span class="line">Enter(n Node) (node Node, skipChildren <span class="keyword">bool</span>)</span><br><span class="line"><span class="comment">// Leave is called after children nodes have been visited.</span></span><br><span class="line"><span class="comment">// The returned node's type can be different from the input node if it is a ExprNode,</span></span><br><span class="line"><span class="comment">// Non-expression node must be the same type as the input node n.</span></span><br><span class="line"><span class="comment">// ok returns false to stop visiting.</span></span><br><span class="line">Leave(n Node) (node Node, ok <span class="keyword">bool</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并且这里，我们看到有一个结构体<code>visitor</code>，该结构体就是用来访问<code>ast</code>用的，因为 <code>tidb</code>的<code>parser库</code> 和<code>阿里巴巴</code> 的 <code>druid sql</code> 类似，都是采用 访问器的方式来遍历 <code>ast</code>的，所以我们只需要定义好我们的访问器，那么就可以访问对应的结构数据。<br>至于访问器的接口如上图，只有2个API，一个是 <code>Enter(n Node) (node Node, skipChildren bool)</code>，另外一个是 <code>Leave(n Node) (node Node, ok bool)</code> 。2个接口返回的第二个参数分别定义为 <code>是否跳过剩下的节点</code>, <code>是否成功退出节点</code>。</p><h3 id="interface在这里的应用"><a href="#interface在这里的应用" class="headerlink" title="interface在这里的应用"></a>interface在这里的应用</h3><p>在parser中，大量运用了interface, 充分的给我们的展示了golang的<code>组合</code>特性。</p><p>例如：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Node is the basic element of the AST.</span></span><br><span class="line"><span class="comment">// Interfaces embed Node should have 'Node' name suffix.</span></span><br><span class="line"><span class="keyword">type</span> Node <span class="keyword">interface</span> &#123;</span><br><span class="line"><span class="comment">// Restore returns the sql text from ast tree</span></span><br><span class="line">Restore(ctx *format.RestoreCtx) error</span><br><span class="line"><span class="comment">// Accept accepts Visitor to visit itself.</span></span><br><span class="line"><span class="comment">// The returned node should replace original node.</span></span><br><span class="line"><span class="comment">// ok returns false to stop visiting.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Implementation of this method should first call visitor.Enter,</span></span><br><span class="line"><span class="comment">// assign the returned node to its method receiver, if skipChildren returns true,</span></span><br><span class="line"><span class="comment">// children should be skipped. Otherwise, call its children in particular order that</span></span><br><span class="line"><span class="comment">// later elements depends on former elements. Finally, return visitor.Leave.</span></span><br><span class="line">Accept(v Visitor) (node Node, ok <span class="keyword">bool</span>)</span><br><span class="line"><span class="comment">// Text returns the original text of the element.</span></span><br><span class="line">Text() <span class="keyword">string</span></span><br><span class="line"><span class="comment">// SetText sets original text to the Node.</span></span><br><span class="line">SetText(text <span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SelectStmt represents the select query node.</span></span><br><span class="line"><span class="comment">// See https://dev.mysql.com/doc/refman/5.7/en/select.html</span></span><br><span class="line"><span class="keyword">type</span> SelectStmt <span class="keyword">struct</span> &#123;</span><br><span class="line">dmlNode</span><br><span class="line">resultSetNode</span><br><span class="line"></span><br><span class="line"><span class="comment">// SelectStmtOpts wraps around select hints and switches.</span></span><br><span class="line">*SelectStmtOpts</span><br><span class="line"><span class="comment">// Distinct represents whether the select has distinct option.</span></span><br><span class="line">Distinct <span class="keyword">bool</span></span><br><span class="line"><span class="comment">// From is the from clause of the query.</span></span><br><span class="line">From *TableRefsClause</span><br><span class="line"><span class="comment">// Where is the where clause in select statement.</span></span><br><span class="line">Where ExprNode</span><br><span class="line"><span class="comment">// Fields is the select expression list.</span></span><br><span class="line">Fields *FieldList</span><br><span class="line"><span class="comment">// GroupBy is the group by expression list.</span></span><br><span class="line">GroupBy *GroupByClause</span><br><span class="line"><span class="comment">// Having is the having condition.</span></span><br><span class="line">Having *HavingClause</span><br><span class="line"><span class="comment">// WindowSpecs is the window specification list.</span></span><br><span class="line">WindowSpecs []WindowSpec</span><br><span class="line"><span class="comment">// OrderBy is the ordering expression list.</span></span><br><span class="line">OrderBy *OrderByClause</span><br><span class="line"><span class="comment">// Limit is the limit clause.</span></span><br><span class="line">Limit *Limit</span><br><span class="line"><span class="comment">// LockTp is the lock type</span></span><br><span class="line">LockTp SelectLockType</span><br><span class="line"><span class="comment">// TableHints represents the table level Optimizer Hint for join type</span></span><br><span class="line">TableHints []*TableOptimizerHint</span><br><span class="line"><span class="comment">// IsAfterUnionDistinct indicates whether it's a stmt after "union distinct".</span></span><br><span class="line">IsAfterUnionDistinct <span class="keyword">bool</span></span><br><span class="line"><span class="comment">// IsInBraces indicates whether it's a stmt in brace.</span></span><br><span class="line">IsInBraces <span class="keyword">bool</span></span><br><span class="line"><span class="comment">// QueryBlockOffset indicates the order of this SelectStmt if counted from left to right in the sql text.</span></span><br><span class="line">QueryBlockOffset <span class="keyword">int</span></span><br><span class="line"><span class="comment">// SelectIntoOpt is the select-into option.</span></span><br><span class="line">SelectIntoOpt *SelectIntoOption</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">splitWhere</span><span class="params">(where ast.ExprNode)</span> []<span class="title">ast</span>.<span class="title">ExprNode</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> conditions []ast.ExprNode</span><br><span class="line"><span class="keyword">switch</span> x := where.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="literal">nil</span>:</span><br><span class="line"><span class="keyword">case</span> *ast.BinaryOperationExpr:</span><br><span class="line"><span class="keyword">if</span> x.Op == opcode.LogicAnd &#123;</span><br><span class="line">conditions = <span class="built_in">append</span>(conditions, splitWhere(x.L)...)</span><br><span class="line">conditions = <span class="built_in">append</span>(conditions, splitWhere(x.R)...)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">conditions = <span class="built_in">append</span>(conditions, x)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">case</span> *ast.ParenthesesExpr:</span><br><span class="line">conditions = <span class="built_in">append</span>(conditions, splitWhere(x.Expr)...)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">conditions = <span class="built_in">append</span>(conditions, where)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> conditions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ast.Node</code> 是ast的基础接口，所有的节点都需要在此之上实现自己的功能。其他接口同理，一环扣一环，设计得十分巧妙。</p><h2 id="KEY-VALUE的编码规则"><a href="#KEY-VALUE的编码规则" class="headerlink" title="KEY-VALUE的编码规则"></a>KEY-VALUE的编码规则</h2><p>DB 对每个表分配一个 TableID，每一个索引都会分配一个 IndexID，每一行分配一个 RowID， 其中 DbId/TableID 在整个集群内唯一，IndexID/RowID 在表内唯一，这些 ID 都是 int64 类型。</p><p>其中细节如下：</p><p>database 编码成 Key-Value pair：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Key: metaPrefix(+)databasePrefix&#123;dbID&#125;</span><br><span class="line">Value: database struct json marshal</span><br></pre></td></tr></table></figure><p>database indexed 编码成 Key-Value pair：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Key: metaPrefix(+)databasePrefix_indexPrefix&#123;database_name&#125;</span><br><span class="line">Value: dbID</span><br></pre></td></tr></table></figure><p>table 编码成 Key-Value pair：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Key: metaPrefix(+)tablePrefix&#123;dbID&#125;_recordPrefixSep&#123;tableID&#125;</span><br><span class="line">Value: table struct json marshal</span><br></pre></td></tr></table></figure><p>table indexed 编码成 Key-Value pair：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Key: metaPrefix(+)tablePrefix&#123;dbID&#125;_indexPrefix&#123;databaseId&#125;&#123;table_name&#125;</span><br><span class="line">Value: tableID</span><br></pre></td></tr></table></figure><p>每行数据按照如下规则进行编码成 Key-Value pair：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Key: databasePrefix&#123;dbID&#125;_tablePrefix&#123;tableID&#125;_recordPrefixSep&#123;rowID&#125;</span><br><span class="line">Value: [col1, col2, col3, col4]</span><br></pre></td></tr></table></figure><p>对于 Unique Index 数据，会按照如下规则编码成 Key-Value pair：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Key: databasePrefix&#123;dbID&#125;_tablePrefix&#123;tableID&#125;_indexPrefixSep&#123;indexID&#125;_indexedColumnsValue</span><br><span class="line">Value: rowID</span><br></pre></td></tr></table></figure><p>Index 数据还需要考虑 Unique Index 和非 Unique Index 两种情况，对于 Unique Index，可以按照上述编码规则。 但是对于非 Unique Index，通过这种编码并不能构造出唯一的 Key，因为同一个<br>Index 的 <code>databasePrefix{dbID}_tablePrefix{tableID}_indexPrefixSep{indexID}</code>都一样，可能有多行数据的 ColumnsValue 是一样的.</p><p>对于 “非” Unique Index 的编码做了一点调整：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Key: databasePrefix&#123;dbID&#125;_tablePrefix&#123;tableID&#125;_indexPrefixSep&#123;indexID&#125;_indexedColumnsValue_&#123;rowID&#125;</span><br><span class="line">Value: null</span><br></pre></td></tr></table></figure><p>对应的标识符如下定义：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">databasePrefix  = []<span class="keyword">byte</span>&#123;<span class="string">'d'</span>&#125;</span><br><span class="line">tablePrefix     = []<span class="keyword">byte</span>&#123;<span class="string">'t'</span>&#125;</span><br><span class="line">recordPrefixSep = []<span class="keyword">byte</span>(<span class="string">"_r"</span>)</span><br><span class="line">indexPrefixSep  = []<span class="keyword">byte</span>(<span class="string">"_i"</span>)</span><br><span class="line">metaPrefix      = []<span class="keyword">byte</span>&#123;<span class="string">'m'</span>&#125;</span><br><span class="line">sepPrefix       = []<span class="keyword">byte</span>&#123;<span class="string">'_'</span>&#125;</span><br><span class="line"></span><br><span class="line">mdPrefix  = <span class="built_in">append</span>(metaPrefix, databasePrefix...)</span><br><span class="line">mdiPrefix = <span class="built_in">append</span>(<span class="built_in">append</span>(metaPrefix, databasePrefix...), indexPrefixSep...)</span><br><span class="line">mtPrefix  = <span class="built_in">append</span>(metaPrefix, tablePrefix...)</span><br><span class="line">mtiPrefix = <span class="built_in">append</span>(<span class="built_in">append</span>(metaPrefix, tablePrefix...), indexPrefixSep...)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">idLen                = <span class="number">8</span></span><br><span class="line">sepPrefixLen         = <span class="number">1</span></span><br><span class="line">prefixLen            = databasePrefixLength + idLen <span class="comment">/*dbID*/</span> + sepPrefixLen + tablePrefixLength + idLen <span class="comment">/*tableID*/</span> + recordPrefixSepLength</span><br><span class="line">uniqPrefixLen        = databasePrefixLength + idLen <span class="comment">/*dbID*/</span> + sepPrefixLen + tablePrefixLength + idLen <span class="comment">/*tableID*/</span> + indexPrefixSepLength + idLen <span class="comment">/*indexID*/</span> + sepPrefixLen <span class="comment">/* +indexedColumnsValue */</span></span><br><span class="line">indexPrefixLen       = databasePrefixLength + idLen <span class="comment">/*dbID*/</span> + sepPrefixLen + tablePrefixLength + idLen <span class="comment">/*tableID*/</span> + indexPrefixSepLength + idLen <span class="comment">/*indexID*/</span> + sepPrefixLen + sepPrefixLen</span><br><span class="line">indexPrefixLenWithID = databasePrefixLength + idLen <span class="comment">/*dbID*/</span> + sepPrefixLen + tablePrefixLength + idLen <span class="comment">/*tableID*/</span> + indexPrefixSepLength + idLen <span class="comment">/*indexID*/</span> + sepPrefixLen + sepPrefixLen + idLen</span><br><span class="line"><span class="comment">// RecordRowKeyLen is public for calculating avgerage row size.</span></span><br><span class="line">RecordRowKeyLen       = prefixLen + idLen <span class="comment">/*handle*/</span></span><br><span class="line">tablePrefixLength     = <span class="number">1</span></span><br><span class="line">databasePrefixLength  = <span class="number">1</span></span><br><span class="line">recordPrefixSepLength = <span class="number">2</span></span><br><span class="line">indexPrefixSepLength  = <span class="number">2</span></span><br><span class="line">metaPrefixLength      = <span class="number">1</span></span><br><span class="line">mdPrefixLen           = metaPrefixLength + databasePrefixLength</span><br><span class="line">mdiPrefixLen          = mdPrefixLen + indexPrefixSepLength</span><br><span class="line">mtPrefixLen           = metaPrefixLength + tablePrefixLength</span><br><span class="line">mtiPrefixLen          = mtPrefixLen + indexPrefixSepLength</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>我们把rowkey的编码规则来看</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EncodeRowKey encodes the table id and record handle into a kv.Key</span></span><br><span class="line"><span class="comment">// EncodeRowKey databasePrefix&#123;dbID&#125;_tablePrefix&#123;tableID&#125;_recordPrefixSep&#123;rowID&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EncodeRowKey</span><span class="params">(databaseId, tableID, rowId <span class="keyword">int64</span>)</span> <span class="title">kv</span>.<span class="title">Key</span></span> &#123;</span><br><span class="line">buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, prefixLen+idLen <span class="comment">/*rowId*/</span>)</span><br><span class="line">buf = <span class="built_in">append</span>(buf, databasePrefix...)</span><br><span class="line">buf = <span class="built_in">append</span>(buf, EncodeIdBuf(databaseId)...)</span><br><span class="line">buf = <span class="built_in">append</span>(buf, sepPrefix...)</span><br><span class="line">buf = <span class="built_in">append</span>(buf, tablePrefix...)</span><br><span class="line">buf = <span class="built_in">append</span>(buf, EncodeIdBuf(tableID)...)</span><br><span class="line">buf = <span class="built_in">append</span>(buf, recordPrefixSep...)</span><br><span class="line">buf = <span class="built_in">append</span>(buf, EncodeIdBuf(rowId)...)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> buf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">EncodeIdBuf</span><span class="params">(id <span class="keyword">int64</span>)</span> <span class="title">kv</span>.<span class="title">Key</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">8</span>)</span><br><span class="line">binary.BigEndian.PutUint64(buf[:], <span class="keyword">uint64</span>(id))</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> buf</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DecodeIdBuf</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">int64</span>(binary.BigEndian.Uint64(b))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们通过<code>EncodeRowKey(databaseId, tableID, rowId int64) kv.Key</code> 来生成数据的<code>row-key</code>，我们利用<code>make([]byte,0, len)</code> 的方式预申请内存的方式，后面再通过append的方式往 <code>slice</code> 中不断追加字节，当遇到<code>int64</code>的数据的时候，我们会调用<code>EncodeIdBuf(id int64) kv.Key</code> 来把int64转换为 <code>大端(网络字节序)</code> 的二进制字节。最后一个row-key就生成了。</p><h3 id="database-编码"><a href="#database-编码" class="headerlink" title="database 编码"></a>database 编码</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> database <span class="keyword">struct</span> &#123;</span><br><span class="line">Id   <span class="keyword">int64</span></span><br><span class="line">Name <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createDatabaseHandle Create database</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">createDatabaseHandle</span><span class="params">(result *Result, stmt *ast.CreateDatabaseStmt)</span></span> &#123;</span><br><span class="line">indexedKey := etccodec.EncodeDatabaseMetaIndexedKey([]<span class="keyword">byte</span>(stmt.Name))</span><br><span class="line">rdb := rocksdb.Load().(*Rocksdb)</span><br><span class="line">slice, err := rdb.Get(rdb.NewDefaultReadOptions(), indexedKey)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">errorlog(UnexpectErrorCategory&#123;&#125;, UnknowRCode)</span><br><span class="line">result.Record(UnknowRCode, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> slice.Exists() &#123;</span><br><span class="line"><span class="keyword">if</span> !stmt.IfNotExists &#123;</span><br><span class="line">errorlog(UnexpectErrorCategory&#123;&#125;, DatabaseExistsRCode)</span><br><span class="line">result.Record(DatabaseExistsRCode, <span class="literal">nil</span>)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">result.Success()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dbId, err := getDatabaseId()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">msg := fmt.Sprintf(<span class="string">"get database id failed, err: %s"</span>, err)</span><br><span class="line">errorlog(UnexpectErrorCategory&#123;&#125;, msg)</span><br><span class="line">result.Record(CreateDatabaseFailedRCode, &amp;msg)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">db := &amp;database&#123;</span><br><span class="line">Id:   dbId,</span><br><span class="line">Name: stmt.Name,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> buf = etccodec.EncodeIdBuf(dbId)</span><br><span class="line">key := etccodec.EncodeDatabaseMetaKey(dbId)</span><br><span class="line">value, err := json.Marshal(db)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">msg := fmt.Sprintf(<span class="string">"marshal database error, err: %s"</span>, err)</span><br><span class="line">errorlog(UnexpectErrorCategory&#123;&#125;, msg)</span><br><span class="line">result.Record(CreateDatabaseFailedRCode, &amp;msg)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = rdb.Put(key, value)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">msg := fmt.Sprintf(<span class="string">"rocksdb put metadata failed, err: %s"</span>, err)</span><br><span class="line">errorlog(UnexpectErrorCategory&#123;&#125;, msg)</span><br><span class="line">result.Record(CreateDatabaseFailedRCode, &amp;msg)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">err = rdb.Put(indexedKey, buf)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">msg := fmt.Sprintf(<span class="string">"rocksdb put indexed failed, err: %s"</span>, err)</span><br><span class="line">errorlog(UnexpectErrorCategory&#123;&#125;, msg)</span><br><span class="line">result.Record(CreateDatabaseFailedRCode, &amp;msg)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">debugf(NormalDebugCategory&#123;&#125;, <span class="string">"create database [%s]"</span>, db)</span><br><span class="line">result.Success()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里，我们借助 <code>create database stmt</code> 来的处理方法来看看 <code>db Key-Value pair</code> 的处理逻辑。<br>我们看到这里，我们通过一个<code>stmt.Name</code> 来拿到数据库的名，并且调用<code>etccodec.EncodeDatabaseMetaIndexedKey([]byte(stmt.Name))</code> 方法来创建符合<code>metaPrefix(+)databasePrefix_indexPrefix{database_name}</code> 索引的key，然后判断是否存在所以索引来判断后续的逻辑。<br>我们通过一个 <code>getDatabaseId()</code> 方法来获取一个全局的数据库id，并且初始化<code>type database struct</code>，然后我们调用了 <code>etccodec.EncodeDatabaseMetaKey(dbid)</code> 来对key进行生成，也就是上面所列出来的 <code>metaPrefix(+)databasePrefix{dbID}</code>, 接下来就是<code>value</code>的生成，这里的value比较直接，就是<code>json.marshal</code>来处理后的字节。然后我们把数据<code>put</code> 到<code>rocksdb</code>就结束了，索引数据也是如此，不过索引存储的dbid。</p><blockquote><p>table的编码也类似</p></blockquote><p>如果对其他的<code>stmt</code>，例如<code>insert stmt/delete stmt</code>具体的逻辑感兴趣的话，可以查阅源码，但是类似差不多。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/indexed.png" alt=" indexed "></p><h2 id="COUNTER计数器-发号器"><a href="#COUNTER计数器-发号器" class="headerlink" title="COUNTER计数器-发号器"></a>COUNTER计数器-发号器</h2><p>这里我们需要讲一下<code>counter</code>，因为我们所有的数据都会有<code>row_id</code>，并且我们在<code>create table</code>的时候也有<code>AUTO_INCREMENT</code>的列，这个时候，我们也是需要一个ID发号器。</p><p>目前常见的发号器实现方案如下：</p><ul><li><ol><li>UUID</li></ol></li><li><ol start="2"><li>snowflake</li></ol></li><li><ol start="3"><li>数据库生成</li></ol></li><li><ol start="4"><li>美团的Leaf（基于数据库）</li></ol></li></ul><h3 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h3><p>UUID(Universally Unique Identifier)的标准型式包含<code>32个16进制</code>数字，以连字号分为<code>五段</code>，形式为<code>8-4-4-4-12</code>的36个字符，示例：<code>550e8400-e29b-41d4-a716-446655440000</code>，到目前为止业界一共有5种方式生成UUID，详情见IETF发布的UUID规范 <a href="https://www.ietf.org/rfc/rfc4122.txt" target="_blank" rel="noopener">A Universally Unique IDentifier (UUID) URN Namespace</a></p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/uuid.png" alt=" UUID "></p><blockquote><p>由于他的无序性，不符合我们所期待的增长序列，所以抛弃</p></blockquote><h3 id="类snowflake方案"><a href="#类snowflake方案" class="headerlink" title="类snowflake方案"></a>类snowflake方案</h3><p>这种方案大致来说是一种以划分命名空间（UUID也算，由于比较常见，所以单独分析）来生成ID的一种算法，这种方案把64-bit分别划分成多段，分开来标示机器、时间等，比如在snowflake中的64-bit分别表示如下图所示：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/snowflake.png" alt=" snowflake "></p><blockquote><p>生成繁琐，由多个指令码组成，并且我们不需要用到分布式，这个还对本地的时间有强依赖，不够简洁</p></blockquote><h3 id="基于数据库的"><a href="#基于数据库的" class="headerlink" title="基于数据库的"></a>基于数据库的</h3><p>基于数据库的其实就是利用自增的自增机制+发号机制的组合，但是由于我们这里不基于数据库，所以给予数据库的基本也不考虑，但是其中的发号机制可以参考。例如：预分配机制。</p><h3 id="自己的发号器"><a href="#自己的发号器" class="headerlink" title="自己的发号器"></a>自己的发号器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> msource</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/gorocksdb"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"os/signal"</span></span><br><span class="line"><span class="string">"reflect"</span></span><br><span class="line"><span class="string">"strconv"</span></span><br><span class="line"><span class="string">"syscall"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> counter <span class="keyword">struct</span> &#123;</span><br><span class="line">*gorocksdb.ReadOptions</span><br><span class="line"></span><br><span class="line">IdKey []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line">GroupId <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">idChan <span class="keyword">chan</span> <span class="keyword">int64</span></span><br><span class="line"></span><br><span class="line">sig <span class="keyword">chan</span> os.Signal</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">UnmarshalJSON</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">c.IdKey = data[<span class="number">1</span> : <span class="built_in">len</span>(data)<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line">turboNew(c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, <span class="built_in">len</span>(c.IdKey)+<span class="number">2</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, <span class="string">'"'</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, c.IdKey...)</span><br><span class="line">b = <span class="built_in">append</span>(b, <span class="string">'"'</span>)</span><br><span class="line"><span class="keyword">return</span> b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">t := reflect.TypeOf(c).Elem()</span><br><span class="line">v := reflect.ValueOf(c).Elem()</span><br><span class="line">p := fmt.Sprintf(<span class="string">"%s &#123;"</span>, t.Name())</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; v.NumField(); i++ &#123;</span><br><span class="line"><span class="keyword">if</span> v.Field(i).CanInterface() &#123;</span><br><span class="line"><span class="keyword">if</span> v.Field(i).Kind() == reflect.Slice &#123;</span><br><span class="line">p += fmt.Sprintf(<span class="string">"\n\t %s(%s): %s"</span>, t.Field(i).Name, t.Field(i).Type, <span class="keyword">string</span>(v.Field(i).Bytes()))</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">p += fmt.Sprintf(<span class="string">"\n\t %s(%s): %v"</span>, t.Field(i).Name, t.Field(i).Type, v.Field(i).Interface())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">p += <span class="string">"\n&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCounter</span><span class="params">(prefix <span class="keyword">string</span>)</span> *<span class="title">counter</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> newCounter(prefix)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newCounter</span><span class="params">(prefix <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">counter</span></span> &#123;</span><br><span class="line">c := <span class="built_in">new</span>(counter)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(args) &gt; <span class="number">0</span> &#123;</span><br><span class="line">c.GroupId = args[<span class="number">0</span>].(<span class="keyword">string</span>)</span><br><span class="line">&#125;</span><br><span class="line">c.IdKey = []<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"%s:%s"</span>, prefix, c.GroupId))</span><br><span class="line"></span><br><span class="line">turboNew(c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">turboNew</span><span class="params">(c *counter)</span></span> &#123;</span><br><span class="line">ct := custom.Load().(*Custom)</span><br><span class="line">c.idChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int64</span>, ct.IdStep)</span><br><span class="line">c.sig = <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">c.ReadOptions = gorocksdb.NewDefaultReadOptions()</span><br><span class="line">signal.Notify(c.sig, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"></span><br><span class="line">c.sender()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">sender</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">ct := custom.Load().(*Custom)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-c.sig:</span><br><span class="line"><span class="built_in">close</span>(c.idChan)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(c.idChan) &lt; ct.IdStep/<span class="number">10</span> &#123;</span><br><span class="line">rdb := rocksdb.Load().(*Rocksdb)</span><br><span class="line"><span class="keyword">if</span> c.ReadOptions == <span class="literal">nil</span> &#123;</span><br><span class="line">c.ReadOptions = gorocksdb.NewDefaultReadOptions()</span><br><span class="line">&#125;</span><br><span class="line">slice, err := rdb.Get(c.ReadOptions, c.getIdKey())</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fatal(UnexpectErrorCategory&#123;<span class="string">"counter sender error"</span>&#125;, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">var</span> idStr <span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> slice.Exists() &amp;&amp; slice.Size() &gt; <span class="number">0</span> &#123;</span><br><span class="line">idStr = <span class="keyword">string</span>(slice.Data())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">idStr = <span class="string">"0"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cid, err := strconv.ParseInt(idStr, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fatal(UnexpectErrorCategory&#123;<span class="string">"counter sender error"</span>&#125;, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ct := custom.Load().(*Custom)</span><br><span class="line"><span class="comment">// id回滚</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="number">1</span>&lt;&lt;<span class="number">63</span><span class="number">-1</span>)/<span class="number">2</span>)-ct.IdStep &lt; ct.IdStep &#123;</span><br><span class="line">cid = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">nextId := cid + <span class="keyword">int64</span>(ct.IdStep)</span><br><span class="line">err = c.ackId(nextId)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fatal(UnexpectErrorCategory&#123;<span class="string">"counter sender error"</span>&#125;, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> cid &lt; nextId &#123;</span><br><span class="line">cid++</span><br><span class="line">c.idChan &lt;- cid</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">time.Sleep(<span class="number">50</span> * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Rocksdb to get a globally unique self increment ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">getId</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">id := &lt;-c.idChan</span><br><span class="line"><span class="keyword">return</span> id, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//return -1, GetIdError&#123;bytes2string(c.IdKey)&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">GetId</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> c.getId()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">ackId</span><span class="params">(id <span class="keyword">int64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">rdb := rocksdb.Load().(*Rocksdb)</span><br><span class="line">err := rdb.Put(c.getIdKey(), []<span class="keyword">byte</span>(strconv.FormatInt(id, <span class="number">10</span>)))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">AckId</span><span class="params">(id <span class="keyword">int64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> c.ackId(id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Gets the key of the ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">getIdKey</span><span class="params">()</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> c.IdKey</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们优先考虑可以通过内存直接通过<code>++</code>或者<code>+1操作符</code>分配的方式。我们重点看到：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nextId := cid + <span class="keyword">int64</span>(ct.IdStep)</span><br><span class="line">err = c.ackId(nextId)</span><br><span class="line"><span class="keyword">for</span> cid &lt; nextId &#123;</span><br><span class="line">cid++</span><br><span class="line">c.idChan &lt;- cid</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以再这里看到，我们通过拿到当前cid的数值，通过<code>idStep</code>来增加固定的步长，然后先通过回写nextId的值到rocksdb进行持久化，再通过<code>for</code>循环来对cid进行叠加，每次都推送到<code>有缓冲区</code>的<code>idChan</code>中。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Rocksdb to get a globally unique self increment ID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">getId</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line">id := &lt;-c.idChan</span><br><span class="line"><span class="keyword">return</span> id, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">GetId</span><span class="params">()</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> c.getId()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>func (c *counter) getId() (int64, error)</code> 来消费<code>idChan</code>中的id，达到一个获取id的效果。 </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// id回滚</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="number">1</span>&lt;&lt;<span class="number">63</span><span class="number">-1</span>)/<span class="number">2</span>)-ct.IdStep &lt; ct.IdStep &#123;</span><br><span class="line">cid = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到这里有一行代码，当int64的cid已经到达分配的极限了，那么cid就会进行回滚，基本保证了发号的可重复利用性。</p><p>扩展问题：id回溯了，怎么做递增判断？</p><p>这个问题其实有点类似tcp的syn回溯的问题。因为syn一开始是随机生成的，并且这个过程了syn是会不断增加的。当syn到达分配的极限进行了回溯的时候，如何比较大小？</p><p>我们查看到内核的tcp源码，可以看到提供的判断方式十分巧妙，如下：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* The next routines deal with comparing 32 bit unsigned ints</span></span><br><span class="line"><span class="comment">* and worry about wraparound (automatic with unsigned arithmetic).</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">before</span><span class="params">(__u32 seq1, __u32 seq2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> (__s32)(seq1-seq2) &lt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> after(seq2, seq1) before(seq1, seq2)</span></span><br></pre></td></tr></table></figure><p>为什么<code>（__s32）(seq1-seq2)&lt;0</code>就可以判断<code>seq1&lt;seq2</code>呢？这里的<code>__s32</code>是有符号整型的意思，而<code>__u32</code>则是无符号整型。<br>为了方便说明，我们以<code>unsigned char</code>和<code>char</code>为例来说明：</p><p>假设seq1=255， seq2=1（发生了回绕）<br>seq1 = 1111 1111 seq2 = 0000 0001<br>我们希望比较结果是 <code>seq1&lt;seq2</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> seq1 - seq2&#x3D;</span><br><span class="line"> 1111 1111</span><br><span class="line">-0000 0001</span><br><span class="line">-----------</span><br><span class="line"> 1111 1110</span><br></pre></td></tr></table></figure><p>由于我们将结果转化成了有符号数，<code>由于最高位是1</code>，因此结果是<code>一个负数</code>，负数的绝对值为<br> 0000 0001 + 1 = 0000 0010 = 2 (补码：取反+1)</p><p>因此 <code>seq1 - seq2 &lt; 0</code></p><p>注意：</p><p>如果seq2=128的话，我们会发现：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> seq1 - seq2&#x3D;</span><br><span class="line"> 1111 1111</span><br><span class="line">-1000 0000</span><br><span class="line">-----------</span><br><span class="line"> 0111 1111</span><br></pre></td></tr></table></figure><p>此时结果尤为正了，判断的结果是<code>seq1&gt;seq2</code>。因此，上述算法正确的前提是，<code>回绕后的增量小于2^(n-1)-1</code>。</p><p>由于tcp序列号用的<code>32位无符号数</code>，因此可以支持的<code>回绕幅度是2^31-1</code>，满足要求了。</p><blockquote><p>但是由于我们这里不需要比较发号的先后次序，只需要保证其唯一性，所以这个回溯的大小比较问题，并不需要过多的关注</p></blockquote><h2 id="行级锁的实现"><a href="#行级锁的实现" class="headerlink" title="行级锁的实现"></a>行级锁的实现</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line"><span class="comment">// dbID:tblID</span></span><br><span class="line"><span class="comment">// dbID:tblID:rowID</span></span><br><span class="line">rowLockLock sync.RWMutex</span><br><span class="line">rowLock     rl</span><br><span class="line">ttlTime     = <span class="keyword">int64</span>(<span class="number">30</span> * <span class="number">60</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> (</span><br><span class="line">rl <span class="keyword">map</span>[<span class="keyword">string</span>]*lock</span><br><span class="line"></span><br><span class="line">lock <span class="keyword">struct</span> &#123;</span><br><span class="line">ttl  <span class="keyword">int64</span></span><br><span class="line">lock sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// clean row lock, release memory</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := time.NewTicker(<span class="number">10</span> * time.Minute)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">ct := time.Now().Unix()</span><br><span class="line">rowLockLock.Lock()</span><br><span class="line"><span class="keyword">for</span> key, lock := <span class="keyword">range</span> rowLock &#123;</span><br><span class="line"><span class="keyword">if</span> ct &gt; lock.ttl &#123;</span><br><span class="line"><span class="built_in">delete</span>(rowLock, key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">rowLockLock.Unlock()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">rowLock = <span class="built_in">make</span>(rl, <span class="number">10</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">rowLockKey</span><span class="params">(dbId, tblId, rowId <span class="keyword">int64</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">"%d:%d:%d"</span>, dbId, tblId, rowId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rl)</span> <span class="title">Lock</span><span class="params">(lockKey <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">rowLockLock.Lock()</span><br><span class="line">m, ok := (*r)[lockKey]</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">m = <span class="built_in">new</span>(lock)</span><br><span class="line">(*r)[lockKey] = m</span><br><span class="line">m.ttl = time.Now().Unix() + ttlTime</span><br><span class="line">&#125;</span><br><span class="line">rowLockLock.Unlock()</span><br><span class="line"></span><br><span class="line">m.lock.Lock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rl)</span> <span class="title">UnLock</span><span class="params">(lockKey <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">rowLockLock.Lock()</span><br><span class="line">m, ok := (*r)[lockKey]</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">m = <span class="built_in">new</span>(lock)</span><br><span class="line">(*r)[lockKey] = m</span><br><span class="line">m.ttl = time.Now().Unix() + ttlTime</span><br><span class="line">&#125;</span><br><span class="line">rowLockLock.Unlock()</span><br><span class="line"></span><br><span class="line">m.lock.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rl)</span> <span class="title">RLock</span><span class="params">(lockKey <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">rowLockLock.Lock()</span><br><span class="line">m, ok := (*r)[lockKey]</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">m = <span class="built_in">new</span>(lock)</span><br><span class="line">(*r)[lockKey] = m</span><br><span class="line">m.ttl = time.Now().Unix() + ttlTime</span><br><span class="line">&#125;</span><br><span class="line">rowLockLock.Unlock()</span><br><span class="line"></span><br><span class="line">m.lock.RLock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rl)</span> <span class="title">RUnlock</span><span class="params">(lockKey <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">rowLockLock.Lock()</span><br><span class="line">m, ok := (*r)[lockKey]</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">m = <span class="built_in">new</span>(lock)</span><br><span class="line">(*r)[lockKey] = m</span><br><span class="line">m.ttl = time.Now().Unix() + ttlTime</span><br><span class="line">&#125;</span><br><span class="line">rowLockLock.Unlock()</span><br><span class="line"></span><br><span class="line">m.lock.RUnlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上是行级锁的实现方式，主要是利用<code>sync.RWMutex</code>来实现读写锁，并且带有ttl的机制，每次加锁的时候，都会更新ttl的时间。<br>其中在<code>init阶段</code>，我们利用的ticker来实现对锁进行一个类似<code>LRU</code>的机制，对于不活跃的锁对象进行释放，防止在这里造成内存只增不减。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Store)</span> <span class="title">updateHandle</span><span class="params">(result *Result, stmt *ast.UpdateStmt)</span></span> &#123;</span><br><span class="line"><span class="comment">// 通过ast获取old数据</span></span><br><span class="line">....</span><br><span class="line"><span class="comment">// 行级锁锁定 </span></span><br><span class="line">rowID, _ := item[<span class="number">0</span>].(json2.Number).Int64()</span><br><span class="line">rowlockKey := rowLockKey(db.Id, tbl.Id, rowID)</span><br><span class="line">rowLock.Lock(rowlockKey)</span><br><span class="line"><span class="keyword">defer</span> rowLock.UnLock(rowlockKey)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新索引数据</span></span><br><span class="line"><span class="keyword">for</span> _, index := <span class="keyword">range</span> indexs &#123;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新为new数据</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="逆波兰表达式-amp-amp-波兰表达式"><a href="#逆波兰表达式-amp-amp-波兰表达式" class="headerlink" title="逆波兰表达式 &amp;&amp; 波兰表达式"></a>逆波兰表达式 &amp;&amp; 波兰表达式</h2><p>这一块其实暂时还没实现，但是他的原理有必要和大家说一下，我们的db实现，都是基于<code>sql</code> 来实现的，我们知道 <code>sql</code> 中也有表达式计算，并且是有优先级之分的。</p><p><code>前/中/后</code>序遍历，相信大家基本都听说过，但是实际运用中少之又少，这是因为大家可能在实际中没有找到合适的模式和套用这些树的遍历方式。</p><ul><li><p>前序遍历：根结点 —&gt; 左子树 —&gt; 右子树</p></li><li><p>中序遍历：左子树—&gt; 根结点 —&gt; 右子树</p></li><li><p>后序遍历：左子树 —&gt; 右子树 —&gt; 根结点</p></li></ul><p>例如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> (<span class="keyword">count</span> * price) <span class="keyword">AS</span> <span class="keyword">sum</span> <span class="keyword">FROM</span> orders <span class="keyword">WHERE</span> order_id &lt; <span class="number">100</span></span><br></pre></td></tr></table></figure><p>其中 <code>order_id &lt; 10</code> 就是一个表达式，它有一个列输入参数： <code>order_id</code>，输出：<code>Bool</code></p><h3 id="RPN-表达式-逆波兰表示法"><a href="#RPN-表达式-逆波兰表示法" class="headerlink" title="RPN 表达式(逆波兰表示法)"></a>RPN 表达式(逆波兰表示法)</h3><p>RPN 是树的<code>后序遍历</code>，后序遍历在每个节点知道自己有几个子节点的时候等价于原本的树结构。</p><blockquote><p>所以你波澜是后序遍历：<code>左右中</code></p></blockquote><p>比如说我们有一个数学算式 <code>2 *（3 + 4）+ 5</code>：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/RPN.png" alt=" RPN "></p><p>由于数学上习惯写法是<code>中序遍历</code>，我们通常要加上括号消除歧义（比如加减和乘除的顺序）。通过把操作符后移 我们得到 <code>RPN：2 3 4 + * 5 +</code>，这样我们无需括号就能无歧义地遍历这个表达式：</p><p><code>中序表达式</code>转<code>后序表达式</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原式：a+b*(c+d&#x2F;e)</span><br><span class="line">补全括号：(a+(b*(c+(d&#x2F;e))))</span><br><span class="line">操作符右移：(a(b(c(de)&#x2F;)+)*)+</span><br><span class="line">去掉括号：abcde&#x2F;+*+</span><br></pre></td></tr></table></figure><blockquote><p>所以波兰表达式是中序遍历：<code>左右中</code></p></blockquote><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/RPN2.png" alt=" RPN "></p><p>执行 RPN 的过程需要一个<code>栈</code>来缓存中间结果，比如说对于 <code>2 3 4 + * 5 +</code>，我们<code>从左到右</code>遍历表达式，遇到值就压入栈中。直到 <code>+</code> 操作符，栈中已经压入了 <code>2 3 4</code>。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/RPN3.png" alt=" RPN "></p><p>因为 <code>+</code> 是二元操作符，需要从栈中弹出两个值 <code>3 4</code>，结果为 <code>7</code>，<code>重新</code>压入栈中：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/RPN4.png" alt=" RPN "></p><p>此时栈中的值为 <code>2 7</code>。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/RPN5.png" alt=" RPN "></p><p>下一个是 <code>*</code> 运算符，也需要弹出两个值 <code>2 7</code>，结果为 <code>14</code> 压入栈中。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/RPN6.png" alt=" RPN "></p><p>接着压入 <code>5</code> 。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/RPN7.png" alt=" RPN "></p><p>最后 <code>+</code> 运算符弹出 <code>14 5</code>，结果为 <code>19</code> ，压入<code>栈</code>。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/RPN8.png" alt=" RPN "></p><p>最后留在栈里的就是表达式的结果，因此，如果需要计算表达式优先级的话，可以采用RPN的方式来读取tree结构来进行顺序计算。</p><h2 id="单独使用DB例子："><a href="#单独使用DB例子：" class="headerlink" title="单独使用DB例子："></a>单独使用DB例子：</h2><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/db-debug.png" alt=" db-debug "></p><p>这里有一个类似于<code>mysql-client</code> 的一个 <code>bin</code> 程序</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"flag"</span></span><br><span class="line"><span class="string">"github.com/pingcap/parser"</span></span><br><span class="line"><span class="string">"github.com/pingcap/parser/ast"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/logbdev"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/msource/v2"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sql = flag.String(<span class="string">"sql"</span>, <span class="string">""</span>, <span class="string">"Input Your Sql"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">flag.Parse()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> os.Getenv(<span class="string">"DEBUG"</span>) == <span class="string">"true"</span> &#123;</span><br><span class="line">logbdev.SetLevel(logbdev.DebugLevel)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">msource.PreparePhase()</span><br><span class="line">store := msource.NewStore()</span><br><span class="line"></span><br><span class="line">p := parser.New()</span><br><span class="line">stmtNode, err := p.ParseOneStmt(*sql, <span class="string">""</span>, <span class="string">""</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Error(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_, ok := stmtNode.(*ast.SelectStmt)</span><br><span class="line"><span class="keyword">var</span> r *msource.Result</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">r, err = store.Query(*sql)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Error(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">r, err = store.Execute(*sql)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Error(err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> r != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> r.Data != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">switch</span> ar := r.Data.(<span class="keyword">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> *msource.InsertResultData:</span><br><span class="line">logbdev.Info(ar.GetSliceInt64())</span><br><span class="line">logbdev.Info(ar.Raw())</span><br><span class="line"><span class="keyword">case</span> *msource.ShowDatabasesResultData:</span><br><span class="line">logbdev.Info(ar.GetSliceString())</span><br><span class="line"><span class="keyword">case</span> *msource.ShowTablesResultData:</span><br><span class="line">logbdev.Info(ar.GetSliceString())</span><br><span class="line"><span class="keyword">case</span> *msource.SelectResultSetData:</span><br><span class="line">logbdev.Info(ar.GetFields())</span><br><span class="line">logbdev.Info(ar.GetValues())</span><br><span class="line">logbdev.Info(ar.Count())</span><br><span class="line"><span class="keyword">case</span> *msource.DeleteResultData:</span><br><span class="line">logbdev.Info(ar.GetAffected())</span><br><span class="line"><span class="keyword">case</span> *msource.UpdateResultData:</span><br><span class="line">logbdev.Info(ar.GetAffected())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">logbdev.Info(r)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>具体用法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;INSERT INTO users(\&#96;name\&#96;,\&#96;age\&#96;,\&#96;last_login\&#96;) VALUES (\&quot;caiwenhui\&quot;, 18, 1614776101)&quot;</span><br><span class="line">go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;show databases;&quot;</span><br><span class="line">go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;show tables;&quot;</span><br><span class="line">go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;INSERT INTO mingchao.users2(\&#96;name\&#96;,\&#96;age\&#96;) VALUES (\&quot;caiwenhui\&quot;, 18),(\&quot;caiwenhui\&quot;, 19)&quot;</span><br><span class="line">go run example&#x2F;msource_db&#x2F;customStmt&#x2F;main.go --sql &quot;INSERT INTO mingchao.users2 VALUES (1000,\&quot;caiwenhui\&quot;, 18)&quot;</span><br></pre></td></tr></table></figure><p>我们可以用对外暴露一个<code>msource.NewStore()</code>来创建一个存储器对象，然后通过API进行<code>数据库</code>的操作。</p><blockquote><p>NewStore我们用了sync.Pool封装，对象可以做到尽可能的复用。</p></blockquote><p>可以看到如果是<code>SELECT STMT</code>的话，我们调用的是<code>QUERY</code>API，如果是<code>非SELECT STMT</code>的话，我们调用的是<code>EXECUTE</code>API。</p><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>基于目前尚未实现，所以暂时不再展开讲叙，后续可以升级处理的点为：</p><ul><li>事务处理，例如前面所说的<code>redolog</code>和<code>undolog</code>可实现。</li><li>orderby， 数据排序。</li><li>全双工的通信获取数据，无需一次性读取所有数据。</li><li>Explain执行计划的实现，逻辑根据执行计划走。</li></ul><h1 id="SPOUT"><a href="#SPOUT" class="headerlink" title="SPOUT"></a>SPOUT</h1><p>另外一篇文章中，记录了我们的<code>spout</code>的作用，在这里，再简单说一下，<code>spout</code> 是我们<code>msource</code>组件的核心角色，它是用于把数据推送到上层业务的所使用。上层业务通过<code>spout</code>角色提供的<code>API</code>，可以获取到从数据源拿到的数据。</p><p><code>spout</code> 自身保持了一套 <code>高可靠</code>, <code>高性能</code>, <code>可容错</code> 的数据机制，主要用于区别出<code>ACK</code>, <code>NACK</code>，并且自带有 <code>失败重传</code>, <code>多阶段状态机的checkpoint</code>等机制。</p><h2 id="channel-mode-大体数据流程图"><a href="#channel-mode-大体数据流程图" class="headerlink" title="channel-mode 大体数据流程图"></a>channel-mode 大体数据流程图</h2><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/channel-mode.png" alt=" channel-mode "></p><p>之前有一篇文章，专门讲解channel-mode下，是如何工作的，这里不做过多详细的说明。简单复述一下。</p><p>channel模式下，是直接把数据推送到我们的<code>golang</code>的<code>channel</code> 当中，上层业务直接用过channel拿到数据，拿到数据后根据自身业务处理数据来判断可以ack或者nack掉数据，同时保存offset。</p><p>这里的问题就在于：</p><blockquote><p>由于我们是本地存储的offset，因为<code>不信任</code> kafka-client的<code>auto-commit</code>机制，当程序在某个节点crash的时候，这会让我们的程序在下次启动的时候，重复消费到数据或者遗漏数据</p></blockquote><p>缺点：每个partition的offset都需要顺序消费，在上层业务无法并发处理，这极大程度的降低了我们的消费效率</p><p>期望：如果我们提前把offset存储起来了，而不需要<code>ACK</code>之后再存储offset的话，那么我们就可以再上层业务并发的处理消息，而无需关注offset的问题</p><h2 id="db-demo-大体数据流程图"><a href="#db-demo-大体数据流程图" class="headerlink" title="db-demo 大体数据流程图"></a>db-demo 大体数据流程图</h2><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/db-mode.png" alt=" db-mode "></p><p>鉴于<code>channel-mode</code>下的缺点，由此诞生了我们的<code>db-mode</code>，其原理是把数据先存储在本地的数据库，也就是我们上面所说的<code>db</code>，所以这里我们可以得出关系<code>spout &lt;- db</code>， <code>db角色</code> 可以被 <code>spout角色</code>所依赖。</p><p>我们创建了4个表来存储不同的数据：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">DefaultDatabase = <span class="string">"default"</span></span><br><span class="line">DefaultDatabaseSql = <span class="string">"CREATE DATABASE IF NOT EXISTS `"</span> +</span><br><span class="line">DefaultDatabase +</span><br><span class="line"><span class="string">"`"</span></span><br><span class="line">UseDefaultDatabase = <span class="string">"USE `"</span> +</span><br><span class="line">DefaultDatabase +</span><br><span class="line"><span class="string">"`"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 推送消息的时候使用</span></span><br><span class="line"><span class="comment">// 因为正常消息过来的时候是没有row_id的，所以这个payload_marshal内的row_id没意义</span></span><br><span class="line"><span class="comment">// 该表仅仅遍历数据到Runner表，到了Runner表和Loser表，Row_id才有用</span></span><br><span class="line">SpoutStoreStorageTable         = <span class="string">"storage"</span></span><br><span class="line">SpoutStoreStorageBuildTableSql = <span class="string">"create table if not exists "</span> + SpoutStoreStorageTable +</span><br><span class="line"><span class="string">"("</span> +</span><br><span class="line"><span class="string">"`payload_marshal` varchar(255) not null comment \"序列化后的payload\","</span> +</span><br><span class="line"><span class="string">"`is_multi_phase` int(11) not null default 0 comment \"是否多阶段，0=否, 1=是\","</span> +</span><br><span class="line"><span class="string">"`cur_state` int(11) not null default 0 comment \"当前状态\","</span> +</span><br><span class="line"><span class="string">"`fin_state` int(11) not null default 0 comment \"最终状态\""</span> +</span><br><span class="line"><span class="string">")"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Storage -&gt; Runner 使用</span></span><br><span class="line"><span class="comment">// 刚启动服务的时候Runner-&gt;Storage有用</span></span><br><span class="line"><span class="comment">// Ack的时候有用</span></span><br><span class="line">SpoutStoreRunningTable         = <span class="string">"runner"</span></span><br><span class="line">SpoutStoreRunningBuildTableSql = <span class="string">"create table if not exists "</span> + SpoutStoreRunningTable +</span><br><span class="line"><span class="string">"("</span> +</span><br><span class="line"><span class="string">"`payload_marshal` varchar(255) not null comment \"序列化后的payload\","</span> +</span><br><span class="line"><span class="string">"`is_multi_phase` int(11) not null default 0 comment \"是否多阶段，0=否, 1=是\","</span> +</span><br><span class="line"><span class="string">"`cur_state` int(11) not null default 0 comment \"当前状态\","</span> +</span><br><span class="line"><span class="string">"`fin_state` int(11) not null default 0 comment \"最终状态\""</span> +</span><br><span class="line"><span class="string">")"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Runner -&gt; Loser 使用</span></span><br><span class="line"><span class="comment">// Nack的时候有用</span></span><br><span class="line"><span class="comment">// 失败重传的时候用/刚启动服务的时候Loser-&gt;Storage有用</span></span><br><span class="line">SpoutStoreLoserTable         = <span class="string">"loser"</span></span><br><span class="line">SpoutStoreLoserBuildTableSql = <span class="string">"create table if not exists "</span> + SpoutStoreLoserTable +</span><br><span class="line"><span class="string">"("</span> +</span><br><span class="line"><span class="string">"`payload_marshal` varchar(255) not null comment \"序列化后的payload\","</span> +</span><br><span class="line"><span class="string">"`is_multi_phase` int(11) not null default 0 comment \"是否多阶段，0=否, 1=是\","</span> +</span><br><span class="line"><span class="string">"`cur_state` int(11) not null default 0 comment \"当前状态\","</span> +</span><br><span class="line"><span class="string">"`fin_state` int(11) not null default 0 comment \"最终状态\""</span> +</span><br><span class="line"><span class="string">")"</span></span><br><span class="line"></span><br><span class="line">SpoutStoreDefaultOffsetTable         = <span class="string">"offset"</span></span><br><span class="line">SpoutStoreDefaultOffsetBuildTableSql = <span class="string">"create table if not exists "</span> + SpoutStoreDefaultOffsetTable +</span><br><span class="line"><span class="string">"("</span> +</span><br><span class="line"><span class="string">"`group_id` varchar(255) not null comment \"消费组\","</span> +</span><br><span class="line"><span class="string">"`topic` varchar(255) not null comment \"消费的topic\","</span> +</span><br><span class="line"><span class="string">"`partition` int(11) not null comment \"topic的partition\","</span> +</span><br><span class="line"><span class="string">"`offset` int(11) not null comment \"当前消费的offset\","</span> +</span><br><span class="line"><span class="string">"    UNIQUE KEY `uniq_idx` (`group_id`,`topic`,`partition`)"</span> +</span><br><span class="line"><span class="string">")"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/phase-deal-with.png" alt=" phase-deal-with "></p><h2 id="DB模式下的用法例子："><a href="#DB模式下的用法例子：" class="headerlink" title="DB模式下的用法例子："></a>DB模式下的用法例子：</h2><blockquote><p>channel-mode下的例子和db模式的差不多，但是更加简单，这里就不列出来了。</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> common</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"context"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/logbdev"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/msource/v2"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"os/signal"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line"><span class="string">"syscall"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PreparePhase</span><span class="params">()</span></span> &#123;</span><br><span class="line">logbdev.SetLevel(logbdev.DebugLevel)</span><br><span class="line">S = msource.PreparePhase()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> S *msource.Spout</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CoreStart</span><span class="params">(function <span class="keyword">func</span>(payload *msource.Payload)</span>)</span> &#123;</span><br><span class="line">wg := <span class="built_in">new</span>(sync.WaitGroup)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建主协程上下文</span></span><br><span class="line">ctx, cannel := context.WithCancel(context.Background())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动msource，并且传递主协程上下文，用于任务间的通信控制</span></span><br><span class="line">S.Start(ctx)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册信号量</span></span><br><span class="line">sig := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(sig, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-sig:</span><br><span class="line">cannel()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里我们可以再创建更多的worker协助我们的消费数据</span></span><br><span class="line"><span class="comment">// 使用方式基本向后兼容</span></span><br><span class="line">innerWorker := <span class="number">3</span></span><br><span class="line"></span><br><span class="line">logbdev.Infof(<span class="string">"total chan: %d\n"</span>, S.ChanSize())</span><br><span class="line"><span class="comment">// 主协程中创建子协程（worker）工作</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; S.ChanSize(); i++ &#123;</span><br><span class="line"><span class="keyword">for</span> ii := <span class="number">0</span>; ii &lt; innerWorker; ii++ &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx, idx2 <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">logbdev.Infof(<span class="string">"start chan[%d-%d]\n"</span>, idx, idx2)</span><br><span class="line">payloadCh := S.GetPayloadChanById(idx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> payload := <span class="keyword">range</span> payloadCh.GetCh() &#123;</span><br><span class="line">function(payload)</span><br><span class="line">&#125;</span><br><span class="line">&#125;(i, ii)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 等待子协程结束</span></span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="comment">// 等待msource退出</span></span><br><span class="line">S.Stop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ACK"><a href="#ACK" class="headerlink" title="ACK"></a>ACK</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/logbdev"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/msource/v2"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/msource/v2/example/spout/db/common"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">common.CoreStart(<span class="function"><span class="keyword">func</span><span class="params">(payload *msource.Payload)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := common.S.Ack(payload); err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Error(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NACK"><a href="#NACK" class="headerlink" title="NACK"></a>NACK</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/logbdev"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/msource/v2"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/msource/v2/example/spout/db/common"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">common.PreparePhase()</span><br><span class="line">common.CoreStart(<span class="function"><span class="keyword">func</span><span class="params">(payload *msource.Payload)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> err := common.S.MarkFailure(payload); err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Error(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="STATE-MACHINE"><a href="#STATE-MACHINE" class="headerlink" title="STATE-MACHINE"></a>STATE-MACHINE</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"context"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/logbdev"</span></span><br><span class="line"><span class="string">"gitlab.mingchao.com/basedev-deps/msource/v2/example/spout/db/common"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"os/signal"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line"><span class="string">"syscall"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyStateMachine <span class="keyword">struct</span> &#123;</span><br><span class="line">phases []<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msm *MyStateMachine)</span> <span class="title">AddPhase</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">msm.phases = <span class="built_in">append</span>(msm.phases, name)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// get all phase</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(msm *MyStateMachine)</span> <span class="title">GetPhases</span><span class="params">()</span> []<span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> msm.phases</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">common.PreparePhase()</span><br><span class="line">wg := <span class="built_in">new</span>(sync.WaitGroup)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建主协程上下文</span></span><br><span class="line">ctx, cannel := context.WithCancel(context.Background())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动msource，并且传递主协程上下文，用于任务间的通信控制</span></span><br><span class="line"><span class="comment">// 需要设置为多阶段的话，必须设置状态机，并且在msource服务Start之前设置</span></span><br><span class="line">sms := &amp;MyStateMachine&#123;&#125;</span><br><span class="line">_ = sms.AddPhase(<span class="string">"step1"</span>)</span><br><span class="line">_ = sms.AddPhase(<span class="string">"step2"</span>)</span><br><span class="line">_ = sms.AddPhase(<span class="string">"step3"</span>)</span><br><span class="line">common.S.SetStateMachine(sms)</span><br><span class="line">common.S.Start(ctx)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册信号量</span></span><br><span class="line">sig := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">signal.Notify(sig, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-sig:</span><br><span class="line">cannel()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">logbdev.Infof(<span class="string">"total chan: %d\n"</span>, common.S.ChanSize())</span><br><span class="line"><span class="comment">// 主协程中创建子协程（worker）工作</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; common.S.ChanSize(); i++ &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line">chCtx, _ := context.WithCancel(ctx)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(idx <span class="keyword">int</span>, childCtx context.Context)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">logbdev.Infof(<span class="string">"start chan[%d]\n"</span>, idx)</span><br><span class="line">payloadCh := common.S.GetPayloadChanById(idx)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> payload := &lt;-payloadCh.GetCh():</span><br><span class="line"><span class="comment">// 不同阶段之间如果相互无依赖的话，则可以并发处理</span></span><br><span class="line"><span class="comment">// 否则请使用同步的方式</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">phase := <span class="string">"step1"</span></span><br><span class="line"><span class="keyword">if</span> common.S.CanTransition(payload, phase) &#123;</span><br><span class="line">fmt.Println(<span class="string">"Do Step 1 something"</span>)</span><br><span class="line">_ = common.S.Transition(payload, phase)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">phase := <span class="string">"step2"</span></span><br><span class="line"><span class="keyword">if</span> common.S.CanTransition(payload, phase) &#123;</span><br><span class="line">fmt.Println(<span class="string">"Do Step 2 something"</span>)</span><br><span class="line">_ = common.S.Transition(payload, phase)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">phase := <span class="string">"step3"</span></span><br><span class="line"><span class="keyword">if</span> common.S.CanTransition(payload, phase) &#123;</span><br><span class="line">fmt.Println(<span class="string">"Do Step 3 something"</span>)</span><br><span class="line">_ = common.S.Transition(payload, phase)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">wg.Wait()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多阶段的请看下，Ack非必须要，如果手动调用ack的话，那么等于一条条同步删除</span></span><br><span class="line"><span class="comment">// msource 在后台会定期检测runner中的状态机数据</span></span><br><span class="line"><span class="comment">//if err := common.S.Ack(payload); err != nil &#123;</span></span><br><span class="line"><span class="comment">//logbdev.Error(err)</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">fmt.Println(<span class="string">"Done"</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;(i, chCtx)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 等待子协程结束</span></span><br><span class="line">wg.Wait()</span><br><span class="line"><span class="comment">// 等待msource退出</span></span><br><span class="line">common.S.Stop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="小知识总结"><a href="#小知识总结" class="headerlink" title="小知识总结"></a>小知识总结</h1><h2 id="time组件"><a href="#time组件" class="headerlink" title="time组件"></a>time组件</h2><p>在开发的过程中，<code>time组件</code>用得还是比较多的，因为有各种异步任务在后台运行，常规的用法就不记录讲述了，这里说一下一些注意的点。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; After waits for the duration to elapse and then sends the current time</span><br><span class="line">&#x2F;&#x2F; on the returned channel.</span><br><span class="line">&#x2F;&#x2F; It is equivalent to NewTimer(d).C.</span><br><span class="line">&#x2F;&#x2F; The underlying Timer is not recovered by the garbage collector</span><br><span class="line">&#x2F;&#x2F; until the timer fires. If efficiency is a concern, use NewTimer</span><br><span class="line">&#x2F;&#x2F; instead and call Timer.Stop if the timer is no longer needed.</span><br><span class="line">func After(d Duration) &lt;-chan Time &#123;</span><br><span class="line">return NewTimer(d).C</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到这个<code>API</code>，如果想要用</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">1</span>*time.Second)):</span><br><span class="line">fmt.Println(<span class="string">"时间到了"</span>)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">"go on"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到这个例子，如果我们这么用的话，每1秒都会重新创建一个Timer对象，不断在堆空间申请内存，然后gc-worker再大量回收没有再使用的对象内存。这就导致cpu做了额外的一些无效工作。</p><p>所以这种用法我是不推荐的。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Timer)</span> <span class="title">Reset</span><span class="params">(d Duration)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> t.r.f == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"time: Reset called on uninitialized Timer"</span>)</span><br><span class="line">&#125;</span><br><span class="line">w := when(d)</span><br><span class="line"><span class="keyword">return</span> resetTimer(&amp;t.r, w)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们看到其实<code>Timer</code> 其实有一个<code>Reset</code>的API，我们可以对同一个timer进行<code>Reset</code>的操作，不断是重置时间即可。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d := <span class="number">1</span>*time.Second</span><br><span class="line">t:= NewTimer(d)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">t.Reset(d)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">fmt.Println(<span class="string">"go on"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="make函数"><a href="#make函数" class="headerlink" title="make函数"></a>make函数</h2><p>make函数是一个很强大的函数，我们会经常使用到，但是有一些细节，需要大家知道的。</p><p><code>make([]byte,0,10)</code> 与 <code>make([]byte,10)</code> 这是2中不同的切片，对于可能刚学习golang的小伙伴来说，会有点疑惑，但是这是需要了解的，如果是三个参数的时候，一个是<code>cap</code>,一个是<code>len</code>，他们是有区别的。如果是三个参数的话，那代表当前大小<code>cap</code> = <code>len</code></p><p>我们经常会用三个参数来进行预分配空间，第二个参数默认都是填写0来进行优化，特别是我们在写<code>DB</code>的时候，用到了大量<code>[]byte</code>类型，在组装编码字节的时候，我们就需要使用这种方式来处理，否则。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, <span class="number">5</span>)</span><br><span class="line">a = <span class="built_in">append</span>(a, []<span class="keyword">byte</span>&#123;<span class="string">'a'</span>&#125;) <span class="comment">// a = [97]</span></span><br><span class="line"></span><br><span class="line">a := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">5</span>)</span><br><span class="line">a = <span class="built_in">append</span>(a, []<span class="keyword">byte</span>&#123;<span class="string">'a'</span>&#125;) <span class="comment">// a = [0,0,0,0,0,97]</span></span><br></pre></td></tr></table></figure><p>看到这里，大家就会明白区别。</p><h2 id="once函数"><a href="#once函数" class="headerlink" title="once函数"></a>once函数</h2><p>有些时候，我们想要保证只运行一次，这里，我们就需要借助 <code>sync.Once</code>，需要注意的是 一个<code>sync.Once</code>只能与一个函数绑定！</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">once := <span class="built_in">new</span>(sync.Once)</span><br><span class="line">callback:= <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; fmt.Println(<span class="string">"我只想运行一次"</span>)&#125;</span><br><span class="line">once.Do(callback) <span class="comment">// 会 输出</span></span><br><span class="line"></span><br><span class="line">once.Do(callback) <span class="comment">// 无 输出</span></span><br><span class="line">once.Do(callback) <span class="comment">// 无 输出</span></span><br><span class="line">once.Do(callback) <span class="comment">// 无 输出</span></span><br></pre></td></tr></table></figure><h2 id="自定义marshal和unmarshal"><a href="#自定义marshal和unmarshal" class="headerlink" title="自定义marshal和unmarshal"></a>自定义marshal和unmarshal</h2><p>有时候，我们想要自己定义json的<code>marshal</code> 和 <code>unmarshal</code>，这里我们的<code>发号计数器</code> 就用到了，用它的原因其实是因为，我们的发号计数器在发号的过程中，其实是后台跑着一个异步任务在发号，所以在被反编码的时候，我们需要启动这个异步任务。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">UnmarshalJSON</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">c.IdKey = data[<span class="number">1</span> : <span class="built_in">len</span>(data)<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重点关注这里</span></span><br><span class="line">turboNew(c)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">MarshalJSON</span><span class="params">()</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, <span class="built_in">len</span>(c.IdKey)+<span class="number">2</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, <span class="string">'"'</span>)</span><br><span class="line">b = <span class="built_in">append</span>(b, c.IdKey...)</span><br><span class="line">b = <span class="built_in">append</span>(b, <span class="string">'"'</span>)</span><br><span class="line"><span class="keyword">return</span> b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">turboNew</span><span class="params">(c *counter)</span></span> &#123;</span><br><span class="line">ct := custom.Load().(*Custom)</span><br><span class="line">c.idChan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int64</span>, ct.IdStep)</span><br><span class="line">c.sig = <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">c.ReadOptions = gorocksdb.NewDefaultReadOptions()</span><br><span class="line">signal.Notify(c.sig, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里会启动一个异步任务</span></span><br><span class="line">c.sender()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *counter)</span> <span class="title">sender</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 异步任务</span></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="lockfree-queue和lockfree-stack"><a href="#lockfree-queue和lockfree-stack" class="headerlink" title="lockfree-queue和lockfree-stack"></a>lockfree-queue和lockfree-stack</h2><p>我们知道如果想要做到并发安全的话，普遍做法就是2种</p><ul><li>无锁化结构的设计（需要针对特定的业务常用，并且不允许乱用）</li><li>有锁结构</li></ul><p>无锁化(<code>lock-free</code>)的实现方式有很多种，在开发的过程中，我也有想过利用<code>lock-free-stack</code>以及<code>lock-free-queue</code>，分别想要运用在<code>RPN</code>的实现以及<code>发号器</code>当中，虽然后来发现用不到，但是可以拿到这里和大家分享一下。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// inrInt64 Increase</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">inrInt64</span><span class="params">(i *<span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">t := <span class="keyword">int64</span>(+<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">value := atomic.LoadInt64(i)</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt64(i, value, value+t) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Nanosecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dcrInt64 Decrease</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">dcrInt64</span><span class="params">(i *<span class="keyword">int64</span>)</span></span> &#123;</span><br><span class="line">t := <span class="keyword">int64</span>(<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">value := atomic.LoadInt64(i)</span><br><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt64(i, value, value+t) &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Nanosecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LKStack returns an empty queue.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLKStack</span><span class="params">()</span> *<span class="title">LKStack</span></span> &#123;</span><br><span class="line">n := unsafe.Pointer(&amp;node&#123;&#125;)</span><br><span class="line"><span class="keyword">return</span> &amp;LKStack&#123;head: n&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LKStack is a lock-free unbounded stack.</span></span><br><span class="line"><span class="keyword">type</span> LKStack <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="built_in">len</span>  <span class="keyword">int64</span></span><br><span class="line">head unsafe.Pointer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *LKStack)</span> <span class="title">IsEmpty</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> q.Len() == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *LKStack)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int64</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> q.<span class="built_in">len</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LKStack puts the given value v at the tail of the stack.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *LKStack)</span> <span class="title">Push</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">n := &amp;node&#123;value: v&#125;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">head := load(&amp;q.head)</span><br><span class="line">next := load(&amp;n.next)</span><br><span class="line">cas(&amp;n.next, next, head)</span><br><span class="line"><span class="keyword">if</span> cas(&amp;q.head, head, n) &#123;</span><br><span class="line">inrInt64(&amp;q.<span class="built_in">len</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">time.Sleep(time.Nanosecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pop removes and returns the value at the head of the stack.</span></span><br><span class="line"><span class="comment">// It returns nil if the stack is empty.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *LKStack)</span> <span class="title">Pop</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">head := load(&amp;q.head)</span><br><span class="line">next := load(&amp;head.next)</span><br><span class="line"><span class="keyword">if</span> next == <span class="literal">nil</span> &#123; <span class="comment">// is stack empty?</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// read value before CAS otherwise another pop might free the next node</span></span><br><span class="line">v := head.value</span><br><span class="line"><span class="keyword">if</span> cas(&amp;q.head, head, next) &#123;</span><br><span class="line">dcrInt64(&amp;q.<span class="built_in">len</span>)</span><br><span class="line"><span class="keyword">return</span> v <span class="comment">// Pop is done.  return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Nanosecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// load from atomic load pointer node</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">load</span><span class="params">(p *unsafe.Pointer)</span> <span class="params">(n *node)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> (*node)(atomic.LoadPointer(p))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// cas swap set</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cas</span><span class="params">(p *unsafe.Pointer, old, <span class="built_in">new</span> *node)</span> <span class="params">(ok <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> atomic.CompareAndSwapPointer(</span><br><span class="line">p, unsafe.Pointer(old), unsafe.Pointer(<span class="built_in">new</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里也不过多在这里描述了，我们大家查看源码吧，主要就是利用了<code>atomic</code>包中的<code>原子性</code>操作<code>CompareAndSwapXxx</code>, 因为这是一个原子性的指令，合理的运用即可做到<code>无锁化并发安全</code>的结构。</p><p><code>atomic</code>包的<code>CompareAndSwapXxx</code>其实就是一个<code>CAS</code>的理念，用<code>乐观锁(逻辑锁)</code>来做数据处理。</p><h2 id="unsafa包中的指针的作用：零拷贝string和byte的转换"><a href="#unsafa包中的指针的作用：零拷贝string和byte的转换" class="headerlink" title="unsafa包中的指针的作用：零拷贝string和byte的转换"></a>unsafa包中的指针的作用：零拷贝string和byte的转换</h2><p><code>零拷贝(zero-copy)</code>，传统较多的说法就是无需经过用户态到内核态到数据copy，即可做到想做的事情。 通俗一点就是不经过copy就能转换数据。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StringHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">    Data <span class="keyword">uintptr</span></span><br><span class="line">    Len  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SliceHeader <span class="keyword">struct</span> &#123;</span><br><span class="line">    Data <span class="keyword">uintptr</span></span><br><span class="line">    Len  <span class="keyword">int</span></span><br><span class="line">    Cap  <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是String和slice的底层数据结构，他们基本是一致的，区别其实就是在于一个有Cap，一个是固定的Len。</p><p>只需要共享底层 Data 和 Len 就可以实现 zero-copy。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">string2bytes</span><span class="params">(s <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> *(*[]<span class="keyword">byte</span>)(unsafe.Pointer(&amp;s))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bytes2string</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="context控制上下文也讲解一下"><a href="#context控制上下文也讲解一下" class="headerlink" title="context控制上下文也讲解一下"></a>context控制上下文也讲解一下</h2><p>我们这里用到了大量协程，他们之间有一些或许是有上下文关系的，因此，我们这里就需要用到<code>context</code>来对协程进行一个上下文的管理，做到协助的作用。</p><p>特别是我们在退出程序的时候，我们想要某一些异步任务<code>优雅</code>,<code>可靠</code>,<code>安全</code>的退出程序，那么我们就需要用到context来控制每个后台运行的程序。</p><p>我们这里用到比较多的其实就是 <code>context.WithCancel(ctx)</code>， 我们需要管理每个协程的退出需要做的事情，例如：我需要msource在退出的时候，保存一下当前在内存中最新的数据到rocksdb中，那么这个时候context的作用就十分有效了。</p><h2 id="pprof的查看"><a href="#pprof的查看" class="headerlink" title="pprof的查看"></a>pprof的查看</h2><p>要利用pprof粗略查看性能，及时它不能准确的反馈出所有的问题，起码它能帮助我们在前面的大问题上更容易发现问题。</p><h2 id="sync-Pool如何做到优化"><a href="#sync-Pool如何做到优化" class="headerlink" title="sync.Pool如何做到优化"></a>sync.Pool如何做到优化</h2><ul><li>对STW暂停时间做了优化, 避免大的sync.Pool严重影响STW时间</li><li>第二个优化是GC时入对<code>sync.Pool</code>进行回收，不会一次将池化对象全部回收，这就避免了<code>sync.Pool</code>释放对象和重建对象导致的性能尖刺，造福于<code>sync.Pool</code>重度用户。</li><li>第三个就是对性能的优化。</li><li>对以上的改进主要是两次提交：<br><a href="https://github.com/golang/go/commit/d5fd2dd6a17a816b7dfd99d4df70a85f1bf0de31#diff-491b0013c82345bf6cfa937bd78b690d" target="_blank" rel="noopener">sync: use lock-free structure for Pool stealing</a><br><a href="https://github.com/golang/go/commit/2dcbf8b3691e72d1b04e9376488cef3b6f93b286#diff-491b0013c82345bf6cfa937bd78b690d" target="_blank" rel="noopener">sync: smooth out Pool behavior over GC with a victim cache</a></li></ul><p>分别是用到了<code>无锁化结构</code> 以及程序GC的行为的优化</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&lt;code&gt;CAP&lt;/code&gt;原则又称CAP定理，指的是在一个分布式系统中，&lt;code&gt;一致性（Consistency）&lt;/code&gt;、&lt;code&gt;可用性（Availability）&lt;/code&gt;、&lt;code&gt;分区容错性（Partition tolerance）&lt;/code&gt;。CAP 原则指的是，这三个要素最多只能同时实现两点，不可能三者兼顾。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;msource&lt;/code&gt; 是我们的一个 &lt;code&gt;数据源组件&lt;/code&gt;，我们所有的大数据ETL服务都构建在此之上，所以我们msource可以说是所有业务系统的核心。他维护着一个稳定，可靠，高性能的数据传输机制。让我们 &lt;code&gt;业务层&lt;/code&gt; 中可以做各种操作，同步，异步等等。&lt;/p&gt;
&lt;p&gt;msource 的角色我大体分为了2种：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;spout （数据推送组件)&lt;/li&gt;
&lt;li&gt;db （数据存储组件）&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="数据结构" scheme="http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="数据库" scheme="http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="Kafka" scheme="http://blog.crazylaw.cn/tags/Kafka/"/>
    
      <category term="TiDB" scheme="http://blog.crazylaw.cn/tags/TiDB/"/>
    
      <category term="RocketDB" scheme="http://blog.crazylaw.cn/tags/RocketDB/"/>
    
      <category term="SQL" scheme="http://blog.crazylaw.cn/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>【Golang】- unsafe Pointer</title>
    <link href="http://blog.crazylaw.cn/2021/01/14/Golang/unsafe-Pointer/"/>
    <id>http://blog.crazylaw.cn/2021/01/14/Golang/unsafe-Pointer/</id>
    <published>2021-01-14T03:37:12.000Z</published>
    <updated>2021-03-20T16:25:01.799Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于目前在使用使用一些go写的odbc库，里面涉及到一些cgo的内容，那就避不开内存和指针等问题，在这边文章中记录一下<code>unsafe Pointer</code> 和 <code>uintptr</code> 的相关内容。</p><p>Go语言在设计的时候，为了编写方便、效率高以及降低复杂度，被设计成为一门强类型的静态语言。强类型意味着一旦定义了，它的类型就不能改变了；静态意味着类型检查在运行前就做了。</p><p>同时为了安全的考虑，Go语言是不允许两个指针类型进行转换的。</p><a id="more"></a><h2 id="指针类型转换"><a href="#指针类型转换" class="headerlink" title="指针类型转换"></a>指针类型转换</h2><p>我们一般使用<code>*T</code>作为一个指针类型，表示一个指向类型<code>T变量</code>的<code>指针</code>。为了安全的考虑，两个不同的指针类型不能相互转换，比如<code>*int</code>不能转为<code>*float64</code>。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">i:= <span class="number">10</span></span><br><span class="line">ip:=&amp;i</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fp *<span class="keyword">float64</span> = (*<span class="keyword">float64</span>)(ip)</span><br><span class="line"></span><br><span class="line">fmt.Println(fp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上代码我们在编译的时候，会提示 <code>cannot convert ip (type *int) to type *float64</code>，也就是不能进行强制转型。那如果我们还是需要进行转换怎么做呢？这就需要我们使用 <code>unsafe包</code> 里的 <code>Pointer</code> 了，下面我们先看看 <code>unsafe.Pointer</code> 是什么，然后再介绍如何转换。</p><h2 id="unsafe-Pointer"><a href="#unsafe-Pointer" class="headerlink" title="unsafe.Pointer"></a>unsafe.Pointer</h2><p><code>unsafe.Pointer</code> 是一种特殊意义的指针，它可以包含任意类型的地址，有点类似于 <code>C语言</code> 里的 <code>void*</code> 指针，全能型的。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">i:= <span class="number">10</span></span><br><span class="line">ip:=&amp;i</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fp *<span class="keyword">float64</span> = (*<span class="keyword">float64</span>)(unsafe.Pointer(ip))</span><br><span class="line"></span><br><span class="line">*fp = *fp * <span class="number">3</span></span><br><span class="line"></span><br><span class="line">fmt.Println(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上示例，我们可以把 <code>*int</code> 转为 <code>*float64</code> ,并且我们尝试了对新的 <code>*float64</code> 进行操作，打印输出i，就会发现i的址同样被改变。</p><p>以上这个例子没有任何实际的意义，但是我们说明了，通过 <code>unsafe.Pointer</code> 这个万能的指针，我们可以在 <code>*T</code> 之间做任何转换。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ArbitraryType <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pointer *ArbitraryType</span><br></pre></td></tr></table></figure><p>可以看到 <code>unsafe.Pointer</code> 其实就是一个 <code>*int</code>,一个通用型的指针。</p><p>我们看下关于 <code>unsafe.Pointer</code> 的4个规则。</p><ul><li><code>任何指针</code> 都可以转换为 <code>unsafe.Pointer</code></li><li><code>unsafe.Pointer</code> 可以转换为 <code>任何指针</code></li><li><code>uintptr</code> 可以转换为 <code>unsafe.Pointer</code></li><li><code>unsafe.Pointer</code> 可以转换为 <code>uintptr</code></li></ul><p>前面两个规则我们刚刚已经演示了，主要用于 <code>*T1</code> 和 <code>*T2</code> 之间的转换，那么最后两个规则是做什么的呢？我们都知道 <code>*T</code> 是 <code>不能计算偏移量</code> 的，也不能进行计算，<code>但是uintptr可以</code>，所以我们可以把<code>指针</code>转为<code>uintptr</code>再<code>进行偏移计算</code>，这样我们就可以<code>访问特定的内存</code>了，达到对不同的<code>内存读写</code>的目的。</p><p>下面我们以通过<code>指针偏移</code> 修改Struct结构体内的字段为例，来演示 <code>uintptr</code> 的用法。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">u:=<span class="built_in">new</span>(user)</span><br><span class="line">fmt.Println(*u)</span><br><span class="line"></span><br><span class="line">pName:=(*<span class="keyword">string</span>)(unsafe.Pointer(u))</span><br><span class="line">*pName=<span class="string">"张三"</span></span><br><span class="line"></span><br><span class="line">pAge:=(*<span class="keyword">int</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(u))+unsafe.Offsetof(u.age)))</span><br><span class="line">*pAge = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">fmt.Println(*u)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上我们通过内存偏移的方式，定位到我们需要操作的字段，然后改变他们的值。</p><p>第一个修改user的name值的时候，<code>因为name是第一个字段，所以不用偏移</code>，我们获取user的指针，然后通过 <code>unsafe.Pointer</code> 转为<code>*string</code> 进行赋值操作<code>即可</code>。</p><p>第二个修改user的age值的时候，<code>因为age不是第一个字段，所以我们需要内存偏移</code>，内存偏移牵涉到的计算只能通过<code>uintptr</code>，所我们要先把<code>user的指针地址</code>转为<code>uintptr</code>，然后我们再通过<code>unsafe.Offsetof(u.age)</code>获取需要偏移的值，进行<code>地址运算(+)偏移</code>即可。</p><p>现在偏移后，地址已经是user的age字段了，如果要给它赋值，我们需要把<code>uintptr</code>转为<code>*int</code>才可以。所以我们通过把<code>uintptr</code>转为<code>unsafe.Pointer</code>,再转为<code>*int</code>就可以操作了。</p><p>这里我们可以看到，我们第二个偏移的表达式非常长，但是也千万不要把他们分段，不能像下面这样。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">temp:=<span class="keyword">uintptr</span>(unsafe.Pointer(u))+unsafe.Offsetof(u.age)</span><br><span class="line">pAge:=(*<span class="keyword">int</span>)(unsafe.Pointer(temp))</span><br><span class="line">*pAge = <span class="number">20</span></span><br></pre></td></tr></table></figure><p>栈内指针在栈扩容的时候，有了新的地址，因此<code>uintptr</code>只能作为指针计算的中间态，<code>不允许</code>使用变量<code>保存uintptr的值</code>。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>unsafe是不安全的，所以我们应该尽可能少的使用它</code>，比如内存的操纵，这是绕过Go本身设计的安全机制的，不当的操作，可能会破坏一块内存，而且这种问题非常不好定位。</p><p>当然必须的时候我们可以使用它，比如底层类型相同的数组之间的转换；比如使用sync/atomic包中的一些函数时；还有访问Struct的私有字段时，该用还是要用，不过一定要慎之又慎。</p><p><code>整个unsafe包都是用于Go编译器的，不用运行时，在我们编译的时候，Go编译器已经把他们都处理了</code>。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;由于目前在使用使用一些go写的odbc库，里面涉及到一些cgo的内容，那就避不开内存和指针等问题，在这边文章中记录一下&lt;code&gt;unsafe Pointer&lt;/code&gt; 和 &lt;code&gt;uintptr&lt;/code&gt; 的相关内容。&lt;/p&gt;
&lt;p&gt;Go语言在设计的时候，为了编写方便、效率高以及降低复杂度，被设计成为一门强类型的静态语言。强类型意味着一旦定义了，它的类型就不能改变了；静态意味着类型检查在运行前就做了。&lt;/p&gt;
&lt;p&gt;同时为了安全的考虑，Go语言是不允许两个指针类型进行转换的。&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>【大数据】- flume + kudu 操作指南</title>
    <link href="http://blog.crazylaw.cn/2021/01/05/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume+kudu/"/>
    <id>http://blog.crazylaw.cn/2021/01/05/%E5%A4%A7%E6%95%B0%E6%8D%AE/flume+kudu/</id>
    <published>2021-01-05T01:56:40.000Z</published>
    <updated>2021-03-20T16:25:01.815Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于我们要尝试使用kudu，架构是由flume-&gt;kudu</p><a id="more"></a><p>[kudu-flume-sink(v1.9)] (<a href="https://github.com/apache/kudu/blob/1.9.0/java/kudu-flume-sink/src/main/java/org/apache/kudu/flume/sink/KuduSink.java" target="_blank" rel="noopener">https://github.com/apache/kudu/blob/1.9.0/java/kudu-flume-sink/src/main/java/org/apache/kudu/flume/sink/KuduSink.java</a>)</p><h2 id="1-9-Configuration-of-KuDu-Sink"><a href="#1-9-Configuration-of-KuDu-Sink" class="headerlink" title="1.9 Configuration of KuDu Sink:  "></a>1.9 Configuration of KuDu Sink:  </h2><table><thead><tr><th>Property Name</th><th align="center">Default</th><th align="center">Required</th><th align="left">Description</th></tr></thead><tbody><tr><td>channel</td><td align="center">-</td><td align="center">Yes</td><td align="left">要绑定读取的channel</td></tr><tr><td>type</td><td align="center">-</td><td align="center">Yes</td><td align="left">组件名，必须填写<code>org.apache.kudu.flume.sink.KuduSink</code></td></tr><tr><td>masterAddresses</td><td align="center">-</td><td align="center">Yes</td><td align="left">逗号分隔kudu master地址，例子: <code>host1:port1,host2:port2</code>,其中端口是选填</td></tr><tr><td>tableName</td><td align="center">-</td><td align="center">Yes</td><td align="left">要写入的kudu表名</td></tr><tr><td>batchSize</td><td align="center">1000</td><td align="center">No</td><td align="left">sink每批次处理最大数</td></tr><tr><td>ignoreDuplicateRows</td><td align="center">true</td><td align="center">No</td><td align="left">是否忽略插入导致的重复主键错误。</td></tr><tr><td>timeoutMillis</td><td align="center">10000</td><td align="center">No</td><td align="left">Kudu写操作的超时时间，单位为毫秒</td></tr><tr><td>producer</td><td align="center">SimpleKuduOperationsProducer</td><td align="center">No</td><td align="left">接收器应该使用实现了的<code>KuduOperationsProducer</code> 接口的的完全限定类名。</td></tr><tr><td>producer.*</td><td align="center">-</td><td align="center">(Varies by operations producer)</td><td align="left">要传递给操作生产者实现的配置属性。</td></tr></tbody></table><blockquote><p>由于这种方式必须一个sink对应一个table，不符合我们的使用场景，我们该用了其他方案。文章待定。</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;由于我们要尝试使用kudu，架构是由flume-&amp;gt;kudu&lt;/p&gt;
    
    </summary>
    
    
      <category term="大数据" scheme="http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="大数据" scheme="http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="flume" scheme="http://blog.crazylaw.cn/tags/flume/"/>
    
      <category term="kudu" scheme="http://blog.crazylaw.cn/tags/kudu/"/>
    
  </entry>
  
  <entry>
    <title>【大数据】- 记一次华为云大数据服务对接问题记录</title>
    <link href="http://blog.crazylaw.cn/2021/01/05/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%AF%B9%E6%8E%A5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/"/>
    <id>http://blog.crazylaw.cn/2021/01/05/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%A4%A7%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%AF%B9%E6%8E%A5%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/</id>
    <published>2021-01-05T01:56:40.000Z</published>
    <updated>2021-05-14T09:05:22.942Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于我们在调研是否让自建IDC大数据机房上云服务，所以华为云进行一下测试。</p><a id="more"></a><h2 id="问题一：impala的连接问题"><a href="#问题一：impala的连接问题" class="headerlink" title="问题一：impala的连接问题"></a>问题一：impala的连接问题</h2><p>由于我们开启了<code>Kerberos</code>，所以我们在终端执行<code>impala-shell</code>的时候，默认情况下是连不上的。需要通过<code>Kerberos</code>进行<code>身份校验</code>和<code>授权</code>才可以访问。</p><p>我们创建了一个名字叫<code>hiveuser</code>的账号，目前所有的组件服务都通过该账号进行访问。</p><p>所以我们需要初始化和续期凭据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@node-str-coreoVpr ~]# impala-shell</span><br><span class="line">Starting Impala Shell without Kerberos authentication</span><br><span class="line">Error connecting: TTransportException, Could not connect to node-str-coreoVpr:21000</span><br><span class="line">Kerberos ticket found in the credentials cache, retrying the connection with a secure transport.</span><br><span class="line">Error connecting: TTransportException, Could not connect to node-str-coreoVpr:21000</span><br><span class="line">***********************************************************************************</span><br><span class="line">Welcome to the Impala shell.</span><br><span class="line">(Impala Shell v3.2.0 (f63543a) built on Wed Nov  6 11:46:33 CST 2019)</span><br><span class="line"></span><br><span class="line">Want to know what version of Impala you&#39;re connected to? Run the VERSION command to</span><br><span class="line">find out!</span><br><span class="line">***********************************************************************************</span><br><span class="line">[Not connected] &gt; quit;</span><br><span class="line">Connection lost, reconnecting...</span><br><span class="line">Error connecting: TTransportException, Could not connect to node-str-coreoVpr:21000</span><br><span class="line">Goodbye root</span><br></pre></td></tr></table></figure><p>可以看到，我们是连不上的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node-str-coreoVpr ~]# kinit hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM</span><br><span class="line">Password for hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM:</span><br><span class="line"></span><br><span class="line">[root@node-str-coreoVpr ~]# klist</span><br><span class="line">Ticket cache: FILE:&#x2F;tmp&#x2F;krb5cc_0</span><br><span class="line">Default principal: hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM</span><br><span class="line"></span><br><span class="line">Valid starting       Expires              Service principal</span><br><span class="line">01&#x2F;05&#x2F;2021 17:05:25  01&#x2F;06&#x2F;2021 17:05:21  krbtgt&#x2F;122451B2_394D_494B_9FCA_B045F596D6D4.COM@122451B2_394D_494B_9FCA_B045F596D6D4.COM</span><br></pre></td></tr></table></figure><p>再次尝试连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node-str-coreoVpr ~]# impala-shell -i node-ana-coretXnL</span><br><span class="line">Starting Impala Shell without Kerberos authentication</span><br><span class="line">Opened TCP connection to node-ana-coretXnL:21000</span><br><span class="line">Error connecting: TTransportException, TSocket read 0 bytes</span><br><span class="line">Kerberos ticket found in the credentials cache, retrying the connection with a secure transport.</span><br><span class="line">Opened TCP connection to node-ana-coretXnL:21000</span><br><span class="line">Connected to node-ana-coretXnL:21000</span><br><span class="line">Server version: impalad version 3.2.0 RELEASE (build 83150778f5d85f48878f611da47face9328e9e6a)</span><br><span class="line">***********************************************************************************</span><br><span class="line">Welcome to the Impala shell.</span><br><span class="line">(Impala Shell v3.2.0 (f63543a) built on Wed Nov  6 11:46:33 CST 2019)</span><br><span class="line"></span><br><span class="line">Press TAB twice to see a list of available commands.</span><br><span class="line">***********************************************************************************</span><br><span class="line">[node-ana-coretXnL:21000] default&gt;</span><br></pre></td></tr></table></figure><p>可以看到，已经可以连接上了。</p><h2 id="问题一：flume-amp-amp-kudu"><a href="#问题一：flume-amp-amp-kudu" class="headerlink" title="问题一：flume &amp;&amp; kudu"></a>问题一：flume &amp;&amp; kudu</h2><p>目前，我们对基本配置如下：</p><table><thead><tr><th>服务</th><th align="center">版本</th></tr></thead><tbody><tr><td>flume</td><td align="center">1.6</td></tr><tr><td>kudu</td><td align="center">1.9</td></tr></tbody></table><blockquote><p>Kerberos</p></blockquote><p>由于flume官方没有提供对应的sink。但是kudu有提供，所以我去找了kudu的sink的jar库下来。而版本对应嘛，一开始我们使用和kudu一样的1.9版本，发现api对应不上。查阅了资料之后，选择了1.4版本。</p><p><a href="https://mvnrepository.com/artifact/org.apache.kudu/kudu-flume-sink/1.4.0?__cf_chl_captcha_tk__=7487a6e6d3af56e81833e042ecdd828beb02882a-1609912123-0-AUmmEDCceLCSAVoPRrj8gzU7DJiq0s6FDvbgtDuPNfnkQTpt6VhrByHJNPAW6OqwOUwy0Q-n6GMXMkdwYsWU3MaV8wittp6D5FDijZeJqG8TNgPpuqc3aP1HKMEpyWvRWHUt3zuktylr8P2yT1PNxi1072tE1YU0DpCJAyDsd9hXVKFgATWgSqysO-VYDm7734rOkyA_hIGFIlm_M9SmJoeKnXkVtVuYEVfvioLp_jJ-fYtJ7JXb2Flv-84qw5_CACpgSG6MQclMt-KjamTut5gPyUm_I0RhwSyMzsC07oSFq47KV0ckhsXoghJud1QsxqlSu2VNpR8IjA23bp1qIPLGmxxrQ0GEcZuCjBMUtLSkPHGzTYgjXu6Os5LMP8deUirp5OLmJ-9Jma8FSRvW5tIkQEpuHw9cUvhAqQSmONyFDTUal_War9HvzntivDc4bhsmuDc7t2spTT8_3Y6mwWUuQD8nE4qxlainXMtXIoeK_FD5O8qNFLKAdzL2cudLjlATsSjSSNMXRzlgGf73c_yieLyjHA4vgvxswnmfRgEh-tnfLVW8_U58OkahQxNs4kWVVjgPAr4lARgFeRV1FxQKYMvbrwHcnxL8RZyvMYIAPmsKF9ClFK-UyuxFKpT3ezseQWzEeTmliATFwT_ope0" target="_blank" rel="noopener">kudu-flume-sink-1.4.jar</a></p><p>需要把jar包放在 java运行程序的 <code>classpath目录下</code>，也就是 <code>-cp 参数的目录下</code>。由于不想通过修改<code>GC_OPTS</code>来指定目录，所以我选择了放在 <code>/opt/Bigdata/MRS_2.1.0/install/FusionInsight-Flume-1.6.0/flume/lib/*</code> 目录下。</p><blockquote><p>可是谁曾想最后还要是动到 <code>GC_OPTS</code>到参数配置</p></blockquote><p>还是类似的问题，目前遇到的问题几乎都是 <code>Kerberos</code> 引起的。因为以往我们并没有使用 <code>Kerberos</code> 作为身份认证。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># &#x3D;                  定义信息                       &#x3D;</span><br><span class="line"># &#x3D; 华为云Agent必填:                                &#x3D;</span><br><span class="line"># &#x3D;  - server                                       &#x3D;</span><br><span class="line"># &#x3D; Agent中存在的sources:                           &#x3D;</span><br><span class="line"># &#x3D;  - src_http_41600                               &#x3D;</span><br><span class="line"># &#x3D; Agent中存在的channels:                          &#x3D;</span><br><span class="line"># &#x3D;  - ch_kudu_table                                &#x3D;</span><br><span class="line"># &#x3D; Agent中存在的sinks:                             &#x3D;</span><br><span class="line"># &#x3D;  - sink_kudu_table                              &#x3D;</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">server.sources  &#x3D; src_http_41600</span><br><span class="line">server.channels &#x3D; ch_kudu_table</span><br><span class="line">server.sinks    &#x3D; sink_kudu_table</span><br><span class="line"></span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># &#x3D;               Http Source                       &#x3D;</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">server.sources.src_http_41600.type &#x3D; http</span><br><span class="line">server.sources.src_http_41600.port &#x3D; 41600</span><br><span class="line">server.sources.src_http_41600.channels &#x3D; ch_kudu_table</span><br><span class="line"></span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># &#x3D;               Http-Kudu&#39;s Channel               &#x3D;</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">server.channels.ch_kudu_table.type &#x3D; memory</span><br><span class="line">server.channels.ch_kudu_table.capacity &#x3D; 1000</span><br><span class="line">server.channels.ch_kudu_table.transactionCapacity &#x3D; 100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># server.sinks.sink_kudu_table.type &#x3D; logger</span><br><span class="line"># server.sinks.sink_kudu_table.channel &#x3D; ch_kudu_table</span><br><span class="line"></span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># &#x3D;                    Kudu Sink                    &#x3D;</span><br><span class="line"># &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"># 组件名，必须填写&#96;org.apache.kudu.flume.sink.KuduSink&#96;</span><br><span class="line">server.sinks.sink_kudu_table.type &#x3D; org.apache.kudu.flume.sink.KuduSink</span><br><span class="line"># 要绑定读取的channel</span><br><span class="line">server.sinks.sink_kudu_table.channel &#x3D; ch_kudu_table</span><br><span class="line">server.sinks.sink_kudu_table.masterAddresses &#x3D; node-master1rfFB,node-ana-corezDdi,node-master2RSDt</span><br><span class="line">server.sinks.sink_kudu_table.tableName &#x3D; impala::kudu_test.my_first_table</span><br></pre></td></tr></table></figure><p>测试的时候所采用的配置如上</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">omm      17051     1  0 11:31 ?        00:00:09 &#x2F;opt&#x2F;Bigdata&#x2F;jdk1.8.0_212&#x2F;&#x2F;bin&#x2F;java -XX:OnOutOfMemoryError&#x3D;bash &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;bin&#x2F;out_memory_error.sh &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc %p -Xms2G -Xmx4G -XX:CMSFullGCsBeforeCompaction&#x3D;1 -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -Djava.security.krb5.conf&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;krb5.conf -Djava.security.auth.login.config&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf -Dzookeeper.request.timeout&#x3D;120000 -Djavax.security.auth.useSubjectCredsOnly&#x3D;false -verbose:gc -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles&#x3D;10 -XX:GCLogFileSize&#x3D;1M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:&#x2F;var&#x2F;log&#x2F;Bigdata&#x2F;flume&#x2F;&#x2F;flume&#x2F;flume-omm-20210106113125-%p-gc.log -Djava.security.krb5.conf&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_5_KerberosClient&#x2F;etc&#x2F;kdc.conf -Djava.security.auth.login.config&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf -Dzookeeper.server.principal&#x3D;zookeeper&#x2F;hadoop.122451b2_394d_494b_9fca_b045f596d6d4.com -Dzookeeper.request.timeout&#x3D;120000 -Dsolrclient.token.enabled&#x3D;false -Dcom.amazonaws.sdk.disableCertChecking&#x3D;true -Dnet.sf.ehcache.skipUpdateCheck&#x3D;true -Dflume.instance.id&#x3D;1000 -Dflume.role&#x3D;server -Dlog4j.configuration.watch&#x3D;true -Dlog4j.configuration&#x3D;log4j.properties -Dflume_log_dir&#x3D;&#x2F;var&#x2F;log&#x2F;Bigdata&#x2F;flume&#x2F;&#x2F;flume&#x2F; -Dflume.monitoring.type&#x3D;http -Dflume.monitoring.port&#x3D;21150 -Dbeetle.application.home.path&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;conf&#x2F;service -Dflume.called.from.service -Dflume.conf.dir&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc -Dflume.metric.conf.dir&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;conf -Dflume.script.home&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;bin -cp &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;*:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;conf&#x2F;service&#x2F; -Djava.library.path&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;plugins.d&#x2F;native&#x2F;native org.apache.flume.node.Application --conf-file &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;properties.properties --name server</span><br></pre></td></tr></table></figure><p>启动的参数如上，其中有几个参数是我后面加的：</p><ul><li>-Djava.security.krb5.conf=/opt/Bigdata/MRS_2.1.0/1_7_Flume/etc/krb5.conf   （指定krb5的配置文件路径）</li><li>-Djava.security.auth.login.config=/opt/Bigdata/MRS_2.1.0/1_7_Flume/etc/jaas.conf (获取jass的认证配置文件路径)</li><li>-Dzookeeper.request.timeout=120000</li><li>-Djavax.security.auth.useSubjectCredsOnly=false (通过底层获取凭据)</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@node-str-coreoVpr ~]# cat &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf</span><br><span class="line">KafkaClient &#123;</span><br><span class="line">com.sun.security.auth.module.Krb5LoginModule required</span><br><span class="line">useKeyTab&#x3D;true</span><br><span class="line">keyTab&#x3D;&quot;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;user.keytab&quot;</span><br><span class="line">principal&#x3D;&quot;hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM&quot;</span><br><span class="line">storeKey&#x3D;true</span><br><span class="line">useTicketCache&#x3D;false;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Client &#123;</span><br><span class="line">com.sun.security.auth.module.Krb5LoginModule required</span><br><span class="line">storeKey&#x3D;true</span><br><span class="line">principal&#x3D;&quot;hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM&quot;</span><br><span class="line">useTicketCache&#x3D;false</span><br><span class="line">keyTab&#x3D;&quot;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;user.keytab&quot;</span><br><span class="line">debug&#x3D;true</span><br><span class="line">useKeyTab&#x3D;true;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">com.sun.security.jgss.initiate &#123;</span><br><span class="line">com.sun.security.auth.module.Krb5LoginModule required</span><br><span class="line">useKeyTab&#x3D;true</span><br><span class="line">useTicketCache&#x3D;false</span><br><span class="line">doNotPrompt&#x3D;true</span><br><span class="line">storeKey&#x3D;true</span><br><span class="line">principal&#x3D;&quot;hiveuser@122451B2_394D_494B_9FCA_B045F596D6D4.COM&quot;</span><br><span class="line">keyTab&#x3D;&quot;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;user.keytab&quot;</span><br><span class="line">debug&#x3D;true;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>由于华为云自己修改过部分组件，所以不太确定为什么凭据一直失败，所以我加了 <code>-Djavax.security.auth.useSubjectCredsOnly=false</code> 参数，这是让我们从底层去拿凭据，而默认拿的<code>section</code>部分就是 <code>com.sun.security.jgss.initiate</code><a href="https://github.com/frohoff/jdk8u-dev-jdk/blob/master/src/share/classes/sun/security/jgss/LoginConfigImpl.java#L92" target="_blank" rel="noopener">详见源码</a>,所以加上了 <code>com.sun.security.jgss.initiate</code> 之后，flume就可以连接上了kudu.</p><p>以下是我调试的时候遇到的问题。</p><ul><li><p>GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos Ticket) Cause: This may occur if no valid Kerberos credentials are obtained. In particular, this occurs if you want the underlying mechanism to obtain credentials but you forgot to indicate this by setting the javax.security.auth.useSubjectCredsOnly system property value to false (for example via -Djavax.security.auth.useSubjectCredsOnly=false in your execution command).</p></li><li><p>GSSException: No valid credentials provided (Mechanism level: Attempt to obtain new INITIATE credentials failed! (null)) . . . Caused by: javax.security.auth.login.LoginException: Clock skew too great Cause: Kerberos requires the time on the KDC and on the client to be loosely synchronized. (The default is within 5 minutes.) If that’s not the case, you will get this error.</p></li></ul><p>附上 <a href="https://docs.oracle.com/javase/7/docs/technotes/guides/security/jgss/tutorials/Troubleshooting.html" target="_blank" rel="noopener">jgss 的异常尝试解决方案官方文档</a>, PS：反正我根据文档没解决，不知道是不是华运自己修改的部分有什么潜规则。所以我才采用默认的jass配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">2021-01-06 11:31:26,235 | INFO  | [lifecycleSupervisor-1-0] |  Configuration provider starting  | org.apache.flume.node.PollingPropertiesFileConfigurationProvider.start(PollingPropertiesFileConfigurationProvider.java:61)</span><br><span class="line">2021-01-06 11:31:26,239 | INFO  | [conf-file-poller-0] |  Reloading configuration file:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;properties.properties  | org.apache.flume.node.PollingPropertiesFileConfigurationProvider$FileWatcherR</span><br><span class="line">unnable.run(PollingPropertiesFileConfigurationProvider.java:133)</span><br><span class="line">2021-01-06 11:31:26,236 | INFO  | [main] |  starting taskCounter  | org.apache.flume.tools.FlumeMetricsMgr.start(FlumeMetricsMgr.java:230)</span><br><span class="line">2021-01-06 11:31:26,250 | INFO  | [conf-file-poller-0] |  Processing:sink_kudu_table  | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)</span><br><span class="line">2021-01-06 11:31:26,250 | INFO  | [conf-file-poller-0] |  Processing:sink_kudu_table  | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)</span><br><span class="line">2021-01-06 11:31:26,250 | INFO  | [conf-file-poller-0] |  Processing:sink_kudu_table  | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)</span><br><span class="line">2021-01-06 11:31:26,251 | INFO  | [conf-file-poller-0] |  Processing:sink_kudu_table  | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:1017)</span><br><span class="line">2021-01-06 11:31:26,251 | INFO  | [conf-file-poller-0] |  Added sinks: sink_kudu_table Agent: server  | org.apache.flume.conf.FlumeConfiguration$AgentConfiguration.addProperty(FlumeConfiguration.java:931)</span><br><span class="line">2021-01-06 11:31:26,262 | INFO  | [conf-file-poller-0] |  Post-validation flume configuration contains configuration for agents: [server]  | org.apache.flume.conf.FlumeConfiguration.validateConfiguration(FlumeConfiguration.java:141)</span><br><span class="line">2021-01-06 11:31:26,263 | INFO  | [conf-file-poller-0] |  Creating channels  | org.apache.flume.node.AbstractConfigurationProvider.loadChannels(AbstractConfigurationProvider.java:155)</span><br><span class="line">2021-01-06 11:31:26,270 | INFO  | [conf-file-poller-0] |  Creating instance of channel ch_kudu_table type memory  | org.apache.flume.channel.DefaultChannelFactory.create(DefaultChannelFactory.java:42)</span><br><span class="line">2021-01-06 11:31:26,274 | INFO  | [conf-file-poller-0] |  Created channel ch_kudu_table  | org.apache.flume.node.AbstractConfigurationProvider.loadChannels(AbstractConfigurationProvider.java:210)</span><br><span class="line">2021-01-06 11:31:26,274 | INFO  | [conf-file-poller-0] |  Creating instance of source src_http_41600, type http  | org.apache.flume.source.DefaultSourceFactory.create(DefaultSourceFactory.java:41)</span><br><span class="line">2021-01-06 11:31:26,289 | INFO  | [main] |  Monitored counter group for type: OTHER, name: taskcount: Successfully registered new MBean.  | org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:132)</span><br><span class="line">2021-01-06 11:31:26,290 | INFO  | [main] |  Component type: OTHER, name: taskcount started  | org.apache.flume.instrumentation.MonitoredCounterGroup.start(MonitoredCounterGroup.java:105)</span><br><span class="line">2021-01-06 11:31:26,323 | INFO  | [conf-file-poller-0] |  Creating instance of sink: sink_kudu_table, type: org.apache.kudu.flume.sink.KuduSink  | org.apache.flume.sink.DefaultSinkFactory.create(DefaultSinkFactory.java:42)</span><br><span class="line">2021-01-06 11:31:26,328 | WARN  | [conf-file-poller-0] |  No Kudu operations producer provided, using default  | org.apache.kudu.flume.sink.KuduSink.configure(KuduSink.java:202)</span><br><span class="line">2021-01-06 11:31:26,330 | INFO  | [conf-file-poller-0] |  Channel ch_kudu_table connected to [src_http_41600, sink_kudu_table]  | org.apache.flume.node.AbstractConfigurationProvider.getConfiguration(AbstractConfigurationProvider.java:124)</span><br><span class="line">2021-01-06 11:31:26,413 | INFO  | [main] |  ServiceServer started (at port[21151])  | org.wcc.framework.business.service.server.ServiceServer.start(ServiceServer.java:260)</span><br><span class="line">2021-01-06 11:31:26,413 | INFO  | [main] |  flume meric server startred ip:192.168.0.222,port:21151.  | org.apache.flume.tools.FlumeMetricsMgr.initMetricsRpcServer(FlumeMetricsMgr.java:84)</span><br><span class="line">2021-01-06 11:31:26,413 | INFO  | [main] |  current role is server  | org.apache.flume.tools.FlumeMetricsMgr.start(FlumeMetricsMgr.java:237)</span><br><span class="line">2021-01-06 11:31:26,429 | INFO  | [main] |  Logging to org.slf4j.impl.Log4jLoggerAdapter(org.mortbay.log) via org.mortbay.log.Slf4jLog  | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)</span><br><span class="line">2021-01-06 11:31:26,430 | INFO  | [main] |  jetty-6.1.26  | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)</span><br><span class="line">2021-01-06 11:31:26,441 | INFO  | [main] |  Started SelectChannelConnector@localhost:21150  | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)</span><br><span class="line">2021-01-06 11:31:26,442 | INFO  | [main] |  starting compment mon  | org.apache.flume.node.Application.startCompMon(Application.java:543)</span><br><span class="line">2021-01-06 11:31:26,443 | INFO  | [main] |  started compment mon success  | org.apache.flume.node.Application.startCompMon(Application.java:582)</span><br><span class="line">2021-01-06 11:31:26,443 | INFO  | [main] |  log4j dynamic load is start.  | org.apache.flume.tools.LogDynamicLoad.start(LogDynamicLoad.java:59)</span><br><span class="line">2021-01-06 11:31:26,444 | INFO  | [conf-file-poller-0] |  stopping compment mon  | org.apache.flume.node.Application.stopCompMon(Application.java:587)</span><br><span class="line">2021-01-06 11:31:26,444 | INFO  | [conf-file-poller-0] |  stopped compment mon success  | org.apache.flume.node.Application.stopCompMon(Application.java:608)</span><br><span class="line">2021-01-06 11:31:26,444 | INFO  | [conf-file-poller-0] |  Starting new configuration:&#123; sourceRunners:&#123;src_http_41600&#x3D;EventDrivenSourceRunner: &#123; source:org.apache.flume.source.http.HTTPSource&#123;name:src_http_41600,state:IDLE&#125; &#125;&#125; sinkRunners:&#123;sink_kudu_table&#x3D;SinkRunner: &#123; policy:org.apache.flume.sink.DefaultSinkProcessor@1e1f84ee counterGroup:&#123; name:null counters:&#123;&#125; &#125; &#125;&#125; channels:&#123;ch_kudu_table&#x3D;org.apache.flume.channel.MemoryChannel&#123;name: ch_kudu_table&#125;&#125; &#125;  | org.apache.flume.node.Application.startAllComponents(Application.java:206)</span><br><span class="line">2021-01-06 11:31:26,498 | INFO  | [conf-file-poller-0] |  current role is server  | org.apache.flume.tools.FlumeSendAlarmMgr.start(FlumeSendAlarmMgr.java:173)</span><br><span class="line">2021-01-06 11:31:26,505 | INFO  | [conf-file-poller-0] |  Starting Channel ch_kudu_table  | org.apache.flume.node.Application.startAllComponents(Application.java:217)</span><br><span class="line">2021-01-06 11:31:26,508 | INFO  | [lifecycleSupervisor-1-0] |  Monitored counter group for type: CHANNEL, name: ch_kudu_table: Successfully registered new MBean.  | org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:132)</span><br><span class="line">2021-01-06 11:31:26,508 | INFO  | [lifecycleSupervisor-1-0] |  Component type: CHANNEL, name: ch_kudu_table started  | org.apache.flume.instrumentation.MonitoredCounterGroup.start(MonitoredCounterGroup.java:105)</span><br><span class="line">2021-01-06 11:31:26,508 | INFO  | [conf-file-poller-0] |  Starting Sink sink_kudu_table  | org.apache.flume.node.Application.startAllComponents(Application.java:245)</span><br><span class="line">2021-01-06 11:31:26,508 | INFO  | [conf-file-poller-0] |  Starting Source src_http_41600  | org.apache.flume.node.Application.startAllComponents(Application.java:256)</span><br><span class="line">2021-01-06 11:31:26,510 | INFO  | [conf-file-poller-0] |  Begin start init plugins.  | com.huawei.flume.PluginManager.PluginManager.&lt;init&gt;(PluginManager.java:39)</span><br><span class="line">2021-01-06 11:31:26,510 | INFO  | [conf-file-poller-0] |  Set plugins configuration file dir successful.  | com.huawei.flume.PluginManager.PluginManager.&lt;init&gt;(PluginManager.java:46)</span><br><span class="line">2021-01-06 11:31:26,511 | INFO  | [conf-file-poller-0] |  Reading monitor server configuration from: &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;flume-check.properties  | com.huawei.flume.configuration.AbstractPluginsConfiguration.loadConfig(AbstractPluginsConfiguration.java:75)</span><br><span class="line">2021-01-06 11:31:26,517 | WARN  | [conf-file-poller-0] |  Needn&#39;t to create PluginsManager, plugins is empty.  | com.huawei.flume.PluginManager.PluginManager.&lt;init&gt;(PluginManager.java:55)</span><br><span class="line">2021-01-06 11:31:26,517 | WARN  | [conf-file-poller-0] |  Have not set any plugins  | com.huawei.flume.PluginManager.PluginManager.start(PluginManager.java:98)</span><br><span class="line">2021-01-06 11:31:26,517 | INFO  | [conf-file-poller-0] |  starting compment mon  | org.apache.flume.node.Application.startCompMon(Application.java:543)</span><br><span class="line">2021-01-06 11:31:26,517 | INFO  | [conf-file-poller-0] |  started compment mon success  | org.apache.flume.node.Application.startCompMon(Application.java:582)</span><br><span class="line">2021-01-06 11:31:26,542 | INFO  | [lifecycleSupervisor-1-0] |  jetty-6.1.26  | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)</span><br><span class="line">2021-01-06 11:31:26,577 | INFO  | [lifecycleSupervisor-1-0] |  Started SelectChannelConnector@0.0.0.0:41600  | org.mortbay.log.Slf4jLog.info(Slf4jLog.java:67)</span><br><span class="line">2021-01-06 11:31:26,578 | INFO  | [lifecycleSupervisor-1-0] |  Monitored counter group for type: SOURCE, name: src_http_41600: Successfully registered new MBean.  | org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:132)</span><br><span class="line">2021-01-06 11:31:26,578 | INFO  | [lifecycleSupervisor-1-0] |  Component type: SOURCE, name: src_http_41600 started  | org.apache.flume.instrumentation.MonitoredCounterGroup.start(MonitoredCounterGroup.java:105)</span><br><span class="line">2021-01-06 11:31:27,187 | INFO  | [lifecycleSupervisor-1-3] |  Monitored counter group for type: SINK, name: sink_kudu_table: Successfully registered new MBean.  | org.apache.flume.instrumentation.MonitoredCounterGroup.register(MonitoredCounterGroup.java:132)</span><br></pre></td></tr></table></figure><p>可以看到，sink启动成功。</p><p>记录几个需要用到的命令：</p><h3 id="同步kudu-flume-sink到各flume节点"><a href="#同步kudu-flume-sink到各flume节点" class="headerlink" title="同步kudu-flume-sink到各flume节点"></a>同步kudu-flume-sink到各flume节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str_nodes&#x3D;&quot;node-str-corelgoh node-str-corenydJ node-str-coreoVpr&quot;;for ip in $(echo $&#123;str_nodes&#125;);do scp &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;kudu-flume-sink-1.4.0.jar $&#123;ip&#125;:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;;ssh $&#123;ip&#125; &#39;chmod 751 &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;kudu-flume-sink-1.4.0.jar &amp;&amp; chown omm:ficommon &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;install&#x2F;FusionInsight-Flume-1.6.0&#x2F;flume&#x2F;lib&#x2F;kudu-flume-sink-1.4.0.jar&#39;;done</span><br></pre></td></tr></table></figure><h3 id="修改对应的jass配置-和-凭据信息同步"><a href="#修改对应的jass配置-和-凭据信息同步" class="headerlink" title="修改对应的jass配置 和 凭据信息同步"></a>修改对应的jass配置 和 凭据信息同步</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str_nodes&#x3D;&quot;node-str-corelgoh node-str-corenydJ node-str-coreoVpr&quot;;for ip in $(echo $&#123;str_nodes&#125;);do scp &#x2F;tmp&#x2F;krb5.conf $&#123;ip&#125;:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;; scp &#x2F;tmp&#x2F;user.keytab $&#123;ip&#125;:&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;;ssh $&#123;ip&#125; &quot;sed -i -e &#39;&#x2F;principal&#x2F;s&#x2F;flume&#x2F;hiveuser&#x2F;g&#39; -e &#39;&#x2F;keyTab&#x2F;s&#x2F;\&#x2F;opt\&#x2F;Bigdata\&#x2F;MRS_2.1.0\&#x2F;install\&#x2F;FusionInsight-Flume-1.6.0\&#x2F;flume\&#x2F;conf\&#x2F;flume.keytab&#x2F;\&#x2F;opt\&#x2F;Bigdata\&#x2F;MRS_2.1.0\&#x2F;1_7_Flume\&#x2F;etc\&#x2F;user.keytab&#x2F;g&#39;  -e &#39;&#x2F;^Client&#x2F;s&#x2F;Client&#x2F;com.sun.security.jgss.initiate&#x2F;g&#39; &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf;chown omm:wheel &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf;chown -R omm:wheel &#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;&quot;;done</span><br></pre></td></tr></table></figure><h2 id="这个不是命令，但是是记得最新的GC-OPTS参数"><a href="#这个不是命令，但是是记得最新的GC-OPTS参数" class="headerlink" title="这个不是命令，但是是记得最新的GC_OPTS参数"></a>这个不是命令，但是是记得最新的GC_OPTS参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Xms2G -Xmx4G -XX:CMSFullGCsBeforeCompaction&#x3D;1 -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -Djava.security.krb5.conf&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;krb5.conf -Djava.security.auth.login.config&#x3D;&#x2F;opt&#x2F;Bigdata&#x2F;MRS_2.1.0&#x2F;1_7_Flume&#x2F;etc&#x2F;jaas.conf -Dzookeeper.request.timeout&#x3D;120000</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;由于我们在调研是否让自建IDC大数据机房上云服务，所以华为云进行一下测试。&lt;/p&gt;
    
    </summary>
    
    
      <category term="大数据" scheme="http://blog.crazylaw.cn/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
      <category term="大数据" scheme="http://blog.crazylaw.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
      <category term="flume" scheme="http://blog.crazylaw.cn/tags/flume/"/>
    
      <category term="kudu" scheme="http://blog.crazylaw.cn/tags/kudu/"/>
    
  </entry>
  
  <entry>
    <title>【数据库开发知识】Rocksdb</title>
    <link href="http://blog.crazylaw.cn/2020/12/29/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/Rocksdb/"/>
    <id>http://blog.crazylaw.cn/2020/12/29/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/Rocksdb/</id>
    <published>2020-12-29T03:16:43.000Z</published>
    <updated>2021-03-20T16:25:01.817Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前沿"><a href="#前沿" class="headerlink" title="前沿"></a>前沿</h1><p>近日工作中使用了 RocksDB。RocksDB 的优点此处无需多说，它的一个 feature 是其有很多优化选项用于对 RocksDB 进行调优。欲熟悉这些参数，必须对其背后的原理有所了解，本文主要整理一些 RocksDB 的 wiki 文档，以备自己参考之用。</p><a id="more"></a><h3 id="1-Basic-Operations"><a href="#1-Basic-Operations" class="headerlink" title="1 Basic Operations"></a>1 <a href="https://github.com/facebook/rocksdb/wiki/Basic-Operations" target="_blank" rel="noopener">Basic Operations</a></h3><hr><p>先介绍一些 RocksDB 的基本操作和基本架构。</p><h4 id="1-1-LSM-与-WriteBatch"><a href="#1-1-LSM-与-WriteBatch" class="headerlink" title="1.1 LSM 与 WriteBatch"></a>1.1 LSM 与 WriteBatch</h4><hr><p><a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Basics" target="_blank" rel="noopener">参考文档5</a>提到RocksDB 是一个快速存储系统，它会充分挖掘 Flash or RAM 硬件的读写特性，支持单个 KV 的读写以及批量读写。RocksDB 自身采用的一些数据结构如 LSM/SKIPLIST 等结构使得其有读放大、写放大和空间使用放大的问题。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/log_structured_merge_tree.png" alt=""></p><p>LSM 大致结构如上图所示。LSM 树而且通过批量存储技术规避磁盘随机写入问题。 LSM 树的设计思想非常朴素, 它的原理是把一颗大树拆分成N棵小树， 它首先写入到内存中（内存没有寻道速度的问题，随机写的性能得到大幅提升），在内存中构建一颗有序小树，随着小树越来越大，内存的小树会flush到磁盘上。磁盘中的树定期可以做 merge 操作，合并成一棵大树，以优化读性能【读数据的过程可能需要从内存 memtable 到磁盘 sstfile 读取多次，称之为读放大】。RocksDB 的 LSM 体现在多 level 文件格式上，最热最新的数据尽在 L0 层，数据在内存中，最冷最老的数据尽在 LN 层，数据在磁盘或者固态盘上。RocksDB 还有一种日志文件叫做 manifest，用于记录对 sstfile 的更改，可以认为是 RocksDB 的 GIF，后面将会详述。</p><p>LSM-Tree(Log-Structured-Merge-Tree)<br>LSM从命名上看，容易望文生义成一个具体的数据结构，一个tree。但LSM并不是一个具体的数据结构，也不是一个tree。LSM是一个数据结构的概念，是一个数据结构的设计思想。实际上，要是给LSM的命名断句，Log和Structured这两个词是合并在一起的，LSM-Tree应该断句成Log-Structured、Merge、Tree三个词汇，这三个词汇分别对应以下三点LSM的关键性质：</p><ul><li>将数据形成Log-Structured：在将数据写入LSM内存结构之前，先记录log。这样LSM就可以将有易失性的内存看做永久性存储器。并且信任内存上的数据，等到内存容量达到threshold再集体写入磁盘。将数据形成Log-Structured，也是将整体存储结构转换成了“内存(in-memory)”存储结构。</li><li>将所有磁盘上数据不组织成一个整体索引结构，而组织成有序的文件集：因为磁盘随机读写比顺序读写慢3个数量级，LSM尽量将磁盘读写转换成顺序读写。将磁盘上的数据组织成B树这样的一个整体索引结构，虽然查找很高效，但是面对随机读写，由于大量寻道导致其性能不佳。而LSM用了一种很有趣的方法，将所有数据不组织成一个整体索引结构，而组织成有序的文件集。每次LSM面对磁盘写，将数据写入一个或几个新生成的文件，顺序写入且不能修改其他文件，这样就将随机读写转换成了顺序读写。LSM将一次性集体写入的文件作为一个level，磁盘上划分多level，level与level之间互相隔离。这就形成了，以写入数据时间线形成的逻辑上、而非物理上的层级结构，这也就是为什么LSM被命名为”tree“，但不是“tree”。</li><li>将数据按key排序，在合并不同file、level上的数据时类似merge-join：如果一直保持生成新的文件，不仅写入会造成冗余空间，而且也会大量降低读的性能。所以要高效的、周期性合并不同file、level。而如果数据是乱序的，根本做不到高效合并。所以LSM要将数据按key排序，在合并不同file、level上的数据时类似 merge-join。</li></ul><p>很明显，LSM牺牲了一部分读的性能和增加了合并的开销，换取了高效的写性能。那LSM为什么要这么做？实际上，这就关系到对于磁盘写已经没有什么优化手段了，而对于磁盘读，不论硬件还是软件上都有优化的空间。通过多种优化后，读性能虽然仍是下降，但可以控制在可接受范围内。实际上，用于磁盘上的数据结构不同于用于内存上的数据结构，用于内存上的数据结构性能的瓶颈就在搜索复杂度，而用于磁盘上的数据结构性能的瓶颈在磁盘IO，甚至是磁盘IO的模式。</p><p>以上三段摘抄自<a href="https://www.tuicool.com/articles/7ju2UfI" target="_blank" rel="noopener">参考文档20</a>。个人以为，除了将随机写合并之后转化为顺写之外，LSM 的另外一个关键特性就在于其是一种自带数据 Garbage Collect 的有序数据集合，对外只提供了 Add/Get 接口，其内部的 Compaction 就是其 GC 的关键，通过 Compaction 实现了对数据的删除、附带了 TTL 的过期数据地淘汰、同一个 Key 的多个版本 Value 地合并。RocksDB 基于 LSM 对外提供了 Add/Delete/Get 三个接口，用户则基于 RocksDB 提供的 transaction 还可以实现 Update 语义。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_arch.png" alt=""></p><p>RocksDB的三种基本文件格式是 memtable/sstfile/logfile，memtable 是一种内存文件数据系统，新写数据会被写进 memtable，部分请求内容会被写进 logfile。logfile 是一种有利于顺序写的文件系统。memtable 的内存空间被填满之后，会有一部分老数据被转移到 sstfile 里面，这些数据对应的 logfile 里的 log 就会被安全删除。sstfile 中的内容是有序的。</p><p>上图所示，所有 Column Family 共享一个 WAL 文件，但是每个 Column Family 有自己单独的 memtable &amp; ssttable(sstfile)，即 log 共享而数据分离。</p><p>一个进程对一个 DB 同时只能创建一个 rocksdb::DB 对象，所有线程共享之。这个对象内部有锁机制保证访问安全，多个线程同时进行 Get/Put/Fetch Iteration 都没有问题，但是如果直接 Iteration 或者 WriteBatch 则需要额外的锁同步机制保护 Iterator 或者 WriteBatch 对象。</p><p>基于 RocksDB 设计存储系统，要考虑到应用场景进行各种 tradeoff 设置相关参数。譬如，如果 RocksDB 进行 compaction 比较频繁，虽然有利于空间和读，但是会造成读放大；compaction 过低则会造成读放大和空间放大；增大每个 level 的 comparession 难度可以减小空间放大，但是会增加 cpu 负担，是运算时间增加换取使用空间减小；增大 SSTfile 的 data block size，则是增大内存使用量来加快读取数据的速度，减小读放大。</p><p>单独的 Get/Put/Delete 是原子操作，要么成功要么失败，不存在中间状态。</p><p>如果需要进行批量的 Get/Put/Delete 操作且需要操作保持原子属性，则可以使用 WriteBatch。</p><p>WriteBatch 还有一个好处是保持加快吞吐率。</p><h4 id="1-2-同步写-与-异步写"><a href="#1-2-同步写-与-异步写" class="headerlink" title="1.2 同步写 与 异步写"></a>1.2 同步写 与 异步写</h4><hr><p>默认情况下，RocksDB 的写是异步的：仅仅把数据写进了操作系统的缓存区就返回了，而这些数据被写进磁盘是一个异步的过程。如果为了数据安全，可以用如下代码把写过程改为同步写：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rocksdb::WriteOptions write_options;   </span><br><span class="line">write_options.sync = <span class="literal">true</span>;   </span><br><span class="line">db-&gt;Put(write_options, …);</span><br></pre></td></tr></table></figure><p>这个选项会启用 Posix 系统的 <code>fsync(...) or fdatasync(...) or msync(..., MS_SYNC)</code> 等函数。</p><p><font color=red> 异步写的吞吐率是同步写的一千多倍。异步写的缺点是机器或者操作系统崩溃时可能丢掉最近一批写请求发出的由操作系统缓存的数据，但是 RocksDB 自身崩溃并不会导致数据丢失。而机器或者操作系统崩溃的概率比较低，所以大部分情况下可以认为异步写是安全的。</font></p><p>RocksDB 由于有 WAL 机制保证，所以即使崩溃，其重启后会进行写重放保证数据一致性。如果不在乎数据安全性，可以把 <code>write_option.disableWAL</code> 设置为 true，加快写吞吐率。</p><p>RocksDB 调用 Posix API <code>fdatasync()</code> 对数据进行异步写。如果想用 <code>fsync()</code> 进行同步写，可以设置 <code>Options::use_fsync</code> 为 true。</p><h4 id="1-3-Snapshots"><a href="#1-3-Snapshots" class="headerlink" title="1.3 Snapshots"></a>1.3 Snapshots</h4><hr><p>RocksDB 能够保存某个版本的所有数据（可称之为一个 Snapshot）以方便读取操作，创建并读取 Snapshot 方法如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rocksdb::ReadOptions options;   </span><br><span class="line">options.snapshot = db-&gt;GetSnapshot();   </span><br><span class="line">… apply some updates to db ….  </span><br><span class="line">rocksdb::Iterator* iter = db-&gt;NewIterator(options);   </span><br><span class="line">… <span class="built_in">read</span> <span class="keyword">using</span> iter to view the state when the snapshot was created ….  </span><br><span class="line"><span class="keyword">delete</span> iter;   </span><br><span class="line">db-&gt;ReleaseSnapshot(options.snapshot);</span><br></pre></td></tr></table></figure><p>如果 ReadOptions::snapshot 为 null，则读取的 snapshot 为 RocksDB 当前版本数据的 snapshot。</p><h4 id="1-4-Slice-amp-PinnableSlice"><a href="#1-4-Slice-amp-PinnableSlice" class="headerlink" title="1.4 Slice &amp; PinnableSlice"></a>1.4 Slice &amp; PinnableSlice</h4><hr><p>不管是 <code>it-&gt;key()</code> 还是 <code>it-&gt;value()</code>，其值类型都是 <code>rocksdb::Slice</code>。 Slice 自身由一个长度字段[ size_t size_ ]以及一个指向外部一个内存区域的指针[ const char* data_ ]构成，返回 Slice 比返回一个 string 廉价，并不存在内存拷贝的问题。RocksDB 自身会给 key 和 value 添加一个 C-style 的 ‘\0’，所以 slice 的指针指向的内存区域自身作为字符串输出没有问题。</p><p>Slice 与 string 之间的转换代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rocksdb::Slice s1 = “hello”;</span><br><span class="line"><span class="function"><span class="built_in">std</span>::<span class="built_in">string</span> <span class="title">str</span><span class="params">(“world”)</span></span>;</span><br><span class="line">rocksdb::Slice s2 = str;</span><br><span class="line"></span><br><span class="line">OR:   </span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> str = s1.ToString();   </span><br><span class="line">assert(str == <span class="built_in">std</span>::<span class="built_in">string</span>(“hello”));</span><br></pre></td></tr></table></figure><p>但是请注意 Slice 的安全性，有代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rocksdb::Slice slice;   </span><br><span class="line"><span class="keyword">if</span> (…) &#123;  </span><br><span class="line"> <span class="built_in">std</span>::<span class="built_in">string</span> str = …;   </span><br><span class="line"> slice = str;   </span><br><span class="line">&#125;  </span><br><span class="line">Use(slice);</span><br></pre></td></tr></table></figure><p>当退出 if 语句块后，slice 内部指针指向的内存区域已经不存在，此时再使用导致程序出问题。</p><p>Slice 自身虽然能够减少内存拷贝，但是在离开相应的 scope 之后，其值就会被释放，rocksdb v5.4.5 版本引入一个 PinnableSlice，其继承自 Slice，可替换之前 Get 接口的出参：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Status <span class="title">Get</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; options,</span></span></span><br><span class="line"><span class="function"><span class="params">                     ColumnFamilyHandle* column_family, <span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="built_in">std</span>::<span class="built_in">string</span>* value)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> Status <span class="title">Get</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; options,</span></span></span><br><span class="line"><span class="function"><span class="params">                     ColumnFamilyHandle* column_family, <span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="function"><span class="params">                     PinnableSlice* value)</span></span></span><br></pre></td></tr></table></figure><p>这里的 PinnableSlice 如同 Slice 一样可以减少内存拷贝，提高读性能，但是 PinnableSlice 内部有一个引用计数功能，可以实现数据内存的延迟释放，延长相关数据的生命周期，相关详细分析详见 <a href="https://zhuanlan.zhihu.com/p/30807728" target="_blank" rel="noopener">参考文档15</a>。</p><p><a href="https://rocksdb.org/blog/2017/08/24/pinnableslice.html" target="_blank" rel="noopener">参考文档16</a> 提到 <code>PinnableSlice, as its name suggests, has the data pinned in memory. The pinned data are released when PinnableSlice object is destructed or when ::Reset is invoked explicitly on it.</code>。所谓的 <strong>pinned in memory</strong> 即为引用计数之意，文中提到内存数据释放是在 PinnableSlice 析构或者调用 ::Reset 之后。</p><p>用户也可以把一个 std::string 对象作为 PinnableSlice 构造函数的参数， 把这个 std::string 指定为 PinnableSlice 的初始内部 buffer [ rocksdb/slice.h:PinnableSlice::buf_ ]，使用方法可以参考 <a href="https://github.com/facebook/rocksdb/blob/9e583711144f580390ce21a49a8ceacca338fcd5/include/rocksdb/db.h#L314" target="_blank" rel="noopener">用新 Get 实现的旧版本的 Get</a>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">inline</span> Status <span class="title">Get</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; options,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ColumnFamilyHandle* column_family, <span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="built_in">std</span>::<span class="built_in">string</span>* value)</span> </span>&#123;</span><br><span class="line">   assert(value != <span class="literal">nullptr</span>);</span><br><span class="line">   <span class="function">PinnableSlice <span class="title">pinnable_val</span><span class="params">(value)</span></span>;</span><br><span class="line">   assert(!pinnable_val.IsPinned());</span><br><span class="line">   <span class="keyword">auto</span> s = Get(options, column_family, key, &amp;pinnable_val);</span><br><span class="line">   <span class="keyword">if</span> (s.ok() &amp;&amp; pinnable_val.IsPinned()) &#123;</span><br><span class="line">     value-&gt;assign(pinnable_val.data(), pinnable_val.<span class="built_in">size</span>());</span><br><span class="line">   &#125;  <span class="comment">// else value is already assigned</span></span><br><span class="line">   <span class="keyword">return</span> s;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>通过 rocksdb/slice.h:PinnableSlice::PinSlice 实现代码可以看出，只有在这个函数里 PinnableSlice::pinned_ 被赋值为 true， 同时内存区域存放在 PinnableSlice::data_ 指向的内存区域，故而 PinnableSlice::IsPinned 为 true，则 内部 buffer [ rocksdb/slice.h:PinnableSlice::buf_ ] 必定为空。</p><p>具体的编程用例可参考 <a href="https://github.com/alexstocks/c-practice/blob/master/db/rocksdb/src/pinnalble_slice.cc" target="_blank" rel="noopener">pinnalble_slice.cc</a>。</p><h4 id="1-5-Transactions"><a href="#1-5-Transactions" class="headerlink" title="1.5 Transactions"></a>1.5 Transactions</h4><hr><p>当使用 TransactionDB 或者 OptimisticTransactionDB 的时候，可以使用 RocksDB 的 BEGIN/COMMIT/ROLLBACK 等事务 API。RocksDB 支持活锁或者死等两种事务。</p><p>WriteBatch 默认使用了事务，确保批量写成功。</p><p>当打开一个 TransactionDB 的时候，如果 RocksDB 检测到某个 key 已经被别的事务锁住，则 RocksDB 会返回一个 error。如果打开成功，则所有相关 key 都会被 lock 住，直到事务结束。TransactionDB 的并发特性表现要比 OptimisticTransactionDB 好，但是 TransactionDB 的一个小问题就是不管写发生在事务里或者事务外，他都会进行写冲突检测。TransactionDB 使用示例代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TransactionDB* txn_db;</span><br><span class="line">Status s = TransactionDB::Open(options, path, &amp;txn_db);</span><br><span class="line">Transaction* txn = txn_db-&gt;BeginTransaction(write_options, txn_options);</span><br><span class="line">s = txn-&gt;Put(“key”, “value”);</span><br><span class="line">s = txn-&gt;Delete(“key2”);</span><br><span class="line">s = txn-&gt;Merge(“key3”, “value”);</span><br><span class="line">s = txn-&gt;Commit();</span><br><span class="line"><span class="keyword">delete</span> txn;</span><br></pre></td></tr></table></figure><p>OptimisticTransactionDB 提供了一个更轻量的事务实现，它在进行写之前不会进行写冲突检测，当对写操作进行 commit 的时候如果发生了 lock 冲突导致写操作失败，则 RocksDB 会返回一个 error。这种事务使用了活锁策略，适用于读多写少这种写冲突概率比较低的场景下，使用示例代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DB* db;</span><br><span class="line">OptimisticTransactionDB* txn_db;</span><br><span class="line">Status s = OptimisticTransactionDB::Open(options, path, &amp;txn_db);</span><br><span class="line">db = txn_db-&gt;GetBaseDB();</span><br><span class="line"></span><br><span class="line">OptimisticTransaction* txn = txn_db-&gt;BeginTransaction(write_options, txn_options);</span><br><span class="line">txn-&gt;Put(“key”, “value”);</span><br><span class="line">txn-&gt;Delete(“key2”);</span><br><span class="line">txn-&gt;Merge(“key3”, “value”);</span><br><span class="line">s = txn-&gt;Commit();</span><br><span class="line"><span class="keyword">delete</span> txn;</span><br></pre></td></tr></table></figure><p>参考文档 6 详细描述了 <code>RocksDB</code> 的 Transactions。</p><h4 id="1-6-Column-Family"><a href="#1-6-Column-Family" class="headerlink" title="1.6 Column Family"></a>1.6 Column Family</h4><hr><p>CF 提供了对 DB 进行逻辑划分开来的方法，用户可以通过 CF 同时对多个 CF 的 KV 进行并行读写的方法，提高了并行度。</p><h4 id="1-7-MemTable-and-Table-factories"><a href="#1-7-MemTable-and-Table-factories" class="headerlink" title="1.7 MemTable and Table factories"></a>1.7 MemTable and Table factories</h4><hr><p>RocksDB 内存中的数据格式是 skiplist，磁盘则是以 table 形式存储的 SST 文件格式。</p><p>table 格式有两种：继承自 leveldb 的文件格式【详见参考文档2】和 PlainTable 格式【详见参考文档3】。PlainTable 格式是针对 低查询延迟 或者低延迟存储媒介如 SSD 特别别优化的一种文件格式。</p><h4 id="1-8-Block-size"><a href="#1-8-Block-size" class="headerlink" title="1.8 Block size"></a>1.8 Block size</h4><hr><p>RocksDB 把相邻的 key 放到同一个 block 中，block 是数据存储和传递的基本单元。默认 Block 的大小是 4096B，数据未经压缩。</p><p>经常进行 bulk scan 操作的用户可能希望增大 block size，而经常进行单 key 读写的用户则可能希望减小其值，官方建议这个值减小不要低于 1KB 的下限，变大也不要超过 <code>a few megabytes</code>。启用压缩也可以起到增大 block size 的好处。</p><p>修改 Block size 的方法是修改 <code>Options::block_size</code>。</p><h4 id="1-9-Writer-Buffer"><a href="#1-9-Writer-Buffer" class="headerlink" title="1.9 Writer Buffer"></a>1.9 Writer Buffer</h4><hr><p><code>Options::write_buffer_size</code> 指定了一个写内存 buffer 的大小，当这个 buffer 写满之后数据会被固化到磁盘上。这个值越大批量写入的性能越好。</p><p>RocksDB 控制写内存 buffer 数目的参数是 <code>Options::max_write_buffer_number</code>。这个值默认是 2，当一个 buffer 的数据被 flush 到磁盘上的时候，RocksDB 就用另一个 buffer 作为数据读写缓冲区。</p><p>‘Options::min_write_buffer_number_to_merge’ 设定了把写 buffer 的数据固化到磁盘上时对多少个 buffer 的数据进行合并然后再固化到磁盘上。这个值如果为 1，则 L0 层文件只有一个，这会导致读放大，这个值太小会导致数据固化到磁盘上之前数据去重效果太差劲。</p><p>这两个值并不是越大越好，太大会延迟一个 DB 被重新打开时的数据加载时间。</p><h4 id="1-10-Key-Layout"><a href="#1-10-Key-Layout" class="headerlink" title="1.10 Key Layout"></a>1.10 Key Layout</h4><hr><p>在 <strong>1.8</strong> 章节里提到 “block 是数据存储和传递的基本单元”，RocksDB 的数据是一个 range 的 key-value 构成一个 Region，根据局部性原理每次访问一个 Region 的 key 的时候，有很多概率会访问其相邻的 key，每个 Region 的 keys 放在一个 block 里，多个 Region 的 keys 放在多个 block 里。</p><p>下面以文件系统作为类比，详细解释下 RocksDB 的文件系统：<br>​<br>​    filename -&gt; permission-bits, length, list of file_block_ids<br>​    file_block_id -&gt; data</p><p>以多个维度组织 key 的时候，我们可能希望 filename 的前缀都是 ‘/‘， 而 file_block_id 的前缀都是 ‘0’，这样可以把他们分别放在不同的 block 里，以方便快速查询。</p><h4 id="1-11-Checksums"><a href="#1-11-Checksums" class="headerlink" title="1.11 Checksums"></a>1.11 Checksums</h4><hr><p>Rocksdb 对每个 kv 以及整体数据文件都分别计算了 checksum，以进行数据正确性校验。下面有两个选项对 checksum 的行为进行控制。</p><ul><li><code>ReadOptions::verify_checksums</code> 强制对每次从磁盘读取的数据进行校验，这个选项默认为 true。</li><li><code>Options::paranoid_checks</code> 这个选项为 true 的时候，如果 RocksDB 打开一个数据检测到内部数据部分错乱，马上抛出一个错误。这个选择默认为 false。</li></ul><p>如果 RocksDB 的数据错乱，RocksDB 会尽量把它隔离出来，保证大部分数据的可用性和正确性。</p><h4 id="1-12-Approximate-Sizes"><a href="#1-12-Approximate-Sizes" class="headerlink" title="1.12 Approximate Sizes"></a>1.12 Approximate Sizes</h4><hr><p><code>GetApproximateSizes</code> 方法可以返回一个 key range 的磁盘占用空间大致使用量，示例代码如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rocksdb::Range ranges[<span class="number">2</span>];  </span><br><span class="line">ranges[<span class="number">0</span>] = rocksdb::Range(“a”, “c”);  </span><br><span class="line">ranges[<span class="number">1</span>] = rocksdb::Range(“x”, “z”);  </span><br><span class="line"><span class="keyword">uint64_t</span> sizes[<span class="number">2</span>];  </span><br><span class="line">rocksdb::Status s = db-&gt;GetApproximateSizes(ranges, <span class="number">2</span>, sizes);</span><br></pre></td></tr></table></figure><p>上面的 <code>sizes[0]</code> 返回 <code>[a..c)</code> key range 的磁盘使用量，而 <code>sizes[1]</code> 返回 <code>[x..z)</code>  key range 的磁盘使用量。</p><h4 id="1-13-Purging-WAL-files"><a href="#1-13-Purging-WAL-files" class="headerlink" title="1.13 Purging WAL files"></a>1.13 Purging WAL files</h4><hr><p>一般情况下，RocksDB 会删除一些过时的 WAL 文件，所谓过时就是 WAL 文件里面对应的一些 key 的数据已经被固化到磁盘了。但是 RocksDB 提供了两个选项以实让用户控制 WAL 何时删除：<code>Options::WAL_ttl_seconds</code> 和 <code>Options::WAL_size_limit_MB</code>，这两个参数分别控制 WAL 文件的超时时间 和 最大文件 size。</p><p>如果这两个值都被设置为 0，则 log 不会被固化到文件系统上。</p><p>如果 <code>Options::WAL_ttl_seconds</code> 为 0 而 <code>Options::WAL_size_limit_MB</code> 不为 0， RocksDB 会每 10 分钟检测所有的 WAL 文件，如果其总体 size 超过 <code>Options::WAL_size_limit_MB</code>，则 RocksDB 会删除最早的日志直到满足这个值位置。一切空文件都会被删除。</p><p>如果 <code>Options::WAL_ttl_seconds</code> 不为 0 而 <code>Options::WAL_size_limit_MB</code> 为 0，RocksDB 会每 <code>Options::WAL_ttl_seconds</code> / 2 检测一次 WAL 文件， 所有 TTL 超过 <code>Options::WAL_ttl_seconds</code> 的 WAL 文件都会被删除。</p><p>如果两个值都不为 0，RocksDB 会每 10 分钟检测所有的 WAL 文件，所有不满足条件的 WAL 文件都会被删除，其中 ttl 参数优先。</p><h4 id="1-14-Prefix-Iterators"><a href="#1-14-Prefix-Iterators" class="headerlink" title="1.14 Prefix Iterators"></a>1.14 Prefix Iterators</h4><hr><p>许多 LSM 引擎不支持高效的 RangeScan 操作，因为 Range 操作需要扫描所有的数据文件。一般情况下常规的技术手段是给 key 建立索引，只用遍历 key 就可以了。应用可以通过确认 <code>prefix_extractor</code> 指定一个可以的前缀，RocksDB 可以为这些 key prefix 建立 Bloom 索引，以加快查询速度。</p><h4 id="1-15-Multi-Threaded-Compactions"><a href="#1-15-Multi-Threaded-Compactions" class="headerlink" title="1.15 Multi-Threaded Compactions"></a>1.15 Multi-Threaded Compactions</h4><hr><p>参考文档 5 的 <code>Compaction Styles</code> 一节提到，如果启用 <code>Level Style Compaction</code>, L0 存储着 RocksDB 最新的数据，Lmax 存储着比较老的数据，<font color=blue><strong>L0 里可能存着重复 keys，但是其他层文件则不可能存在重复 key</strong></font>。每个 compaction 任务都会选择 Ln 层的一个文件以及与其相邻的 Ln+1 层的多个文件进行合并，删除过期 或者 标记为删除 或者 重复 的 key，然后把合并后的文件放入 Ln+1 层。Compaction 过程会导致写放大【如写qps是10MB/s，但是实际磁盘io是50MB/s】效应，但是可以节省空间并减少读放大。</p><p>如果启用 <code>Universal Style Compaction</code>，则只压缩 L0 的所有文件，合并后再放入 L0 层里。</p><p>RocksDB 的 compaction 任务线程不宜过多，过多容易导致写请求被 hang 住。</p><h4 id="1-16-Incremental-Backups-and-Replication"><a href="#1-16-Incremental-Backups-and-Replication" class="headerlink" title="1.16 Incremental Backups and Replication"></a>1.16 Incremental Backups and Replication</h4><hr><p>RocksDB 的 API <code>GetUpdatesSince</code> 可以让调用者从 transaction log 获知最近被更新的 key（原文意为用 tail 方式读取 transaction log），通过这个 API 可以进行数据的增量备份。</p><p>RocksDB 在进行数据备份时候，可以调用 API <code>DisableFileDeletions</code> 停止删除文件操作，调用 API <code>GetLiveFiles/GetSortedWalFiles</code> 以检索活跃文件列表，然后进行数据备份。备份工作完成以后在调用 API <code>EnableFileDeletions</code> 让 RocksDB 再启动过期文件淘汰工作。</p><h4 id="1-17-Thread-Pool"><a href="#1-17-Thread-Pool" class="headerlink" title="1.17 Thread Pool"></a>1.17 Thread Pool</h4><hr><p>RocksDB 会创建一个 thread pool 与 Env 对象进行关联，线程池中线程的数目可以通过 <code>Env::SetBackgroundThreads()</code> 设定。通过这个线程池可以执行 compaction 与 memtable flush 任务。</p><p>当 memtable flush 和 compaction 两个任务同时执行的时候，会导致写请求被 hang 住。RocksDB 建议创建两个线程池，分别指定  HIGH 和 LOW 两个优先级。默认情况下 HIGH 线程池执行 memtable flush 任务，LOW 线程池执行 compaction 任务。</p><p>相关代码示例如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> “rocksdb/env.h”</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> “rocksdb/db.h”</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> env = rocksdb::Env::Default();</span><br><span class="line">env-&gt;SetBackgroundThreads(<span class="number">2</span>, rocksdb::Env::<span class="literal">LOW</span>);</span><br><span class="line">env-&gt;SetBackgroundThreads(<span class="number">1</span>, rocksdb::Env::<span class="literal">HIGH</span>);</span><br><span class="line">rocksdb::DB* db;</span><br><span class="line">rocksdb::Options options;</span><br><span class="line">options.env = env;</span><br><span class="line">options.max_background_compactions = <span class="number">2</span>;</span><br><span class="line">options.max_background_flushes = <span class="number">1</span>;</span><br><span class="line">rocksdb::Status status = rocksdb::DB::Open(options, “/tmp/testdb”, &amp;db);</span><br><span class="line">assert(status.ok());</span><br></pre></td></tr></table></figure><p>还有其他一些参数，可详细阅读参考文档4。<br>​</p><h4 id="1-18-Bloom-Filter"><a href="#1-18-Bloom-Filter" class="headerlink" title="1.18 Bloom Filter"></a>1.18 Bloom Filter</h4><hr><p>RocksDB 的每个 SST 文件都包含一个 Bloom filter。Bloom Filter 只对特定的一组 keys 有效，所以只有新的 SST 文件创建的时候才会生成这个 filter。当两个 SST 文件合并的时候，会生成新的 filter 数据。</p><p>当 SST 文件加载进内存的时候，filter 也会被加载进内存，当关闭 SST 文件的时候，filter 也会被关闭。如果想让 filter 常驻内存，可以用如下代码设置：    </p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BlockBasedTableOptions::cache_index_and_filter_blocks=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>一般情况下不要修改 filter 相关参数。如果需要修改，相关设置上面已经说过，此处不再多谈，详细内容见参考文档 7。</p><h4 id="1-19-Time-to-Live"><a href="#1-19-Time-to-Live" class="headerlink" title="1.19 Time to Live"></a>1.19 Time to Live</h4><hr><p>RocksDB 在进行 compact 的时候，会删除被标记为删除的数据，会删除重复 key 的老版本的数据，也会删除过期的数据。数据过期时间由 API <code>DBWithTTL::Open(const Options&amp; options, const std::string&amp; name, StackableDB** dbptr, int32_t ttl = 0, bool read_only = false)</code> 的 ttl 参数设定。</p><p>TTL 的使用有以下注意事项：</p><ul><li>1 TTL 其值单位是秒，如果 TTL 值为 0 或者负数，则 TTL 值为 <code>infinity</code>，即永不过期；</li><li>2 每个 kv 被插入数据文件中的时候会带上创建时的机器 <code>(int32_t)Timestamp</code> 时间值；</li><li>3 compaction 时如果 kv 满足条件 <code>Timestamp+ttl&lt;time_now</code>，则会被淘汰掉；</li><li>4 Get/Iterator 的时候可能返回过期的 kv（compact 任务还未执行）；</li><li>5 不同的 <code>DBWithTTL::Open</code> 可能会带上不同的 TTL 值，此时 kv 以最大的 TTL 值为准；</li><li>6 如果 <code>DBWithTTL::Open</code> 的参数 <code>read_only</code> 为 true，则不会触发 compact 任务，不会有过期数据被删除。</li></ul><h3 id="2-RocksDB-Memory"><a href="#2-RocksDB-Memory" class="headerlink" title="2 RocksDB Memory"></a>2 <a href="https://github.com/facebook/rocksdb/wiki/Memory-usage-in-RocksDB" target="_blank" rel="noopener">RocksDB Memory</a></h3><hr><p>RocksDB的内存大致有如下四个区：</p><ul><li>Block Cache</li><li>Indexes and bloom filters</li><li>Memtables</li><li>Blocked pinned by iterators</li></ul><h4 id="2-1-Block-Cache"><a href="#2-1-Block-Cache" class="headerlink" title="2.1 Block Cache"></a>2.1 Block Cache</h4><hr><p>第三节详述了 Block Cache，这里只给出总结性描述：它存储一些读缓存数据，它的下一层是操作系统的 Page Cache。</p><h4 id="2-2-Indexes-and-bloom-filters"><a href="#2-2-Indexes-and-bloom-filters" class="headerlink" title="2.2 Indexes and bloom filters"></a>2.2 Indexes and bloom filters</h4><hr><p>Index 由 key、offset 和 size 三部分构成，当 Block Cache 增大 Block Size 时，block 个数必会减小，index 个数也会随之降低，如果减小 key size，index 占用内存空间的量也会随之降低。</p><p>filter是 bloom filter 的实现，如果假阳率是 1%，每个key占用 10 bits，则总占用空间就是 <code>num_of_keys * 10 bits</code>，如果缩小 bloom 占用的空间，可以设置 <code>options.optimize_filters_for_hits = true</code>，则最后一个 level 的 filter 会被关闭，bloom 占用率只会用到原来的 10% 。</p><p>结合 block cache 所述，index &amp; filter 有如下优化选项：</p><ul><li><code>cache_index_and_filter_blocks</code> 这个 option 如果为 true，则 index &amp; filter 会被存入 block cache，而 block cache 中的内容会随着 page cache 被交换到磁盘上，这就会大大降低 RocksDB的性能，把这个 option 设为 true 的同时也把 <code>pin_l0_filter_and_index_blocks_in_cache</code> 设为 true，以减小对性能的影响。</li></ul><p>如果 <code>cache_index_and_filter_blocks</code> 被设置为 false （其值默认就是 false），index/filter 个数就会受 <code>max_open_files</code> 影响，官方建议把这个选项设置为 -1，以方便 RocksDB 加载所有的 index 和 filter 文件，最大化程序性能。</p><p>可以通过如下代码获取 index &amp; filter 内存量大小：<br>​</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> out;</span><br><span class="line">db-&gt;GetProperty(“rocksdb.estimate-table-readers-mem”, &amp;out);</span><br></pre></td></tr></table></figure><h4 id="2-3-Indexes-and-bloom-filters"><a href="#2-3-Indexes-and-bloom-filters" class="headerlink" title="2.3 Indexes and bloom filters"></a>2.3 Indexes and bloom filters</h4><hr><p>block cache、index &amp; filter 都是读 buffer，而 memtable 则是写 buffer，所有 kv 首先都会被写进 memtable，其 size 是 <code>write_buffer_size</code>。 memtable 占用的空间越大，则写放大效应越小，因为数据在内存被整理好，磁盘上就越少的内容会被 compaction。如果 memtable 磁盘空间增大，则 L1 size 也就随之增大，L1 空间大小受 <code>max_bytes_for_level_base</code> option 控制。</p><p>可以通过如下代码获取 memtable 内存量大小：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> out;</span><br><span class="line">db-&gt;GetProperty(“rocksdb.cur-<span class="built_in">size</span>-all-mem-tables”, &amp;out);</span><br></pre></td></tr></table></figure><h4 id="2-4-Blocks-pinned-by-iterators"><a href="#2-4-Blocks-pinned-by-iterators" class="headerlink" title="2.4 Blocks pinned by iterators"></a>2.4 Blocks pinned by iterators</h4><hr><p>这部分内存空间一般占用总量不多，但是如果有 100k 之多的transactions 发生，每个 iterator 与一个 data block 外加一个 L1 的 data block，所以内存使用量大约为 <code>num_iterators * block_size * ((num_levels-1) + num_l0_files)</code>。</p><p>可以通过如下代码获取 Pin Blocks 内存量大小：<br>​</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_options.block_cache-&gt;GetPinnedUsage();</span><br></pre></td></tr></table></figure><h4 id="2-5-读流程"><a href="#2-5-读流程" class="headerlink" title="2.5 读流程"></a>2.5 读流程</h4><hr><p>RocksDB 的读流程分为逻辑读(logical read)和物理读(physical read)。逻辑读通常是对 cache【Block Cache &amp; Table Cache】进行读取，物理读就是直接读磁盘。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_read_process.png" alt=""></p><p>参考文档 12 详细描述了 LeveDB（RocksDB）的读流程，转述如下：</p><ul><li><p>在MemTable中查找，无法命中转到下一流程；</p></li><li><p>在immutable_memtable中查找，查找不中转到下一流程；</p></li><li><p>在第0层SSTable中查找，无法命中转到下一流程；</p><p>对于L0 的文件，RocksDB 采用遍历的方法查找，所以为了查找效率 RocksDB 会控制 L0 的文件个数。</p></li><li><p>在剩余SSTable中查找。</p><p>对于 L1 层以及 L1 层以上层级的文件，每个 SSTable 没有交叠，可以使用二分查找快速找到 key 所在的 Level 以及 SSTfile。</p></li></ul><p>至于写流程，请参阅 ### 5 Flush &amp; Compaction 章节内容。</p><h4 id="2-6-memory-pool"><a href="#2-6-memory-pool" class="headerlink" title="2.6 memory pool"></a>2.6 memory pool</h4><hr><p>不管 RocksDB 有多少 column family，一个 DB 只有一个 WriteController，一旦 DB 中一个 column family 发生堵塞，那么就会阻塞其他 column family 的写。RocksDB 写入时间长了以后，可能会不定时出现较大的写毛刺，可能有两个地方导致 RocksDB 会出现较大的写延时：获取 mutex 时可能出现几十毫秒延迟 和 将数据写入 memtable 时候可能出现几百毫秒延时。</p><p>获取 mutex 出现的延迟是因为 flush/compact 线程与读写线程竞争导致的，可以通过调整线程数量降低毛刺时间。</p><p>至于写入 memtable 时候出现的写毛刺时间，解决方法一就是使用大的 page cache，禁用系统 swap 以及配置 min_free_kbytes、dirty_ratio、dirty_background_ratio 等参数来调整系统的内存回收策略，更基础的方法是使用内存池。</p><p>采用内存池时，memtable 的内存分配和回收流程图如下：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_mempool.png" alt=""></p><p>使用内存池时，RocksDB 的内容分配代码模块如下：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_mempool_arena.png" alt=""></p><h3 id="3-Block-Cache"><a href="#3-Block-Cache" class="headerlink" title="3 Block Cache"></a>3 <a href="https://github.com/facebook/rocksdb/wiki/Block-Cache" target="_blank" rel="noopener">Block Cache</a></h3><hr><p>Block Cache 是 RocksDB 的数据的缓存，这个缓存可以在多个 RocksDB 的实例下缓存。一般默认的Block Cache 中存储的值是未压缩的，而用户可以再指定一个 Block Cache，里面的数据可以是压缩的。用户访问数据先访问默认的 Block Cache，待无法获取后再访问用户 Cache，用户 Cache 的数据可以直接存入 page cache 中。</p><p>Cache 有两种：LRUCache 和 BlockCache。Block 分为很多 Shard，以减小竞争，所以 shard 大小均匀一致相等，默认 Cache 最多有 64 个 shards，每个 shard 的 最小 size 为 512k，总大小是 8M，类别是 LRU。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">shared_ptr</span>&lt;Cache&gt; cache = NewLRUCache(capacity);  </span><br><span class="line">BlockedBasedTableOptions table_options;  </span><br><span class="line">table_options.block_cache = cache;  </span><br><span class="line">Options options;  </span><br><span class="line">options.table_factory.reset(<span class="keyword">new</span> BlockedBasedTableFactory(table_options));</span><br></pre></td></tr></table></figure><p>这个 Cache 是不压缩数据的，用户可以设置压缩数据 BlockCache，方法如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_options.block_cache_compressed = cache;</span><br></pre></td></tr></table></figure><p>如果 Cache 为 nullptr，则RocksDB会创建一个，如果想禁用 Cache，可以设置如下 Option：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_options.no_block_cache = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p>默认情况下RocksDB用的是 LRUCache，大小是 8MB， 每个 shard 单独维护自己的 LRU list 和独立的 hash table，以及自己的 Mutex。</p><p> RocksDB还提供了一个 ClockCache，每个 shard 有自己的一个 circular list，有一个 clock handle 会轮询这个 circular list，寻找过时的 kv，如果 entry 中的 kv 已经被访问过则可以继续存留，相对于 LRU 好处是无 mutex lock，circular list 本质是 tbb::concurrent_hash_map，从 benchmark 来看，二者命中率相似，但吞吐率 Clock 比 LRU 稍高。</p><p>Block Cache初始化之时相关参数：</p><ul><li>capacity 总的内存使用量</li><li>num_shards_bits 把 key 的前 n bits 作为 shard id，则总 shard 的数目为 2 ^ num_shards_bits；</li><li>strict_capacity_limit 在一些极端情况下 block cache 的总体使用量可能超过 capacity，如在对 block 进行读或者迭代读取的时候可能有插入数据的操作，此时可能因为加锁导致有些数据无法及时淘汰，使得总体capacity超标。如果这个选项设置为 true，则此时插入操作是被允许的，但有可能导致进程 OOM。如果设置为 false，则插入操作会被 refuse，同时读取以及遍历操作有可能失败。这个选项对每个 shard 都有效，这就意味着有的 shard 可能内存已满， 别的 shard 却有很多空闲。</li><li>high_pri_pool_ratio block中为高优先级的 block 保留多少比例的空间，这个选项只有 LRU Cache 有。</li></ul><p>默认情况下 index 和filter block 与 block cache 是独立的，用户不能设定二者的内存空间使用量，但为了控制 RocksDB 的内存空间使用量，可以用如下代码把 index 和 filter 也放在 block cache 中：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BlockBasedTableOptions table_options;</span><br><span class="line">table_options.cache_index_and_filter_blocks = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure><p>index 与 filter 一般访问频次比 data 高，所以把他们放到一起会导致内存空间与 cpu 资源竞争，进而导致 cache 性能抖动厉害。有如下两个参数需要注意：cache_index_filter_blocks_with_high_priority 和 high_pri_pool_ratio 一样，这个参数只对 LRU Cache 有效，两者须同时生效。这个选项会把 LRU Cache 划分为高 prio 和低 prio 区，data 放在 low 区，index 和 filter 放在 high 区，如果高区占用的内存空间超过了 capacity * high_pri_pool_ratio，则会侵占 low 区的尾部数据空间。</p><ul><li>pin_l0_filter_and_index_blocks_in_cache 把 level0 的 index 以及 filter block 放到 Block Cache 中，因为 l0 访问频次最高，一般内存容量不大，占用不了多大内存空间。</li></ul><p>SimCache 用于评测 Cache 的命中率，它封装了一个真正的 Cache，然后用给定的 capacity 进行 LRU 测算，代码如下:<br>​<br>​```c++<br>​// This cache is the actual cache use by the DB.<br>​std::shared_ptr<Cache> cache = NewLRUCache(capacity);<br>​// This is the simulated cache.<br>​std::shared_ptr<Cache> sim_cache = NewSimCache(cache, sim_capacity, sim_num_shard_bits);<br>​BlockBasedTableOptions table_options;<br>​table_options.block_cache = sim_cache;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">大概只有容量的 2% 会被用于测算。</span><br><span class="line"></span><br><span class="line">### 4 [Column Families](https:&#x2F;&#x2F;github.com&#x2F;facebook&#x2F;rocksdb&#x2F;wiki&#x2F;Column-Families)</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">RocksDB 3.0 以后添加了一个 Column Family【后面简称 CF】 的feature，每个 kv 存储之时都必须指定其所在的 CF。RocksDB为了兼容以往版本，默认创建一个 “default” 的CF。存储 kv 时如果不指定 CF，RocksDB 会把其存入 “default” CF 中。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 4.1 Option</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">RocksDB 的 Option 有 Options, ColumnFamilyOptions, DBOptions 三种。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ColumnFamilyOptions 是 table 级的，而 Options 是 DB 级的，Options 继承自 ColumnFamilyOptions 和 DBOptions，它一般影响只有一个 CF 的 DB，如 “default”。</span><br><span class="line"></span><br><span class="line">每个 CF 都有一个 Handle：ColumnFamilyHandle，在 DB 指针被 delete 前，应该先 delete ColumnFamilyHandle。如果 ColumnFamilyHandle 指向的 CF 被别的使用者通过 DropColumnFamily 删除掉，这个 CF 仍然可以被访问，因为其引用计数不为 0.</span><br><span class="line"></span><br><span class="line">在以 Read&#x2F;Write 方式打开一个 DB 的时候，需要指定一个由所有将要用到的 CF string name 构成的 ColumnFamilyDescriptor array。不管 “default” CF 使用与否，都必须被带上。</span><br><span class="line"></span><br><span class="line">CF 存在的意义是所有 table 共享 WAL，但不共享 memtable 和 table 文件，通过 WAL 保证原子写，通过分离 table 可快读快写快删除。每次 flush 一个 CF 后，都会新建一个 WAL，都这并不意味着旧的 WAL 会被删除，因为别的 CF 数据可能还没有落盘，只有所有的 CF 数据都被 flush 且所有的 WAL 有关的 data 都落盘，相关的 WAL 才会被删除。RocksDB 会定时执行 CF flush 任务，可以通过 &#96;Options::max_total_wal_size&#96; 查看已有多少旧的 CF 文件已经被 flush 了。</span><br><span class="line"></span><br><span class="line">RocksDB 会在磁盘上依据 LSM 算法对多级磁盘文件进行 compaction，这会影响写性能，拖慢程序性能，可以通过 &#96;WriteOptions.low_pri &#x3D; true&#96; 降低 compaction 的优先级。</span><br><span class="line"></span><br><span class="line">#### 4.2 [Set Up Option](https:&#x2F;&#x2F;github.com&#x2F;facebook&#x2F;rocksdb&#x2F;wiki&#x2F;Set-Up-Options)</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">RocksDB 有很多选项以专门的目的进行设置，但是大部分情况下不需要进行特殊的优化。这里只列出一个常用的优化选项。</span><br><span class="line"></span><br><span class="line">* &#96;cf_options.write_buffer_size&#96;</span><br><span class="line"></span><br><span class="line">CF 的 write buffer 的最大 size。最差情况下 RocksDB 使用的内存量会翻倍，所以一般情况下不要轻易修改其值。</span><br><span class="line"></span><br><span class="line">* Set block cache size</span><br><span class="line"></span><br><span class="line">这个值一般设置为 RocksDB 想要使用的内存总量的 1&#x2F;3，其余的留给 OS 的 page cache。</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;C++</span><br><span class="line">BlockBasedTableOptions table_options;</span><br><span class="line">… \\ set options in table_options</span><br><span class="line">options.table_factory.reset(new</span><br><span class="line"></span><br><span class="line">std::shared_ptr&lt;Cache&gt; cache &#x3D; NewLRUCache(&lt;your_cache_size&gt;);</span><br><span class="line">table_options.block_cache &#x3D; cache;</span><br><span class="line"></span><br><span class="line">BlockBasedTableFactory(table_options));</span><br></pre></td></tr></table></figure><p>本进程的所有的 DB 所有的 CF 所有的 table_options 都必须使用同一个 cahce 对象，或者让所有的 DB 所有的 CF 使用同一个 table_options。</p><ul><li><code>cf_options.compression, cf_options.bottonmost_compression</code></li></ul><p>选择压缩方法跟你的机器、CPU 能力以及内存磁盘空间大小有关，官方推荐 <code>cf_options.compression</code> 使用 kLZ4Compression，<code>cf_options.bottonmost_compression</code> 使用 kZSTD，选用的时候要确认你的机器有这两个库，这两个选项也可以分别使用 Snappy 和 Zlib。</p><ul><li>Bloom filter</li></ul><p><font color=red><strong>官方真正建议修改的参数只有这个 filter 参数。如果大量使用迭代方法，不要修改这个参数，如果大量调用 Get() 接口，建议修改这个参数。</strong></font>修改方法如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_options.filter_policy.reset(NewBloomFilterPolicy(<span class="number">10</span>, <span class="literal">false</span>));</span><br></pre></td></tr></table></figure><p>一个可能的优化设定如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cf_options.level_compaction_dynamic_level_bytes &#x3D; true;</span><br><span class="line">options.max_background_compactions &#x3D; 4;</span><br><span class="line">options.max_background_flushes &#x3D; 2;</span><br><span class="line">options.bytes_per_sync &#x3D; 1048576;</span><br><span class="line">table_options.block_size &#x3D; 16 * 1024;</span><br><span class="line">table_options.cache_index_and_filter_blocks &#x3D; true;</span><br><span class="line">table_options.pin_l0_filter_and_index_blocks_in_cache &#x3D; true;</span><br></pre></td></tr></table></figure><p>上面只是罗列了一些优化选项，这些选项也只能在进程启动的时候设定。更多的选项请详细阅读参考文档1。</p><h4 id="4-3-WriteOption-amp-Persistence"><a href="#4-3-WriteOption-amp-Persistence" class="headerlink" title="4.3 WriteOption &amp; Persistence"></a>4.3 WriteOption &amp; Persistence</h4><hr><p>参考文档 5 的 Persistence 一节提到，RocksDB 每次接收写请求的时候，请求内容会先被写入 WAL transaction log，然后再把数据写入 memfile 里面。</p><p>Put 函数的参数 WriteOptions 里有一个选项可以指明是否需要把写请求的内容写入 WAL log 里面。</p><p>RocksDB 内部有一个 batch-commit 机制，通过一次 commit 批量地在一次 sync 操作里把所有 transactions log 写入磁盘。</p><h3 id="5-Flush-amp-Compaction-amp-Merge"><a href="#5-Flush-amp-Compaction-amp-Merge" class="headerlink" title="5 Flush &amp; Compaction &amp; Merge"></a>5 Flush &amp; Compaction &amp; Merge</h3><hr><p>RocksDB 的内存数据在 memtable 中存着，有 active-memtable 和 immutable-memtable 两种。active-memtable 是当前被写操作使用的 memtable，当 active-memtable 空间写满之后( Options.write_buffer_size 控制其内存空间大小 )这个空间会被标记为 readonly 成为 immutable-memtable。memtable 实质上是一种有序 SkipList，所以写过程其实是写 WAL 日志和数据插入 SkipList 的过程。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_write_process.png" alt=""></p><p>RocksDB 的数据删除过程跟写过程相同，只不过 插入的数据是 “key:删除标记”。</p><p>immutable-memtable 被写入 L0 的过程被称为 flush 或者 minor compaction。flush 的触发条件是 immutable memtable数量超过 min_write_buffer_number_to_merge。flush 过程以 column family 为单位，一个 column family 会使用一个或者多个 immutable-memtable，flush 会一次把所有这些文件合并后写入磁盘的 L0 sstfile 中。</p><p>在 compaction 过程中如果某个被标记为删除的 key 在某个 snapshot 中存在，则会被一直保留，直到 snapshot 不存在才会被删除。</p><p>RocksDB 的 compaction 策略分为 <code>Universal Compaction</code> 和 <code>Leveled Compaction</code> 两种。两种策略分别有不同的使用场景，下面分两个章节详述。综述就是  <code>Leveled Compaction</code> 有利于减小空间放大却会增加读放大，<code>Universal Compaction</code> 有利于减少读放大却会增大空间放大。</p><h4 id="5-1-Leveled-Compaction"><a href="#5-1-Leveled-Compaction" class="headerlink" title="5.1 Leveled Compaction"></a>5.1 Leveled Compaction</h4><hr><p>compaction 的触发条件是文件个数和文件大小。L0 的触发条件是 sst 文件个数（level0_file_num_compaction_trigger 控制），触发 compaction score 是 L0 sst 文件个数与 level0_file_num_compaction_trigger 的比值或者所有文件的 size 超过 max_bytes_for_level_base。L1 ~ LN 的触发条件则是 sst 文件的大小。</p><p>如果 <code>level_compaction_dynamic_level_bytes</code> 为 false，L1 ~ LN 每个 level 的最大容量由 <code>max_bytes_for_level_base</code> 和 <code>max_bytes_for_level_multiplier</code> 决定，其 compaction score 就是当前总容量与设定的最大容量之比，如果某 level 满足 compaction 的条件则会被加入 compaction 队列。</p><p>如果 <code>level_compaction_dynamic_level_bytes</code> 为 true，则 <code>Target_Size(Ln-1) = Target_Size(Ln) / max_bytes_for_level_multiplier</code>，此时如果某 level 计算出来的 target 值小于 <code>max_bytes_for_level_base / max_bytes_for_level_multiplier</code>，则 RocksDB 不会再这个 level 存储任何 sst 数据。</p><h5 id="5-1-1-Compaction-Score"><a href="#5-1-1-Compaction-Score" class="headerlink" title="5.1.1 Compaction Score"></a>5.1.1 Compaction Score</h5><hr><p>compact 流程的 Compaction Score，不同 level 的计算方法不一样，下面先列出 L0 的计算方法。其中 num 代表未 compact 文件的数目。</p><table><thead><tr><th align="left">Param</th><th align="left">Value</th><th align="left">Description</th><th align="left">Score</th></tr></thead><tbody><tr><td align="left">level0_file_num_compaction_trigger</td><td align="left">4</td><td align="left">num 为 4 时，达到 compact 条件</td><td align="left">num &lt; 20 时 Score = num / 4</td></tr><tr><td align="left">level0_slowdown_writes_trigger</td><td align="left">20</td><td align="left">num 为 20 时，RocksDB 会减慢写入速度</td><td align="left">20 &lt;= num &amp;&amp; num &lt; 24 时 Score = 10000</td></tr><tr><td align="left">level0_stop_writes_trigger</td><td align="left">24</td><td align="left">num 为 24 时，RocksDB 停止写入文件，尽快对 L0 进行 compact</td><td align="left">24 &lt;= num 时 Score = 1000000</td></tr></tbody></table><p>对于 L1+ 层，score = Level_Bytes / Target_Size。</p><h5 id="5-1-2-Level-Max-Bytes"><a href="#5-1-2-Level-Max-Bytes" class="headerlink" title="5.1.2 Level Max Bytes"></a>5.1.2 Level Max Bytes</h5><hr><p>每个 level 容量总大小的计算前文已经提过，</p><table><thead><tr><th align="left">Param</th><th align="left">Value</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left">max_bytes_for_level_base</td><td align="left">10485760</td><td align="left">L1 总大小</td></tr><tr><td align="left">max_bytes_for_level_multiplier</td><td align="left">10</td><td align="left">最大乘法因子</td></tr><tr><td align="left">max_bytes_for_level_multiplier_addtl[2…6]</td><td align="left">1</td><td align="left">L2 ~ L6 总大小调整参数</td></tr></tbody></table><p>每个 level 的总大小计算公式为 <code>Level_max_bytes[N] = Level_max_bytes[N-1] * max_bytes_for_level_multiplier^(N-1)*max_bytes_for_level_multiplier_additional[N-1]</code>。</p><h5 id="5-1-3-compact-file"><a href="#5-1-3-compact-file" class="headerlink" title="5.1.3 compact file"></a>5.1.3 compact file</h5><hr><p>上面详述了 compact level 的选择，但是每个 level 具体的 compact 文件对象，</p><p>L0 层所有文件会被选做 compact 对象，因为它们有很高的概率所有文件的 key range 发生重叠。</p><p>对于 L1+ 层的文件，先对所有文件的大小进行排序以选出最大文件。</p><p>LevelDB 的文件选取过程如下：</p><p>LN 中每个文件都一个 seek 数值，其默认值非零，每次访问后这个数值减 1，其值越小说明访问越频繁。sst 文件的策略如下：</p><ul><li>1 选择 seek 次数为 0 的文件进行 merge，如果没有 seek 次数为 0 的文件，则从第一个文件开始进行 compact；</li><li>2 一次 compact 后记录本次结束的 key，下次 compact 开始时以这个 key 为起始继续进行 compact。</li></ul><h5 id="5-1-4-compaction"><a href="#5-1-4-compaction" class="headerlink" title="5.1.4 compaction"></a>5.1.4 compaction</h5><hr><p>大致的 compaction 流程大致为：</p><ul><li>1 找到 score 最高的 level；</li><li>2 根据一定策略从 level 中选择一个 sst 文件进行 compact，L0 的各个 sst 文件之间 key range 【minkey， maxkey】 有重叠，所以可能一次选取多个；</li><li>3 获取 sst 文件的 minkey 和 maxkey;</li><li>4 从 level + 1 中选取出于 (minkey, maxkey) 用重叠的 sst 文件，有重叠的文件则把文件与 level 中的文件进行合并（merge - sort）作为目标文件，没有重叠文件则把原始文件作为目标文件；</li><li>5 对目标文件进行压缩后放入 level + 1 中。</li></ul><h5 id="5-1-5-并行-Compact-与-sub-compact"><a href="#5-1-5-并行-Compact-与-sub-compact" class="headerlink" title="5.1.5 并行 Compact 与 sub-compact"></a>5.1.5 并行 Compact 与 sub-compact</h5><hr><p>参数 max_background_compactions 大于 1 时，RocksDB 会进行并行 Compact，但 L0 和 L1 层的 Compaction 任务不能进行并行。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_subcompaction.png" alt=""></p><p>一次 compaction 只能 compact 一个或者多个文件，这会约束整体 compaction 速度。用户可以设置 max_subcompactions 参数大于 1，RocksDB 如上图一样尝试把一个文件拆为多个 sub，然后启动多个线程执行 sub-compact。</p><h4 id="5-2-Universal-Compaction"><a href="#5-2-Universal-Compaction" class="headerlink" title="5.2 Universal Compaction"></a>5.2 Universal Compaction</h4><hr><p>Univesal Compaction 主要针对 L0。当 L0 中的文件个数多于 <code>level0_file_num_compaction_trigger</code>，则启动 compact。</p><p>L0 中所有的 sst 文件都可能存在重叠的 key range，假设所有的 sst 文件组成了文件队列 R1,R2,R3,…,Rn，R1 文件的数据是最新的，R2 其次，Rn 则包含了最老的数据，其 compact 流程如下：</p><ul><li>1 如果空间放大超过 <code>max_size_amplification_percent</code>，则对所有的 sst 进行 compaction（就是所谓的 full compaction）；</li><li>2 如果前size(R1)小于size(R2)在一定比例，默认1%，则与R1与R2一起进行compaction，如果（R1+R2)*(100+ratio)%100&lt;R3，则将R3也加入到compaction任务中，依次顺序加入sst文件；</li><li>如果第1和第2种情况都没有compaction，则强制选择前N个文件进行合并。</li></ul><p><code>Universal Compaction</code> 主要针对低写放大场景，跟 <code>Leveled Compaction</code> 相比一次合并文件较多但因为一次只处理 L0 所以写放大整体较低，但是空间放大效应比较大。</p><p>RocksDB 还支持一种 FIFO 的 compaction。FIFO 顾名思义就是先进先出，这种模式周期性地删除旧数据。在 FIFO 模式下，所有文件都在 L0，当 sst 文件总大小超过阀值 max_table_files_size，则删除最老的 sst 文件。<a href="https://www.jianshu.com/p/0fdeed70b36a" target="_blank" rel="noopener">参考文档21</a>中提到可以基于 FIFO compaction 机制把 RocksDB 当做一个时序数据库：<code>对于 FIFO 来说，它的策略非常的简单，所有的 SST 都在 Level 0，如果超过了阈值，就从最老的 SST 开始删除，其实可以看到，这套机制非常适合于存储时序数据</code>。</p><p>整个 compaction 是 LSM-tree 数据结构的核心，也是rocksDB的核心，详细内容请阅读 <a href="https://github.com/facebook/rocksdb/wiki/Universal-Compaction" target="_blank" rel="noopener">参考文档8</a> 和 <a href="https://github.com/facebook/rocksdb/wiki/Leveled-Compaction" target="_blank" rel="noopener">参考文档9</a>。</p><h4 id="5-4-Merge"><a href="#5-4-Merge" class="headerlink" title="5.4 Merge"></a>5.4 Merge</h4><hr><p>RocksDB 自身之提供了 Put/Delete/Get 等接口，若需要在现有值上进行修改操作【或者成为增量更新】，可以借助这三个操作进行以下操作实现之：</p><ul><li>调用 Get 接口然后获取其值；</li><li>在内存中修改这个值；</li><li>调用 Put 接口写回 RocksDB。</li></ul><p>如果希望整个过程是原子操作，就需要借助 RocksDB 的 Merge 接口了。<a href="https://www.jianshu.com/p/e13338a3f161" target="_blank" rel="noopener">参考文档14</a> 给出了 RocksDB Merge 接口定义如下：</p><ul><li>1 封装了read - modify - write语义，对外统一提供简单的抽象接口；</li><li>2 减少用户重复触发Get操作引入的性能损耗；</li><li>3 通过决定合并操作的时间和方式，来优化后端性能，并达到并不改变底层更新的语义；</li><li>4 渐进式的更新，来均摊更新带来带来的性能损耗，以得到渐进式的性能提升。</li></ul><p>RocksDB 提供了一个 MergeOperator 作为 Merge 接口，其中一个子类 AssociativeMergeOperator 可在大部分场景下使用，其定义如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The simpler, associative merge operator.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AssociativeMergeOperator</span> :</span> <span class="keyword">public</span> MergeOperator &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~AssociativeMergeOperator() &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Gives the client a way to express the read -&gt; modify -&gt; write semantics</span></span><br><span class="line">  <span class="comment">// key:           (IN) 操作对象 KV 的 key</span></span><br><span class="line">  <span class="comment">// existing_value:(IN) 操作对象 KV 的 value，如果为 null 则意味着 KV 不存在</span></span><br><span class="line">  <span class="comment">// value:         (IN) 新值，用于替换/更新 @existing_value</span></span><br><span class="line">  <span class="comment">// new_value:    (OUT) 客户端负责把 merge 后的新值填入这个变量</span></span><br><span class="line">  <span class="comment">// logger:        (IN) Client could use this to log errors during merge.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Return true on success.</span></span><br><span class="line">  <span class="comment">// All values passed in will be client-specific values. So if this method</span></span><br><span class="line">  <span class="comment">// returns false, it is because client specified bad data or there was</span></span><br><span class="line">  <span class="comment">// internal corruption. The client should assume that this will be treated</span></span><br><span class="line">  <span class="comment">// as an error by the library.</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Merge</span><span class="params">(<span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> Slice* existing_value,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> Slice&amp; value,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="built_in">std</span>::<span class="built_in">string</span>* new_value,</span></span></span><br><span class="line"><span class="function"><span class="params">                     Logger* logger)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Default implementations of the MergeOperator functions</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">FullMergeV2</span><span class="params">(<span class="keyword">const</span> MergeOperationInput&amp; merge_in,</span></span></span><br><span class="line"><span class="function"><span class="params">                           MergeOperationOutput* merge_out)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">PartialMerge</span><span class="params">(<span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> Slice&amp; left_operand,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> Slice&amp; right_operand,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="built_in">std</span>::<span class="built_in">string</span>* new_value,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Logger* logger)</span> <span class="keyword">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>RocksDB AssociativeMergeOperator 被称为关联性 Merge Operator，<a href="https://www.jianshu.com/p/e13338a3f161" target="_blank" rel="noopener">参考文档14</a>  给出了关联性的定义：</p><ul><li>调用Put接口写入RocksDB的数据的格式和Merge接口是相同的</li><li>用用户自定义的merge操作，可以将多个merge操作数合并成一个</li></ul><p><code>**MergeOperator还可以用于非关联型数据类型的更新。** 例如，在RocksDB中保存json字符串，即Put接口写入data的格式为合法的json字符串。而Merge接口只希望更新json中的某个字段。所以代码可能是这样</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// Put/store the json string into to the database</span></span><br><span class="line">   db_-&gt;Put(put_option_, <span class="string">"json_obj_key"</span>,</span><br><span class="line">            <span class="string">"&#123; employees: [ &#123;first_name: john, last_name: doe&#125;, &#123;first_name: adam, last_name: smith&#125;] &#125;"</span>);</span><br><span class="line">   <span class="comment">// Use a pre-defined "merge operator" to incrementally update the value of the json string</span></span><br><span class="line">   db_-&gt;Merge(merge_option_, <span class="string">"json_obj_key"</span>, <span class="string">"employees[1].first_name = lucy"</span>);</span><br><span class="line">   db_-&gt;Merge(merge_option_, <span class="string">"json_obj_key"</span>, <span class="string">"employees[0].last_name = dow"</span>);</span><br><span class="line">`AssociativeMergeOperator无法处理这种场景，因为它假设Put和Merge的数据格式是关联的。我们需要区分Put和Merge的数据格式，也无法把多个merge操作数合并成一个。这时候就需要Generic MergeOperator。`</span><br><span class="line"></span><br><span class="line">   <span class="comment">// The Merge Operator</span></span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">   <span class="comment">// Essentially, a MergeOperator specifies the SEMANTICS of a merge, which only</span></span><br><span class="line">   <span class="comment">// client knows. It could be numeric addition, list append, string</span></span><br><span class="line">   <span class="comment">// concatenation, edit data structure, ... , anything.</span></span><br><span class="line">   <span class="comment">// The library, on the other hand, is concerned with the exercise of this</span></span><br><span class="line">   <span class="comment">// interface, at the right time (during get, iteration, compaction...)</span></span><br><span class="line">   <span class="class"><span class="keyword">class</span> <span class="title">MergeOperator</span> &#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">     <span class="keyword">virtual</span> ~MergeOperator() &#123;&#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// Gives the client a way to express the read -&gt; modify -&gt; write semantics</span></span><br><span class="line">     <span class="comment">// key:         (IN) The key that's associated with this merge operation.</span></span><br><span class="line">     <span class="comment">// existing:    (IN) null indicates that the key does not exist before this op</span></span><br><span class="line">     <span class="comment">// operand_list:(IN) the sequence of merge operations to apply, front() first.</span></span><br><span class="line">     <span class="comment">// new_value:  (OUT) Client is responsible for filling the merge result here</span></span><br><span class="line">     <span class="comment">// logger:      (IN) Client could use this to log errors during merge.</span></span><br><span class="line">     <span class="comment">//</span></span><br><span class="line">     <span class="comment">// Return true on success. Return false failure / error / corruption.</span></span><br><span class="line">     <span class="comment">// 用于对已有的值做Put或Delete操作</span></span><br><span class="line">     <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">FullMerge</span><span class="params">(<span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> Slice* existing_value,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">deque</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;&amp; operand_list,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="built_in">std</span>::<span class="built_in">string</span>* new_value,</span></span></span><br><span class="line"><span class="function"><span class="params">                            Logger* logger)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// This function performs merge(left_op, right_op)</span></span><br><span class="line">     <span class="comment">// when both the operands are themselves merge operation types.</span></span><br><span class="line">     <span class="comment">// Save the result in *new_value and return true. If it is impossible</span></span><br><span class="line">     <span class="comment">// or infeasible to combine the two operations, return false instead.</span></span><br><span class="line">     <span class="comment">// 如果连续多次对一个 key 进行操作，则可以可以借助 PartialMerge 将两个操作数合并.</span></span><br><span class="line">     <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">PartialMerge</span><span class="params">(<span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">const</span> Slice&amp; left_operand,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">const</span> Slice&amp; right_operand,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="built_in">std</span>::<span class="built_in">string</span>* new_value,</span></span></span><br><span class="line"><span class="function"><span class="params">                               Logger* logger)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// The name of the MergeOperator. Used to check for MergeOperator</span></span><br><span class="line">     <span class="comment">// mismatches (i.e., a DB created with one MergeOperator is</span></span><br><span class="line">     <span class="comment">// accessed using a different MergeOperator)</span></span><br><span class="line">     <span class="function"><span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keyword">char</span>* <span class="title">Name</span><span class="params">()</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">   &#125;;</span><br></pre></td></tr></table></figure><ul><li><strong>工作原理</strong></li></ul><p>当调用DB::Put()和DB:Merge()接口时, 并不需要立刻计算最后的结果. RocksDB将计算的动作延后触发, 例如在下一次用户调用Get, 或者RocksDB决定做Compaction时. 所以, 当merge的动作真正开始做的时候, 可能积压(stack)了多个操作数需要处理. 这种情况就需要MergeOperator::FullMerge来对existing_value和一个操作数序列进行计算, 得到最终的值.</p><ul><li><strong>PartialMerge 和 Stacking</strong></li></ul><p>有时候, 在调用FullMerge之前, 可以先对某些merge操作数进行合并处理, 而不是将它们保存起来, 这就是PartialMerge的作用: 将两个操作数合并为一个, 减少FullMerge的工作量.<br>当遇到两个merge操作数时, RocksDB总是先会尝试调用用户的PartialMerge方法来做合并, 如果PartialMerge返回false才会保存操作数. 当遇到Put/Delete操作, 就会调用FullMerge将已存在的值和操作数序列传入, 计算出最终的值.</p><ul><li><strong>使用Associative Merge的场景</strong></li></ul><p>merge 操作数的格式和Put相同<br>多个顺序的merge操作数可以合并成一个</p><ul><li><strong>使用Generic Merge的场景</strong></li></ul><p>merge 操作数的格式和Put不同<br>当多个merge操作数可以合并时，PartialMerge()方法返回true</p><p>*!!!: 本节文字摘抄自 <a href="https://www.jianshu.com/p/e13338a3f161" target="_blank" rel="noopener">参考文档14</a>  。</p><h3 id="6-磁盘文件"><a href="#6-磁盘文件" class="headerlink" title="6 磁盘文件"></a>6 磁盘文件</h3><hr><p>参考文档 12 列举了 RocksDB 磁盘上数据文件的种类：</p><pre><code>* db的操作日志* 存储实际数据的 SSTable 文件* DB的元信息 Manifest 文件* 记录当前正在使用的 Manifest 文件，它的内容就是当前的 manifest 文件名* 系统的运行日志，记录系统的运行信息或者错误日志。* 临时数据库文件，repair 时临时生成的。</code></pre><p>manifest 文件记载了所有 SSTable 文件的 key 的范围、level 级别等数据。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_arch.png" alt=""></p><p>上面是 leveldb 的架构图，可以作为参考，明白各种文件的作用。</p><h4 id="6-1-log-文件"><a href="#6-1-log-文件" class="headerlink" title="6.1 log 文件"></a>6.1 log 文件</h4><hr><p>log 文件就是 WAL。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_log_block_record.png" alt=""></p><p>如上图，log 文件的逻辑单位是 Record，物理单位是 block，每个 Record 可以存在于一个 block 中，也可以占用多个 block。Record 的详细结构见上图文字部分，其 type 字段的意义见下图。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_log_record.png" alt=""></p><p>从上图可见 Record type的意义：如果某 KV 过长则可以用多 Record 存储。</p><h4 id="6-2-Manifest-文件"><a href="#6-2-Manifest-文件" class="headerlink" title="6.2 Manifest 文件"></a>6.2 Manifest 文件</h4><hr><p>RocksDB 整个 LSM 树的信息需要常驻内存，以让 RocksDB 快速进行 kv 查找或者进行 compaction 任务，RocksDB 会用文件把这些信息固化下来，这个文件就是 Manifest 文件。RocksDB 称 Manifest 文件记录了 DB 状态变化的事务性日志，也就是说它记录了所有改变 DB 状态的操作。主要内容有事务性日志和数据库状态的变化。</p><p>RocksDB 的函数 VersionSet::LogAndApply 是对 Manifest 文件的更新操作，所以可以通过定位这个函数出现的位置来跟踪 Manifest 的记录内容。</p><p>Manifest 文件作为事务性日志文件，只要数据库有变化，Manifest都会记录。其内容 size 超过设定值后会被 VersionSet::WriteSnapShot 重写。</p><p>RocksDB 进程 Crash 后 Reboot 的过程中，会首先读取 Manifest 文件在内存中重建 LSM 树，然后根据 WAL 日志文件恢复 memtable 内容。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_manifest.jpg" alt=""></p><p>上图是 leveldb 的 Manifest 文件结构，这个 Manifest 文件有以下文件内容：</p><ul><li>coparator名、log编号、前一个log编号、下一个文件编号、上一个序列号，这些都是日志、sstable文件使用到的重要信息，这些字段不一定必然存在；</li><li>其次是compact点，可能有多个，写入格式为{kCompactPointer, level, internal key}</li><li>其后是删除文件，可能有多个，格式为{kDeletedFile, level, file number}。</li><li>最后是新文件，可能有多个，格式为{kNewFile, level, file number, file size, min key, max key}。</li></ul><p>RocksDB MANIFEST文件所保存的数据基本是来自于VersionEdit这个结构，MANIFEST包含了两个文件，一个log文件一个包含最新MANIFEST文件名的文件，Manifest的log文件名是这样 MANIFEST-(seqnumber)，这个seq会一直增长，只有当 超过了指定的大小之后，MANIFEST会刷新一个新的文件，当新的文件刷新到磁盘(并且文件名更新)之后，老的文件会被删除掉，这里可以认为每一次MANIFEST的更新都代表一次snapshot，其结构描述如下：</p><pre><code>MANIFEST = { CURRENT, MANIFEST-&lt;seq-no&gt;* }  CURRENT = File pointer to the latest manifest logMANIFEST-&lt;seq no&gt; = Contains snapshot of RocksDB state and subsequent modifications</code></pre><p>在RocksDB中任意时间存储引擎的状态都会保存为一个Version(也就是SST的集合)，而每次对Version的修改都是一个VersionEdit,而最终这些VersionEdit就是 组成manifest-log文件的内容。</p><p>下面就是MANIFEST的log文件的基本构成:</p><pre><code>version-edit      = Any RocksDB state changeversion           = { version-edit* }manifest-log-file = { version, version-edit* }                  = { version-edit* }</code></pre><p>关于 VersionSet 相关代码分析见<a href="https://yq.aliyun.com/articles/594728?spm=a2c4e.11157919.spm-cont-list.17.302c27aeDR3OyC" target="_blank" rel="noopener">参考文档13</a>。</p><h4 id="6-3-SSTfile"><a href="#6-3-SSTfile" class="headerlink" title="6.3 SSTfile"></a>6.3 SSTfile</h4><hr><p>SSTfile 结构如下：</p><pre><code>&lt;beginning_of_file&gt;[data block 1][data block 2]…[data block N][meta block 1: filter block]                 [meta block 2: stats block]                   [meta block 3: compression dictionary block]  …[meta block K: future extended block][metaindex block][index block][Footer]                              &lt;end_of_file&gt;</code></pre><p>LevelDB 的 SSTfile 结构如下：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_sst_file.png" alt=""></p><p>见参考文档12，SSTtable 大致分为几个部分：</p><ul><li>数据块 Data Block，直接存储有序键值对，是 SSTfile 的数据实体；</li><li>Meta Block，存储Filter相关信息；</li><li>Meta Index Block，对Meta Block的索引，它只有一条记录，key是meta index的名字（也就是Filter的名字），value为指向meta index的位置；</li><li>Index Block，是对Data Block的索引，对于其中的每个记录，其key &gt;=Data Block最后一条记录的key，同时&lt;其后Data Block的第一条记录的key；value是指向data index的位置信息；</li><li>Footer，指向各个分区的位置和大小。</li></ul><p>block 结构如下图：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_sst_block.jpg" alt=""></p><p>record 结构如下图：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_sst_record.jpg" alt=""></p><p>Footer 结构如下图：</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_sst_footer.jpg" alt=""></p><h4 id="6-4-memtable"><a href="#6-4-memtable" class="headerlink" title="6.4 memtable"></a>6.4 memtable</h4><hr><p>memtable 中存储了一些 metadata 和 data，data 在 skiplist 中存储。metadata 数据如下（源自参考文档 12）：</p><ul><li>当前日志句柄；</li><li>版本管理器、当前的版本信息（对应 compaction）和对应的持久化文件标示；</li><li>当前的全部db配置信息比如 comparator 及其对应的 memtable 指针；</li><li>当前的状态信息以决定是否需要持久化 memtable 和合并 sstable；</li><li>sstable 文件集合的信息。</li></ul><h4 id="6-5-VersionSet"><a href="#6-5-VersionSet" class="headerlink" title="6.5 VersionSet"></a>6.5 VersionSet</h4><hr><p>RocksDB 的 Version 表示一个版本的 metadata，其主要内容是 FileMetaData 指针的二维数组，分层记录了所有的SST文件信息。</p><p>FileMetaData 数据结构用来维护一个文件的元信息，包括文件大小，文件编号，最大最小值，引用计数等信息，其中引用计数记录了被不同的Version引用的个数，保证被引用中的文件不会被删除。</p><p>Version中还记录了触发 Compaction 相关的状态信息，这些信息会在读写请求或 Compaction 过程中被更新。在 CompactMemTable 和 BackgroundCompaction 过程中会导致新文件的产生和旧文件的删除，每当这个时候都会有一个新的对应的Version生成，并插入 VersionSet 链表头部，LevelDB 用 VersionEdit 来表示这种相邻 Version 的差值。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_versionset.png" alt=""></p><p>VersionSet 结构如上图所示，它是一个 Version 构成的双向链表，这些Version按时间顺序先后产生，记录了当时的元信息，链表头指向当前最新的Version，同时维护了每个Version的引用计数，被引用中的Version不会被删除，其对应的SST文件也因此得以保留，通过这种方式，使得LevelDB可以在一个稳定的快照视图上访问文件。</p><p>VersionSet中除了Version的双向链表外还会记录一些如LogNumber，Sequence，下一个SST文件编号的状态信息。</p><h4 id="6-6-MetaData-Restore"><a href="#6-6-MetaData-Restore" class="headerlink" title="6.6 MetaData Restore"></a>6.6 MetaData Restore</h4><hr><p>本节内容节选自参考文档 12。</p><p>为了避免进程崩溃或机器宕机导致的数据丢失，LevelDB 需要将元信息数据持久化到磁盘，承担这个任务的就是 Manifest 文件，每当有新的Version产生都需要更新 Manifest。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_version_manifest.png" alt=""></p><p>新增数据正好对应于VersionEdit内容，也就是说Manifest文件记录的是一组VersionEdit值，在Manifest中的一次增量内容称作一个Block。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_manifest_block_item.png" alt=""></p><p>Manifest Block 的详细结构如上图所示。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/leveldb_data_restore.png" alt=""></p><p>上图最上面的流程显示了恢复元信息的过程，也就是一次应用 VersionEdit 的过程，这个过程会有大量的临时 Version 产生，但这种方法显然太过于耗费资源，LevelDB 引入 VersionSet::Builder 来避免这种中间变量，方法是先将所有的VersoinEdit内容整理到VersionBuilder中，然后一次应用产生最终的Version，详细流程如上图下边流程所示。</p><p>数据恢复的详细流程如下：</p><ul><li>依次读取Manifest文件中的每一个Block， 将从文件中读出的Record反序列化为VersionEdit；</li><li>将每一个的VersionEdit Apply到VersionSet::Builder中，之后从VersionSet::Builder的信息中生成Version；</li><li>计算compaction_level_、compaction_score_；</li><li>将新生成的Version挂到VersionSet中，并初始化VersionSet的manifest_file_number_， next_file_number_，last_sequence_，log_number_，prev_log_number_ 信息；</li></ul><h4 id="6-7-Snapshot"><a href="#6-7-Snapshot" class="headerlink" title="6.7 Snapshot"></a>6.7 Snapshot</h4><hr><p>RocksDB 每次进行更新操作就会把更新内容写入 Manifest 文件，同时它会更新版本号。</p><p>版本号是一个 8 字节的证书，每个 key 更新时，除了新数据被写入数据文件，同时记录下 RocksDB 的版本号。RocksDB 的 Snapshot 数据仅仅是逻辑数据，并没有对应的真实存在的物理数据，仅仅对应一下当前 RocksDB 的全局版本号而已，只要 Snapshot 存在，每个 key 对应版本号的数据在后面的更新、删除、合并时会一并存在，不会被删除，以保证数据一致性。</p><h5 id="6-7-1-Checkpoints"><a href="#6-7-1-Checkpoints" class="headerlink" title="6.7.1  Checkpoints"></a>6.7.1  <a href="https://github.com/facebook/rocksdb/wiki/Checkpoints" target="_blank" rel="noopener">Checkpoints</a></h5><hr><p>Checkpoints 是 RocksDB 提供的一种 snapshot，独立的存在一个单独的不同于 RocksDB 自身数据目录的目录中，既可以 ReadOnly 模式打开，也可以 Read-Write 模式打开。Checkpoints 被用于全量或者增量 Backup 机制中。</p><p>如果 Checkpoints 目录和 RocksDB 数据目录在同一个文件系统上，则 Checkpoints 目录下的 SST 是一个 hard link【SST 文件是 Read-Only的】，而 manifest 和 CURRENT 两个文件则会被拷贝出来。如果 DB 有多个 Column Family，wal 文件也会被复制，其时间范围足以覆盖 Checkpoints 的起始和结束，以保证数据一致性。</p><p>如果以 Read-Write 模式打开 Checkpoints 文件，则其中过时的 SST 文件会被删除掉。</p><h4 id="6-8-Backup"><a href="#6-8-Backup" class="headerlink" title="6.8 Backup"></a>6.8 Backup</h4><hr><p>RocksDB 提供了 point-of-time 数据备份功能，可以调用 <code>BackupEngine::CreateNewBackup(db, flush_before_backup = false)</code> 接口进行数据备份， 其大致流程如下：</p><ul><li><p>禁止删除文件（sst 文件和 log 文件）；</p></li><li><p>调用 <code>GetLiveFiles()</code> 获取当前的有效文件，如 table files, current, options and manifest file;</p></li><li><p>将 RocksDB 中的所有的 sst/Manifest/配置/CURRENT 等有效文件备份到指定目录；</p><p>  GetLiveFiles() 接口返回的 SST 文件如果已经被备份过，则这个文件不会被重新复制到目标备份目录，但是 <code>BackupEngine</code> 会对这个文件进行 checksum 校验，如果校验失败则会中止备份过程。</p></li><li><p>如果 <code>flush_before_backup</code> 为 false，则<code>BackupEngine</code> 会调用 <code>GetSortedWalFiles()</code> 接口把当前有效的 wal 文件也拷贝到备份目录；</p></li><li><p>重新允许删除文件。</p></li></ul><p>sst 文件只有在 compact 时才会被删除，所以禁止删除就相当于禁止了 compaction。别的 RocksDB 在获取这些备份数据文件后会依据 Manifest 文件重构 LSM 结构的同时，也能恢复出 WAL 文件，进而重构出当时的 memtable 文件。</p><p>在进行 Backup 的过程中，写操作是不会被阻塞的，所以 WAL 文件内容会在 backup 过程中发生改变。RocksDB 的 flush_before_backup 选项用来控制在 backup 时是否也拷贝 WAL，其值为 true 则不拷贝。</p><h5 id="6-8-1-Backup-编程接口"><a href="#6-8-1-Backup-编程接口" class="headerlink" title="6.8.1 Backup 编程接口"></a>6.8.1 Backup 编程接口</h5><hr><p>RocksDB 提供的 Backup 接口使用方法详见 <a href="https://github.com/facebook/rocksdb/wiki/How-to-backup-RocksDB%3F" target="_blank" rel="noopener">参考文档17</a>。include/rocksdb/utilities/backupable_db.h 主要提供了 <code>BackupEngine</code> 和 <code>BackupEngineReadOnly</code>，分别用于备份数据和恢复数据。</p><p><code>BackupEngine</code>备份数据是增量式备份【设置选项 <code>BackupableDBOptions::share_table_files</code> 】，调用 <code>BackupEngine::CreateNewBackup()</code> 接口进行备份后，可以调用接口 <code>BackupEngine::GetBackupInfo()</code>获取备份文件的信息：ID、timestamp、size、file number 和 metadata【用户自定义数据】。</p><p><img src="/images/%E6%95%B0%E6%8D%AE%E5%BA%93/rocksdb_backup_dir_list.png" alt=""></p><p>备份 DB 目录见上图，各个备份文件的 size 是其 private 目录下数据与 shared 目录下数据之和，shared 下面存储的数据是各个备份公共的数据，所以所有备份文件的 size 之和可能大于实际占用的磁盘空间大小。meta 目录下各个文件的格式详见 utilities/backupable/backupable_db.cc，上图中 <code>meta/1</code>内容如下：</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1536821592   # checksum</span><br><span class="line">1            # backup ID</span><br><span class="line">4            # private file number</span><br><span class="line">private/1/MANIFEST-000008 crc32 272357318</span><br><span class="line">private/1/OPTIONS-000011 crc32 3039312718</span><br><span class="line">private/1/CURRENT crc32 1581506767</span><br><span class="line">private/1/000009.log crc32 3494278128</span><br></pre></td></tr></table></figure><p>Private 目录则包含一些非 SST 文件：options, current, manifest, WALs。如果 <code>Options::share_table_files</code> 为false，则 private 目录会存储 SST 文件。如果 <code>Options::share_table_files</code> 为 true 且 <code>Options::share_files_with_checksum</code> 为 false，shared 目录包含一些 SST 文件，SST 文件命名与原 RocksDB 目录下命名一致，所以在一个备份目录下只能备份一个 RocksDB 实例的数据。</p><p>接口 <code>BackupEngine::VerifyBackups()</code> 用于对备份数据进行校验，但是仅仅根据 meta 目录下各个 ID 文件记录的文件 size 与 相应的 private 目录下的文件的 size 是否相等，并不会进行 checksum 校验， 校验 checksum 需要读取数据文件，比较费时。另外需要注意的是，这个接口相应的 <code>BackupEngine</code> 句柄只能由<code>BackupEngine::CreateNewBackup()</code> 创建，也即只能在进行文件备份且句柄未失效前进行数据校验，因为校验时所依据的数据是在备份过程中产生的。</p><p>接口 <code>BackupEngineReadOnly::RestoreDBFromBackup(backup_id, db_dir, wal_dir,restore_options)</code> 用于备份数据恢复，参数 <code>db_dir</code> 和<code>wal_dir</code>大部分场景下都是同一个目录，但在 <a href="https://www.jianshu.com/p/46bb78bca726?utm_source=oschina-app" target="_blank" rel="noopener">参考文档18</a> 所提供的把 RocksDB 当做纯内存数据库的使用场景下， <code>db_dir</code> 在内存虚拟文件系统上，而 <code>wal_dir</code> 则是一个磁盘文件目录。进行数据恢复时，这个接口还会根据 meta 下相应 ID 记录的 备份数据 checksum 对 private 目录下的数据进行校验，发错错误时返回 <code>Status::Corruption</code> 错误。</p><h5 id="6-8-2-Backup-性能优化"><a href="#6-8-2-Backup-性能优化" class="headerlink" title="6.8.2 Backup 性能优化"></a>6.8.2 Backup 性能优化</h5><hr><p><code>BackupEngine::Open()</code> 启用时需要进行一些初始化工作，所以它会消耗一些时间。例如需要把本地 RocksDB 数据备份到远端的 HDFS 上，这个过程就可能消耗多个 network round-trip，所以在实际使用中不要频繁创建 <code>BackupEngine</code> 对象。</p><p>加快 BackupEngine 对象的方式之一是通过调用 <code>PurgeOldBackups(N)</code>来删除非必要的备份文件，接口 <code>PurgeOldBackups(N)</code> 本身之意就是只保留最近的 N 个备份，多余的会被删除掉。也可以通过调用 <code>DeleteBackup(id)</code> 接口根据备份 ID 删除某个确定的备份。</p><p>初始化 BackupEngine 对象过后，备份的速度就取决于本地与远端的媒介运行速度了。例如，如果本地媒介是 HDD，在其自身饱和运转之后就算是打开再多的线程也无济于事。如果媒介是一个小的 HDFS 集群，其表现也不会很好。如果本地是 SSD 而远端是一个大的 HDFS 集群，则相较于单线程， 16 个备份线程会被备份时间缩短 2/3。</p><h5 id="6-8-3-高级编程接口"><a href="#6-8-3-高级编程接口" class="headerlink" title="6.8.3 高级编程接口"></a>6.8.3 高级编程接口</h5><hr><ul><li><code>BackupEngine::CreateNewBackupWithMetadata()</code> 用于设置 metadata，例如设置你能辨识的备份 ID，metadata 可以通过 <code>BackupEngine::GetBackupInfo()</code> 获取；</li><li><code>rocksdb::LoadLatestOptions()</code> or <code>rocksdb:: LoadOptionsFromFile()</code> RocksDB 现在也能对 RocksDB 的 options 进行备份，可以通过这两个接口获取相应备份的 Options；</li><li><code>BackupableDBOptions::backup_env</code> 用于设置备份目录的 ENV；</li><li><code>BackupableDBOptions::backup_dir</code> 用于设置备份文件的根目录；</li><li><code>BackupableDBOptions::share_table_files</code> 如果这个选项为 true，则 <code>BackupEngine</code> 会进行增量备份，把所有的 SST 文件存储到 “shared/“ 子目录，其危险是 SST 文件名字可能相同【在多个 RocksDB 对象共用同一备份目录的场景下】；</li><li><code>BackupableDBOptions::share_files_with_checksum</code> 在多个 RocksDB 对象共用同一备份目录的场景下，SST 文件名字可能相同，把这个选项设置为 true 可以处理这个冲突，SST 文件会被 <code>BackupEngine</code> 通过 checksum/size/seqnum 三个参数进行校验；</li><li><code>BackupableDBOptions::max_background_operations</code> 这个参数用于设置备份和恢复数据的线程数，在使用分布式文件系统如 HDFS 场景下，这个参数会大大提高备份和恢复的效率；</li><li><code>BackupableDBOptions::info_log</code> 用于设置 LOG 对象，可以在备份和恢复数据时进行日志输出；</li><li><code>BackupableDBOptions::sync</code> 如果设置为 true，<code>BackupEngine</code> 会调用 <code>fsync</code> 系统接口进行文件数据和 metadata 的数据写入，以防备系统重启或者崩溃时的数据不一致现象，大部分情况下如果为追求性能，这个参数可以设置为 false；</li><li><code>BackupableDBOptions::destroy_old_data</code> 如果这个选项为 true，新的 <code>BackupEngine</code> 被创建出来之后备份目录下旧的备份数据会被清空；</li><li><code>BackupEngine::CreateNewBackup(db, flush_before_backup = false)</code> flush_before_backup 被设置为 true 时，<code>BackupEngine</code> 首先 flush memtable，然后再进行数据复制，而 WAL log 文件不会被复制，因为 flush 时候它会被删掉，如果这个为 false 则相应的 WAL 日志文件也会被复制以保证备份数据与当前 RocksDB 状态一致；</li></ul><h3 id="7-FAQ"><a href="#7-FAQ" class="headerlink" title="7 FAQ"></a>7 FAQ</h3><hr><p>官方 wiki 【参考文档 11】提供了一份 FAQ，下面节选一些比较有意义的建议，其他内容请移步官方文档。</p><ul><li>1 如果机器崩溃后重启，则 RocksDB 能够恢复的数据是同步写【WriteOptions.sync=true】调用 <code>DB::SyncWAL()</code> 之前的数据 或者已经被写入 L0 的 memtable 的数据都是安全的；</li><li>2 可以通过 <code>GetIntProperty(cf_handle, “rocksdb.estimate-num-keys&quot;)</code> 获取一个 column family 中大概的 key 的个数；</li><li>3 可以通过 <code>GetAggregatedIntProperty(“rocksdb.estimate-num-keys&quot;, &amp;num_keys)</code> 获取整个 RocksDB 中大概的 key 的总数，之所以只能获取一个大概数值是因为 RocksDB 的磁盘文件有重复 key，而且 compact 的时候会进行 key 的淘汰，所以无法精确获取；</li><li>4 Put()/Write()/Get()/NewIterator() 这几个 API 都是线程安全的；</li><li>5 多个进程可以同时打开同一个 RocksDB 文件，但是其中只能有一个写进程，其他的都只能通过 <code>DB::OpenForReadOnly()</code> 对 RocksDB 进行只读访问；</li><li>6 当进程中还有线程在对 RocksDB 进行 读、写或者手工 compaction 的时候，不能强行关闭它；</li><li>7 RocksDB 本身不建议使用大 key，但是它支持的 key 的最大长度是 8MB，value 的最大长度是 3GB；</li><li>8 RocksDB 最佳实践：一个线程进行写，且以顺序方式写；以 batch 方式把数据写入 RocksDB；使用 vector memtable；确保 <code>options.max_background_flushes</code> 最少为 4；插入数据之前设置关闭自动 compact，把 <code>options.level0_file_num_compaction_trigger/options.level0_slowdown_writes_trigger/options.level0_stop_writes_trigger</code> 三个值放大，数据插入后再启动调用 compact 函数进行 compaction 操作。<br>  如果调用了<code>Options::PrepareForBulkLoad()</code>，后面三个方法会被自动启用；</li><li>9 关闭 RocksDB 对象时，如果是通过 DestroyDB() 去关闭时，这个 RocksDB 还正被另一个进程访问，则会造成不可预料的后果；</li><li>10 可以通过 <code>DBOptions::db_paths/DBOptions::db_log_dir/DBOptions::wal_dir</code> 三个参数分别存储 RocksDB 的数据，这种情况下如果要释放 RocksDB 的数据可以通过 DestroyDB() 这个 API 去执行删除任务；</li><li>11 当 <code>BackupOptions::backup_log_files</code> 或者 <code>flush_before_backup</code> 的值为 true 的时候，如果程序调用 <code>CreateNewBackup()</code> 则 RocksDB 会创建 <code>point-in-time snapshot</code>，RocksDB进行数据备份的时候不会影响正常的读写逻辑；</li><li>12 RocksDB 启动之后不能修改 <code>prefix extractor</code>；</li><li>13 SstFileWriter API 可以用来创建 SST 文件，如果这些 SST 文件被添加到别的 RocksDB 数据库发生 key range 重叠，则会导致数据错乱；</li><li>14 编译 RocksDB 的 gcc 版本 最低是 4.7，推荐 4.8 以上；</li><li>15 单个文件系统如 ext3 或者 xfs 可以使用多个磁盘，然后让 RocksDB 在这个文件系统上运行进而使用多个磁盘；</li><li>16 使用多磁盘时，RAID 的 stripe size 不能小于 64kb，推荐使用1MB；</li><li>17 RocksDB 可以针对每个 SST 文件通过 <code>ColumnFamilyOptions::bottommost_compression</code> 使用不同的压缩的方法；</li><li>18 当多个 Handle 指向同一个 Column Family 时，其中一个线程通过 DropColumnFamily() 删除一个 CF 的时候，其引用计数会减一，直至为 0 时整个 CF 会被删除；</li><li>19 RocksDB 接受一个写请求的时候，可能因为 compact 会导致 RocksDB 多次读取数据文件进行数据合并操作；</li><li>20 RocksDB 不直接支持数据的复制，但是提供了 API GetUpdatesSince() 供用户调用以获取某个时间点以后更新的 kv；</li><li>21 Options 的 block_size 是指 block 的内存空间大小，与数据是否压缩无关；</li><li>22 options.prefix_extractor 一旦启用，就无法继续使用 Prev() 和 SeekToLast() 两个 API，可以把 ReadOptions.total_order_seek 设置为 true，以禁用 <code>prefix iterating</code>；</li><li>23 当 BlockBaseTableOptions::cache_index_and_filter_blocks 的值为 true 时，在进行 Get() 调用的时候相应数据的 bloom filter 和 index block 会被放进 LRU cache 中，如果这个参数为 false 则只有 memtable 的 index 和 bloom filter 会被放进内存中；</li><li>24 当调用 Put() 或者 Write() 时参数 WriteOptions.sync 的值为 true，则本次写以前的所有 WriteOptions.disableWAL 为 false 的写的内容都会被固化到磁盘上；</li><li>25 禁用 WAL 时，DB::Flush() 只对单个 Column Family 的数据固化操作是原子的，对多个 Column Family 的数据操作则不是原子的，官方考虑将来会支持这个 feature；</li><li>26 当使用自定义的 comparators 或者 merge operators 时，ldb 工具就无法读取 sst 文件数据；</li><li>27 RocksDB 执行前台的 Get() 和 Write() 任务遇到错误时，它会返回 rocksdb::IOError 具体值；</li><li>28 RocksDB 执行后台任务遇到错误时 且 options.paranoid_checks 值为 true，则 RocksDB 会自动进入只读模式；</li><li>29 RocksDB 一个线程执行 compact 的时候，这个任务是不可取消的；</li><li>30 RocksDB 一个线程执行 compact 任务的时候，可以在另一个线程调用 CancelAllBackgroundWork(db, true) 以中断正在执行的 compact 任务；</li><li>31 当多个进程打开一个 RocksDB 时，如果指定的 compact 方式不一样，则后面的进程会打开失败；</li><li>32 Column Family 使用场景：(1) 不同的 Column Family 可以使用不同的 setting/comparators/compression types/merge operators/compaction filters；(2) 对数据进行逻辑隔离，方便分别删除；(3) 一个 Column Family 存储 metadata，另一个存储 data；</li><li>33 使用一个 RocksDB 就是使用一个物理存储系统，使用一个 Column Family 则是使用一个逻辑存储系统，二者主要区别体现在 数据备份、原子写以及写性能表现上。DB 是数据备份和复制以及 checkpoint 的基本单位，但是 Column Family 则利用 BatchWrite，因为这个操作是可以跨 Column Family 的，而且多个 Column Family 可以共享同一个 WAL，多个 DB 则无法做到这一点；</li><li>34 RocksDB 不支持多列；</li><li>35 RocksDB 的读并不是无锁的，有如下情况：(1) 访问 sharded block cache (2) 如果 table cache options.max_open_files 不等于 -1 (3) 如果 flush 或者 compaction 刚刚完成，RocksDB 此时会使用全局 mutex lock 以获取 LSM 树的最新 metadata (4) RocksDB 使用的内存分配器如 jemalloc 有时也会加锁，这四种情况总体很少发生，总体可以认为读是无锁的；</li><li>36 如果想高效的对所有数据进行 iterate，则可以创建 snapshot 然后再遍历；</li><li>37 如果一个 key space range (minkey, maxkey) 很大，则使用 Column Family 对其进行 sharding，如果这个 range 不大则不要单独使用一个 Column Family；</li><li>38 RocksDB 没有进行 compaction 的时候，可以通过 <code>rocksdb.estimate-live-data-size</code> 可以估算 RocksDB 使用的磁盘空间；</li><li>39 Snapshot 仅仅存在于逻辑概念上，其对应的实际物理文件可能正被 compaction 线程执行写任务；Checkpoint 则是实际物理文件的一个镜像，或者说是一个硬链接，而出处于同样的 Env 下【都是 RocksDB 数据文件格式】；而 backup 虽然也是物理数据的镜像，但是与原始数据处于不同的 Env 下【如 backup 可能在 HDFS 上】；</li><li>40 推荐使用压缩算法 LZ4，Snappy 次之，压缩之后如果为了更好的压缩效果可以使用 Zlib；</li><li>41 即使没有被标记为删除的 key，也没有数据过期，RocksDB 仍然会执行 compaction，以提高读性能；</li><li>42 RocksDB 的 key 和 value 是存在一起的，遍历一个 key 的时候，RocksDB 已经把其 value 读入 cache 中；</li><li>43 对于一个离线 DB 可以通过 “sst_dump –show_properties –command=none” 命令获取特定 sst 文件的 index &amp; filter 的 size，对于正在运行的 DB 可以通过读取 DB 的属性 “kAggregatedTableProperties” 或者调用 DB::GetPropertiesOfAllTables() 获取 DB 的 index &amp; filter 的 size。</li></ul><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><hr><ul><li>1 <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Tuning-Guide" target="_blank" rel="noopener">RocksDB Tuning Guide</a></li><li>2 <a href="https://github.com/facebook/rocksdb/wiki/Rocksdb-BlockBasedTable-Format" target="_blank" rel="noopener">Rocksdb BlockBasedTable Format</a></li><li>3 <a href="https://github.com/facebook/rocksdb/wiki/PlainTable-Format" target="_blank" rel="noopener">PlainTable Format</a></li><li>4 <a href="https://github.com/facebook/rocksdb/wiki/Thread-Pool" target="_blank" rel="noopener">Thread Pool</a></li><li>5 <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Basics" target="_blank" rel="noopener">RocksDB Basics</a></li><li>6 <a href="https://github.com/facebook/rocksdb/wiki/Transactions" target="_blank" rel="noopener">Transactions</a></li><li>7 <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-Bloom-Filter" target="_blank" rel="noopener">Bloom Filter</a></li><li>8 <a href="https://github.com/facebook/rocksdb/wiki/Universal-Compaction" target="_blank" rel="noopener">Universal Compaction</a></li><li>9 <a href="https://github.com/facebook/rocksdb/wiki/Leveled-Compaction" target="_blank" rel="noopener">Leveled Compaction</a></li><li>10 <a href="https://github.com/facebook/rocksdb/wiki/Time-to-Live" target="_blank" rel="noopener">Time to Live</a></li><li>11 <a href="https://github.com/facebook/rocksdb/wiki/RocksDB-FAQ" target="_blank" rel="noopener">RocksDB-FAQ</a></li><li>12 <a href="https://note.youdao.com/share/?id=60b7e3aa14a01c85d05ee8a7e4d16c46&type=note#/" target="_blank" rel="noopener">设计思路和主要知识点</a></li><li>13 <a href="https://yq.aliyun.com/articles/594728?spm=a2c4e.11157919.spm-cont-list.17.302c27aeDR3OyC" target="_blank" rel="noopener">RocksDB · MANIFEST文件介绍</a></li><li>14 <a href="https://www.jianshu.com/p/e13338a3f161" target="_blank" rel="noopener">RocksDB. Merge Operator</a></li><li>15 <a href="https://zhuanlan.zhihu.com/p/30807728" target="_blank" rel="noopener">使用PinnableSlice减少Get时的内存拷贝</a></li><li>16 <a href="https://rocksdb.org/blog/2017/08/24/pinnableslice.html" target="_blank" rel="noopener">PinnableSlice; less memcpy with point lookups</a></li><li>17 <a href="https://github.com/facebook/rocksdb/wiki/How-to-backup-RocksDB%3F" target="_blank" rel="noopener">How to backup RocksDB?</a></li><li>18 <a href="https://www.jianshu.com/p/46bb78bca726?utm_source=oschina-app" target="_blank" rel="noopener">RocksDB系列十三:How to persist in memory RocksDB database?</a></li><li>19 <a href="https://github.com/facebook/rocksdb/wiki/Checkpoints" target="_blank" rel="noopener">Checkpoints</a></li><li>20 <a href="https://www.tuicool.com/articles/7ju2UfI" target="_blank" rel="noopener">LSM-Tree与RocksDB</a></li><li>21 <a href="https://www.jianshu.com/p/0fdeed70b36a" target="_blank" rel="noopener">自动调优 RocksDB</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;前沿&quot;&gt;&lt;a href=&quot;#前沿&quot; class=&quot;headerlink&quot; title=&quot;前沿&quot;&gt;&lt;/a&gt;前沿&lt;/h1&gt;&lt;p&gt;近日工作中使用了 RocksDB。RocksDB 的优点此处无需多说，它的一个 feature 是其有很多优化选项用于对 RocksDB 进行调优。欲熟悉这些参数，必须对其背后的原理有所了解，本文主要整理一些 RocksDB 的 wiki 文档，以备自己参考之用。&lt;/p&gt;
    
    </summary>
    
    
      <category term="数据结构" scheme="http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
      <category term="数据库" scheme="http://blog.crazylaw.cn/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="数据库开发知识" scheme="http://blog.crazylaw.cn/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%BC%80%E5%8F%91%E7%9F%A5%E8%AF%86/"/>
    
  </entry>
  
  <entry>
    <title>【Golang】- 使用golang重写tga服务</title>
    <link href="http://blog.crazylaw.cn/2020/12/17/Golang/%E4%BD%BF%E7%94%A8golang%E9%87%8D%E5%86%99tga%E6%9C%8D%E5%8A%A1/"/>
    <id>http://blog.crazylaw.cn/2020/12/17/Golang/%E4%BD%BF%E7%94%A8golang%E9%87%8D%E5%86%99tga%E6%9C%8D%E5%8A%A1/</id>
    <published>2020-12-17T01:46:51.000Z</published>
    <updated>2021-03-20T16:25:01.799Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>早期，在我们的部门中后端的技术栈语言主要有三种语言，分别是<code>php/python/erlang</code>，其中用于做服务的是 <code>php/erlang</code>。</p><p>在我们的体系中，日志采集服务体系目前都是用erlang写的，而php写的服务多是基于swoole写的一些基础服务。</p><p>在tga服务中，我们需要从<code>kafka</code> -&gt; <code>服务</code> -&gt; <code>本地文件</code>的模式。</p><p>业务据流图如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">+---------------------------------------------------------------+</span><br><span class="line">|                                                               |</span><br><span class="line">|                                                               |</span><br><span class="line">|       +---------------------------------------------+         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       |                  kafka服务                   |         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       |                                             |         |</span><br><span class="line">|       +----------------------+----------------------+         |</span><br><span class="line">|                              |                                |</span><br><span class="line">|                              |                                |</span><br><span class="line">|       +----------------------v-----------------------+        |                     +----------------------------+</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |               mthinkingdata服务               |        &lt;---------------------+          logbus服务        |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       |                                              |        |                     |                            |</span><br><span class="line">|       +----------------------+-----------------------+        |                     +----------------------------+</span><br><span class="line">|                              |                                |</span><br><span class="line">|                              |                                |</span><br><span class="line">|       +----------------------v------------------------+       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                   本地文件                     +-------+</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       |                                               |       |</span><br><span class="line">|       +-----------------------------------------------+       |</span><br><span class="line">|                                                               |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>于是我们试探性的自研基于swoole的kafka客户端，我们自己实现根据kafka协议的封包，解包，流程处理。(<code>swoole-kafka</code>)<br><code>mthinkingdata服务</code>就是我们基于<code>kafka-swoole</code>研发的业务服务。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+------------+</span><br><span class="line">|            |</span><br><span class="line">|  message1  +------------+</span><br><span class="line">|            |            |</span><br><span class="line">+------------+            |</span><br><span class="line">                          |</span><br><span class="line">+------------+     +------+--------+</span><br><span class="line">|            |     |               |</span><br><span class="line">|  message2  +-----+   snappy压缩   |</span><br><span class="line">|            |     |               |</span><br><span class="line">+------------+     +------+--------+</span><br><span class="line">                           |</span><br><span class="line">+---------------+          |</span><br><span class="line">|               |          |</span><br><span class="line">| message[3..n] +----------+</span><br><span class="line">|               |</span><br><span class="line">+---------------+</span><br></pre></td></tr></table></figure><p>在这个过程中，我们发现php对于cpu密集型的处理存在瓶颈，因为我们在生产者一方如果发送多条协议的情况下，会经过 <code>snappy</code> 算法的压缩再推送以便减少network-io（增加cpu-io）。<br>消费者在接受消息的时候也是被压缩过的数据，所以我们需要解压，在这个解压的过程中，是个十分消费cpu的过程，即使我们当时是基于swoole4.3的协程版本来处理，<br>不行的是的抢占式协程当时并没有很好的完成，我们没办法达到快速的接受多个数据包的行为。消费速度也并不是特别理想。<br>在这个大环境下，我们还需要借助redis来作为中间的存储。而redis是单线程的，我们在这个过程中，试过使用<code>pipeline</code>等手段减少tcp中的响应包的带来的性能损耗。但是由于redis只能利用单核的缘故，批量处理一批指令后，最高的cpu利用率接近100%下无法再增长。<br>也因此，我们的服务注定无法达到很好的性能测试。</p><p>我们得出结论，当时服务的瓶颈在于：</p><ul><li><ol><li>php语言本身的性能</li></ol></li><li><ol start="2"><li>swoole协程不支持抢占式调度</li></ol></li><li><ol start="3"><li>未实现动态伸缩扩展worker数量（感兴趣可以去看看kafka-swoole的架构分享）</li></ol></li><li><ol start="4"><li>redis未能利用多核，cpu利用率达到峰值</li></ol></li></ul><a id="more"></a><h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>针对以上几个问题，我们逐一得出解决方案</p><ul><li><ol><li>使用golang语言（语言优先在公司内部博客有比较）</li></ol></li><li><ol start="2"><li>使用基于golang的嵌入式存储服务作为中间存储服务（<code>badger</code>）（<code>rocksdb</code>的使用在尝试中）</li></ol></li></ul><p>也因此催生出了使用golang重写tga服务（<code>mtga</code>）的需求。以其中一个项目开发为例子(项目编号：<code>24</code>)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── _build                                 # 部署的目录结构</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── bin                                 </span><br><span class="line">│   │   └── mtga                           # 编译后的二进制文件</span><br><span class="line">│   ├── config</span><br><span class="line">│   │   ├── common.env</span><br><span class="line">│   │   ├── msource.yml</span><br><span class="line">│   │   ├── mtga.local.yml</span><br><span class="line">│   │   └── mtga.yml</span><br><span class="line">│   ├── mctl                               # 操作入口脚本</span><br><span class="line">│   ├── scripts</span><br><span class="line">│   │   └── init.sh                        # 第一次部署项目需要执行的初始化脚本</span><br><span class="line">│   ├── settings</span><br><span class="line">│   │   ├── mthinkingdata:filter.24.json</span><br><span class="line">│   │   └── mthinkingdata:metadata.24.json</span><br><span class="line">│   └── tmp</span><br><span class="line">├── _local_build                           # 本地开发部署的目录结构</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── bin</span><br><span class="line">│   │   └── mtga</span><br><span class="line">│   ├── config</span><br><span class="line">│   │   ├── common.env</span><br><span class="line">│   │   ├── msource.yml</span><br><span class="line">│   │   ├── mtga.local.yml</span><br><span class="line">│   │   └── mtga.yml</span><br><span class="line">│   ├── mctl</span><br><span class="line">│   ├── scripts</span><br><span class="line">│   │   └── init.sh</span><br><span class="line">│   ├── settings</span><br><span class="line">│   │   ├── mthinkingdata:filter.24.json</span><br><span class="line">│   │   └── mthinkingdata:metadata.24.json</span><br><span class="line">│   └── tmp</span><br><span class="line">├── build</span><br><span class="line">│   ├── Dockerfile</span><br><span class="line">│   ├── Jenkinsfile</span><br><span class="line">│   └── README.md</span><br><span class="line">└── src</span><br><span class="line">    ├── Makefile                         # 便于构建服务</span><br><span class="line">    ├── app                              # 业务代码</span><br><span class="line">    │   ├── bussiness.go                 # 消费者的业务核心代码</span><br><span class="line">    │   ├── config</span><br><span class="line">    │   │   ├── app.go</span><br><span class="line">    │   │   ├── redis_keys.go</span><br><span class="line">    │   │   ├── setting_tools.go</span><br><span class="line">    │   │   └── settings.go</span><br><span class="line">    │   ├── main.go</span><br><span class="line">    │   └── reporter</span><br><span class="line">    │       └── notify.go</span><br><span class="line">    ├── cmd                              # cli终端命令</span><br><span class="line">    │   ├── clear_failure_queue.go       # 清理失败队列</span><br><span class="line">    │   ├── failure_queue_count.go       # 失败队列数量</span><br><span class="line">    │   ├── kafka_lag.go                 # 当前消费者阻塞总数据量</span><br><span class="line">    │   ├── offset_checker.go            # topic中各个partition的当前offset以及阻塞情况</span><br><span class="line">    │   ├── restart.go                   # 重启服务</span><br><span class="line">    │   ├── root.go</span><br><span class="line">    │   ├── start.go                     # 启动服务</span><br><span class="line">    │   ├── start_not_daemon.go          # 以非守护进程的方式启动服务</span><br><span class="line">    │   └── stop.go                      # 暂停服务</span><br><span class="line">    ├── config                           # 配置目录</span><br><span class="line">    │   ├── msource.yml</span><br><span class="line">    │   ├── mtga.local.yml</span><br><span class="line">    │   └── mtga.yml</span><br><span class="line">    ├── go.mod</span><br><span class="line">    ├── go.sum</span><br><span class="line">    ├── main.go</span><br><span class="line">    ├── settings</span><br><span class="line">    │   ├── mthinkingdata:filter.24.json</span><br><span class="line">    │   └── mthinkingdata:metadata.24.json</span><br><span class="line">    └── test</span><br><span class="line">        ├── setting_test.go</span><br><span class="line">        └── setting_tools_test.go</span><br></pre></td></tr></table></figure><blockquote><p>早期我们还没抛弃redis的时候，持续占用cpu100%的话就会出现这个。 如果不用pipe模式的话，tps测试只有2500-3500之间。<br>抛弃redis使用了badger之后， 结合业务逻辑，tps:1w/s左右</p></blockquote><p>其中用到内部的组件包含如下：</p><ul><li>commentjson</li><li>go-graceful-daemon</li><li>logbdev</li><li>metl-sdk</li><li>msink</li><li>msource</li></ul><h2 id="mtga-amp-amp-msource"><a href="#mtga-amp-amp-msource" class="headerlink" title="mtga &amp;&amp; msource"></a>mtga &amp;&amp; msource</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 转换前</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"headers"</span>:&#123;</span><br><span class="line">        <span class="attr">"app_id"</span>:<span class="number">24</span>,</span><br><span class="line">        <span class="attr">"log_name"</span>:<span class="string">"log_item"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"logs"</span>:&#123;</span><br><span class="line">        <span class="attr">"account_name"</span>:<span class="string">"4866014107"</span>,</span><br><span class="line">        <span class="attr">"action"</span>:<span class="number">2146</span>,</span><br><span class="line">        <span class="attr">"agent_id"</span>:<span class="number">36</span>,</span><br><span class="line">        <span class="attr">"amount"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"bag_amount"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"bag_type"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"bind_type"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"client_version"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"device_id"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"end_time"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"idfa"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"imei"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"is_internal"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"item_id"</span>:<span class="number">31103003</span>,</span><br><span class="line">        <span class="attr">"mac"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"mtime"</span>:<span class="number">1608184243</span>,</span><br><span class="line">        <span class="attr">"pid"</span>:<span class="number">1608184244000008</span>,</span><br><span class="line">        <span class="attr">"platform"</span>:<span class="number">3100</span>,</span><br><span class="line">        <span class="attr">"quality"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"regrow"</span>:<span class="number">14</span>,</span><br><span class="line">        <span class="attr">"role_id"</span>:<span class="number">6001310009300</span>,</span><br><span class="line">        <span class="attr">"role_level"</span>:<span class="number">800</span>,</span><br><span class="line">        <span class="attr">"server_id"</span>:<span class="number">5001</span>,</span><br><span class="line">        <span class="attr">"server_version"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"sn"</span>:<span class="string">"205914E03BF640CB76"</span>,</span><br><span class="line">        <span class="attr">"star"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"start_time"</span>:<span class="number">1608184243</span>,</span><br><span class="line">        <span class="attr">"upf"</span>:<span class="number">3100</span>,</span><br><span class="line">        <span class="attr">"via"</span>:<span class="string">"36|3100"</span>,</span><br><span class="line">        <span class="attr">"zero_dateline"</span>:<span class="number">1608134400</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转换后</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"#account_id"</span>:<span class="string">"10289100005300x"</span>,</span><br><span class="line">    <span class="attr">"#distinct_id"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="attr">"#event_name"</span>:<span class="string">"t_log_item"</span>,</span><br><span class="line">    <span class="attr">"#ip"</span>:<span class="string">""</span>,</span><br><span class="line">    <span class="attr">"#time"</span>:<span class="string">"2020-12-17 13:52:39"</span>,</span><br><span class="line">    <span class="attr">"#type"</span>:<span class="string">"track"</span>,</span><br><span class="line">    <span class="attr">"properties"</span>:&#123;</span><br><span class="line">        <span class="attr">"account_name"</span>:<span class="string">"1608153237001005108"</span>,</span><br><span class="line">        <span class="attr">"action"</span>:<span class="number">1005</span>,</span><br><span class="line">        <span class="attr">"agent_id"</span>:<span class="number">11</span>,</span><br><span class="line">        <span class="attr">"amount"</span>:<span class="number">-1</span>,</span><br><span class="line">        <span class="attr">"bag_amount"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"bag_type"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"bind_type"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"client_version"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"device_id"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"end_time"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"idfa"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"imei"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"is_internal"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"item_id"</span>:<span class="number">10203101</span>,</span><br><span class="line">        <span class="attr">"mac"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"mtime"</span>:<span class="number">1608184359</span>,</span><br><span class="line">        <span class="attr">"pid"</span>:<span class="number">1608184359000031</span>,</span><br><span class="line">        <span class="attr">"platform"</span>:<span class="number">101</span>,</span><br><span class="line">        <span class="attr">"quality"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"regrow"</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">"role_id"</span>:<span class="number">110289100005300</span>,</span><br><span class="line">        <span class="attr">"role_level"</span>:<span class="number">160</span>,</span><br><span class="line">        <span class="attr">"server_id"</span>:<span class="number">289</span>,</span><br><span class="line">        <span class="attr">"server_version"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"sn"</span>:<span class="string">""</span>,</span><br><span class="line">        <span class="attr">"star"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="attr">"start_time"</span>:<span class="number">1608184359</span>,</span><br><span class="line">        <span class="attr">"upf"</span>:<span class="number">101</span>,</span><br><span class="line">        <span class="attr">"via"</span>:<span class="string">"11|101"</span>,</span><br><span class="line">        <span class="attr">"zero_dateline"</span>:<span class="number">1608134400</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数据在<code>msource</code>到<code>mtga</code>的交互</p><p>改版前：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                       +-----------------------------------------+</span><br><span class="line">                       | +---------+                             |</span><br><span class="line">                       | | msource |                             |</span><br><span class="line">                       | +---------+                             |</span><br><span class="line">                       |                                         |</span><br><span class="line">                       |    +--------------------------------+   |</span><br><span class="line">                       |    |                                |   |</span><br><span class="line">                       |    |       spoutKafka(channel)      |   |</span><br><span class="line">                       |    |                                +-&gt;X+-------------------------+</span><br><span class="line">                       |    |                                |   |                         |</span><br><span class="line">                       |    +-------------^----------^-------+   |           +-------------v----------------+</span><br><span class="line">                       |                  |          |           |           |-----------+                  |</span><br><span class="line">                       |                  |          |           |           || 业务服务 |                   |</span><br><span class="line">                       |                  |          |           |           +-----------+                  |</span><br><span class="line">+------------+         |                  |          |           |           |                              |</span><br><span class="line">|            |         |    +--------------------------------+   |           |      XXXXXXXXXXXXXXX         |</span><br><span class="line">|   kafka    +---------&gt;X+  | +-------+   |          |       |   |           |      X1.过滤的数据 X          |</span><br><span class="line">|            |         | |  | | badge |   |          |       |   |           |      XXXXXXXXXXXXXXX         |</span><br><span class="line">+------------+         | |  | +-------+   |          |       |   |           |                              |</span><br><span class="line">                       | |  |             |          |       |   |           |                              |</span><br><span class="line">                       | |  |      +------+-------+  |       |   |           |      +---------------+       |</span><br><span class="line">                       | ^---------&gt;              |  |       | ^--------------------+2.失败的数据     |       |</span><br><span class="line">                       |    |      |  等待ack队列   &lt;-----^   | | |           |      +---------------+       |</span><br><span class="line">                       |    |      |              |  |  |    | | |           |                              |</span><br><span class="line">                       |    |      +--------------+  |  |    | | |           |                              |</span><br><span class="line">                       |    |                        |  |    | | |           |                              |</span><br><span class="line">                       |    |      +--------------+  |  |    | | |           |     +------------------+     |</span><br><span class="line">                       |    |      |              +--^  &lt;--------------------------+3.正常处理完的数据   |     |</span><br><span class="line">                       |    |      |  业务失败队列  |          | | |           |     +------------------+     |</span><br><span class="line">                       |    |      |              &lt;------------v |           |                              |</span><br><span class="line">                       |    |      +--------------+          |   |           +------------------------------+</span><br><span class="line">                       |    +--------------------------------+   |</span><br><span class="line">                       +-----------------------------------------+</span><br></pre></td></tr></table></figure><p>改版后：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                       +-----------------------------------------+</span><br><span class="line">                       | +---------+                             |           +-----------------------+</span><br><span class="line">                       | | msource |                             |           |                       |</span><br><span class="line">                       | +---------+                             |           |  特定条件下提交offse    &lt;----------+</span><br><span class="line">                       |                                         |           |                       |          |</span><br><span class="line">                       |    +--------------------------------+   |           +-----------------------+          |</span><br><span class="line">                       |    |                                |   |                                              |</span><br><span class="line">                       | +--&gt;       spoutKafka(channel)      |   |                                              |</span><br><span class="line">                       | |  |        （有缓冲）                +-&gt;X+-------------------------+                    |</span><br><span class="line">                       | |  |                                |   |                         |                    |</span><br><span class="line">                       | |  +------------------------^-------+   |           +-------------v----------------+   |</span><br><span class="line">                       | |                           |           |           |-----------+                  |   |</span><br><span class="line">                       | |                           |           |           || 业务服务  |                  |   |</span><br><span class="line">                       | |                           |           |           +-----------+                  |   |</span><br><span class="line">+------------+         | |                           |           |           |                              |   |</span><br><span class="line">|            |         | |  +--------------------------------+   |           |      XXXXXXXXXXXXXXX         |   |</span><br><span class="line">|   kafka    +---------&gt;X+  | +-------+              |       |   |           |      X1.过滤的数据   X         |   |</span><br><span class="line">|            |         |    | | badge |              |       |   |           |      XXXXXXXXXXXXXXX         |   |</span><br><span class="line">+------------+         |    | +-------+     ^--------&gt;       |   |           |                              |   |</span><br><span class="line">                       |    |               |                |   |           |                              |   |</span><br><span class="line">                       |    |       +-------+------+         |   |           |      +---------------+       |   |</span><br><span class="line">                       |    |       |              &lt;-----------+X+------------------+2.失败的数据     |       |   |</span><br><span class="line">                       |    |       |  业务失败队列  |         |   |           |      +---------------+       |   |</span><br><span class="line">                       |    |       |              |         |   |           |                              |   |</span><br><span class="line">                       |    |       +--------------+         |   |           |                              |   |</span><br><span class="line">                       |    |                                |   |           |                              |   |</span><br><span class="line">                       |    |                                |   |           |     +------------------+     |   |</span><br><span class="line">                       |    +--------------------------------+   |           |     |3.正常处理完的数据   +---------&gt;</span><br><span class="line">                       |                                         |           |     +------------------+     |</span><br><span class="line">                       |                                         |           |                              |</span><br><span class="line">                       |                                         |           +------------------------------+</span><br><span class="line">                       |                                         |</span><br><span class="line">                       +-----------------------------------------+</span><br></pre></td></tr></table></figure><ul><li>每10s记录一次本地offset</li><li>接收到信号量（<code>SIGINT/SIGTERM</code>）到时候也提交一次</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收到信号量到时候也提交一次</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line">  signal.Notify(ch, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">  <span class="keyword">for</span> _ = <span class="keyword">range</span> ch &#123;</span><br><span class="line">    t.Stop()</span><br><span class="line">    logic.ackf.RLock()</span><br><span class="line">    <span class="keyword">for</span> _, partitionMessage := <span class="keyword">range</span> logic.acks &#123;</span><br><span class="line">      <span class="keyword">for</span> _,msg := <span class="keyword">range</span> partitionMessage &#123;</span><br><span class="line">        logic.Sk.Ack(msg)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    logic.ackf.RUnlock()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每10s记录一次本地offset</span></span><br><span class="line">t := time.NewTicker(<span class="number">10</span> * time.Second)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">      logic.ackf.RLock()</span><br><span class="line">      <span class="keyword">for</span> _, partitionMessage := <span class="keyword">range</span> logic.acks &#123;</span><br><span class="line">        <span class="keyword">for</span> _,msg := <span class="keyword">range</span> partitionMessage &#123;</span><br><span class="line">          logic.Sk.Ack(msg)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      logic.ackf.RUnlock()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 服务worker启动核心逻辑</span></span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">logic := <span class="built_in">new</span>(CoreLogic)</span><br><span class="line">logic.Sk = sk</span><br><span class="line">logic.acks = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">int32</span>]*kafka.Message&#123;&#125;</span><br><span class="line">logic.ackf = sync.RWMutex&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; config.AppConfig.Worker; &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">logic.Consume()</span><br><span class="line">&#125;()</span><br><span class="line">i++</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br></pre></td></tr></table></figure><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bussiness.go 的核心代码</span></span><br><span class="line"><span class="keyword">type</span> CoreLogic <span class="keyword">struct</span> &#123;</span><br><span class="line">Sk *msource.SpoutKafka</span><br><span class="line"></span><br><span class="line">ackf sync.RWMutex</span><br><span class="line">acks <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">map</span>[<span class="keyword">int32</span>]*kafka.Message</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(business *CoreLogic)</span> <span class="title">Consume</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// 从正常队列来的数据</span></span><br><span class="line"><span class="keyword">if</span> msg.TopicPartition.Topic != <span class="literal">nil</span> &#123;</span><br><span class="line">business.ackf.Lock()</span><br><span class="line"><span class="keyword">if</span> _, ok := business.acks[*msg.TopicPartition.Topic]; !ok &#123;</span><br><span class="line">business.acks[*msg.TopicPartition.Topic] = <span class="keyword">map</span>[<span class="keyword">int32</span>]*kafka.Message&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">business.acks[*msg.TopicPartition.Topic][msg.TopicPartition.Partition] = msg</span><br><span class="line">business.ackf.Unlock()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// 从失败队列来的数据，独立写入，独立Ack</span></span><br><span class="line">err = p.Write(fileName, <span class="keyword">string</span>(sinkBuffer))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Error(err)</span><br><span class="line">&#125;</span><br><span class="line">business.Sk.Ack(msg)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于我们的消费者需要从<code>msource</code>中把消息拉出来，所以设置了一个<code>Corelogic</code>的结构体，其中包含了 <code>sk</code>,<code>acks</code>,<code>ackf</code>三个属性。</p><blockquote><p>由于我们需要异步的提交offset，所以需要设置 ackf 的锁来确保数据的完整性</p></blockquote><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 读取消息的方式</span></span><br><span class="line"><span class="keyword">for</span> msg := <span class="keyword">range</span> business.Sk.MessageChan() &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>golang的格式化时间戳很奇葩，需要以<code>&quot;2006-01-02 15:04:05&quot;</code>为格式进行格式化。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// yyyy-MM-dd hh:mm:ss</span></span><br><span class="line"><span class="comment">// yyyy-MM-dd H:i:s</span></span><br><span class="line"></span><br><span class="line">jsonArray[<span class="string">"#time"</span>] = time.Unix(time.Now().Unix(), <span class="number">0</span>).Format(<span class="string">"2006-01-02 15:04:05"</span>)</span><br></pre></td></tr></table></figure><h2 id="msource"><a href="#msource" class="headerlink" title="msource"></a>msource</h2><p><code>msource</code>是<code>kafka</code>和<code>本地存储</code>的桥梁(通信服务)，间接得做着服务可靠性的保证。（数据不丢，不重，方便查看堵塞情况）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;mctl</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  mtga [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  clear_failure_queue 清空失败队列</span><br><span class="line">  failure_queue_count 失败队列数量</span><br><span class="line">  kafka_lag           消费阻塞</span><br><span class="line">  offset_checker      offset的情况</span><br></pre></td></tr></table></figure><p>以下命令都是msource提供出来的api，再由业务服务封装成命令</p><p>例如：offset_checker</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.---.----------------.-----------.------------.------------.------------.-----.</span><br><span class="line">| # |     Topic      | Partition |    Low     |    High    |  Current   | Lag |</span><br><span class="line">+---+----------------+-----------+------------+------------+------------+-----+</span><br><span class="line">| 0 | mulog_clean_24 | 0         | 6171720626 | 6197511755 | 6197511494 | 261 |</span><br><span class="line">| 1 | mulog_clean_24 | 1         | 6169152656 | 6197196879 | 6197196555 | 324 |</span><br><span class="line">| 2 | mulog_clean_24 | 2         | 6169656725 | 6195509715 | 6195509483 | 232 |</span><br><span class="line">| 3 | mulog_clean_24 | 3         | 6172416843 | 6197496752 | 6197496518 | 234 |</span><br><span class="line">| 4 | mulog_clean_24 | 4         | 6170706518 | 6197423974 | 6197423659 | 315 |</span><br><span class="line">| 5 | mulog_clean_24 | 5         | 6168091223 | 6196757252 | 6196756991 | 261 |</span><br><span class="line">&#39;---&#39;----------------&#39;-----------&#39;------------&#39;------------&#39;------------&#39;-----&#39;</span><br></pre></td></tr></table></figure><p>例如：kafka_lag/failure_queue_count</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1234</span><br></pre></td></tr></table></figure><p>msource如何做到由业务系统控制指定offset中消费呢？</p><p>我们还是通过了<code>badger</code>来存储各个topic-partition的offset。服务在启动的时候会取各个partition的offset，如果存在的话，就设置需要从对应的offset开始读取数据。如果不存在对应的offset的话，那么就根据你的策略从<code>最早</code>,<code>最近</code>开始选择拉取数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+-------------------+</span><br><span class="line">|---------+         |</span><br><span class="line">|| badger |         |</span><br><span class="line">+---------+         +---------------+</span><br><span class="line">|                   |               |</span><br><span class="line">|      offset存储   |               |</span><br><span class="line">|                   |               |</span><br><span class="line">+-------------------+     +---------v-------------+</span><br><span class="line">                          |                       |      +------------+</span><br><span class="line">                          |  从partition拉取数据    +-----+   。。。。。。|</span><br><span class="line">                          |                       |      +------------+</span><br><span class="line">                          +---------+-------------+</span><br><span class="line">                                    |</span><br><span class="line">                                    |</span><br><span class="line">+-------------------+               |</span><br><span class="line">|                   |               |</span><br><span class="line">|      Kafka        &lt;---------------+</span><br><span class="line">|                   |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure><p>msource的工作原理在介绍mtga的时候基本也差不多介绍完了。至于这些api的实现是基于<code>Unix Socket</code>实现的。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sk *SpoutKafka)</span> <span class="title">unixSocketListen</span><span class="params">()</span></span> &#123;</span><br><span class="line">start:</span><br><span class="line">lis, err := net.Listen(<span class="string">"unix"</span>, UNIX_SOCKET_FILE)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Info(<span class="string">"UNIX Domain Socket 创建失败，正在尝试重新创建 -&gt; "</span>, err)</span><br><span class="line">err = os.Remove(UNIX_SOCKET_FILE)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Info(<span class="string">"删除 sock 文件失败！程序退出 -&gt; "</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">goto</span> start</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">logbdev.Info(<span class="string">"创建 UNIX Domain Socket 成功"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sigs := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">signal.Notify(sigs, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">&lt;-sigs</span><br><span class="line"><span class="keyword">if</span> sk.SigTermCbNeed &#123;</span><br><span class="line">sk.SigTermCb(<span class="literal">true</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">lis.Close()</span><br><span class="line">os.Remove(UNIX_SOCKET_FILE)</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">invokeObjectMethod := <span class="function"><span class="keyword">func</span><span class="params">(conn net.Conn, object <span class="keyword">interface</span>&#123;&#125;, methodName <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">inputs := <span class="built_in">make</span>([]reflect.Value, <span class="built_in">len</span>(args))</span><br><span class="line"><span class="keyword">for</span> i, _ := <span class="keyword">range</span> args &#123;</span><br><span class="line">inputs[i] = reflect.ValueOf(args[i])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">intCb := <span class="function"><span class="keyword">func</span><span class="params">(v reflect.Value)</span></span> &#123;</span><br><span class="line">n, err := conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"%d\n"</span>, v.Int())))</span><br><span class="line"><span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">logbdev.Info(fmt.Sprintf(<span class="string">"Cmd: %s ,成功响应结果: %d"</span>, methodName, v.Int()))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Error(fmt.Sprintf(<span class="string">"Cmd: %s ,响应失败 %s"</span>, methodName, err))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">strCb := <span class="function"><span class="keyword">func</span><span class="params">(v reflect.Value)</span></span> &#123;</span><br><span class="line">n, err := conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"%s\n"</span>, v.String())))</span><br><span class="line"><span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">logbdev.Info(fmt.Sprintf(<span class="string">"Cmd: %s ,成功响应结果: %s"</span>, methodName, v.String()))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Error(fmt.Sprintf(<span class="string">"Cmd: %s ,响应失败 %s"</span>, methodName, err))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> reflect.ValueOf(object).MethodByName(methodName).Call(inputs) &#123;</span><br><span class="line"><span class="keyword">switch</span> v.Kind() &#123;</span><br><span class="line"><span class="keyword">case</span> reflect.Int:</span><br><span class="line"><span class="keyword">case</span> reflect.Int64:</span><br><span class="line">intCb(v)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">case</span> reflect.String:</span><br><span class="line">strCb(v)</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">_, err := conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"%s\n"</span>, <span class="string">"不支持的响应数据类型"</span>)))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">handleError(err.Error())</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">handle := <span class="function"><span class="keyword">func</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">var</span> buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>)</span><br><span class="line">n, err := conn.Read(buf)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果已经没数据了，则结束</span></span><br><span class="line"><span class="keyword">if</span> err == io.EOF &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Info(<span class="string">"Socket conn read error:"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cmd Cmd</span><br><span class="line"><span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</span><br><span class="line">err := json.Unmarshal(buf[:n], &amp;cmd)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">_, err := conn.Write([]<span class="keyword">byte</span>(fmt.Sprintf(<span class="string">"Rpc-Json解析失败, err: %s"</span>, err) + <span class="string">"\n"</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Warn(err)</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">invokeObjectMethod(conn, sk, cmd.RpcFuncName, cmd.Params...)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := lis.Accept()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">logbdev.Info(<span class="string">"请求接收错误 -&gt; "</span>, err)</span><br><span class="line"><span class="keyword">continue</span> <span class="comment">// 一个连接错误，不会影响整体的稳定性，忽略就好</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> handle(conn) <span class="comment">//开始处理数据</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之前在mtga中出现过一个问题，那就是rpc超时问题的问题（socket超时）。这个问题导致了我们在执行各种命令的时候，如果出现问题会一直<code>hang up</code>的状态，得不到结果的同时一直卡住。影响到了我们对服务的监控。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------------------------------+</span><br><span class="line">|   +-------------+                                        |</span><br><span class="line">|   |   msource   |                                        |</span><br><span class="line">|   +-------------+                                        |</span><br><span class="line">|                                                          |</span><br><span class="line">|   +---------------------+     +---------------------+    |</span><br><span class="line">|   |                     |     |                     |    |</span><br><span class="line">|   | unix socket server  |     | unix socket client  |    |</span><br><span class="line">|   |                     |     |                     |    |</span><br><span class="line">|   +---------------------+     +---------------------+    |</span><br><span class="line">+----------------------------------------------------------+</span><br></pre></td></tr></table></figure><p>为了解决这个问题。我们在<code>unix socket client</code> 这里加了一个超时的机制。借助是<code>context</code>的机制，实现协程之间的超时通信。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">TimeoutMsg = <span class="string">"操作超时, 请检查服务状态!"</span></span><br><span class="line">TimeoutInt = <span class="number">-1</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">rcn := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line">ctx, cancel := context.WithTimeout(context.Background(), time.Second*<span class="number">10</span>)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> exists(UNIX_SOCKET_FILE) &#123;</span><br><span class="line">    conn, err := net.Dial(<span class="string">"unix"</span>, UNIX_SOCKET_FILE)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      handleError(err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    rpc := Cmd&#123;RpcFuncName: <span class="string">"FailureQueueCount"</span>&#125;</span><br><span class="line">    data, err := json.Marshal(rpc)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      handleError(fmt.Sprintf(<span class="string">"encode-json失败"</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n, err := conn.Write(data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span> &amp;&amp; err == <span class="literal">nil</span> &#123;</span><br><span class="line">      reader := bufio.NewReader(conn)</span><br><span class="line">      msg, err := reader.ReadString(<span class="string">'\n'</span>)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        logbdev.Info(err)</span><br><span class="line">      &#125;</span><br><span class="line">      msg = msg[:<span class="built_in">len</span>(msg)-<span class="built_in">len</span>(<span class="string">"\n"</span>)]</span><br><span class="line">      lagInt, err := strconv.Atoi(msg)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        handleError(err.Error())</span><br><span class="line">      &#125;</span><br><span class="line">      lag = <span class="keyword">int64</span>(lagInt)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sk := SourceToolRun(configOpts)</span><br><span class="line">    lag = sk.FailureQueueCount()</span><br><span class="line">  &#125;</span><br><span class="line">  rcn &lt;- <span class="literal">true</span></span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">    <span class="keyword">if</span> ctx.Err() != <span class="literal">nil</span> &#123;</span><br><span class="line">      logbdev.Warn(ctx.Err())</span><br><span class="line">      <span class="keyword">return</span> TimeoutInt</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> lag</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">case</span> &lt;- rcn:</span><br><span class="line">    <span class="keyword">return</span> lag</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里需要注意的是，这个<code>context.WithTimeout</code> 是不管你内部是否处理完毕，一定会在指定的时间内<code>timeout</code>，所以如果提前完成了必须通过自己的手段提前结束。</p><h2 id="msink"><a href="#msink" class="headerlink" title="msink"></a>msink</h2><p>这个组件的作用主要是用于把指定的消息进行sink到各种<code>终端</code>，例如<code>msink_file</code>,<code>msink_kafka</code>等等。</p><p>目前我们是封装在同一个仓库中，以不同文件保存，后续，我们或许会考虑拆分开来便于维护发版。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">├── Dockerfile</span><br><span class="line">├── README.MD</span><br><span class="line">├── config.go</span><br><span class="line">├── config.yml</span><br><span class="line">├── config_test.go</span><br><span class="line">├── error.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── msource_spout.go</span><br><span class="line">├── msource_spout_test.go</span><br><span class="line">└── rpc.go</span><br></pre></td></tr></table></figure><p>这里主要和大家说以下<code>msink_file</code>吧，<code>msink_kafka</code>的实现原理差不多。</p><ul><li>支持自定义回调函数，判断是否写入成功</li><li>支持批处理和流式处理</li></ul><p>流式处理有独立的Api</p><ul><li><code>func (f *FileClient) WriteWithoutEol(filePath string, message string) error</code></li><li><code>func (f *FileClient) Write(filePath string, message string) error</code></li><li><code>(f *FileClient) BatchLineDataChannel() chan&lt;- map[Filename]ChannelMessage</code></li></ul><p>批处理的Api</p><ul><li><code>(f *FileClient) BatchLineDataChannel() chan&lt;- map[Filename]ChannelMessage</code></li></ul><p>可能细心的朋友已经发现了，流式处理的Api包含了批处理的Api。<br>是的，被包含在一起了，为什么会这样子？</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFileClient</span><span class="params">(client afero.Fs, opts ...DialOption)</span> *<span class="title">FileClient</span></span> &#123;</span><br><span class="line">p := <span class="built_in">new</span>(FileClient)</span><br><span class="line">p.client = client</span><br><span class="line">p.dopts = defaultOptions()</span><br><span class="line">p.batchLineDataChannel = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">map</span>[Filename]ChannelMessage, <span class="number">1000</span>)</span><br><span class="line">p.events = <span class="built_in">make</span>(<span class="keyword">chan</span> FileMetaMessage, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//循环调用opts</span></span><br><span class="line"><span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">opt.apply(&amp;p.dopts)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> writer <span class="function"><span class="keyword">func</span><span class="params">(fileClient *FileClient)</span></span></span><br><span class="line"><span class="keyword">if</span> p.dopts.batchWrite &#123;</span><br><span class="line">writer = channelBatchWriter</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">writer = channelWriter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">p.wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">writer(p)</span><br><span class="line">p.wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">p.wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">p.run()</span><br><span class="line">p.wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 流式</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelWriter</span><span class="params">(client *FileClient)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> m := <span class="keyword">range</span> client.batchLineDataChannel &#123;</span><br><span class="line"><span class="keyword">for</span> fn, msg := <span class="keyword">range</span> m &#123;</span><br><span class="line">err := client.WriteWithoutEol(<span class="keyword">string</span>(fn), <span class="keyword">string</span>(msg))</span><br><span class="line">client.events &lt;- FileMetaMessage&#123;Message: <span class="keyword">string</span>(msg), Error: err&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 批量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelBatchWriter</span><span class="params">(client *FileClient)</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> buffered = <span class="built_in">make</span>(<span class="keyword">map</span>[Filename][]ChannelMessage)</span><br><span class="line">bufferedCnt := <span class="number">0</span></span><br><span class="line">batchSize := client.dopts.batchLineDataChannelCount</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> m := <span class="keyword">range</span> client.batchLineDataChannel &#123;</span><br><span class="line"><span class="keyword">for</span> fn, msg := <span class="keyword">range</span> m &#123;</span><br><span class="line">buffered[fn] = <span class="built_in">append</span>(buffered[fn], msg)</span><br><span class="line">bufferedCnt++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">loop:</span><br><span class="line"><span class="keyword">for</span> <span class="literal">true</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> m, ok := &lt;-client.batchLineDataChannel:</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">break</span> loop</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> m == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"nil message received on batchLineDataChannel"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> fn, msg := <span class="keyword">range</span> m &#123;</span><br><span class="line">buffered[fn] = <span class="built_in">append</span>(buffered[fn], msg)</span><br><span class="line">bufferedCnt++</span><br><span class="line"><span class="keyword">if</span> bufferedCnt &gt; batchSize &#123;</span><br><span class="line"><span class="keyword">break</span> loop</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">break</span> loop</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tmpLongMsg = <span class="built_in">make</span>(<span class="keyword">map</span>[Filename]<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">for</span> Filename, ChannelMessageList := <span class="keyword">range</span> buffered &#123;</span><br><span class="line">tmpMsg := <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> _, cm := <span class="keyword">range</span> ChannelMessageList &#123;</span><br><span class="line">tmpMsg += <span class="keyword">string</span>(cm)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tmpLongMsg[Filename] = tmpMsg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> Filename, longMsg := <span class="keyword">range</span> tmpLongMsg &#123;</span><br><span class="line">err := client.WriteWithoutEol(<span class="keyword">string</span>(Filename), longMsg)</span><br><span class="line"><span class="keyword">for</span> _, ChannelMessageList := <span class="keyword">range</span> buffered &#123;</span><br><span class="line"><span class="keyword">for</span> _, cm := <span class="keyword">range</span> ChannelMessageList &#123;</span><br><span class="line">client.events &lt;- FileMetaMessage&#123;Message: <span class="keyword">string</span>(cm), Error: err&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">buffered = <span class="built_in">make</span>(<span class="keyword">map</span>[Filename][]ChannelMessage)</span><br><span class="line">bufferedCnt = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到这里大家应该也知道Api应该就可以理解为什么会被包含在一起了。</p><h2 id="logdev"><a href="#logdev" class="headerlink" title="logdev"></a>logdev</h2><p>这是我们的日志组件，在上面的代码中，多多少少已经有了这个组件的身影。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── exported.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── hooks</span><br><span class="line">│   ├── reporter</span><br><span class="line">│   │   ├── metl.go</span><br><span class="line">│   │   ├── reporter.go</span><br><span class="line">│   │   └── reporter_test.go</span><br><span class="line">│   └── stacker</span><br><span class="line">│       ├── stacker.go</span><br><span class="line">│       └── stacker_test.go</span><br><span class="line">├── logbdev.go</span><br><span class="line">├── logbdev_test.go</span><br><span class="line">├── logger.go</span><br><span class="line">├── mc_formatter.go</span><br></pre></td></tr></table></figure><p>常规设置，主要是我们在这个组件中添加了几个<code>hook</code>，分别是<code>reporter</code>,<code>stacker</code></p><ul><li><p>reporter （设置需要上报日志的级别，用于如果发现了<code>error</code>级别的错误就推送日志到我们的<code>告警服务</code>中。）</p></li><li><p>stacker （设置需要输出堆栈的级别日志级别）</p></li></ul><p>日志存储的方式有几种</p><ul><li><ol><li>常规的单日志存储</li></ol></li><li><ol start="2"><li>日志按照大小轮转</li></ol></li><li><ol start="3"><li>日志按照日期轮转</li></ol></li></ul><h2 id="commentjson"><a href="#commentjson" class="headerlink" title="commentjson"></a>commentjson</h2><p>这个是用来解析包含了<code>换行符</code>,<code>空白行</code>,<code>行注释</code>,<code>段注释</code>等等的<code>json</code>字符串</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── hjson.go</span><br><span class="line">├── hjson_test.go</span><br><span class="line">└── test.json</span><br></pre></td></tr></table></figure><p>这个原理也比较简单，就是一个个字符去匹配，重新构造出一个新的合法的json格式。里面的单元测试也做得比较完善了。</p><h2 id="go-graceful-daemon"><a href="#go-graceful-daemon" class="headerlink" title="go-graceful-daemon"></a>go-graceful-daemon</h2><p>这个组件是用来将服务变成守护进程用的。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">├── README.md</span><br><span class="line">├── daemon.<span class="keyword">go</span></span><br><span class="line">├── <span class="keyword">go</span>.mod</span><br><span class="line">├── <span class="keyword">go</span>.mod2</span><br><span class="line">├── signal.<span class="keyword">go</span></span><br><span class="line">└── test</span><br><span class="line">    └── test.<span class="keyword">go</span></span><br></pre></td></tr></table></figure><p>这里的核心主要是借助了<code>syscall</code>的<code>ForkExec</code>实现。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">forkDaemon</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">args := os.Args</span><br><span class="line">os.Setenv(<span class="string">"__Daemon"</span>, <span class="string">"true"</span>)</span><br><span class="line">procAttr := &amp;syscall.ProcAttr&#123;</span><br><span class="line">Env:   os.Environ(),</span><br><span class="line">&#125;</span><br><span class="line">pid, err := syscall.ForkExec(os.Args[<span class="number">0</span>], args, procAttr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">log.Printf(<span class="string">"[%d] %s start daemon\n"</span>, pid, AppName)</span><br><span class="line">savePid(pid)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并且支持自定实现信号量的捕捉处理逻辑</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ErrStop = errors.New(<span class="string">"stop serve signals"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SignalHandlerFunc <span class="function"><span class="keyword">func</span><span class="params">(sig os.Signal)</span> <span class="params">(err error)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetSigHandler</span><span class="params">(handler SignalHandlerFunc, signals ...os.Signal)</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, sig := <span class="keyword">range</span> signals &#123;</span><br><span class="line">handlers[sig] = handler</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServeSignals calls handlers for system signals.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ServeSignals</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">signals := <span class="built_in">make</span>([]os.Signal, <span class="number">0</span>, <span class="built_in">len</span>(handlers))</span><br><span class="line"><span class="keyword">for</span> sig := <span class="keyword">range</span> handlers &#123;</span><br><span class="line">signals = <span class="built_in">append</span>(signals, sig)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">8</span>)</span><br><span class="line">signal.Notify(ch, signals...)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> sig := <span class="keyword">range</span> ch &#123;</span><br><span class="line">err = handlers[sig](sig)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">signal.Stop(ch)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err == ErrStop &#123;</span><br><span class="line">err = <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> handlers = <span class="built_in">make</span>(<span class="keyword">map</span>[os.Signal]SignalHandlerFunc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">handlers[syscall.SIGINT] = sigtermDefaultHandler</span><br><span class="line">handlers[syscall.SIGTERM] = sigtermDefaultHandler</span><br><span class="line">handlers[syscall.SIGHUP] = sighupDefaultHandler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sigtermDefaultHandler</span><span class="params">(sig os.Signal)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">log.Printf(<span class="string">"[%d] %s stop graceful"</span>, os.Getpid(), AppName)</span><br><span class="line">log.Printf(<span class="string">"[%d] %s stopped."</span>, os.Getpid(), AppName)</span><br><span class="line">os.Remove(PidFile)</span><br><span class="line">os.Exit(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">return</span> ErrStop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sighupDefaultHandler</span><span class="params">(sig os.Signal)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">//only deamon时不支持kill -HUP,因为可能监听地址会占用</span></span><br><span class="line">log.Printf(<span class="string">"[%d] %s stopped."</span>, os.Getpid(), AppName)</span><br><span class="line">os.Remove(PidFile)</span><br><span class="line">os.Exit(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">return</span> ErrStop</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>目前内置了<code>SIGINT</code>,<code>SIGTERM</code>,<code>SIGHUP</code>的默认行为</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;早期，在我们的部门中后端的技术栈语言主要有三种语言，分别是&lt;code&gt;php/python/erlang&lt;/code&gt;，其中用于做服务的是 &lt;code&gt;php/erlang&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;在我们的体系中，日志采集服务体系目前都是用erlang写的，而php写的服务多是基于swoole写的一些基础服务。&lt;/p&gt;
&lt;p&gt;在tga服务中，我们需要从&lt;code&gt;kafka&lt;/code&gt; -&amp;gt; &lt;code&gt;服务&lt;/code&gt; -&amp;gt; &lt;code&gt;本地文件&lt;/code&gt;的模式。&lt;/p&gt;
&lt;p&gt;业务据流图如下：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------------------------------------------------------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|                                                               |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|                                                               |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       +---------------------------------------------+         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                             |         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                             |         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                  kafka服务                   |         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                             |         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                             |         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                             |         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       +----------------------+----------------------+         |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|                              |                                |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|                              |                                |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       +----------------------v-----------------------+        |                     +----------------------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                              |        |                     |                            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                              |        |                     |                            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                              |        |                     |                            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |               mthinkingdata服务               |        &amp;lt;---------------------+          logbus服务        |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                              |        |                     |                            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                              |        |                     |                            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                              |        |                     |                            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       +----------------------+-----------------------+        |                     +----------------------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|                              |                                |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|                              |                                |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       +----------------------v------------------------+       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                               |       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                               |       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                               |       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                   本地文件                     +-------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                               |       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                               |       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       |                                               |       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|       +-----------------------------------------------+       |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|                                                               |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------------------------------------------------------------+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;


&lt;p&gt;于是我们试探性的自研基于swoole的kafka客户端，我们自己实现根据kafka协议的封包，解包，流程处理。(&lt;code&gt;swoole-kafka&lt;/code&gt;)&lt;br&gt;&lt;code&gt;mthinkingdata服务&lt;/code&gt;就是我们基于&lt;code&gt;kafka-swoole&lt;/code&gt;研发的业务服务。&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;+------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|  message1  +------------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|            |            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+------------+            |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                          |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+------------+     +------+--------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|            |     |               |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|  message2  +-----+   snappy压缩   |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|            |     |               |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+------------+     +------+--------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;                           |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------------+          |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|               |          |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;| message[3..n] +----------+&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;|               |&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;+---------------+&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;在这个过程中，我们发现php对于cpu密集型的处理存在瓶颈，因为我们在生产者一方如果发送多条协议的情况下，会经过 &lt;code&gt;snappy&lt;/code&gt; 算法的压缩再推送以便减少network-io（增加cpu-io）。&lt;br&gt;消费者在接受消息的时候也是被压缩过的数据，所以我们需要解压，在这个解压的过程中，是个十分消费cpu的过程，即使我们当时是基于swoole4.3的协程版本来处理，&lt;br&gt;不行的是的抢占式协程当时并没有很好的完成，我们没办法达到快速的接受多个数据包的行为。消费速度也并不是特别理想。&lt;br&gt;在这个大环境下，我们还需要借助redis来作为中间的存储。而redis是单线程的，我们在这个过程中，试过使用&lt;code&gt;pipeline&lt;/code&gt;等手段减少tcp中的响应包的带来的性能损耗。但是由于redis只能利用单核的缘故，批量处理一批指令后，最高的cpu利用率接近100%下无法再增长。&lt;br&gt;也因此，我们的服务注定无法达到很好的性能测试。&lt;/p&gt;
&lt;p&gt;我们得出结论，当时服务的瓶颈在于：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;ol&gt;
&lt;li&gt;php语言本身的性能&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol start=&quot;2&quot;&gt;
&lt;li&gt;swoole协程不支持抢占式调度&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol start=&quot;3&quot;&gt;
&lt;li&gt;未实现动态伸缩扩展worker数量（感兴趣可以去看看kafka-swoole的架构分享）&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;&lt;ol start=&quot;4&quot;&gt;
&lt;li&gt;redis未能利用多核，cpu利用率达到峰值&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>【DevOps】Jenkins的share-libraries明朝的运用</title>
    <link href="http://blog.crazylaw.cn/2020/11/10/DevOps/Jenkins%E5%9C%A8%E6%98%8E%E6%9C%9D%E7%9A%84%E8%BF%90%E7%94%A8/"/>
    <id>http://blog.crazylaw.cn/2020/11/10/DevOps/Jenkins%E5%9C%A8%E6%98%8E%E6%9C%9D%E7%9A%84%E8%BF%90%E7%94%A8/</id>
    <published>2020-11-10T08:44:30.000Z</published>
    <updated>2021-03-20T16:25:01.798Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次我们不从Jenkins的部署架构和具体配置说明，我们主要围绕 <code>jenkinsfile</code> 的内部来讲解。</p><a id="more"></a><h2 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h2><p>目前我们的 jenkins 服务用过<code>普通的pipeline</code>和 <code>多分支的pipeline</code>，其主要区别就是<code>多分支pipeline</code>更加灵活一些，能够让我们少做一些逻辑处理。<br>但是这引入了一个问题，那就是我们的<code>jenkins</code>，必须存在与对应的分支中，也因此，pipeline 的流程变成了代码管理，并且由于我们存在多个项目，那么将会有<code>项目数 * 2(master/pre-develop)</code> 那么多的 jenkins 需要管理，于是就导致了我们有很多这种冗余的写法，这还不是最糟糕的，最糟糕的是如果我们需要修改一些通用的内容的时候，就需要一个个去修改，这绝对是灾难级别的需求。</p><p>Jenkinsfile的实现分为<code>2</code>种，分别是<code>声明式pipeline</code>和<code>脚本式pipeline</code>，这2种各有优缺点</p><p>jenkins需要做的事情，可以概括为如下几种：</p><ol><li>拉取代码</li><li>版本管理</li><li>单元测试</li><li>构建部署</li><li>通知结果</li></ol><h3 id="声明式pipeline"><a href="#声明式pipeline" class="headerlink" title="声明式pipeline"></a>声明式pipeline</h3><p>可以为我们提供<code>关键字</code> 和 <code>顺序结构</code>来辅助我们完成如上的5个阶段。</p><p>但是他的缺点也是明显的，就是<code>不能很灵活</code>根据自己的想法去做处理逻辑。</p><p>还有一种情况是比较蛋疼的，例如项目A和项目B，独立维护一个jenkinsfile，但是其实项目A和项目B的jenkinsfile其实是一致的，如果某一条要优化这个jenkinsfile的部署逻辑了。那么项目B和项目A都需要一起处理，无法实现<code>复用</code>的概念，并没有提供<code>抽象</code>的概念，不利于维护。</p><p>对于一些<code>相对简单，没有太复杂流程</code>的构建过程来说，声明式一定是大家的首要选择。</p><h3 id="脚本式pipeline"><a href="#脚本式pipeline" class="headerlink" title="脚本式pipeline"></a>脚本式pipeline</h3><p>可以给我们提供类似于写代码脚本的方式来组织部署逻辑，我把<code>脚本式pipeline</code>定义为<code>升级版的声明式pipeline</code>。</p><p>虽然脚本式的pipeline可以给我们提供灵活的部署逻辑，但是依旧无法解决我们的<code>复用</code>的问题。</p><p>我们需要把这种能<code>复用</code>的东西放在同一个地方进行统一管理，类似于<code>依赖库</code>的概念，独立与jenkinsfile之外的一种存在。于是乎，这便有了<code>jenkins-shard-libaray</code>。</p><h2 id="Jenkins-shard-libaray"><a href="#Jenkins-shard-libaray" class="headerlink" title="Jenkins-shard-libaray"></a>Jenkins-shard-libaray</h2><p>这是一个jenkins中的共享类库，只需要在jenkinsfile中对其引入，就可以引用共享库的代码，从而实现我们的<code>复用</code>。</p><p>但是有一点是这个共享库，需要我们储备点<code>groovy</code>语言的知识，因为他是用groovy作为”外挂”的方式加载运行的。</p><p>我们在写共享库的时候，<code>必须</code> 依照要有2个基本目录，否则jenkins无法类库。</p><ul><li>src (必要，核心代码)</li><li>vars (非必要，声明自己的语法)</li><li>resources (非必要，配置存放的目录)</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">├── Jenkinsfile.example                                   jenkinsfile的DEMO样式</span><br><span class="line">├── README.MD</span><br><span class="line">├── jars</span><br><span class="line">│   ├── groovy-cps-1.1.jar</span><br><span class="line">│   └── pipeline-model-definition-1.7.1.jar</span><br><span class="line">├── resources                                              配置文件和基础库分开管理了，所以这里不会存在静态资源文件</span><br><span class="line">├── src</span><br><span class="line">│   └── com</span><br><span class="line">│       └── company</span><br><span class="line">│           └── jenkins</span><br><span class="line">│               ├── BasePipeline.groovy                    基础管道</span><br><span class="line">│               ├── CommonPipeline.groovy                  公共管道</span><br><span class="line">│               ├── Constant.groovy                        常量类</span><br><span class="line">│               ├── Deploy.groovy                          部署基类</span><br><span class="line">│               ├── Git.groovy                             git相关的操作类</span><br><span class="line">│               ├── GolangPipeline.groovy                  golang项目管道</span><br><span class="line">│               ├── LaravelPipeline.groovy                 laravel项目管道</span><br><span class="line">│               ├── MPipeline.groovy                       初始化类</span><br><span class="line">│               ├── MetlNotify.groovy                      用于发送通知的类</span><br><span class="line">│               ├── Repo.groovy                            用于实例化代码仓库信息</span><br><span class="line">│               ├── SummaryNotify.groovy                   用于结构化通知内容的类</span><br><span class="line">│               └── deployments                            具体的部署类</span><br><span class="line">│                   ├── AbstractDeployment.groovy          抽象部署类</span><br><span class="line">│                   ├── BaseDeployment.groovy              基础部署类</span><br><span class="line">│                   ├── DefaultDeployment.groovy           默认部署类</span><br><span class="line">│                   └── GolangDeployment.groovy            Go部署类</span><br><span class="line">├── tests                                                  单元测试目录</span><br><span class="line">│   ├── RepoTest.groovy</span><br><span class="line">│   └── classfiles</span><br><span class="line">│       └── com</span><br><span class="line">│           └── company</span><br><span class="line">│               └── jenkins</span><br><span class="line">│                   ├── Constant.class</span><br><span class="line">│                   ├── Git.class</span><br><span class="line">│                   ├── MPipeline.class</span><br><span class="line">│                   ├── MetlNotify.class</span><br><span class="line">│                   ├── Repo.class</span><br><span class="line">│                   └── SummaryNotify.class</span><br><span class="line">└── vars                                                   全局函数定义目录</span><br><span class="line">    ├── mpipeline.groovy                                   自定义入口语法糖</span><br><span class="line">    └── notify.groovy                                      定义通知全局调用函数</span><br></pre></td></tr></table></figure><h3 id="Jenkinsfile-1"><a href="#Jenkinsfile-1" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mpipeline&#123;</span><br><span class="line">    script&#x3D;this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import com.company.jenkins.LaravelPipeline</span><br><span class="line">def laravelPipeline &#x3D; new LaravelPipeline(this)</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    laravelPipeline.preBuild().build().debug().reviews().production().execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这是一个最基本的jenkinsfile的demo。我们把他分为2个部分。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 第一部分</span><br><span class="line">mpipeline&#123;</span><br><span class="line">    script&#x3D;this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 第二部分</span><br><span class="line">import com.company.jenkins.LaravelPipeline</span><br><span class="line">def laravelPipeline &#x3D; new LaravelPipeline(this)</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    laravelPipeline.preBuild().build().debug().reviews().production().execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这2个部分各司其职。</p><p>第一部分 <code>mpipeline</code> 的语法糖，来自于我们<code>vars/mpipeline.groovy</code>文件，这是我们自定义的语法糖。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import com.company.jenkins.*</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> *</span><br><span class="line"> * @param body</span><br><span class="line"> *      repo 代码仓库地址 default: null</span><br><span class="line"> *      autoCheckout 是否需要自动checkout代码，default: true</span><br><span class="line"> * @return</span><br><span class="line"> *&#x2F;</span><br><span class="line">def call(body) &#123;</span><br><span class="line">    def config &#x3D; [:]</span><br><span class="line">    body.resolveStrategy &#x3D; Closure.DELEGATE_FIRST</span><br><span class="line">    body.delegate &#x3D; config</span><br><span class="line">    body()</span><br><span class="line"></span><br><span class="line">    config.repo &#x3D; config.repo ?: null</span><br><span class="line">    config.script &#x3D; config.script ?: null</span><br><span class="line">    config.autoCheckout &#x3D; config.autoCheckout ?: true</span><br><span class="line"></span><br><span class="line">    if (config.script &#x3D;&#x3D; null) &#123;</span><br><span class="line">        throw new Exception(&quot;&lt;script&#x3D;this&gt;是必填参数&quot;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (config.repo &#x3D;&#x3D; null) &#123;</span><br><span class="line">        config.repo &#x3D;  config.script.scm.getUserRemoteConfigs()[0].getUrl()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line">        def mpipe &#x3D; new MPipeline(config.script, config.repo)</span><br><span class="line">        mpipe.initializeResources()</span><br><span class="line">        def credentialsId &#x3D; config.credentialsId ?: config.script.gitCredentialsId</span><br><span class="line"></span><br><span class="line">        if (config.autoCheckout) &#123;</span><br><span class="line">            stage(&quot;Checkout&quot;) &#123;</span><br><span class="line">                &#x2F;&#x2F; git clone repo</span><br><span class="line">                git credentialsId: credentialsId, url: mpipe.repo.getGitLink(), branch: env.BRANCH_NAME</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mpipe.initializeEnvironment()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个语法糖做的内容定义了 <code>mpipeline</code> 做的内容，其中有三个有效参数 <code>repo</code>, <code>script</code>, <code>autoCheckout</code>，分别的意思是代表<code>该任务下的操作仓库地址</code>，<code>当前任务上下文</code>, <code>是否自动拉取代码</code>。其中 <code>script</code>参数为必填参数，其他2个都是选填参数，其都存在默认值。这个<code>script</code>必填的原因是因为一定要从jenkinsfile把对象传递进来，否则作用域有所不同。因为我们在第二部分要把这个对象继续传递下去，因为他携带了贯穿整个任务的上下文。</p><p>我们这里看到了 <code>node</code> 结构块，这是因为在<code>脚本式pipeline</code>中，他其实也是jenkins内置的一个自定义语法糖，所以他可以直接被嵌入在我们的代码中。因为我们这里实例化了共享库中的<code>Mpipeline类</code>，所以需要在 <code>node</code> 结构块中编写代码。</p><p>在这一块，我们可以看到，我们做了3件事</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+--------------------------------------+                +--------------------------------+              +----------------------------------------------------+</span><br><span class="line">|                                      |                |                                |              |                                                    |</span><br><span class="line">|  1. Initialize the custom resource   +---------------&gt;+   2. Pull the warehouse code   +-------------&gt;+   3. Initialize the custom environment variable    |</span><br><span class="line">|                                      |                |                                |              |                                                    |</span><br><span class="line">+--------------------------------------+                +--------------------------------+              +----------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li><p>初始化自定义资源（接下来要说的resource-libaray共享库）</p></li><li><p>拉取仓库代码（这是jenkins自带的一个git插件，调用git函数，加上一些参数，就会拉取代码到一个目录，如果目录不存在，则会创建）</p></li><li><p>初始化自定义环境变量</p></li></ul><p>初始化自定义资源的代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化资源库</span><br><span class="line"> *&#x2F;</span><br><span class="line">def initializeResources() &#123;</span><br><span class="line">    this.script.mresource_load([</span><br><span class="line">            script: this.script,</span><br><span class="line">            groupRepo: this.getRepoGroupRepo(),</span><br><span class="line">            shortJobName: this.getShortName(),</span><br><span class="line">            host: this.getHost()</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里，我们可以看到我们通过上下文变量，调用了 <code>mresource_load</code> 函数，这个是我们在 <code>resource-libaray共享库</code> 定义的函数，用于加载对应仓库的具体资源配置用，相关参数依旧会加载到上下文之中。</p><p>自定义环境变量部分代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 初始化环境变量</span><br><span class="line"> *&#x2F;</span><br><span class="line">def initializeEnvironment() &#123;</span><br><span class="line">    this.initBaseEnv().initEnvDependGit().initEnvDependRepo()</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def initBaseEnv() &#123;</span><br><span class="line">    &#x2F;&#x2F; SHORT_JOB_NAME</span><br><span class="line">    this.script.env.SHORT_JOB_NAME &#x3D; this.getShortName()</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 是否仅仅显示stage节点而不执行内容</span><br><span class="line">    this.script.mStageShow &#x3D; false</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def initEnvDependGit() &#123;</span><br><span class="line">    &#x2F;&#x2F; COMMIT_ID</span><br><span class="line">    this.script.env.COMMIT_ID &#x3D; this.git.commitId()</span><br><span class="line">    &#x2F;&#x2F; COMMIT_AUTHOR</span><br><span class="line">    this.script.env.COMMIT_AUTHOR &#x3D; this.git.commitAuthor()</span><br><span class="line">    &#x2F;&#x2F; COMMIT_TIME</span><br><span class="line">    this.script.env.COMMIT_TIME &#x3D; this.git.commitTime()</span><br><span class="line">    &#x2F;&#x2F; COMMIT_COMMENT</span><br><span class="line">    this.script.env.COMMIT_COMMENT &#x3D; this.git.commitMessage()</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def initEnvDependRepo() &#123;</span><br><span class="line">    &#x2F;&#x2F; REPO</span><br><span class="line">    this.script.env.REPO &#x3D; this.repo.getRepo()</span><br><span class="line">    &#x2F;&#x2F; REPOSITORY</span><br><span class="line">    this.script.env.REPOSITORY &#x3D; this.repo.getFullRepoString()</span><br><span class="line">    &#x2F;&#x2F; Notify</span><br><span class="line">    this.script.env.COMMIT_ID_PATH &#x3D; this.repo.getCommitIdHostPath()</span><br><span class="line">    &#x2F;&#x2F; REPOSITORY_LINK</span><br><span class="line">    this.script.env.REPOSITORY_LINK &#x3D; this.repo.getGitLink()</span><br><span class="line">    &#x2F;&#x2F; REPOSITORY_GROUP</span><br><span class="line">    this.script.env.REPOSITORY_GROUP &#x3D; this.repo.getGroup()</span><br><span class="line">    &#x2F;&#x2F; REPOSITORY_GROUP_REPO</span><br><span class="line">    this.script.env.REPOSITORY_GROUP_REPO &#x3D; this.getRepoGroupRepo()</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个，我们把环境变量也拆分封装到对应的方法了，分别是git相关的环境变量和仓库信息的环境变量等等。</p><p>接下来，我们看下 <code>第二部分</code> 的代码。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 第二部分</span><br><span class="line">import com.company.jenkins.LaravelPipeline</span><br><span class="line">def laravelPipeline &#x3D; new LaravelPipeline(this)</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    laravelPipeline.preBuild().build().testing().debug().reviews().production().execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里，我们import进来了Laravel的具体实现管道，并且实例化这个对象，传入了当前上下文对象。</p><p>并且在下面的node结构中，调用laravelpipeline对象的相关封装方法。</p><p>经过我们对部署流程的抽象和统一，我们的部署流程大致分为 <code>5个阶段</code>。分别如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">+-----------------------------+</span><br><span class="line">|  1. Pre-construction phase  |</span><br><span class="line">+------------+----------------+</span><br><span class="line">             |</span><br><span class="line">             |             +-----------------------+</span><br><span class="line">             +------------&gt;+2. Construction phase  +------------------+</span><br><span class="line">                           +-----------------------+                  |</span><br><span class="line">                                                                      |</span><br><span class="line">                                                                      |</span><br><span class="line">                                                +---------------------v-----------------------------+</span><br><span class="line">                                        +-------+3. Deployment development environment phase (Debug)|</span><br><span class="line">                                        |       +---------------------------------------------------+</span><br><span class="line">                                        |</span><br><span class="line">                                        v</span><br><span class="line">                           +------------+---------------------------------------+</span><br><span class="line">             +-------------+4. Grayscale Environment Deployment Stage（ reviews） |</span><br><span class="line">             |             +----------------------------------------------------+</span><br><span class="line">             |</span><br><span class="line">+------------v----------------------------------------------+</span><br><span class="line">| 5. Deployment of production environment phase（ prodution） |</span><br><span class="line">+-----------------------------------------------------------+</span><br></pre></td></tr></table></figure><ul><li>预构建阶段</li><li>构建阶段</li><li>部署开发环境阶段（debug）</li><li>部署灰度环境阶段（reviews）</li><li>部署生产环境阶段（production）</li></ul><p>因此，我们把所有的仓库jenkinsfile都按照这样子的不是来写，这样子就可以做到，当我们需要修改部署的内容的时候，代码仓库的jenkinsfile不需要做任务变动，只需要修改我们的共享库即可。</p><p>部分代码如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">def preBuild() &#123;</span><br><span class="line">    def callback &#x3D; &#123;</span><br><span class="line">        this.startNotify()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def apiName &#x3D; &#39;preBuild&#39;</span><br><span class="line">    this.addCallback(apiName, callback)</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def build(isParallel &#x3D; true) &#123;</span><br><span class="line">    def callback &#x3D; &#123;</span><br><span class="line">        this.script.stage(&#39;Build&#39;) &#123;</span><br><span class="line">            if (isParallel) &#123;</span><br><span class="line">                def stages &#x3D; [failFast: true]</span><br><span class="line"></span><br><span class="line">                stages[&quot;Composer Install&quot;] &#x3D; this.composerInstall()</span><br><span class="line">                stages[&quot;Client Build&quot;] &#x3D; this.clientBuild()</span><br><span class="line">                this.script.parallel stages</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.composerInstall()()</span><br><span class="line">                this.clientBuild()()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def apiName &#x3D; &#39;build&#39;</span><br><span class="line">    this.addCallback(apiName, callback)</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里看到，我们几乎所有的代码都会通过回调函数来编写的，所以，我们在实际调用的时候，必须加上 <code>execute()</code> 方法来实际触发链式过程。</p><p>因为在我们这个例子中，laravel是php的项目，默认情况下，我们是有前端和后端的代码。分别是<code>composer依赖</code>，<code>npm依赖</code>。</p><p>由于这2个部分的依赖，他们是没有相关性的，所以，我们在设计上，默认是支持 <code>并发</code> 执行的，所以我们这里调用了jenkins的一个内置函数 <code>parallel</code>来实现并发。实际效果如下展示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">                          +-----------------------+</span><br><span class="line">                          | +------------------+  |</span><br><span class="line">                          | | Composer Install |  |</span><br><span class="line">                          | +------------------+  |</span><br><span class="line">                          |                       |</span><br><span class="line">                          |                       |</span><br><span class="line">+----------------+        |                       |</span><br><span class="line">|   pre-build    +-------&gt;+        build          |</span><br><span class="line">+----------------+        |                       |</span><br><span class="line">                          |                       |</span><br><span class="line">                          |                       |</span><br><span class="line">                          | +------------------+  |</span><br><span class="line">                          | | Client Build     |  |</span><br><span class="line">                          | +------------------+  |</span><br><span class="line">                          |                       |</span><br><span class="line">                          +-----------------------+</span><br></pre></td></tr></table></figure><p>以npm依赖安装为例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public npmInstall(def packageFile &#x3D; &#39;client&#x2F;package.json&#39;, def clientDir &#x3D; &#39;client&#39;, def version &#x3D; &#39;latest&#39;) &#123;</span><br><span class="line">    def md5File &#x3D; &quot;$&#123;packageFile&#125;.md5&quot;</span><br><span class="line">    def callback &#x3D; &#123; isChange -&gt;</span><br><span class="line">        this.script.echo &quot;package.json是否有变化:$&#123;isChange&#125;&quot;</span><br><span class="line">        this.script.echo &quot;是否强制编译前端资源:$&#123;this.script.params.isBuild&#125;&quot;</span><br><span class="line">        if (isChange || this.script.params.isBuild) &#123;</span><br><span class="line">            this.script.docker.image(&quot;jenkins_docker_node:$&#123;version&#125;&quot;).inside(&#39;--dns-opt&#x3D;ndots:5 -v $HOME&#x2F;.npm:&#x2F;root&#x2F;.npm&#39;) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    this.checkChangeFile(packageFile, md5File, callback)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>另外在composer和npm依赖安装的过程中，我们做了一些细节上的优化，例如，我们会检测<code>package.json</code>以及<code>composer.json</code>，如果这2个文件没有变化的话，则不会更新依赖。避免了每次构建都需要去检查更新依赖包。<br>另外由于我们的jenkisn环境本身也是一个jenkins的docker容器，所以我们的jenkins环境下是不会存在<code>php</code>以及<code>node</code>的环境，所以我们这个时候，在安装依赖的时候，借助了上下文中的 <code>docker.image</code> 关键字来构建一个容器来触发我们的依赖安装。</p><p>接下来就是部署相关的内容了，我们以部署 <code>production</code> 环境来举例子</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">def production(def map &#x3D; [</span><br><span class="line">        sshId      : null,</span><br><span class="line">        deployClass: null</span><br><span class="line">]) &#123;</span><br><span class="line">    def callback &#x3D; &#123;</span><br><span class="line">        if (map[&#39;sshId&#39;] &#x3D;&#x3D; null) &#123;</span><br><span class="line">            map[&#39;sshId&#39;] &#x3D; this.getValue(&#39;deploySshId&#39;)</span><br><span class="line">        &#125;</span><br><span class="line">        if (map[&#39;deployClass&#39;] &#x3D;&#x3D; null) &#123;</span><br><span class="line">            map[&#39;deployClass&#39;] &#x3D; this.getDeployClass()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        map[&#39;pipeline&#39;] &#x3D; this</span><br><span class="line"></span><br><span class="line">        this.deploy.production(map)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def apiName &#x3D; &#39;production&#39;</span><br><span class="line">    this.addCallback(apiName, callback)</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果不指定 <code>sshId</code> 和 <code>deployClass</code> 的话，都会存在默认值。由于我们整个过程都是通过回调的方式调用的（其实类似于中间件），所以我们这里的多了一个 <code>map[pipeline] = this</code> 的代码，意义在于把当前上下文传递进具体的部署类。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">def production(def map &#x3D; [</span><br><span class="line">        sshId      : null,</span><br><span class="line">        deployClass: null,</span><br><span class="line">        pipeline   : null</span><br><span class="line">]) &#123;</span><br><span class="line"></span><br><span class="line">    def keyword &#x3D; &#39;production&#39;</span><br><span class="line">    this.script.stage(&#39;Production Deploy&#39;) &#123;</span><br><span class="line">        if (this.git.isMasterBranch() &amp;&amp; this.script.currentResources[keyword].enabled !&#x3D; false) &#123;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; 注入参数</span><br><span class="line">            def tags &#x3D; this.git.tagsList()</span><br><span class="line"></span><br><span class="line">            def buildParameters &#x3D; [</span><br><span class="line">                    [</span><br><span class="line">                            &#39;$class&#39;    : &#39;ChoiceParameter&#39;,</span><br><span class="line">                            choiceType  : &#39;PT_SINGLE_SELECT&#39;,</span><br><span class="line">                            description : &#39;&#39;&#39;</span><br><span class="line">选择构建类型：</span><br><span class="line">auto_deploy - 自动发布（直接发布最新代码）        </span><br><span class="line">deploy - 指定版本发布</span><br><span class="line">rollback - 版本回滚发布</span><br><span class="line">&#39;&#39;&#39;,</span><br><span class="line">                            filterLength: 1,</span><br><span class="line">                            filterable  : false,</span><br><span class="line">                            name        : &#39;buildType&#39;,</span><br><span class="line">                            randomName  : &#39;choice-parameter-69483043309720&#39;,</span><br><span class="line">                            script      : [</span><br><span class="line">                                    &#39;$class&#39;      : &#39;GroovyScript&#39;,</span><br><span class="line">                                    fallbackScript: [</span><br><span class="line">                                            classpath: [],</span><br><span class="line">                                            sandbox  : true,</span><br><span class="line">                                            script   : &#39;return[&quot;unknow&quot;]&#39;</span><br><span class="line">                                    ],</span><br><span class="line">                                    script        : [</span><br><span class="line">                                            classpath: [],</span><br><span class="line">                                            sandbox  : true,</span><br><span class="line">                                            script   : &#39;return[&quot;auto_deploy&quot;, &quot;deploy&quot;, &quot;rollback&quot;]&#39;,</span><br><span class="line">                                    ]</span><br><span class="line">                            ]</span><br><span class="line">                    ],</span><br><span class="line">                    [</span><br><span class="line">                            &#39;$class&#39;    : &#39;ChoiceParameter&#39;,</span><br><span class="line">                            choiceType  : &#39;PT_SINGLE_SELECT&#39;,</span><br><span class="line">                            description : &#39;&#39;&#39;</span><br><span class="line">选择Tag标签：</span><br><span class="line">auto_deploy时该参数无效</span><br><span class="line">&#39;&#39;&#39;,</span><br><span class="line">                            filterLength: 20,</span><br><span class="line">                            filterable  : true,</span><br><span class="line">                            name        : &#39;buildTag&#39;,</span><br><span class="line">                            randomName  : &#39;choice-parameter-69483043309721&#39;,</span><br><span class="line">                            script      : [</span><br><span class="line">                                    &#39;$class&#39;      : &#39;GroovyScript&#39;,</span><br><span class="line">                                    fallbackScript: [</span><br><span class="line">                                            classpath: [],</span><br><span class="line">                                            sandbox  : true,</span><br><span class="line">                                            script   : &#39;return[&quot;unknow&quot;]&#39;</span><br><span class="line">                                    ],</span><br><span class="line">                                    script        : [</span><br><span class="line">                                            classpath: [],</span><br><span class="line">                                            sandbox  : true,</span><br><span class="line">                                            script   : &quot;return [$&#123;tags&#125;]&quot;,</span><br><span class="line">                                    ]</span><br><span class="line">                            ]</span><br><span class="line">                    ]</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">            if (!this.script.mStageShow) &#123;</span><br><span class="line">                this.script.notify &#39;请确认是否发布到生产环境？&#39;</span><br><span class="line"></span><br><span class="line">                this.script.timeout(time: 10, unit: &#39;MINUTES&#39;) &#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        this.script.input &#39;请确认是否要发布到生产环境？&#39;</span><br><span class="line">                    &#125; catch (e) &#123;</span><br><span class="line">                        map[&#39;pipeline&#39;].parameters +&#x3D; buildParameters</span><br><span class="line">                        throw e</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    def updateHistoryFile &#x3D; &#39;UPDATE_HISTORY&#39;</span><br><span class="line">                    def currentTag</span><br><span class="line"></span><br><span class="line">                    if (this.script.params.buildType &#x3D;&#x3D; &#39;deploy&#39; || this.script.params.buildType &#x3D;&#x3D; &#39;rollback&#39;) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 发布指定tag</span><br><span class="line">                        this.script.sh &quot;git checkout $&#123;this.script.params.buildTag&#125;&quot;</span><br><span class="line">                        this.script.currentBuild.description &#x3D; &quot;【指定发布】Tag: $&#123;this.script.params.buildTag&#125;&quot;</span><br><span class="line">                        if (this.script.params.buildType &#x3D;&#x3D; &#39;rollback&#39;) &#123;</span><br><span class="line">                            this.script.currentBuild.description &#x3D; &quot;【回滚】Tag: $&#123;this.script.params.buildTag&#125;&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                        currentTag &#x3D; this.script.params.buildTag</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        &#x2F;&#x2F; 开始打tag</span><br><span class="line">                        ...</span><br><span class="line">                            try &#123;</span><br><span class="line">                                def tagRes</span><br><span class="line">                                if (link.startsWith(&quot;http&quot;)) &#123;</span><br><span class="line">                                    &#x2F;&#x2F; gitbucket</span><br><span class="line">                                    ...</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125; else &#123;</span><br><span class="line">                                    &#x2F;&#x2F; gitlab</span><br><span class="line">                                    ...</span><br><span class="line">                                &#125;</span><br><span class="line">                                if (tagRes[&#39;exitCode&#39;] &gt; 0 &amp;&amp; !tagRes[&#39;stdout&#39;].contains(&#39;already exists&#39;)) &#123;</span><br><span class="line">                                    throw new Exception(tagRes[&#39;stdout&#39;])</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; catch (e) &#123;</span><br><span class="line">                                throw e</span><br><span class="line">                            &#125;</span><br><span class="line">                            this.script.sh &quot;tee $&#123;preCommitIdFile&#125; &lt;&lt;&lt; $&#123;this.git.commitId()&#125;&quot;</span><br><span class="line"></span><br><span class="line">                            currentTag &#x3D; nextTag</span><br><span class="line"></span><br><span class="line">                            &#x2F;&#x2F; 最新tag加入下拉框</span><br><span class="line">                            buildParameters[1][&#39;script&#39;][&#39;script&#39;][&#39;script&#39;] &#x3D; &quot;return [\&quot;$&#123;currentTag&#125;\&quot;,$&#123;tags&#125;]&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ...</span><br><span class="line">                    this.script.currentBuild.description &#x3D; &quot;【自动发布】Tag: $&#123;currentTag&#125;&quot;</span><br><span class="line">                    this.publishDeployment(keyword)(map[&#39;sshId&#39;], map[&#39;deployClass&#39;])</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                this.script.echo &#39;Production Deploy Show&#39;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            map[&#39;pipeline&#39;].parameters +&#x3D; buildParameters</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            Utils.markStageSkippedForConditional(this.script.env.STAGE_NAME)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return this</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里，我们再说明一下我们的自动化流程。</p><ul><li><ol><li>提交feature代码</li></ol></li><li><ol start="2"><li>合并到pre-develop分支，触发jenkins任务构建更新debug环境代码</li></ol></li><li><ol start="3"><li>最终合并到master分支，触发jenkins任务，如果代码有变化则对最新的master代码进行打tag，构建更新production环境代码</li></ol></li></ul><p>基于以上几点，我们就可以很直观的看到部署production类的时候，我们会检测master的代码，如果存在变化则进行打tag。然后再调用具体的部署逻辑。其中 <code>this.script.currentResources[keyword].enabled</code> 是来自于我们的 <code>resource-libaray</code> 的配置。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">abstract class AbstractDeployment &#123;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 打包逻辑</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    abstract def parallelBefore(def packFiles, def packExclude)</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 并行逻辑</span><br><span class="line">     * @param ip</span><br><span class="line">     * @param port</span><br><span class="line">     * @param directory</span><br><span class="line">     * @return</span><br><span class="line">     *&#x2F;</span><br><span class="line">    abstract def parallel(def ip, def port, def directory, def backupExclude)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们的抽象具体部署类存在2个必须实现的抽象方法，分别是 <code>parallelBefore</code>, <code>parallel</code>。</p><ul><li>parallelBefore：并发部署前做的事情</li><li>parallel：并发部署到多台目标机器上</li></ul><h2 id="resources-libraries"><a href="#resources-libraries" class="headerlink" title="resources-libraries"></a>resources-libraries</h2><p>资源共享库</p><p>对外提供一个全局的函数 <code>mresource_load</code>，内部提供给上下文关键字拿到当前项目，当前环境的对应的部署内容信息。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">├── README.MD</span><br><span class="line">├── resources</span><br><span class="line">│   ├── git.xxxx.com</span><br><span class="line">│   │   ├── repo-group1</span><br><span class="line">│   │   │   ├── a.yaml</span><br><span class="line">│   │   │   └── b.yaml</span><br><span class="line">│   │   └── repo-group2</span><br><span class="line">│   │       └── c.yaml</span><br><span class="line">│   └── gitlab.xxx.com</span><br><span class="line">│       ├── repo-group3</span><br><span class="line">│       │   ├── d.yaml</span><br><span class="line">│       │   └── e.yaml</span><br><span class="line">│       └── repo-group4</span><br><span class="line">│           ├── f.yaml</span><br><span class="line">│           └── g.yaml</span><br><span class="line">├── tests</span><br><span class="line">│   └── test_mresource_load.groovy</span><br><span class="line">└── vars</span><br><span class="line">    └── mresource_load.groovy</span><br></pre></td></tr></table></figure><p>我们看到我们的基本结构和上一个 <code>jenkins-shard-libraries</code> 十分的类似，区别在于 <code>resources-libraries</code> 不存在 <code>src</code> 目录，但是 <code>resources</code> 全部都存在资源配置。</p><p>资源存放的目录，结构目录规则为 <code>&lt;FQDN&gt;/&lt;group&gt;/&lt;repo&gt;</code>，对应git仓库。</p><p>资源库采用<code>yaml</code>格式。目前支持的key有：</p><ul><li><p>type(normal|job_name)</p><ul><li>normal   常规项目，不区分项目</li><li>job_name 区分项目，一套仓库，多个项目区分部署</li></ul></li><li><p>debug 内测环境</p><ul><li>address   ip:port</li><li>directory 代码目录路径</li><li>deploy_ssh_id 部署的凭证</li><li>execute_user 执行的用户，目前仅仅在GolangPipline有效</li><li>ssh_username 部署代码的ssh的账号，目前在GolangPipline仅调试用</li></ul></li><li><p>reviews 灰度环境</p><ul><li>enabled:  false  跳过reviews步骤</li><li>address   ip:port</li><li>directory 代码目录路径</li><li>deploy_ssh_id 部署的凭证</li><li>execute_user 执行的用户，目前仅仅在GolangPipline有效</li><li>ssh_username 部署代码的ssh的账号，目前在GolangPipline仅调试用【非必填，默认采用deploy_ssh_id的信息】</li></ul></li><li><p>production 生产环境</p><ul><li>address   ip:port</li><li>directory 代码目录路径</li><li>deploy_ssh_id 部署的凭证</li><li>branch    生产环境对应的分支 【非必填】</li><li>execute_user 执行的用户，目前仅仅在GolangPipline有效【非必填】</li><li>ssh_username 部署代码的ssh的账号，目前在GolangPipline仅调试用【非必填，默认采用deploy_ssh_id的信息】</li></ul></li></ul><p>附加在上下文的变量：</p><ul><li>script.currentResources</li><li>script.gitCredentialsId</li><li>script.buildCredentialsId</li></ul><p>具体的yaml配置格式的demo</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">type: &#39;normal&#39;</span><br><span class="line"></span><br><span class="line">git_credentials_id: &#39;git_credentials_id&#39;</span><br><span class="line"></span><br><span class="line">common: &amp;common</span><br><span class="line">  deploy_ssh_id: &#39;deploy_ssh_id&#39;</span><br><span class="line"></span><br><span class="line">environment:</span><br><span class="line">  debug:</span><br><span class="line">    &lt;&lt;: *common</span><br><span class="line">    address:</span><br><span class="line">      - &#39;2.2.2.2:22&#39;</span><br><span class="line">      - &#39;1.1.1.1:22&#39;</span><br><span class="line">    directory:</span><br><span class="line">      &#39;2.2.2.2:22&#39;: &#39;&#x2F;a&#39;</span><br><span class="line">      &#39;1.1.1.1:22&#39;: &#39;&#x2F;b&#39;</span><br><span class="line"></span><br><span class="line">  reviews:</span><br><span class="line">    &lt;&lt;: *common</span><br><span class="line">    address: &#39;3.3.3.3:22&#39;</span><br><span class="line">    directory: &#39;&#x2F;c&#39;</span><br><span class="line"></span><br><span class="line">  production:</span><br><span class="line">    &lt;&lt;: *common</span><br><span class="line">    address: &#39;4.4.4.4:22&#39;</span><br><span class="line">    directory: &#39;&#x2F;d&#39;</span><br></pre></td></tr></table></figure><p>这是基本的配置文件，我们借助了yaml的灵活性，配置出尽可能简洁，可复用的项。<br>我们还有更加灵活的配置和格式，具体参考以下代码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">@Grab(&#39;org.yaml:snakeyaml:1.26&#39;)</span><br><span class="line">import org.yaml.snakeyaml.*</span><br><span class="line"></span><br><span class="line">def call(def config &#x3D; [script: null, groupRepo: null, shortJobName: null, host: null]) &#123;</span><br><span class="line"></span><br><span class="line">    def script &#x3D; config.script</span><br><span class="line">    def groupRepo &#x3D; config.groupRepo</span><br><span class="line">    def shortJobName &#x3D; config.shortJobName</span><br><span class="line">    def host &#x3D; config.host</span><br><span class="line"></span><br><span class="line">    if (groupRepo &#x3D;&#x3D; null) &#123;</span><br><span class="line">        groupRepo &#x3D; script.env.REPOSITORY_GROUP_REPO</span><br><span class="line">    &#125;</span><br><span class="line">    if (shortJobName &#x3D;&#x3D; null) &#123;</span><br><span class="line">        shortJobName &#x3D; script.env.SHORT_JOB_NAME</span><br><span class="line">    &#125;</span><br><span class="line">    if (host &#x3D;&#x3D; null) &#123;</span><br><span class="line">        host &#x3D; &quot;git.xxxx.com&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    configFile &#x3D; host + &#39;&#x2F;&#39; + groupRepo + &#39;.yaml&#39;</span><br><span class="line">    Yaml yaml &#x3D; new Yaml()</span><br><span class="line">    String resourceString &#x3D; libraryResource(configFile)</span><br><span class="line">    Map&lt;String, Object&gt; obj &#x3D; yaml.load(resourceString)</span><br><span class="line">    obj.type &#x3D; obj.type ?: null</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    def resource &#x3D; [:]</span><br><span class="line">    def git_credentials_id &#x3D; &#39;&#39;</span><br><span class="line">    def build_credentials_id &#x3D; &#39;&#39;</span><br><span class="line"></span><br><span class="line">    if (obj.type &#x3D;&#x3D; &#39;job_name&#39;) &#123;</span><br><span class="line">        String pointJobName &#x3D; shortJobName</span><br><span class="line">        for (item in obj) &#123;</span><br><span class="line">            if (item.key &#x3D;&#x3D; pointJobName) &#123;</span><br><span class="line">                def value &#x3D; item.value</span><br><span class="line">                for (it1 in value) &#123;</span><br><span class="line">                    if (it1.key &#x3D;&#x3D; &#39;git_credentials_id&#39;) &#123;</span><br><span class="line">                        git_credentials_id &#x3D; it1.value</span><br><span class="line">                        continue</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (it1.key &#x3D;&#x3D; &#39;build_credentials_id&#39;) &#123;</span><br><span class="line">                        build_credentials_id &#x3D; it1.value</span><br><span class="line">                        continue</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (it1.key &#x3D;&#x3D; &#39;environment&#39;) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 兼容 address，String &amp;&amp; List</span><br><span class="line">                        for (it in it1.value) &#123;</span><br><span class="line">                            for (values in it.value) &#123;</span><br><span class="line">                                if (values instanceof Map.Entry) &#123;</span><br><span class="line">                                    if (values.key &#x3D;&#x3D; &#39;address&#39;) &#123;</span><br><span class="line">                                        if (values.value instanceof String) &#123;</span><br><span class="line">                                            values.value &#x3D; [values.value]</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    if (it1.key &#x3D;&#x3D; &#39;environment&#39;) &#123;</span><br><span class="line">                        &#x2F;&#x2F; 兼容 directory</span><br><span class="line">                        for (it in it1.value) &#123;</span><br><span class="line">                            for (values in it.value) &#123;</span><br><span class="line">                                if (values instanceof Map.Entry) &#123;</span><br><span class="line">                                    if (values.key &#x3D;&#x3D; &#39;directory&#39;) &#123;</span><br><span class="line">                                        if (values.value instanceof String) &#123;</span><br><span class="line">                                            def dir &#x3D; values.value</span><br><span class="line">                                            values.value &#x3D; [:]</span><br><span class="line">                                            for (def addr in it.value.address) &#123;</span><br><span class="line">                                                values.value[addr] &#x3D; dir</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                resource &#x3D; value</span><br><span class="line"></span><br><span class="line">                break</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;  &#x2F;&#x2F; job.type &#x3D;&#x3D; normal</span><br><span class="line">        resource &#x3D; obj</span><br><span class="line">        resource.remove(&#39;type&#39;)</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 兼容 address，String &amp;&amp; List</span><br><span class="line">        for (item in resource.environment) &#123;</span><br><span class="line">            for (values in item.value) &#123;</span><br><span class="line">                if (values instanceof Map.Entry) &#123;</span><br><span class="line">                    if (values.key &#x3D;&#x3D; &#39;address&#39;) &#123;</span><br><span class="line">                        if (values.value instanceof String) &#123;</span><br><span class="line">                            values.value &#x3D; [values.value]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 兼容 directory</span><br><span class="line">        for (item in resource.environment) &#123;</span><br><span class="line">            for (values in item.value) &#123;</span><br><span class="line">                if (values instanceof Map.Entry) &#123;</span><br><span class="line">                    if (values.key &#x3D;&#x3D; &#39;directory&#39;) &#123;</span><br><span class="line">                        if (values.value instanceof String) &#123;</span><br><span class="line">                            def dir &#x3D; values.value</span><br><span class="line">                            values.value &#x3D; [:]</span><br><span class="line">                            for (def addr in item.value.address) &#123;</span><br><span class="line">                                values.value[addr] &#x3D; dir</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        git_credentials_id &#x3D; resource.git_credentials_id</span><br><span class="line">        build_credentials_id &#x3D; resource.build_credentials_id</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    def environment &#x3D; resource.environment</span><br><span class="line"></span><br><span class="line">    script.currentResources &#x3D; environment ?: [:]</span><br><span class="line">    script.gitCredentialsId &#x3D; git_credentials_id ?: null</span><br><span class="line">    script.buildCredentialsId &#x3D; build_credentials_id ?: null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上就是我们的jenkins对共享库应用场景了，后续也会随着服务器对架构而升级优化改变。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本次我们不从Jenkins的部署架构和具体配置说明，我们主要围绕 &lt;code&gt;jenkinsfile&lt;/code&gt; 的内部来讲解。&lt;/p&gt;
    
    </summary>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/categories/DevOps/"/>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/tags/DevOps/"/>
    
      <category term="Jenkins" scheme="http://blog.crazylaw.cn/tags/Jenkins/"/>
    
  </entry>
  
  <entry>
    <title>【kubernetes】pause容器</title>
    <link href="http://blog.crazylaw.cn/2020/08/25/k8s/pause%E5%AE%B9%E5%99%A8/"/>
    <id>http://blog.crazylaw.cn/2020/08/25/k8s/pause%E5%AE%B9%E5%99%A8/</id>
    <published>2020-08-25T14:53:30.000Z</published>
    <updated>2021-03-20T16:25:01.807Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>k8s中有 <code>init容器</code>的概念，其中一个就是<code>pause容器</code>，<code>pause容器</code>是一个十分重要的概念，贯穿整个<code>Pod</code>的通信。</p><a id="more"></a><h1 id="Pause容器"><a href="#Pause容器" class="headerlink" title="Pause容器"></a>Pause容器</h1><p>Pause容器，又叫Infra容器，本文将探究该容器的作用与原理。</p><p>我们知道在kubelet的配置中有这样一个参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_POD_INFRA_CONTAINER=--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest</span><br></pre></td></tr></table></figure><p>上面是openshift中的配置参数，kubernetes中默认的配置参数是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_POD_INFRA_CONTAINER=--pod-infra-container-image=gcr.io/google_containers/pause-amd64:3.0</span><br></pre></td></tr></table></figure><p>Pause容器，是可以自己来定义，官方使用的<code>gcr.io/google_containers/pause-amd64:3.0</code>容器的代码见<a href="https://github.com/kubernetes/kubernetes/tree/master/build/pause" target="_blank" rel="noopener">Github</a>，使用C语言编写。</p><h2 id="Pause容器特点"><a href="#Pause容器特点" class="headerlink" title="Pause容器特点"></a>Pause容器特点</h2><ul><li>镜像非常小，目前在700KB左右</li><li>永远处于Pause(暂停)状态</li></ul><h2 id="Pause容器背景"><a href="#Pause容器背景" class="headerlink" title="Pause容器背景"></a>Pause容器背景</h2><p>像 Pod 这样一个东西，本身是一个逻辑概念。那在机器上，它究竟是怎么实现的呢？这就是我们要解释的一个问题。</p><p>既然说 Pod 要解决这个问题，核心就在于如何让一个 Pod 里的多个容器之间最高效的共享某些资源和数据。</p><p>因为容器之间原本是被 Linux Namespace 和 cgroups 隔开的，所以现在实际要解决的是怎么去打破这个隔离，然后共享某些事情和某些信息。这就是 Pod 的设计要解决的核心问题所在。</p><p>所以说具体的解法分为两个部分：网络和存储。</p><p>Pause容器就是为解决Pod中的网络问题而生的。</p><h2 id="Pause容器实现"><a href="#Pause容器实现" class="headerlink" title="Pause容器实现"></a>Pause容器实现</h2><p>Pod 里的多个容器怎么去共享网络？下面是个例子：</p><p>比如说现在有一个 Pod，其中包含了一个容器 A 和一个容器 B，它们两个就要共享 Network Namespace。在 Kubernetes 里的解法是这样的：它会在每个 Pod 里，额外起一个 Infra container 小容器来共享整个 Pod 的 Network Namespace。</p><p>Infra container 是一个非常小的镜像，大概 700KB 左右，是一个C语言写的、永远处于“暂停”状态的容器。由于有了这样一个 Infra container 之后，其他所有容器都会通过 Join Namespace 的方式加入到 Infra container 的 Network Namespace 中。</p><p>所以说一个 Pod 里面的所有容器，它们看到的网络视图是完全一样的。即：它们看到的网络设备、IP地址、Mac地址等等，跟网络相关的信息，其实全是一份，这一份都来自于 Pod 第一次创建的这个 Infra container。这就是 Pod 解决网络共享的一个解法。</p><p>在 Pod 里面，一定有一个 IP 地址，是这个 Pod 的 Network Namespace 对应的地址，也是这个 Infra container 的 IP 地址。所以大家看到的都是一份，而其他所有网络资源，都是一个 Pod 一份，并且被 Pod 中的所有容器共享。这就是 Pod 的网络实现方式。</p><p>由于需要有一个相当于说中间的容器存在，所以整个 Pod 里面，必然是 Infra container 第一个启动。并且整个 Pod 的生命周期是等同于 Infra container 的生命周期的，与容器 A 和 B 是无关的。这也是为什么在 Kubernetes 里面，它是允许去单独更新 Pod 里的某一个镜像的，即：做这个操作，整个 Pod 不会重建，也不会重启，这是非常重要的一个设计。</p><h2 id="Pause容器的作用"><a href="#Pause容器的作用" class="headerlink" title="Pause容器的作用"></a>Pause容器的作用</h2><p>我们检查node节点的时候会发现每个node上都运行了很多的pause容器，例如如下。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                                                                                                    COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">2c7d50f1a7be        docker.io/jimmysong/heapster-grafana-amd64@sha256:d663759b3de86cf62e64a43b021f133c383e8f7b0dc2bdd78115bc95db371c9a       <span class="string">"/run.sh"</span>                3 hours ago         Up 3 hours                              k8s_grafana_monitoring-influxdb-grafana-v4-5697c6b59-76zqs_kube-system_5788a3c5-29c0-11e8-9e88-525400005732_0</span><br><span class="line">5df93dea877a        docker.io/jimmysong/heapster-influxdb-amd64@sha256:a217008b68cb49e8f038c4eeb6029261f02adca81d8eae8c5c01d030361274b8      <span class="string">"influxd --config ..."</span>   3 hours ago         Up 3 hours                              k8s_influxdb_monitoring-influxdb-grafana-v4-5697c6b59-76zqs_kube-system_5788a3c5-29c0-11e8-9e88-525400005732_0</span><br><span class="line">9cec6c0ef583        jimmysong/pause-amd64:3.0                                                                                                <span class="string">"/pause"</span>                 3 hours ago         Up 3 hours                              k8s_POD_monitoring-influxdb-grafana-v4-5697c6b59-76zqs_kube-system_5788a3c5-29c0-11e8-9e88-525400005732_0</span><br><span class="line">54d06e30a4c7        docker.io/jimmysong/kubernetes-dashboard-amd64@sha256:668710d034c4209f8fa9a342db6d8be72b6cb5f1f3f696cee2379b8512330be4   <span class="string">"/dashboard --inse..."</span>   3 hours ago         Up 3 hours                              k8s_kubernetes-dashboard_kubernetes-dashboard-65486f5fdf-lshl7_kube-system_27c414a1-29c0-11e8-9e88-525400005732_0</span><br><span class="line">5a5ef33b0d58        jimmysong/pause-amd64:3.0                                                                                                <span class="string">"/pause"</span>                 3 hours ago         Up 3 hours                              k8s_POD_kubernetes-dashboard-65486f5fdf-lshl7_kube-system_27c414a1-29c0-11e8-9e88-525400005732_0</span><br></pre></td></tr></table></figure><p>kubernetes中的pause容器主要为每个业务容器提供以下功能：</p><ul><li>在pod中担任Linux命名空间共享的基础；</li><li>启用pid命名空间，开启init进程。</li></ul><p>在<a href="https://www.ianlewis.org/en/almighty-pause-container" target="_blank" rel="noopener">The Almighty Pause Container</a>这篇文章中做出了详细的说明，pause容器的作用可以从这个例子中看出，首先见下图：</p><p><img src="/images/k8s/pause-container.png" alt="Pause容器"></p><p>我们首先在节点上运行一个pause容器。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name pause -p 8880:80 jimmysong/pause-amd64:3.0</span><br></pre></td></tr></table></figure><p>然后再运行一个nginx容器，nginx将为<code>localhost:2368</code>创建一个代理。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt;EOF &gt;&gt; nginx.conf</span><br><span class="line">error_log stderr;</span><br><span class="line">events &#123; worker_connections  1024; &#125;</span><br><span class="line">http &#123;</span><br><span class="line">    access_log /dev/stdout combined;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 80 default_server;</span><br><span class="line">        server_name example.com www.example.com;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://127.0.0.1:2368;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">$ docker run -d --name nginx -v `<span class="built_in">pwd</span>`/nginx.conf:/etc/nginx/nginx.conf --net=container:pause --ipc=container:pause --pid=container:pause nginx</span><br></pre></td></tr></table></figure><p>突然间发现报错：</p><p><code>docker: Error response from daemon: can&#39;t join IPC of container 90208aca191fd04e86276bf29a1b1ff742f3d04c0c8c01f6cc61c3283909725b: non-shareable IPC (hint: use IpcMode:shareable for the donor container).</code></p><p>因为当前docker容器默认的<code>&quot;default-ipc-mode&quot;: &quot;host&quot;</code>，我们需要切换到<code>&quot;default-ipc-mode&quot;: &quot;shareable&quot;</code>, linux环境下写入到<code>/etc/docker/daemon.json</code>，<code>docker-for-mac</code> 写在配置中。然后重启即可。</p><p>然后再为<a href="https://github.com/TryGhost/Ghost" target="_blank" rel="noopener">ghost</a>创建一个应用容器，这是一款博客软件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -d --name ghost --net=container:pause --ipc=container:pause --pid=container:pause ghost</span><br></pre></td></tr></table></figure><p>现在访问<a href="http://localhost:8880/" target="_blank" rel="noopener">http://localhost:8880/</a>就可以看到ghost博客的界面了。</p><p><strong>解析</strong></p><p>pause容器将内部的80端口映射到宿主机的8880端口，pause容器在宿主机上设置好了网络namespace后，nginx容器加入到该网络namespace中，我们看到nginx容器启动的时候指定了<code>--net=container:pause</code>，ghost容器同样加入到了该网络namespace中，这样三个容器就共享了网络，互相之间就可以使用<code>localhost</code>直接通信，<code>--ipc=contianer:pause --pid=container:pause</code>就是三个容器处于同一个namespace中，init进程为<code>pause</code>，这时我们进入到ghost容器中查看进程情况。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps aux</span></span><br><span class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root         1  0.0  0.0   1024     4 ?        Ss   13:49   0:00 /pause</span><br><span class="line">root         5  0.0  0.1  32432  5736 ?        Ss   13:51   0:00 nginx: master p</span><br><span class="line">systemd+     9  0.0  0.0  32980  3304 ?        S    13:51   0:00 nginx: worker p</span><br><span class="line">node        10  0.3  2.0 1254200 83788 ?       Ssl  13:53   0:03 node current/<span class="keyword">in</span></span><br><span class="line">root        79  0.1  0.0   4336   812 pts/0    Ss   14:09   0:00 sh</span><br><span class="line">root        87  0.0  0.0  17500  2080 pts/0    R+   14:10   0:00 ps aux</span><br></pre></td></tr></table></figure><p>在ghost容器中同时可以看到pause和nginx容器的进程，并且pause容器的PID是1。而在kubernetes中容器的PID=1的进程即为容器本身的业务进程。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  k8s docker ps</span><br><span class="line">CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS              PORTS                  NAMES</span><br><span class="line">56b408835478        nginx                  &quot;&#x2F;docker-entrypoint.…&quot;   About an hour ago   Up About an hour                           nginx</span><br><span class="line">b4b5ecc6ddf4        ghost                  &quot;docker-entrypoint.s…&quot;   2 hours ago         Up 2 hours                                 ghost</span><br><span class="line">2be4a03fea85        k8s.gcr.io&#x2F;pause:3.2   &quot;&#x2F;pause&quot;                 3 hours ago         Up 3 hours          0.0.0.0:8880-&gt;80&#x2F;tcp   pause</span><br></pre></td></tr></table></figure><p>当关闭<code>pause进程的时候，所有的容器都会停止</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop pause</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.ianlewis.org/en/almighty-pause-container" target="_blank" rel="noopener">The Almighty Pause Container</a></li><li><a href="https://o-my-chenjian.com/2017/10/17/The-Pause-Container-Of-Kubernetes/" target="_blank" rel="noopener">Kubernetes之Pause容器</a></li><li><a href="https://edu.aliyun.com/lesson_1651_16895?spm=5176.10731542.0.0.41a620be3s3dmu#_16895" target="_blank" rel="noopener">CNCF&amp;Aliyun云原生课程</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;k8s中有 &lt;code&gt;init容器&lt;/code&gt;的概念，其中一个就是&lt;code&gt;pause容器&lt;/code&gt;，&lt;code&gt;pause容器&lt;/code&gt;是一个十分重要的概念，贯穿整个&lt;code&gt;Pod&lt;/code&gt;的通信。&lt;/p&gt;
    
    </summary>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/categories/kubernetes/"/>
    
    
      <category term="kubernetes" scheme="http://blog.crazylaw.cn/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>【爬虫】- scrapy</title>
    <link href="http://blog.crazylaw.cn/2020/08/24/%E7%88%AC%E8%99%AB/Tutorial/"/>
    <id>http://blog.crazylaw.cn/2020/08/24/%E7%88%AC%E8%99%AB/Tutorial/</id>
    <published>2020-08-24T01:46:51.000Z</published>
    <updated>2021-03-20T16:25:01.820Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在和朋友写一个二手房的项目，需要用到爬虫，这里借助了scrapy来写。顺便整理了scrapy的用法.</p><p><a href="https://github.com/four-seas/source" target="_blank" rel="noopener">fous_seas/sources</a></p><a id="more"></a><h2 id="第一个-Spider"><a href="#第一个-Spider" class="headerlink" title="第一个 Spider"></a>第一个 Spider</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">    name = <span class="string">"quotes"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span><span class="params">(self)</span>:</span></span><br><span class="line">        urls = [</span><br><span class="line">            <span class="string">'http://quotes.toscrape.com/page/1/'</span>,</span><br><span class="line">            <span class="string">'http://quotes.toscrape.com/page/2/'</span>,</span><br><span class="line">        ]</span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> urls:</span><br><span class="line">            <span class="keyword">yield</span> scrapy.Request(url=url, callback=self.parse)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        page = response.url.split(<span class="string">"/"</span>)[<span class="number">-2</span>]</span><br><span class="line">        filename = <span class="string">'quotes-%s.html'</span> % page</span><br><span class="line">        <span class="keyword">with</span> open(filename, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(response.body)</span><br><span class="line">        self.log(<span class="string">'Saved file %s'</span> % filename)</span><br></pre></td></tr></table></figure><p>可以看到，我们新建的 QuotesSpider 类是继承自 scrapy.Spider 类的；下面看看其属性和方法的意义.</p><ul><li>name</li></ul><p>是 Spider 的标识符，用于唯一标识该 Spider；它必须在整个项目中是全局唯一的.</p><ul><li>start_requests()</li></ul><p>必须定义并返回一组可以被 Spider 爬取的 Requests，Request 对象由一个 URL 和一个回调函数构成.</p><ul><li>parse()</li></ul><p>就是 Request 对象中的回调方法，用来解析每一个 Request 之后的 Response；所以，parse() 方法就是用来解析返回的内容，通过解析得到的 URL 同样可以创建对应的 Requests 进而继续爬取.</p><p>再来看看具体的实现。</p><ul><li>start_request(self)</li></ul><p>方法分别针对 <a href="http://quotes.toscrape.com/page/1/" target="_blank" rel="noopener">http://quotes.toscrape.com/page/1/</a> 和 <a href="http://quotes.toscrape.com/page/2/" target="_blank" rel="noopener">http://quotes.toscrape.com/page/2/</a> 创建了两个需要被爬取的 Requests 对象；并通过 yield 进行迭代返回；备注，yield 是迭代生成器，是一个 Generator；</p><ul><li>parse(self, response)</li></ul><p>对 Request 的反馈的内容 Response 进行解析，这里的解析的逻辑很简单，就是分别创建两个本地文件，然后将 response.body 的内容放入这两个文件当中。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes</span><br></pre></td></tr></table></figure><p>大致会输出如下内容</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">2016-12-16 21:24:05 [scrapy.core.engine] INFO: Spider opened</span><br><span class="line">2016-12-16 21:24:05 [scrapy.extensions.logstats] INFO: Crawled 0 pages (at 0 pages/min), scraped 0 items (at 0 items/min)</span><br><span class="line">2016-12-16 21:24:05 [scrapy.extensions.telnet] DEBUG: Telnet console listening on 127.0.0.1:6023</span><br><span class="line">2016-12-16 21:24:05 [scrapy.core.engine] DEBUG: Crawled (404) &lt;GET http://quotes.toscrape.com/robots.txt&gt; (referer: None)</span><br><span class="line">2016-12-16 21:24:05 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET http://quotes.toscrape.com/page/1/&gt; (referer: None)</span><br><span class="line">2016-12-16 21:24:05 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET http://quotes.toscrape.com/page/2/&gt; (referer: None)</span><br><span class="line">2016-12-16 21:24:05 [quotes] DEBUG: Saved file quotes-1.html</span><br><span class="line">2016-12-16 21:24:05 [quotes] DEBUG: Saved file quotes-2.html</span><br><span class="line">2016-12-16 21:24:05 [scrapy.core.engine] INFO: Closing spider (finished)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>可以看到，通过爬取，我们在本地生成了两个 html 文件 quotes-1.html 和 quotes-2.html</p><h2 id="如何提取"><a href="#如何提取" class="headerlink" title="如何提取"></a>如何提取</h2><h3 id="通过命令行的方式提取"><a href="#通过命令行的方式提取" class="headerlink" title="通过命令行的方式提取"></a>通过命令行的方式提取</h3><p>Scrapy 提供了命令行的方式可以对需要被爬取的内容进行高效的<code>调试</code>，通过使用<code>Scrapy shell</code>进入命令行，然后在命令行中可以快速的对要爬取的内容进行提取；</p><blockquote><p>一定要学会调试！！！这是不能跳过的步骤</p></blockquote><p>我们试着通过 Scrapy shell 来提取下 “<a href="http://quotes.toscrape.com/page/1/&quot;" target="_blank" rel="noopener">http://quotes.toscrape.com/page/1/&quot;</a> 中的数据，通过执行如下命令，进入 shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">scrapy shell &quot;http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&quot;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 或者</span><br><span class="line"></span><br><span class="line">scrapy shll</span><br><span class="line">fetch(&#39;http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&#39;)</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[ ... Scrapy log here ... ]</span><br><span class="line">2016-09-19 12:09:27 [scrapy.core.engine] DEBUG: Crawled (200) &lt;GET http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&gt; (referer: None)</span><br><span class="line">[s] Available Scrapy objects:</span><br><span class="line">[s]   scrapy     scrapy module (contains scrapy.Request, scrapy.Selector, etc)</span><br><span class="line">[s]   crawler    &lt;scrapy.crawler.Crawler object at 0x7fa91d888c90&gt;</span><br><span class="line">[s]   item       &#123;&#125;</span><br><span class="line">[s]   request    &lt;GET http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&gt;</span><br><span class="line">[s]   response   &lt;200 http:&#x2F;&#x2F;quotes.toscrape.com&#x2F;page&#x2F;1&#x2F;&gt;</span><br><span class="line">[s]   settings   &lt;scrapy.settings.Settings object at 0x7fa91d888c10&gt;</span><br><span class="line">[s]   spider     &lt;DefaultSpider &#39;default&#39; at 0x7fa91c8af990&gt;</span><br><span class="line">[s] Useful shortcuts:</span><br><span class="line">[s]   shelp()           Shell help (print this help)</span><br><span class="line">[s]   fetch(req_or_url) Fetch request (or URL) and update local objects</span><br><span class="line">[s]   view(response)    View response in a browser</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure><p>这样，我们就进入了 Scrapy shell 的环境，上面显示了连接请求和返回的相关信息，response 返回 status code 200 表示成功返回；</p><h3 id="通过-CSS-标准进行提取"><a href="#通过-CSS-标准进行提取" class="headerlink" title="通过 CSS 标准进行提取"></a>通过 CSS 标准进行提取</h3><p>这里主要是遵循 CSS 标准 <a href="https://www.w3.org/TR/selectors/" target="_blank" rel="noopener">https://www.w3.org/TR/selectors/</a> 来对网页的元素进行提取.</p><h4 id="通过使用-css-选择我们要提取的元素"><a href="#通过使用-css-选择我们要提取的元素" class="headerlink" title="通过使用 css() 选择我们要提取的元素"></a>通过使用 css() 选择我们要提取的元素</h4><p>下面演示一下如何提取元素.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;title&#39;)</span><br><span class="line">[&lt;Selector xpath&#x3D;u&#39;descendant-or-self::title&#39; data&#x3D;u&#39;&lt;title&gt;Quotes to Scrape&lt;&#x2F;title&gt;&#39;&gt;]</span><br></pre></td></tr></table></figure><p>可以看到，它通过返回一个类似 SelectorList 的对象成功的获取到了 <a href="http://quotes.toscrape.com/page/1/" target="_blank" rel="noopener">http://quotes.toscrape.com/page/1/</a> 页面中的 <title/> 的信息，该信息是封装在Selector对象中的 data 属性中的.</p><h4 id="提取Selector元素的文本内容，一般有两种方式用来提取"><a href="#提取Selector元素的文本内容，一般有两种方式用来提取" class="headerlink" title="提取Selector元素的文本内容，一般有两种方式用来提取"></a>提取Selector元素的文本内容，一般有两种方式用来提取</h4><ul><li>通过使用 extract() 或者 extract_first() 方法来提取元素的内容；下面演示如何提取 #1 返回的元素 <title/> 中的文本内容 text；</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;title::text&#39;).extract_first()</span><br><span class="line">&#39;Quotes to Scrape&#39;</span><br></pre></td></tr></table></figure><ul><li>extract_first() 表示提取返回队列中的第一个 Selector 对象；同样也可以使用如下的方式.</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;title::text&#39;)[0].extract()</span><br><span class="line">&#39;Quotes to Scrape&#39;</span><br></pre></td></tr></table></figure><p>不过 extract_first() 方法可以在当页面没有找到的情况下，避免出现<code>IndexError</code>的错误；</p><ul><li>通过 re() 方法来使用正则表达式的方式来进行提取元素的文本内容</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;title::text&#39;).re(r&#39;Quotes.*&#39;)</span><br><span class="line">[&#39;Quotes to Scrape&#39;]</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;title::text&#39;).re(r&#39;Q\w+&#39;)</span><br><span class="line">[&#39;Quotes&#39;]</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;title::text&#39;).re(r&#39;(\w+) to (\w+)&#39;)</span><br><span class="line">[&#39;Quotes&#39;, &#39;Scrape&#39;]</span><br></pre></td></tr></table></figure><h3 id="使用-XPath"><a href="#使用-XPath" class="headerlink" title="使用 XPath"></a>使用 XPath</h3><p>除了使用 <code>CSS 标准</code> 来提取元素意外，我们还可以使用 <code>XPath 标准</code>来提取元素，比如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;title&#39;)</span><br><span class="line">[&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;title&#39; data&#x3D;&#39;&lt;title&gt;Quotes to Scrape&lt;&#x2F;title&gt;&#39;&gt;]</span><br><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;title&#x2F;text()&#39;).extract_first()</span><br><span class="line">&#39;Quotes to Scrape&#39;</span><br></pre></td></tr></table></figure><p>XPath 比 CSS 的爬取方式更为强大，因为它不仅仅是根据 HTML 的结构元素去进行检索(Navigating)，并且它可以顺带的对文本(text)进行检索；所以它可以支持 CSS 标准不能做到的场景，比如，检索一个 包含文本内容”Next Page”的 link 元素；这就使得通过 XPath 去构建爬虫更为简单.</p><h2 id="数据流设计图"><a href="#数据流设计图" class="headerlink" title="数据流设计图"></a>数据流设计图</h2><p><img src="/images/%E7%88%AC%E8%99%AB/scrapy_architecture.png" alt="架构图"></p><h2 id="Items"><a href="#Items" class="headerlink" title="Items"></a>Items</h2><p>Scrapy 的核心目的就是从非结构化的网页中提取出结构化的数据；默认的，Scrapy 爬虫以 dicts 的形式返回格式化的数据；但是，这里有一个问题，就是 dicts 并不能很好的表示这种结构化数据的结构，而且经常容易出错，转换也麻烦。</p><p>因此，Item 诞生了，它提供了这样一个简单的容器来收集爬取到的数据，并提供非常简便的 API 来声明它的 fields。</p><h3 id="声明-Items"><a href="#声明-Items" class="headerlink" title="声明 Items"></a>声明 Items</h3><p>通过一个简单的 class 和多个 Field 对象来声明 Items 对象；看一个 Product Item 的例子。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import scrapy</span><br><span class="line"></span><br><span class="line">class Product(scrapy.Item):</span><br><span class="line">    name &#x3D; scrapy.Field()</span><br><span class="line">    price &#x3D; scrapy.Field()</span><br><span class="line">    stock &#x3D; scrapy.Field()</span><br><span class="line">    last_updated &#x3D; scrapy.Field(serializer&#x3D;str)</span><br></pre></td></tr></table></figure><p>需要注意的是，Product 继承自 scrapy.Item 父类.</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近在和朋友写一个二手房的项目，需要用到爬虫，这里借助了scrapy来写。顺便整理了scrapy的用法.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/four-seas/source&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;fous_seas/sources&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="爬虫" scheme="http://blog.crazylaw.cn/categories/%E7%88%AC%E8%99%AB/"/>
    
    
      <category term="爬虫" scheme="http://blog.crazylaw.cn/tags/%E7%88%AC%E8%99%AB/"/>
    
  </entry>
  
  <entry>
    <title>【Golang】- pprof性能分析</title>
    <link href="http://blog.crazylaw.cn/2020/08/14/Golang/pprof%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/"/>
    <id>http://blog.crazylaw.cn/2020/08/14/Golang/pprof%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/</id>
    <published>2020-08-14T08:35:51.000Z</published>
    <updated>2021-03-20T16:25:01.799Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在开发一个golang的大数据服务，发现只要到了业务层性能就急剧下降，为了排查这个原因，使用pprof进行性能分析</p><a id="more"></a><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>在main函数中加入以下代码</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"runtime/pprof"</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">cpuProfile, _ := os.Create(<span class="string">"cpu_profile"</span>)</span><br><span class="line">pprof.StartCPUProfile(cpuProfile)</span><br><span class="line"><span class="keyword">defer</span> pprof.StopCPUProfile()</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>这里 <code>os.Create(&quot;cpu_profile&quot;)</code> 指定生成的数据文件, 然后 pprof.StartCPUProfile 看名字就知道是开始对 CPU 的使用进行监控. 有开始就有结束, 一般直接跟着 defer pprof.StopCPUProfile() 省的后面忘了. 编译执行一次以后会在目录下生成监控数据并记录到 <code>cpu_profile</code>. 接着就可以使用 pprof 来解读分析这些监控生成的数据.</p><h2 id="CPU-Profiling"><a href="#CPU-Profiling" class="headerlink" title="CPU Profiling"></a>CPU Profiling</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@60b1d42d6330:&#x2F;www# go tool pprof cpu_profile</span><br><span class="line">File: main</span><br><span class="line">Build ID: 3d9d75a7fe2c5c4917c59acabfd743a6512d91fa</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Aug 14, 2020 at 8:34am (UTC)</span><br><span class="line">Duration: 205.73ms, Total samples &#x3D; 30ms (14.58%)</span><br><span class="line">Entering interactive mode (type &quot;help&quot; for commands, &quot;o&quot; for options)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近在开发一个golang的大数据服务，发现只要到了业务层性能就急剧下降，为了排查这个原因，使用pprof进行性能分析&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>【Golang】- devle</title>
    <link href="http://blog.crazylaw.cn/2020/08/14/Golang/dlv%E5%9C%A8%E7%BA%BF%E8%B0%83%E8%AF%95/"/>
    <id>http://blog.crazylaw.cn/2020/08/14/Golang/dlv%E5%9C%A8%E7%BA%BF%E8%B0%83%E8%AF%95/</id>
    <published>2020-08-14T01:46:51.000Z</published>
    <updated>2021-03-20T16:25:01.799Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于我们可能断点调试程序，所以我们需要debug工具，对于golang来说，delve比gdb对go程序更友好。所以，我们今天来看看devle怎么debug程序</p><a id="more"></a><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com&#x2F;go-delve&#x2F;delve&#x2F;cmd&#x2F;dlv</span><br></pre></td></tr></table></figure><h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>a）dlv debug</p><p>使用dlv debug可以在main函数文件所在目录直接对main函数进行调试，也可以在根目录以指定包路径的方式对main函数进行调试。</p><p>b）dlv test</p><p>使用dlv test可以对test包进行调试。</p><p>c）dlv attach</p><p>使用dlv attach可以附加到一个已在运行的进程进行调试。</p><p>d）dlv connect</p><p>使用dlv connect可以连接到调试服务器进行调试。</p><p>e）dlv trace</p><p>使用dlv trace可以追踪程序。</p><p>f）dlv exec</p><p>使用dlv exec可以对编译好的二进制进行调试</p><p>创建main.go文件，main函数先通过循初始化一个切片，然后输出切片的内容：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    nums := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(nums); i++ &#123;</span><br><span class="line">        nums[i] = i * i</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(nums)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>命令行进入包所在目录，然后输入<code>dlv debug</code>命令进入调试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ dlv debug</span><br><span class="line">Type &#39;help&#39; for list of commands.</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>输入<code>help</code>命令可以查看到Delve提供的调试命令列表：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">(dlv) help</span><br><span class="line">The following commands are available:</span><br><span class="line"></span><br><span class="line">Running the program:</span><br><span class="line">    call ------------------------ Resumes process, injecting a function call (EXPERIMENTAL!!!)</span><br><span class="line">    continue (alias: c) --------- Run until breakpoint or program termination.</span><br><span class="line">    next (alias: n) ------------- Step over to next source line.</span><br><span class="line">    rebuild --------------------- Rebuild the target executable and restarts it. It does not work if the executable was not built by delve.</span><br><span class="line">    restart (alias: r) ---------- Restart process.</span><br><span class="line">    step (alias: s) ------------- Single step through program.</span><br><span class="line">    step-instruction (alias: si)  Single step a single cpu instruction.</span><br><span class="line">    stepout (alias: so) --------- Step out of the current function.</span><br><span class="line"></span><br><span class="line">Manipulating breakpoints:</span><br><span class="line">    break (alias: b) ------- Sets a breakpoint.</span><br><span class="line">    breakpoints (alias: bp)  Print out info for active breakpoints.</span><br><span class="line">    clear ------------------ Deletes breakpoint.</span><br><span class="line">    clearall --------------- Deletes multiple breakpoints.</span><br><span class="line">    condition (alias: cond)  Set breakpoint condition.</span><br><span class="line">    on --------------------- Executes a command when a breakpoint is hit.</span><br><span class="line">    trace (alias: t) ------- Set tracepoint.</span><br><span class="line"></span><br><span class="line">Viewing program variables and memory:</span><br><span class="line">    args ----------------- Print function arguments.</span><br><span class="line">    display -------------- Print value of an expression every time the program stops.</span><br><span class="line">    examinemem (alias: x)  Examine memory:</span><br><span class="line">    locals --------------- Print local variables.</span><br><span class="line">    print (alias: p) ----- Evaluate an expression.</span><br><span class="line">    regs ----------------- Print contents of CPU registers.</span><br><span class="line">    set ------------------ Changes the value of a variable.</span><br><span class="line">    vars ----------------- Print package variables.</span><br><span class="line">    whatis --------------- Prints type of an expression.</span><br><span class="line"></span><br><span class="line">Listing and switching between threads and goroutines:</span><br><span class="line">    goroutine (alias: gr) -- Shows or changes current goroutine</span><br><span class="line">    goroutines (alias: grs)  List program goroutines.</span><br><span class="line">    thread (alias: tr) ----- Switch to the specified thread.</span><br><span class="line">    threads ---------------- Print out info for every traced thread.</span><br><span class="line"></span><br><span class="line">Viewing the call stack and selecting frames:</span><br><span class="line">    deferred --------- Executes command in the context of a deferred call.</span><br><span class="line">    down ------------- Move the current frame down.</span><br><span class="line">    frame ------------ Set the current frame, or execute command on a different frame.</span><br><span class="line">    stack (alias: bt)  Print stack trace.</span><br><span class="line">    up --------------- Move the current frame up.</span><br><span class="line"></span><br><span class="line">Other commands:</span><br><span class="line">    config --------------------- Changes configuration parameters.</span><br><span class="line">    disassemble (alias: disass)  Disassembler.</span><br><span class="line">    edit (alias: ed) ----------- Open where you are in $DELVE_EDITOR or $EDITOR</span><br><span class="line">    exit (alias: quit | q) ----- Exit the debugger.</span><br><span class="line">    funcs ---------------------- Print list of functions.</span><br><span class="line">    help (alias: h) ------------ Prints the help message.</span><br><span class="line">    libraries ------------------ List loaded dynamic libraries</span><br><span class="line">    list (alias: ls | l) ------- Show source code.</span><br><span class="line">    source --------------------- Executes a file containing a list of delve commands</span><br><span class="line">    sources -------------------- Print list of source files.</span><br><span class="line">    types ---------------------- Print list of types</span><br><span class="line"></span><br><span class="line">Type help followed by a command for full documentation.</span><br></pre></td></tr></table></figure><p>每个Go程序的入口是main.main函数，我们可以用<code>break(b)</code>在此设置一个断点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(dlv) break main.main</span><br><span class="line">Breakpoint 1 set at 0x10ae9b8 for main.main() .&#x2F;main.go:7</span><br></pre></td></tr></table></figure><p>然后通过<code>breakpoints(bp)</code>查看已经设置的所有断点：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(dlv) breakpoints</span><br><span class="line">Breakpoint unrecovered-panic at 0x102a380 for runtime.startpanic()</span><br><span class="line">    &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;panic.go:588 (0)</span><br><span class="line">        print runtime.curg._panic.arg</span><br><span class="line">Breakpoint 1 at 0x10ae9b8 for main.main() .&#x2F;main.go:7 (0)</span><br></pre></td></tr></table></figure><p>我们发现除了我们自己设置的<code>main.main</code>函数断点外，Delve内部已经为panic异常函数设置了一个断点。</p><p>通过<code>vars</code>命令可以查看全部包级的变量。因为最终的目标程序可能含有大量的全局变量，我们可以通过一个正则参数选择想查看的全局变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(dlv) vars main</span><br><span class="line">main.initdone· &#x3D; 2</span><br><span class="line">runtime.main_init_done &#x3D; chan bool 0&#x2F;0</span><br><span class="line">runtime.mainStarted &#x3D; true</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>然后就可以通过<code>continue(c)</code>命令让程序运行到下一个断点处：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(dlv) continue</span><br><span class="line">&gt; main.main() .&#x2F;main.go:7 (hits goroutine(1):1 total:1) (PC: 0x10ae9b8)</span><br><span class="line">     2:</span><br><span class="line">     3: import (</span><br><span class="line">     4:         &quot;fmt&quot;</span><br><span class="line">     5: )</span><br><span class="line">     6:</span><br><span class="line">&#x3D;&gt;   7: func main() &#123;</span><br><span class="line">     8:         nums :&#x3D; make([]int, 5)</span><br><span class="line">     9:         for i :&#x3D; 0; i &lt; len(nums); i++ &#123;</span><br><span class="line">    10:                 nums[i] &#x3D; i * i</span><br><span class="line">    11:         &#125;</span><br><span class="line">    12:         fmt.Println(nums)</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>输入<code>next(n)</code>命令单步执行进入main函数内部：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(dlv) next</span><br><span class="line">&gt; main.main() .&#x2F;main.go:8 (PC: 0x10ae9cf)</span><br><span class="line">     3: import (</span><br><span class="line">     4:         &quot;fmt&quot;</span><br><span class="line">     5: )</span><br><span class="line">     6:</span><br><span class="line">     7: func main() &#123;</span><br><span class="line">&#x3D;&gt;   8:         nums :&#x3D; make([]int, 5)</span><br><span class="line">     9:         for i :&#x3D; 0; i &lt; len(nums); i++ &#123;</span><br><span class="line">    10:                 nums[i] &#x3D; i * i</span><br><span class="line">    11:         &#125;</span><br><span class="line">    12:         fmt.Println(nums)</span><br><span class="line">    13: &#125;</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>进入函数之后可以通过<code>args</code>和<code>locals</code>命令查看函数的参数和局部变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(dlv) args</span><br><span class="line">(no args)</span><br><span class="line">(dlv) locals</span><br><span class="line">nums &#x3D; []int len: 842350763880, cap: 17491881, nil</span><br></pre></td></tr></table></figure><p>因为main函数没有参数，因此args命令没有任何输出。而locals命令则输出了局部变量nums切片的值：此时切片还未完成初始化，切片的底层指针为nil，长度和容量都是一个随机数值。</p><p>再次输入next命令单步执行后就可以查看到nums切片初始化之后的结果了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(dlv) next</span><br><span class="line">&gt; main.main() .&#x2F;main.go:9 (PC: 0x10aea12)</span><br><span class="line">     4:         &quot;fmt&quot;</span><br><span class="line">     5: )</span><br><span class="line">     6:</span><br><span class="line">     7: func main() &#123;</span><br><span class="line">     8:         nums :&#x3D; make([]int, 5)</span><br><span class="line">&#x3D;&gt;   9:         for i :&#x3D; 0; i &lt; len(nums); i++ &#123;</span><br><span class="line">    10:                 nums[i] &#x3D; i * i</span><br><span class="line">    11:         &#125;</span><br><span class="line">    12:         fmt.Println(nums)</span><br><span class="line">    13: &#125;</span><br><span class="line">(dlv) locals</span><br><span class="line">nums &#x3D; []int len: 5, cap: 5, [...]</span><br><span class="line">i &#x3D; 17601536</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>此时因为调试器已经到了for语句行，因此局部变量出现了还未初始化的循环迭代变量i。</p><p>下面我们通过组合使用<code>break(b)</code>和<code>condition(cond)</code>命令，在循环内部设置一个条件断点，当循环变量i等于3时断点生效：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(dlv) break main.go:10</span><br><span class="line">Breakpoint 2 set at 0x10aea33 for main.main() .&#x2F;main.go:10</span><br><span class="line">(dlv) condition 2 i&#x3D;&#x3D;3</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>然后通过continue执行到刚设置的条件断点，并且输出局部变量：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(dlv) continue</span><br><span class="line">&gt; main.main() .&#x2F;main.go:10 (hits goroutine(1):1 total:1) (PC: 0x10aea33)</span><br><span class="line">     5: )</span><br><span class="line">     6:</span><br><span class="line">     7: func main() &#123;</span><br><span class="line">     8:         nums :&#x3D; make([]int, 5)</span><br><span class="line">     9:         for i :&#x3D; 0; i &lt; len(nums); i++ &#123;</span><br><span class="line">&#x3D;&gt;  10:                 nums[i] &#x3D; i * i</span><br><span class="line">    11:         &#125;</span><br><span class="line">    12:         fmt.Println(nums)</span><br><span class="line">    13: &#125;</span><br><span class="line">(dlv) locals</span><br><span class="line">nums &#x3D; []int len: 5, cap: 5, [...]</span><br><span class="line">i &#x3D; 3</span><br><span class="line">(dlv) print nums</span><br><span class="line">[]int len: 5, cap: 5, [0,1,4,0,0]</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>我们发现当循环变量i等于3时，nums切片的前3个元素已经正确初始化。</p><p>我们还可以通过stack查看当前执行函数的栈帧信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(dlv) stack</span><br><span class="line">0  0x00000000010aea33 in main.main</span><br><span class="line">   at .&#x2F;main.go:10</span><br><span class="line">1  0x000000000102bd60 in runtime.main</span><br><span class="line">   at &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:198</span><br><span class="line">2  0x0000000001053bd1 in runtime.goexit</span><br><span class="line">   at &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;asm_amd64.s:2361</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>或者通过<code>goroutine</code>和<code>goroutines</code>命令查看当前Goroutine相关的信息：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(dlv) goroutine</span><br><span class="line">Thread 101686 at .&#x2F;main.go:10</span><br><span class="line">Goroutine 1:</span><br><span class="line">  Runtime: .&#x2F;main.go:10 main.main (0x10aea33)</span><br><span class="line">  User: .&#x2F;main.go:10 main.main (0x10aea33)</span><br><span class="line">  Go: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;asm_amd64.s:258 runtime.rt0_go (0x1051643)</span><br><span class="line">  Start: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:109 runtime.main (0x102bb90)</span><br><span class="line">(dlv) goroutines</span><br><span class="line">[4 goroutines]</span><br><span class="line">* Goroutine 1 - User: .&#x2F;main.go:10 main.main (0x10aea33) (thread 101686)</span><br><span class="line">  Goroutine 2 - User: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:292 \</span><br><span class="line">                runtime.gopark (0x102c189)</span><br><span class="line">  Goroutine 3 - User: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:292 \</span><br><span class="line">                runtime.gopark (0x102c189)</span><br><span class="line">  Goroutine 4 - User: &#x2F;usr&#x2F;local&#x2F;go&#x2F;src&#x2F;runtime&#x2F;proc.go:292 \</span><br><span class="line">                runtime.gopark (0x102c189)</span><br><span class="line">(dlv)</span><br></pre></td></tr></table></figure><p>最后完成调试工作后输入quit命令退出调试器。至此我们已经掌握了Delve调试器器的简单用法。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;由于我们可能断点调试程序，所以我们需要debug工具，对于golang来说，delve比gdb对go程序更友好。所以，我们今天来看看devle怎么debug程序&lt;/p&gt;
    
    </summary>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/categories/Golang/"/>
    
    
      <category term="Golang" scheme="http://blog.crazylaw.cn/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>【DevOps】Jenkins-shared-library 实战</title>
    <link href="http://blog.crazylaw.cn/2020/07/10/DevOps/Jenkins-shared-library/"/>
    <id>http://blog.crazylaw.cn/2020/07/10/DevOps/Jenkins-shared-library/</id>
    <published>2020-07-10T09:35:30.000Z</published>
    <updated>2021-03-20T16:25:01.798Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近公司用了 <code>jenkins</code> 做为 <code>CI/CD</code> 的工具，<code>jenkins</code>是什么，我就不和大家详细说明了。</p><p>今天主要讲的是 <code>jenkins</code> 的 <code>pipeline</code>，旧版的 jenkins 我不太了解，但是听说这个 pipeline 是新出的。</p><p>今天要讲的也不单单是<code>pipeline</code>，更是有强力干货<code>share-library</code>相关的内容。</p><a id="more"></a><h2 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h2><p>目前我们的 jenkins 服务用过<code>普通的pipeline</code>和 <code>多分支的pipeline</code>，其主要区别就是<code>多分支pipeline</code>更加灵活一些，能够让我们少做一些逻辑处理。<br>但是这引入了一个问题，那就是我们的<code>jenkins</code>，必须存在与对应的分支中，也因此，pipeline 的流程变成了代码管理，并且由于我们存在多个项目，那么将会有<code>项目数 * 2(master/pre-develop)</code> 那么多的 jenkins 需要管理，于是就导致了我们有很多这种冗余的写法，这还不是最糟糕的，最糟糕的是如果我们需要修改一些通用的内容的时候，就需要一个个去修改，这绝对是灾难级别的需求。</p><h2 id="Shared-library"><a href="#Shared-library" class="headerlink" title="Shared-library"></a>Shared-library</h2><p>幸好，或许 jenkins 已经考虑到了这种情况的出现，给我们提供了<code>shared-library</code>，在共享库的存在下，我们可以写一些自定义的定制功能。但是这不是没有代价的，代价就是你需要了解<code>groovy</code>这门语言，这是<code>java</code>的派生语言，提供了弱类型的语法，让写 groovy 脚本的变得更加轻松简单，但是也因此，groovy 和 java 的语法常常可以混在一起写，显得有点杂乱。</p><p>但是有总比没有好，我们把共享库分成了 2 个库，分别是<code>resource-libraries</code>，<code>jenkins-shard-library</code>。</p><ul><li><code>resource-libraries</code><ul><li>这个资源共享库定义了我们需要部署不同的配置资源信息，主要是对应<code>libraryResource</code>这个 api 来加载资源</li></ul></li><li><code>jenkins-shard-library</code><ul><li>这个共享库定义了我们需要的通用方法，例如部署流程已经需要统一对外的 api</li></ul></li></ul><h3 id="resource-libraries"><a href="#resource-libraries" class="headerlink" title="resource-libraries"></a>resource-libraries</h3><p>目前，我们的资源库目录结构如下，基本不存在 src 目录，这也意味者这个库不存在独特的<code>类</code>代码，只有统一对外开放的<code>vars</code>，整个库对外开放的 api 只有一个<code>mresource_load</code>方法，核心作用就是加载<code>resources</code>目录中的个项目的配置。由于可能会存在不同组之间的相同项目名，所以我们以<code>组/项目</code>为目录切分资源配置文件，文件以<code>yaml</code>格式为统一标准。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  resource-libraries git:(master) tree</span><br><span class="line">.</span><br><span class="line">├── README.MD</span><br><span class="line">├── resources</span><br><span class="line">│   ├── GamePlatform</span><br><span class="line">│   │   └── mcfx-admin.yaml</span><br><span class="line">│   ├── mc-game-admin</span><br><span class="line">│   │   └── om.yaml</span><br><span class="line">│   └── mc-webapp</span><br><span class="line">│       └── testing-tools.yaml</span><br><span class="line">├── tests</span><br><span class="line">│   └── test_mresource_load.groovy</span><br><span class="line">└── vars</span><br><span class="line">    └── mresource_load.groovy</span><br></pre></td></tr></table></figure><p>基本结构如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  resource-libraries git:(master) cat resources&#x2F;mc-webapp&#x2F;testing-tools.yaml</span><br><span class="line">type: &#39;normal&#39;</span><br><span class="line"></span><br><span class="line">git_credentials_id: &#39;basedev-git-account&#39;</span><br><span class="line"></span><br><span class="line">common: &amp;common</span><br><span class="line">  directory: &#39;&#x2F;data&#x2F;webapp&#x2F;testing-tools&#39;</span><br><span class="line">  deploy_ssh_id: &#39;basedev_tp_normal&#39;</span><br><span class="line"></span><br><span class="line">debug:</span><br><span class="line">  address: &#39;192.168.8.29:61618&#39;</span><br><span class="line">  &lt;&lt;: *common</span><br><span class="line">production:</span><br><span class="line">  address: &#39;192.168.8.93:61618&#39;</span><br><span class="line">  &lt;&lt;: *common</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  resource-libraries git:(master) cat resources&#x2F;mc-game-admin&#x2F;om.yaml</span><br><span class="line">type: job_name</span><br><span class="line"></span><br><span class="line">git_credentials_id: &#39;basedev_24_om&#39;</span><br><span class="line">debug_address: &amp;debug_address &#39;192.168.8.47:61618&#39;</span><br><span class="line">release_address: &amp;release_address &#39;192.168.8.47:61618&#39;</span><br><span class="line">deploy_ssh_id: &amp;deploy_ssh_id &#39;basedev_tp_normal&#39;</span><br><span class="line"></span><br><span class="line">basedev-m24-om:</span><br><span class="line">  debug:</span><br><span class="line">    address: *debug_address</span><br><span class="line">    directory: &#39;&#x2F;data&#x2F;m24&#x2F;web&#x2F;om_debug&#39;</span><br><span class="line">    deploy_ssh_id: *deploy_ssh_id</span><br><span class="line">  production:</span><br><span class="line">    address: *release_address</span><br><span class="line">    directory: &#39;&#x2F;data&#x2F;m24&#x2F;web&#x2F;om&#39;</span><br><span class="line">    deploy_ssh_id: *deploy_ssh_id</span><br></pre></td></tr></table></figure><ul><li>(*)type<ul><li>normal 普通模式</li><li>job_name job_name 模式。对于一个代码仓库，需要分项目部署的我们定义为 job_name 模式，这个的好处就是不同的项目可以以同一份配置文件进行不同的配置管理</li></ul></li><li>(*)git_credentials_id<ul><li>这是 checkout 下来的 git 唯一凭证 id</li></ul></li><li>common<ul><li>这个是推荐但是非必须存在的结构，这里存放一些我们在下面定义的一些通用配置来减少冗余</li></ul></li><li>支持的环境<ul><li>debug</li><li>reviews</li><li>production</li></ul></li><li>环境必填的属性如下<ul><li>address (ip+port)<ul><li>支持 string</li><li>支持 list</li></ul></li><li>directory 代码部署目录<ul><li>支持 string</li><li>支持 list</li></ul></li><li>deploy_ssh_id<ul><li>部署代码到服务的 ssh 的唯一凭证 id</li></ul></li></ul></li></ul><p>由以上构成我们的配置文件的格式。</p><h3 id="jenkins-shard-library"><a href="#jenkins-shard-library" class="headerlink" title="jenkins-shard-library"></a>jenkins-shard-library</h3><p>这个共享库直接影响到我们的 jenkinsfile 的写法，这是直接作用与 jenkinsfile 的共享库，先来一个目前 jenkinsfile 的写法：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def link &#x3D; &#39;https:&#x2F;&#x2F;xxx.com&#x2F;mc-webapp&#x2F;testing-tools&#39;</span><br><span class="line"></span><br><span class="line">mpipeline&#123;</span><br><span class="line">    repo&#x3D;link</span><br><span class="line">    script&#x3D;this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">import xxx.jenkins.LaravelPipeline</span><br><span class="line">def larvaelPipeline &#x3D; new LaravelPipeline(this)</span><br><span class="line"></span><br><span class="line">node &#123;</span><br><span class="line">    larvaelPipeline.preBuild().build().debug().reviews().production().execute()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这就是目前的 jenkinsfile 的写法，可以看到这个 jenkinsfile 没有定制的东西，除了一个<code>link</code>仓库链接之外，其他都是公用的内容。<br>接下来说一下<code>jenkinsfile-dsl</code></p><p>这个东西也就是我们在 jenkinsfile 中看到的<code>mpipeline</code>的结构体，这个是由于我们这个库提供的一个<code>dsl结构</code>，并非原始 jenkinsfile 提供的<br>所有的 jenkinsfile 必须存在这个<code>dsl</code>，并且需要写在流程的头部，以确保 jenkinsfile 的初始化对应的事情（checkout+环境变量+关键字加载）</p><p>目前，封装了一个基于<code>laravel</code>项目的 pipeline 操作类，用这个类来进行流程的统一创建管理。最后我们在 <code>node</code>结构中进行流程的 api 调用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">➜  jenkins-shard-library git:(master)   tree</span><br><span class="line">.</span><br><span class="line">├── Jenkinsfile.example</span><br><span class="line">├── README.MD</span><br><span class="line">├── jars</span><br><span class="line">│   └── groovy-cps-1.1.jar</span><br><span class="line">├── resources</span><br><span class="line">├── src</span><br><span class="line">│   └── xxx</span><br><span class="line">│       └── xxx</span><br><span class="line">│           └── jenkins</span><br><span class="line">│               ├── Constant.groovy</span><br><span class="line">│               ├── Deploy.groovy</span><br><span class="line">│               ├── Git.groovy</span><br><span class="line">│               ├── LaravelPipeline.groovy</span><br><span class="line">│               ├── MPipeline.groovy</span><br><span class="line">│               ├── MetlNotify.groovy</span><br><span class="line">│               ├── Repo.groovy</span><br><span class="line">│               └── SummaryNotify.groovy</span><br><span class="line">├── tests</span><br><span class="line">│   ├── RepoTest.groovy</span><br><span class="line">│   └── classfiles</span><br><span class="line">│       └── xxx</span><br><span class="line">│           └── xxx</span><br><span class="line">│               └── jenkins</span><br><span class="line">│                   ├── Constant.class</span><br><span class="line">│                   ├── Git.class</span><br><span class="line">│                   ├── MPipeline.class</span><br><span class="line">│                   ├── MetlNotify.class</span><br><span class="line">│                   ├── Repo.class</span><br><span class="line">│                   └── SummaryNotify.class</span><br><span class="line">└── vars</span><br><span class="line">    ├── mpipeline.groovy</span><br><span class="line">    └── notify.groovy</span><br></pre></td></tr></table></figure><p>详细的就不多做讲解，只说一些重要的，LaravelPipeline 对外提供的 api 有：</p><ul><li>preBuild()<ul><li>构建前需要做的事情，例如<code>发送通知任务开始</code></li></ul></li><li>build(isParallel = true)<ul><li>构建过程，参数<code>isParallel = true</code>是否并行构建</li></ul></li><li>deployment(def sshId = null)<ul><li>部署 api，主要是把 debug，reviews，production 写在了一起</li></ul></li><li>customDeploy(def closure = {})<ul><li>自定义部署流程，参数是一个回调函数，需要参考共享库的写法</li></ul></li><li>debug(def sshId)<ul><li>如果是对应的分支，那么将会部署到 debug 环境</li></ul></li><li>reviews(def sshId)<ul><li>如果是对应的分支，那么将会部署到 reviews 环境</li></ul></li><li>production(def sshId)<ul><li>如果是对应的分支，那么将会部署到 production 环境</li></ul></li><li>show()<ul><li>这是一个用于查看构建流程的方法，并不会真正运行各个结构的 stage 里面的内容。但是可以看到节点连线图</li></ul></li><li>execute(def config = [show: false])<ul><li>这是一个启动执行的方法，如果传入了参数 show=true，那么该方法等于 show 方法</li></ul></li></ul><p>对于全局关键字的提供有：</p><ul><li>mpipeline<ul><li>用于初始化整个部署流程，其中包含了 checkout 和环境变量等的初始化</li></ul></li><li>notify<ul><li>用于发送通知</li></ul></li></ul><p>最终的效果如下：</p><p><img src="/images/CI-CD/%E6%B5%81%E7%A8%8B%E8%8A%82%E7%82%B9%E5%9B%BE.png" alt="流程节点图"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;最近公司用了 &lt;code&gt;jenkins&lt;/code&gt; 做为 &lt;code&gt;CI/CD&lt;/code&gt; 的工具，&lt;code&gt;jenkins&lt;/code&gt;是什么，我就不和大家详细说明了。&lt;/p&gt;
&lt;p&gt;今天主要讲的是 &lt;code&gt;jenkins&lt;/code&gt; 的 &lt;code&gt;pipeline&lt;/code&gt;，旧版的 jenkins 我不太了解，但是听说这个 pipeline 是新出的。&lt;/p&gt;
&lt;p&gt;今天要讲的也不单单是&lt;code&gt;pipeline&lt;/code&gt;，更是有强力干货&lt;code&gt;share-library&lt;/code&gt;相关的内容。&lt;/p&gt;
    
    </summary>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/categories/DevOps/"/>
    
    
      <category term="DevOps" scheme="http://blog.crazylaw.cn/tags/DevOps/"/>
    
  </entry>
  
</feed>
